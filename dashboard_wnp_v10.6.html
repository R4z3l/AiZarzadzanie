<!DOCTYPE html>
<html lang="pl" style="background:#111827">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>AIZarzadzanie v10.6 ¬∑ Wydzia≈Ç Wdra≈ºania EFS+ ¬∑ Departament Funduszy Europejskich</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script>
// Chart.js 4 ‚Äî wyrejestruj domy≈õlny plugin bia≈Çego t≈Ça
if(typeof Chart !== 'undefined' && Chart.registry && Chart.registry.plugins){
  try{ Chart.registry.plugins.unregister(Chart.registry.plugins.get('backgroundColor')); }catch(e){}
}
</script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<!-- ==================== SEKCJA 2: CSS ‚Äî STYLE GLOBALNE ==================== -->
<link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,400;0,14..32,500;0,14..32,600;0,14..32,700;0,14..32,800;0,14..32,900;1,14..32,400;1,14..32,700&display=swap" rel="stylesheet">
<style>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   AIZarzadzanie v10.6 ¬∑ Wydzia≈Ç Wdra≈ºania EFS+ ¬∑ Departament Funduszy Europejskich
   Jasny (default) ¬∑ Ciemny ¬∑ Sepia
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
:root{
  --r7-btn-col:#111;
  --bg:#f8fafc;--bg2:#ffffff;--bg3:#f1f5f9;--bg4:#e2e8f0;
  --acc:#2563eb;--acc2:#0891b2;--acc3:#7c3aed;
  --grn:#059669;--yel:#d97706;--red:#dc2626;--orn:#ea580c;
  --txt:#0f172a;--txt2:#475569;--txt3:#94a3b8;
  --brd:#e2e8f0;--brd2:#cbd5e1;--card:#ffffff;
  --font:'Inter',sans-serif;--mono:'Inter',sans-serif;
  --sh:0 1px 3px rgba(15,23,42,.06),0 1px 2px rgba(15,23,42,.04);
  --sh2:0 4px 16px rgba(15,23,42,.08);
  --sh3:0 20px 50px rgba(15,23,42,.14);
}
body.theme-dark{
  --r7-btn-col:#ffffff;
  --bg:#111827;--bg2:#1f2937;--bg3:#162032;--bg4:#1a2535;
  --txt:#e5e7eb;--txt2:#9ca3af;--txt3:#6b7280;
  --brd:#374151;--brd2:#4b5563;--card:#1f2937;
  --sh:0 1px 3px rgba(0,0,0,.3);--sh2:0 4px 16px rgba(0,0,0,.4);
}
body.theme-dark .tbl th{background:#0d1117;color:#6b7280}
body.theme-dark .wsk-tbl th{background:#0d1117;color:#6b7280}
body.theme-dark input,body.theme-dark select{background:var(--bg)!important;color:var(--txt)!important;border-color:var(--brd)!important}
body.theme-sepia{
  --bg:#f5efe0;--bg2:#fdf8ee;--bg3:#f0e8d2;--bg4:#e8dcc4;
  --txt:#2c1a0e;--txt2:#5c3d2e;--txt3:#8c6a52;
  --brd:#d4b896;--brd2:#c4a07a;--card:#fdf8ee;
  --acc:#92400e;--grn:#065f46;--red:#7f1d1d;
}
body.theme-sepia input,body.theme-sepia select{background:var(--bg)!important;color:var(--txt)!important;border-color:var(--brd)!important}
*{box-sizing:border-box;margin:0;padding:0}
html{min-height:100%;background:var(--bg)}body{min-height:100vh;font-family:var(--font);background:var(--bg);color:var(--txt);font-size:14px;-webkit-font-smoothing:antialiased}
/* Wszystkie elementy u≈ºywajƒÖce --mono majƒÖ tabular nums ‚Äî cyfry o r√≥wnej szeroko≈õci bez slashed-zero */
[style*="font-family:var(--mono)"],.mono,.t-info,.pager button,.kpi-v,.ob-heat td.ob-cell,.ob-qlbl,.tb-date,
.arpk-score,.arpk-ci-pts,.arpk-cat-val,.imp-delta-v,.pm-nr,.pcard-nr,.zd-tbl td.zd-kwota,.zd-tbl td.zd-pct,
.zd-tbl td.zd-nr,.cfg-num,.op-aname,.arpk-cat-code,.arpk-ci-code,.imp-sheet-name,.imp-log,.imp-delta-v{
  font-family:'Inter',sans-serif!important;
  font-variant-numeric:tabular-nums;
  letter-spacing:0
}
::-webkit-scrollbar{width:5px;height:5px}::-webkit-scrollbar-track{background:var(--bg3)}::-webkit-scrollbar-thumb{background:var(--brd2);border-radius:3px}
/* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
.topbar{position:fixed;top:0;left:0;right:0;height:52px;background:var(--bg2);border-bottom:2px solid var(--brd);z-index:200;display:flex;align-items:center;padding:0 20px;gap:12px;box-shadow:var(--sh)}
.tb-logo{font-weight:900;font-size:.95rem;color:var(--txt);display:flex;align-items:center;gap:8px;flex-shrink:0;text-transform:uppercase;letter-spacing:-.02em;font-style:italic}
.tb-logo span{color:var(--acc)}
.tb-logo-badge{font-size:.6rem;font-weight:800;background:var(--acc);color:#fff;padding:2px 6px;border-radius:4px;letter-spacing:.06em;font-style:normal;text-transform:uppercase}
.tb-div{width:1px;height:22px;background:var(--brd);flex-shrink:0}
.tb-sub{font-size:.78rem;color:var(--txt3);font-weight:600;letter-spacing:.01em;flex-shrink:0}
.tb-sub b{color:var(--acc);font-weight:800}
.tb-right{margin-left:auto;display:flex;align-items:center;gap:7px}
.tb-date{font-family:var(--mono);font-size:.78rem;color:var(--txt3);font-weight:600}
.tb-live{display:flex;align-items:center;gap:5px;font-size:.65rem;font-weight:900;letter-spacing:2px;color:var(--grn);background:#05966912;border:1px solid #05966930;padding:3px 9px;border-radius:20px;text-transform:uppercase}
.tb-live-dot{width:5px;height:5px;border-radius:50%;background:var(--grn);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.25}}
/* Theme switcher */
.tb-theme{display:flex;gap:2px;background:var(--bg3);border:1px solid var(--brd);border-radius:8px;padding:2px;flex-shrink:0}
.tb-theme-btn{font-size:.65rem;font-weight:800;padding:3px 8px;border-radius:6px;cursor:pointer;border:none;background:transparent;color:var(--txt3);transition:all .12s;font-family:var(--font);text-transform:uppercase;letter-spacing:.06em}
.tb-theme-btn:hover{color:var(--txt);background:var(--bg4)}
.tb-theme-btn.on{background:var(--acc);color:#fff}
.btn-cfg{background:var(--bg3);border:1px solid var(--brd);color:var(--txt2);border-radius:8px;padding:4px 10px;cursor:pointer;font-size:.72rem;font-weight:800;font-family:var(--font);transition:all .12s;text-transform:uppercase;letter-spacing:.05em;white-space:nowrap}
.btn-cfg:hover{border-color:var(--acc);color:var(--acc)}
.btn-cfg.acc{background:var(--acc);color:#fff;border-color:var(--acc)}
.btn-cfg.acc:hover{opacity:.88}
.btn-cfg.danger{color:var(--red)}
.btn-cfg.danger:hover{border-color:var(--red);color:var(--red)}
/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.wrap{display:flex;min-height:calc(100vh - 52px);padding-top:52px;background:var(--bg)}
.sidebar{width:232px;background:var(--bg2);border-right:1px solid var(--brd);flex-shrink:0;overflow-y:auto;padding:12px 0;position:fixed;top:52px;bottom:0;left:0;z-index:100}
.sb-label{padding:10px 16px 4px;font-size:.62rem;color:var(--txt3);text-transform:uppercase;letter-spacing:2px;font-weight:900}
.sb-item{display:flex;align-items:center;gap:9px;padding:8px 16px;cursor:pointer;color:var(--txt2);font-size:.82rem;font-weight:500;border-left:3px solid transparent;transition:all .1s;user-select:none}
.sb-item:hover{background:var(--bg3);color:var(--txt)}
.sb-item.act{background:linear-gradient(90deg,#2563eb0d 0%,transparent);color:var(--acc);border-left-color:var(--acc);font-weight:700}
.sb-sep{margin:6px 14px;border-top:1px solid var(--brd)}
.sb-cnt{margin-left:auto;font-size:.68rem;font-weight:900;padding:2px 6px;border-radius:10px;background:var(--red);color:#fff;min-width:20px;text-align:center}
.sb-cnt.g{background:var(--grn)}.sb-cnt.y{background:var(--yel)}.sb-cnt.b{background:var(--acc)}
/* ‚îÄ‚îÄ CONFIG DRAWER ‚îÄ‚îÄ */
.cfg-overlay{display:none;position:fixed;inset:0;z-index:300;background:rgba(15,23,42,.55);backdrop-filter:blur(4px)}
.cfg-overlay.on{display:flex;justify-content:flex-end;align-items:stretch}
.cfg-drawer{width:420px;background:var(--bg2);border-left:1px solid var(--brd);display:flex;flex-direction:column;box-shadow:-20px 0 60px rgba(15,23,42,.15)}
.cfg-hdr{background:var(--bg3);border-bottom:1px solid var(--brd);padding:14px 18px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.cfg-hdr-t{font-size:.82rem;font-weight:900;display:flex;align-items:center;gap:8px;text-transform:uppercase;letter-spacing:.08em;color:var(--txt)}
.cfg-x{background:var(--bg2);border:1px solid var(--brd);color:var(--txt2);cursor:pointer;font-size:.75rem;border-radius:7px;padding:4px 10px;font-family:var(--font);font-weight:700;transition:all .1s;text-transform:uppercase}
.cfg-x:hover{color:var(--red);border-color:var(--red)}
.cfg-tabs{display:flex;background:var(--bg3);border-bottom:1px solid var(--brd);flex-shrink:0;overflow-x:auto}
.cfg-tab{padding:9px 14px;font-size:.72rem;color:var(--txt3);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all .1s;user-select:none;white-space:nowrap;font-weight:800;text-transform:uppercase;letter-spacing:.06em}
.cfg-tab:hover{color:var(--txt)}.cfg-tab.on{color:var(--acc);border-bottom-color:var(--acc)}
.cfg-body{flex:1;overflow-y:auto;padding:16px 18px}
.cfg-pane{display:none}.cfg-pane.on{display:block}
.cfg-sec{margin-bottom:20px}
.cfg-sec-t{font-size:.65rem;color:var(--txt3);text-transform:uppercase;letter-spacing:1.5px;font-weight:900;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--brd)}
.cfg-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;gap:8px}
.cfg-row label{font-size:.88rem;color:var(--txt2);flex:1;font-weight:500}
.cfg-num{width:68px;background:var(--bg3);border:1px solid var(--brd);color:var(--txt);border-radius:7px;padding:4px 8px;font-size:.8rem;font-family:var(--mono);text-align:center;outline:none;transition:border-color .1s}
.cfg-num:focus{border-color:var(--acc)}
.cfg-sel{background:var(--bg3);border:1px solid var(--brd);color:var(--txt);border-radius:7px;padding:6px 9px;font-size:.85rem;font-family:var(--font);outline:none;width:100%;transition:border-color .1s}
.cfg-sel:focus{border-color:var(--acc)}
.dz-pills{display:flex;gap:5px;flex-wrap:wrap;margin-top:3px}
.dz-pill{padding:4px 12px;border-radius:20px;border:1px solid var(--brd);color:var(--txt2);font-size:.72rem;font-weight:800;cursor:pointer;transition:all .1s;user-select:none;text-transform:uppercase;letter-spacing:.05em}
.dz-pill:hover{border-color:var(--acc);color:var(--acc)}.dz-pill.on{background:var(--acc);color:#fff;border-color:var(--acc)}
.op-assign{display:flex;flex-direction:column;gap:5px;max-height:400px;overflow-y:auto}
.op-arow{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:5px 9px;background:var(--bg3);border:1px solid var(--brd);border-radius:7px}
.op-aname{font-family:var(--mono);font-size:.8rem;color:var(--acc);font-weight:700;min-width:90px}
.cfg-info{font-size:.82rem;color:var(--txt3);line-height:1.6;padding:9px 11px;background:var(--bg3);border:1px solid var(--brd);border-radius:8px;margin-bottom:11px}
.cfg-ftr{padding:14px 18px;border-top:1px solid var(--brd);flex-shrink:0;background:var(--bg3)}
.arpk-cat-list{display:flex;flex-direction:column;gap:7px}
.arpk-cat-row{background:var(--bg3);border:1px solid var(--brd);border-radius:8px;padding:10px 13px}
.arpk-cat-hdr{display:flex;align-items:flex-start;gap:8px;margin-bottom:7px}
.arpk-cat-code{font-family:var(--mono);font-size:.78rem;font-weight:900;color:var(--acc);min-width:24px}
.arpk-cat-name{font-size:.86rem;font-weight:700;flex:1;color:var(--txt)}
.arpk-cat-badge{font-size:.68rem;padding:2px 7px;border-radius:4px;background:var(--acc);color:#fff;white-space:nowrap;font-weight:900;text-transform:uppercase;letter-spacing:.05em}
.arpk-cat-desc{font-size:.82rem;color:var(--txt3);line-height:1.5;margin-bottom:7px}
.arpk-cat-ctl{display:flex;align-items:center;gap:7px}
.arpk-cat-ctl label{font-size:.8rem;color:var(--txt2);font-weight:500}
.arpk-cat-ctl input[type=range]{flex:1;accent-color:var(--acc)}
.arpk-cat-val{font-family:var(--mono);font-size:.88rem;font-weight:900;color:var(--acc);min-width:38px;text-align:right}
/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
.main{flex:1;margin-left:232px;padding:22px 24px;min-height:calc(100vh - 52px);background:var(--bg)}
.page{display:none;animation:fi .15s ease}.page.on{display:block}
@keyframes fi{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
/* Page header */
.ph{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:18px;padding-bottom:14px;border-bottom:2px solid var(--brd)}
.ph-t{font-size:.95rem;font-weight:900;display:flex;align-items:center;gap:9px;text-transform:uppercase;letter-spacing:-.01em;color:var(--txt)}
.ph-icon{width:28px;height:28px;border-radius:8px;background:var(--acc);display:flex;align-items:center;justify-content:center;font-size:.9rem;color:#fff}
.ph-sub{font-size:.78rem;color:var(--txt3);margin-top:3px;font-weight:600}
.xbar{display:flex;gap:6px}
/* ‚îÄ‚îÄ KPI ‚îÄ‚îÄ */
.kgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(168px,1fr));gap:10px;margin-bottom:16px}
.kpi{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:14px 16px;position:relative;overflow:hidden;box-shadow:var(--sh);transition:box-shadow .15s}
.kpi:hover{box-shadow:var(--sh2)}
.kpi::before{content:"";position:absolute;top:0;left:0;right:0;height:3px;border-radius:12px 12px 0 0}
.kpi.b::before{background:var(--acc)}.kpi.g::before{background:var(--grn)}.kpi.r::before{background:var(--red)}
.kpi.y::before{background:var(--yel)}.kpi.c::before{background:var(--acc2)}.kpi.p::before{background:var(--acc3)}.kpi.o::before{background:var(--orn)}
.kpi-l{font-size:.65rem;color:var(--txt3);text-transform:uppercase;letter-spacing:1px;font-weight:900;margin-bottom:6px}
.kpi-v{font-size:1.5rem;font-weight:900;line-height:1;font-variant-numeric:tabular-nums;letter-spacing:-.03em}
.kpi.b .kpi-v{color:var(--acc)}.kpi.g .kpi-v{color:var(--grn)}.kpi.r .kpi-v{color:var(--red)}
.kpi.y .kpi-v{color:var(--yel)}.kpi.c .kpi-v{color:var(--acc2)}.kpi.p .kpi-v{color:var(--acc3)}.kpi.o .kpi-v{color:var(--orn)}
.kpi-s{font-size:.78rem;color:var(--txt3);margin-top:4px;font-weight:500}
/* ‚îÄ‚îÄ FILTER BAR ‚îÄ‚îÄ */
.fbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:12px;padding:9px 14px;background:var(--bg3);border:1px solid var(--brd);border-radius:10px}
.fbar input,.fbar select{background:var(--bg2);border:1px solid var(--brd);color:var(--txt);border-radius:7px;padding:5px 9px;font-size:.8rem;outline:none;font-family:var(--font);transition:border-color .1s;font-weight:500}
.fbar input:focus,.fbar select:focus{border-color:var(--acc)}
.flbl{font-size:.65rem;font-weight:900;color:var(--txt3);text-transform:uppercase;letter-spacing:.1em;white-space:nowrap}
/* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
.twrap{background:var(--card);border:1px solid var(--brd);border-radius:12px;overflow:hidden;margin-bottom:16px;box-shadow:var(--sh)}
.ttb{display:flex;align-items:center;justify-content:space-between;padding:8px 14px;background:var(--bg3);border-bottom:1px solid var(--brd);flex-wrap:wrap;gap:5px}
.t-info{font-size:.75rem;color:var(--txt3);font-family:var(--mono);font-weight:600}
.of{overflow-x:auto}
.tbl{width:100%;border-collapse:collapse;font-size:.84rem}
.tbl th{background:#0f172a;color:#64748b;padding:8px 10px;text-align:left;font-size:.65rem;font-weight:900;text-transform:uppercase;letter-spacing:.08em;border-bottom:1px solid #1e293b;white-space:nowrap;position:sticky;top:0}
.tbl td{padding:8px 10px;border-bottom:1px solid var(--brd);vertical-align:middle;white-space:nowrap;color:var(--txt)}
.tbl tr:last-child td{border-bottom:none}
.tbl tbody tr:hover td{background:var(--bg3)}
.tbl td.nr{text-align:right}.tbl th.nr{text-align:right}
.mono{font-family:var(--mono);font-size:.8rem}
.clamp{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:180px}
/* ‚îÄ‚îÄ PAGER ‚îÄ‚îÄ */
.pager{display:flex;gap:3px;align-items:center;padding:8px 14px;border-top:1px solid var(--brd);background:var(--bg3);flex-wrap:wrap}
.pager button{background:var(--bg2);border:1px solid var(--brd);color:var(--txt2);border-radius:7px;padding:3px 9px;cursor:pointer;font-size:.78rem;font-family:var(--mono);transition:all .1s;font-weight:700}
.pager button:hover{color:var(--acc);border-color:var(--acc)}
.pager button.on{background:var(--acc);color:#fff;border-color:var(--acc)}
.pager button:disabled{opacity:.3;cursor:default}
/* ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ */
.badge{display:inline-flex;align-items:center;padding:2px 7px;border-radius:5px;font-size:.72rem;font-weight:800;white-space:nowrap;letter-spacing:.03em}
.bg{background:#05966915;color:var(--grn);border:1px solid #05966935}
.bgr{background:#dc262615;color:var(--red);border:1px solid #dc262635}
.by{background:#d9780615;color:var(--yel);border:1px solid #d9780635}
.bb{background:#2563eb15;color:var(--acc);border:1px solid #2563eb35}
.bc{background:#08a4c415;color:var(--acc2);border:1px solid #08a4c435}
.br{background:var(--red);color:#fff;border:1px solid var(--red)}
.bo{background:#ea580c15;color:var(--orn);border:1px solid #ea580c35}
.bgr-h{background:var(--bg3);color:var(--txt2);border:1px solid var(--brd)}
.bbl{background:var(--acc);color:#fff;border:1px solid var(--acc)}
/* ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ */
.prog{background:var(--bg3);border:1px solid var(--brd);border-radius:4px;height:5px;min-width:60px;overflow:hidden}
.prog-b{height:5px;border-radius:4px;transition:width .4s}
/* ‚îÄ‚îÄ CHARTS ‚îÄ‚îÄ */
.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px}
.chart-card{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:16px;box-shadow:var(--sh)}
.chart-title{font-size:.65rem;font-weight:900;color:var(--txt3);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}
/* ‚îÄ‚îÄ ALERTS PANEL ‚îÄ‚îÄ */
.alerts-panel{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:14px 16px;margin-bottom:16px;box-shadow:var(--sh)}
.alert-item{display:flex;align-items:flex-start;gap:9px;padding:8px 0;border-bottom:1px solid var(--brd);font-size:.84rem;line-height:1.5;color:var(--txt2)}
.alert-item:last-child{border-bottom:none}
.alert-dot{width:7px;height:7px;border-radius:50%;margin-top:5px;flex-shrink:0}
/* ‚îÄ‚îÄ PM CARDS (Postƒôp/Rzeczowy) ‚îÄ‚îÄ */
.pm-list{display:flex;flex-direction:column;gap:8px}
.pm-card,.proj-metric{background:var(--card);border:1px solid var(--brd);border-radius:12px;overflow:hidden;box-shadow:var(--sh);transition:box-shadow .15s;margin-bottom:4px}
.pm-card:hover,.proj-metric:hover{box-shadow:var(--sh2)}
.pm-hdr{display:flex;align-items:center;gap:10px;padding:12px 15px;cursor:pointer;user-select:none;transition:background .1s}
.pm-hdr:hover{background:var(--bg3)}
.pm-nr{font-family:var(--mono);font-size:.72rem;color:var(--txt3);font-weight:700}
.pm-name{font-size:.9rem;font-weight:700;color:var(--txt)}
.pm-badges{display:flex;gap:5px;flex-shrink:0;align-items:center;flex-wrap:wrap}
.pm-body{display:none;padding:15px;border-top:1px solid var(--brd);background:var(--bg3)}
.pm-body.on{display:block}
.pm-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:9px;margin-bottom:14px}
.pm-kpi{background:var(--card);border:1px solid var(--brd);border-radius:8px;padding:9px 11px;box-shadow:var(--sh)}
.pm-kpi-l{font-size:.65rem;color:var(--txt3);text-transform:uppercase;letter-spacing:.8px;font-weight:900;margin-bottom:4px}
.pm-kpi-v{font-size:.9rem;font-weight:800;color:var(--txt)}
.pm-section{margin-bottom:13px}
.pm-sec-t{font-size:.65rem;color:var(--txt3);text-transform:uppercase;letter-spacing:1px;font-weight:900;margin-bottom:8px;display:flex;align-items:center;gap:7px}
.pm-sec-t::after{content:"";flex:1;height:1px;background:var(--brd)}
.arpk-breakdown{display:grid;grid-template-columns:repeat(auto-fill,minmax(285px,1fr));gap:8px}
.arpk-cat-item{background:var(--card);border:1px solid var(--brd);border-radius:8px;padding:10px 12px;box-shadow:var(--sh)}
.arpk-ci-hdr{display:flex;align-items:center;gap:6px;margin-bottom:5px}
.arpk-ci-code{font-family:var(--mono);font-size:.72rem;font-weight:900;color:var(--acc)}
.arpk-ci-name{font-size:.86rem;font-weight:700;flex:1;color:var(--txt)}
.arpk-ci-pts{font-family:var(--mono);font-size:.88rem;font-weight:900;min-width:32px;text-align:right;color:var(--txt)}
.arpk-ci-max{font-size:.8rem;color:var(--txt3)}
.arpk-ci-state{font-size:.82rem;color:var(--txt2);margin-bottom:5px;line-height:1.45}
.arpk-ci-bar{background:var(--bg3);border-radius:3px;height:3px;overflow:hidden;margin-top:5px}
.arpk-ci-fill{height:3px;border-radius:3px}
.wsk-tbl{width:100%;border-collapse:collapse;font-size:.84rem;margin-top:7px}
.wsk-tbl th{background:#0f172a;color:#64748b;padding:6px 9px;text-align:left;font-size:.65rem;font-weight:900;text-transform:uppercase;letter-spacing:.08em;border-bottom:1px solid #1e293b}
.wsk-tbl td{padding:6px 9px;border-bottom:1px solid var(--brd);vertical-align:middle;color:var(--txt)}
.wsk-tbl tr:last-child td{border-bottom:none}
.wsk-tbl tbody tr:hover td{background:var(--bg3)}
.wsk-pct{display:flex;align-items:center;gap:6px}
.wsk-pct-bar{width:50px;height:4px;background:var(--bg3);border-radius:3px;overflow:hidden;flex-shrink:0;border:1px solid var(--brd)}
.wsk-pct-fill{height:4px;border-radius:3px}
/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal-ov{display:none;position:fixed;inset:0;background:rgba(15,23,42,.55);z-index:400;backdrop-filter:blur(4px)}
.modal-ov.on{display:flex;align-items:center;justify-content:center}
.modal{background:var(--card);border:1px solid var(--brd);border-radius:16px;width:760px;max-width:95vw;max-height:90vh;overflow-y:auto;padding:22px 24px;position:relative;box-shadow:var(--sh3)}
.modal-x{position:absolute;top:12px;right:14px;background:var(--bg3);border:1px solid var(--brd);color:var(--txt2);cursor:pointer;font-size:.75rem;border-radius:8px;padding:4px 10px;font-family:var(--font);font-weight:800;transition:all .1s;text-transform:uppercase}
.modal-x:hover{color:var(--red);border-color:var(--red)}
.modal-t{font-size:.95rem;font-weight:900;margin-bottom:16px;padding-right:50px;text-transform:uppercase;letter-spacing:-.01em;color:var(--txt)}
.dg{display:grid;grid-template-columns:1fr 1fr;gap:7px}
.dr{background:var(--bg3);border-radius:8px;padding:8px 12px;display:flex;flex-direction:column;gap:3px;border:1px solid var(--brd)}
.dr.full{grid-column:1/-1}
.dk{font-size:.65rem;color:var(--txt3);text-transform:uppercase;letter-spacing:.1em;font-weight:900}
.dv{font-size:.86rem;color:var(--txt);font-weight:600}
/* ‚îÄ‚îÄ POSTEP CARDS ‚îÄ‚îÄ */
.pcard{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:14px 16px;margin-bottom:8px;cursor:pointer;transition:all .15s;box-shadow:var(--sh)}
.pcard:hover{box-shadow:var(--sh2);transform:translateY(-1px)}
.pcard.late{border-left:4px solid var(--red)}.pcard.ok{border-left:4px solid var(--grn)}
.pcard-hdr{display:flex;align-items:flex-start;justify-content:space-between;gap:8px;margin-bottom:8px}
.pcard-nr{font-family:var(--mono);font-size:.72rem;color:var(--txt3);font-weight:700}
.pcard-nm{font-size:.9rem;font-weight:700;color:var(--txt)}
.pcard-meta{font-size:.8rem;color:var(--txt2);display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px;font-weight:500}
.pcard-meta b{color:var(--txt);font-weight:700}
.zd{display:none;margin-top:8px;border-top:1px solid var(--brd);padding-top:8px}
.zd.on{display:block}
.zd-tbl{width:100%;border-collapse:collapse;table-layout:fixed}
.zd-tbl th{font-size:.65rem;font-weight:900;color:var(--txt3);text-transform:uppercase;letter-spacing:.07em;padding:5px 8px;background:var(--bg3);border-bottom:2px solid var(--brd);white-space:nowrap}
.zd-tbl th.zd-nr{width:36px;text-align:center}
.zd-tbl th.zd-nazwa{width:auto}
.zd-tbl th.zd-kwota{width:150px;text-align:right}
.zd-tbl th.zd-pct{width:52px;text-align:right}
.zd-tbl td{padding:5px 8px;border-bottom:1px solid var(--brd);vertical-align:top;font-size:.82rem;color:var(--txt2)}
.zd-tbl tr:last-child td{border-bottom:none}
.zd-tbl tbody tr:hover td{background:var(--bg3)}
.zd-tbl td.zd-nr{text-align:center;font-family:var(--mono);font-size:.75rem;color:var(--txt3);white-space:nowrap}
.zd-tbl td.zd-nazwa{word-break:break-word;line-height:1.4}
.zd-tbl td.zd-kwota{text-align:right;font-family:var(--mono);font-size:.8rem;white-space:nowrap}
.zd-tbl td.zd-pct{text-align:right;font-family:var(--mono);font-size:.8rem;white-space:nowrap;font-weight:700}
/* ‚îÄ‚îÄ OP GRID ‚îÄ‚îÄ */
.op-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(258px,1fr));gap:10px;margin-bottom:16px}
.opcard{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:14px 16px;cursor:pointer;transition:all .15s;box-shadow:var(--sh)}
.opcard:hover{border-color:var(--acc);box-shadow:var(--sh2);transform:translateY(-1px)}
.opcard-nm{font-weight:800;color:var(--txt);font-size:.9rem;margin-bottom:3px}
.opcard-dz{font-size:.65rem;color:var(--txt3);margin-bottom:8px;font-weight:800;text-transform:uppercase;letter-spacing:.07em}
.op-stats{display:flex;gap:12px;flex-wrap:wrap}
.opst{text-align:center}
.opst-v{font-size:1.2rem;font-weight:900;color:var(--txt);letter-spacing:-.03em}
.opst-l{font-size:.58rem;color:var(--txt3);text-transform:uppercase;letter-spacing:.07em;font-weight:800}
/* ‚îÄ‚îÄ aRPK ‚îÄ‚îÄ */
.arpk-bar{display:flex;align-items:center;gap:5px}
.arpk-score{font-family:var(--mono);font-size:.84rem;font-weight:900;min-width:28px;color:var(--txt)}
.arpk-prog{flex:1;height:5px;background:var(--bg3);border-radius:3px;overflow:hidden;min-width:40px;border:1px solid var(--brd)}
.arpk-fill{height:5px;border-radius:3px}
/* ‚îÄ‚îÄ INLINE ALERTS ‚îÄ‚îÄ */
.alert{padding:9px 13px;border-radius:8px;font-size:.84rem;margin-bottom:12px;display:flex;align-items:center;gap:9px;font-weight:500}
.ai{background:#2563eb0d;border:1px solid #2563eb28;color:var(--acc)}
.aw{background:#d978060d;border:1px solid #d9780628;color:var(--yel)}
.sec{font-size:.65rem;font-weight:900;color:var(--txt3);text-transform:uppercase;letter-spacing:1px;margin:16px 0 10px;display:flex;align-items:center;gap:8px}
.sec::after{content:"";flex:1;height:1px;background:var(--brd)}
.empty{text-align:center;padding:36px;color:var(--txt3);font-size:.88rem;font-weight:600}
/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn{background:var(--acc);color:#fff;border:none;border-radius:8px;padding:5px 14px;cursor:pointer;font-size:.72rem;font-weight:900;font-family:var(--font);transition:all .12s;white-space:nowrap;text-transform:uppercase;letter-spacing:.06em}
.btn:hover{background:#1d4ed8}
.btn-sm{padding:3px 9px;font-size:.68rem}
.btn-out{background:transparent;border:1px solid var(--brd);color:var(--txt2);font-weight:800}
.btn-out:hover{border-color:var(--acc);color:var(--acc);background:transparent}
.hidden{display:none!important}
/* ‚îÄ‚îÄ IMPORT MODULE ‚îÄ‚îÄ */
.imp-drop{border:2px dashed var(--brd2);border-radius:14px;padding:44px 32px;text-align:center;cursor:pointer;transition:all .2s;background:var(--bg3)}
.imp-drop:hover,.imp-drop.over{border-color:var(--acc);background:#2563eb06}
.imp-drop-icon{font-size:2.2rem;margin-bottom:12px;opacity:.35}
.imp-drop-t{font-size:.88rem;font-weight:900;margin-bottom:5px;text-transform:uppercase;letter-spacing:.05em;color:var(--txt)}
.imp-drop-s{font-size:.82rem;color:var(--txt3);font-weight:500}
.imp-sheets{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:9px;margin:14px 0}
.imp-sheet{background:var(--bg3);border:1px solid var(--brd);border-radius:9px;padding:11px 14px}
.imp-sheet.ok{border-color:var(--grn);background:#05966906}
.imp-sheet.warn{border-color:var(--yel);background:#d9780606}
.imp-sheet.skip{opacity:.38}
.imp-sheet-name{font-family:var(--mono);font-size:.8rem;font-weight:800;margin-bottom:4px;display:flex;align-items:center;gap:6px;color:var(--txt)}
.imp-sheet-info{font-size:.76rem;color:var(--txt3);font-weight:500}
.imp-preview{background:var(--card);border:1px solid var(--brd);border-radius:12px;overflow:hidden;margin-bottom:16px;box-shadow:var(--sh)}
.imp-prev-hdr{background:var(--bg3);padding:10px 15px;font-size:.78rem;font-weight:900;display:flex;gap:8px;align-items:center;border-bottom:1px solid var(--brd);text-transform:uppercase;letter-spacing:.07em;color:var(--txt)}
.imp-delta{display:flex;gap:7px;flex-wrap:wrap;padding:12px 15px}
.imp-delta-item{background:var(--bg3);border:1px solid var(--brd);border-radius:9px;padding:9px 13px;display:flex;flex-direction:column;gap:3px;min-width:140px}
.imp-delta-l{font-size:.62rem;color:var(--txt3);text-transform:uppercase;letter-spacing:.09em;font-weight:900}
.imp-delta-v{font-weight:900;font-family:var(--mono);color:var(--txt);font-size:.92rem}
.imp-log{font-family:var(--mono);font-size:.78rem;color:var(--txt2);background:var(--bg3);border:1px solid var(--brd);border-radius:9px;padding:11px 14px;max-height:200px;overflow-y:auto;line-height:1.85;margin-bottom:13px}
.imp-log .ok{color:var(--grn);font-weight:700}
.imp-log .warn{color:var(--yel);font-weight:700}
.imp-log .info{color:var(--acc);font-weight:600}
.imp-prog{height:4px;background:var(--brd);border-radius:4px;overflow:hidden;margin:9px 0}
.imp-prog-b{height:4px;background:var(--acc);border-radius:4px;transition:width .3s}
<!-- ==================== KONIEC: CSS ‚Äî STYLE GLOBALNE ==================== -->

@media(max-width:800px){.cgrid{grid-template-columns:1fr}.sidebar{display:none}.main{margin-left:0;background:var(--bg)}.dg{grid-template-columns:1fr}}
.mpills{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:12px;align-items:center}
.mp{display:inline-flex;align-items:center;justify-content:center;padding:4px 11px;border:1px solid var(--brd2);border-radius:6px;background:var(--bg3);color:var(--txt2);font-size:.78rem;font-weight:700;cursor:pointer;transition:all .12s;white-space:nowrap;user-select:none;min-width:32px}
.mp:hover{border-color:var(--acc);color:var(--acc);background:var(--bg3)}
.mp.on{background:var(--acc);color:#fff;border-color:var(--acc)}
/* ‚îÄ‚îÄ OBCIƒÑ≈ªENIE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.ob-vtab{padding:4px 12px;border:1px solid var(--brd);border-radius:5px;background:var(--bg2);color:var(--txt2);font-size:.82rem;font-weight:600;cursor:pointer;transition:all .15s}
.ob-vtab.on{background:var(--acc);color:#fff;border-color:var(--acc)}
.ob-vtab:hover:not(.on){background:var(--bg3);color:var(--txt)}
.ob-section{margin-bottom:20px}
.ob-section-t{font-size:.72rem;font-weight:900;text-transform:uppercase;letter-spacing:.08em;color:var(--txt3);margin-bottom:8px}
/* Heatmapa */
.ob-heat{border-collapse:collapse;font-size:.82rem;table-layout:fixed}
.ob-heat th{padding:5px 6px;text-align:left;font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.04em;color:var(--txt3);border-bottom:2px solid var(--brd);white-space:nowrap}
.ob-heat th:first-child{min-width:140px}
.ob-heat th.nr{text-align:center}
.ob-heat td{padding:6px 6px;border-bottom:1px solid var(--brd2);vertical-align:middle;overflow:hidden;text-overflow:ellipsis}
.ob-heat td.ob-name{font-weight:600;color:var(--txt);white-space:nowrap;max-width:none}
.ob-heat td.ob-dz{font-size:.75rem;color:var(--txt3)}
.ob-heat td.ob-cell{text-align:center;font-family:var(--mono);font-weight:700;font-size:.84rem;border-radius:4px;position:relative}
.ob-heat tr:hover td{background:var(--bg3)}
.ob-best{font-size:.7rem;background:var(--grn);color:#fff;border-radius:3px;padding:1px 5px;margin-left:5px;vertical-align:middle}
/* Pasek kwarta≈Ç√≥w */
.ob-qgrid{display:flex;flex-direction:column;gap:6px}
.ob-qrow{display:grid;grid-template-columns:100px 1fr 60px 90px;align-items:center;gap:10px}
.ob-qrow.header{font-size:.7rem;font-weight:900;text-transform:uppercase;letter-spacing:.06em;color:var(--txt3);padding-bottom:4px;border-bottom:1px solid var(--brd2)}
.ob-qbar-wrap{background:var(--bg3);border-radius:4px;height:20px;overflow:hidden;position:relative}
.ob-qbar{height:100%;border-radius:4px;transition:width .4s ease;min-width:2px}
.ob-qbar.end{background:var(--acc)}
.ob-qbar.act{background:var(--grn)}
.ob-qlbl{font-size:.82rem;font-weight:700;font-family:var(--mono)}
.ob-qperiod{font-size:.82rem;font-weight:600;color:var(--txt2)}
.ob-now-marker{background:var(--yel);color:#000;font-size:.68rem;font-weight:800;padding:1px 6px;border-radius:3px;margin-left:6px}
.ob-min-badge{font-size:.68rem;background:var(--grn);color:#fff;padding:1px 5px;border-radius:3px;font-weight:900;letter-spacing:0}
/* Submodu≈Ç tabs */
.ob-stab{padding:8px 18px;border:none;border-bottom:3px solid transparent;background:transparent;color:var(--txt3);font-size:.82rem;font-weight:700;cursor:pointer;font-family:var(--font);transition:all .15s;letter-spacing:.01em;margin-bottom:-2px}
.ob-stab:hover:not(.on){color:var(--txt);border-bottom-color:var(--brd2)}
.ob-stab.on{color:var(--acc);border-bottom-color:var(--acc);background:linear-gradient(0deg,#2563eb08,transparent)}
.ob-subpane{display:none}.ob-subpane.on{display:block;animation:fi .15s ease}


/* Collapsed Sidebar */
.sidebar.collapsed {
  width: 56px;
  padding: 12px 0;
}
.sidebar.collapsed .sb-label { 
  display: none; 
}
.sidebar.collapsed .sb-item span { 
  display: none; 
}
.sidebar.collapsed .sb-item:hover span {
  display: block;
  position: absolute;
  left: 60px;
  top: 0;
  background: var(--bg2);
  padding: 8px 12px;
  border-radius: 6px;
  white-space: nowrap;
  border: 1px solid var(--brd);
  box-shadow: var(--sh2);
  z-index: 10;
  font-size: .82rem;
  min-width: 140px;
}
.sidebar.collapsed .sb-item { 
  justify-content: center;
  gap: 0;
  padding: 10px 8px;
}
.sidebar.collapsed .sb-cnt {
  margin-left: 0;
}
.main.collapsed {
  margin-left: 56px;
}
.sidebar-toggle {
  position: fixed;
  top: 70px;
  left: 232px;
  width: 32px;
  height: 32px;
  background: var(--bg2);
  border: 1px solid var(--brd);
  border-left: none;
  border-radius: 0 8px 8px 0;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 150;
  transition: all .2s;
  font-size: 1rem;
}
.sidebar.collapsed + .main .sidebar-toggle {
  left: 56px;
}
.sidebar-toggle:hover {
  background: var(--bg3);
  color: var(--acc);
}
</style>
</head>
<!-- ==================== SEKCJA 3: TOPBAR + PASEK G√ìRNY ==================== -->
<body class="theme-dark">
<div class="topbar" data-ai-id="ai-ID.topbar">
  <div style="display:flex;flex-direction:column;justify-content:center;flex-shrink:0">
    <div class="tb-logo">
      <span>AI</span>Zarzadzanie
      <span class="tb-logo-badge" style="letter-spacing:.04em;padding:2px 8px">EFS+</span>
    </div>
    <div style="font-size:.58rem;color:var(--txt3);font-weight:600;letter-spacing:.04em;font-style:italic;padding-left:1px">wersja 10.6</div>
  </div>
  <div class="tb-div"></div>
  <div class="tb-sub">Wydzia≈Ç Wdra≈ºania EFS+ ¬∑ DFE ¬∑ <b id="tb-dzial">Wszystkie dzia≈Çy</b> ¬∑ <b id="tb-pcnt">‚Äî</b> projekt√≥w</div>
  <div class="tb-div"></div>
  <span class="flbl" style="flex-shrink:0">Dzia≈Ç:</span>
  <select id="tb-dzial-sel" data-ai-id="ai-ID.topbar.dzial-selector" style="background:var(--bg3);border:1px solid var(--brd);color:var(--txt);border-radius:7px;padding:4px 8px;font-size:.78rem;font-family:var(--font);font-weight:600;outline:none;flex-shrink:0;cursor:pointer" onchange="topbarDzialChange(this.value)">
    <option value="all">Wszystkie dzia≈Çy</option>
    <option value="1">Dzia≈Ç EFS I</option>
    <option value="2">Dzia≈Ç EFS II</option>
    <option value="3">Dzia≈Ç EFS III</option>
  </select>
  <div class="tb-right">
    <div class="tb-date" id="tb-date"></div>
    <div class="tb-div"></div>
    <div class="tb-theme" id="tb-theme-sw" style="display:none"></div>
    <div class="tb-div"></div>
    <button class="btn-cfg acc" onclick="saveState()" title="Wygeneruj nowy plik HTML z aktualnymi danymi">üíæ Zapisz</button>
    <button class="btn-cfg danger" onclick="clearData()" title="Wyczy≈õƒá dane ‚Äî kod i pracownicy zostajƒÖ">üóë Wyczy≈õƒá</button>
    <button class="btn-cfg" id="btn-cfg" onclick="toggleCfg()">‚öô Konfiguracja</button>
    <div class="tb-live"><div class="tb-live-dot"></div>LIVE</div>
  </div>
<!-- ==================== SEKCJA 3b: KONFIGURACJA (panel ‚öô) ==================== -->
</div>

<div class="cfg-overlay" id="cfgOverlay" data-ai-id="ai-ID.cfg.overlay" onclick="overlayClick(event)">
  <div class="cfg-drawer" data-ai-id="ai-ID.cfg.drawer">
    <div class="cfg-hdr" data-ai-id="ai-ID.cfg.header"><div class="cfg-hdr-t">‚öô Konfiguracja systemu</div><button class="cfg-x" onclick="toggleCfg()">‚úï Zamknij</button></div>
    <div class="cfg-tabs" data-ai-id="ai-ID.cfg.tabs">
      <div class="cfg-tab on" onclick="showCfgTab(this,'c-dzialy')">Dzia≈Çy</div>
      <div class="cfg-tab" onclick="showCfgTab(this,'c-parametry')">Parametry</div>
      <div class="cfg-tab" onclick="showCfgTab(this,'c-arpk-cfg')">aRPK Kategorie</div>
    </div>
    <div class="cfg-body" data-ai-id="ai-ID.cfg.body">
      <div class="cfg-pane on" id="c-dzialy" data-ai-id="ai-ID.cfg.pane.dzialy">
        <div class="cfg-sec"><div class="cfg-sec-t">üè¢ Aktywne dzia≈Çy</div>
          <p style="font-size:.96rem;color:var(--txt2);margin-bottom:9px">Wyb√≥r filtruje dane we wszystkich modu≈Çach:</p>
          <div class="dz-pills" data-ai-id="ai-ID.cfg.dzialy-pills"><div class="dz-pill on" onclick="toggleDzial('all')" id="dp-all">Wszystkie</div><div class="dz-pill" onclick="toggleDzial('1')" id="dp-1">Dzia≈Ç EFS I</div><div class="dz-pill" onclick="toggleDzial('2')" id="dp-2">Dzia≈Ç EFS II</div><div class="dz-pill" onclick="toggleDzial('3')" id="dp-3">Dzia≈Ç EFS III</div></div>
        </div>
      </div>
      <div class="cfg-pane" id="c-parametry" data-ai-id="ai-ID.cfg.pane.parametry">
        <div class="cfg-sec"><div class="cfg-sec-t">üìà Postƒôp finansowy</div>
          <select class="cfg-sel" id="cfg-postep-od" data-ai-id="ai-ID.cfg.param.postep-od" style="margin-bottom:10px" onchange="cfgChange()"><option value="projekt">Od daty rozpoczƒôcia projektu</option><option value="umowa">Od daty podpisania umowy</option></select>
          <div class="cfg-row"><label>Pr√≥g op√≥≈∫nienia (pp):</label><input type="number" class="cfg-num" id="cfg-opozn" data-ai-id="ai-ID.cfg.param.opozn" value="20" min="5" max="50" onchange="cfgChange()"></div>
        </div>
        <div class="cfg-sec"><div class="cfg-sec-t">‚è± Terminy weryfikacji WNP</div>
          <div class="cfg-row"><label>I wersja wniosku (dni rob.):</label><input type="number" class="cfg-num" id="cfg-d1" data-ai-id="ai-ID.cfg.param.d1" value="20" onchange="cfgChange()"></div>
          <div class="cfg-row"><label>Kolejna wersja (dni rob.):</label><input type="number" class="cfg-num" id="cfg-dn" data-ai-id="ai-ID.cfg.param.dn" value="15" onchange="cfgChange()"></div>
          <div class="cfg-row"><label>Termin poprawki (dni rob.):</label><input type="number" class="cfg-num" id="cfg-dp" data-ai-id="ai-ID.cfg.param.dp" value="5" onchange="cfgChange()"></div>
        </div>
      </div>
      <div class="cfg-pane" id="c-arpk-cfg" data-ai-id="ai-ID.cfg.pane.arpk">
        <div class="cfg-info">‚öô Edytuj wagi kategorii ryzyka aRPK. Zmiana istotno≈õci dynamicznie przelicza scoring wszystkich projekt√≥w. Suma maksymalnych wag oryg.: 105 pkt.</div>
        <div class="arpk-cat-list" id="arpk-cat-editor" data-ai-id="ai-ID.cfg.arpk.editor"></div>
      </div>
    </div>
    <div class="cfg-ftr" data-ai-id="ai-ID.cfg.footer"><button class="btn" style="width:100%" onclick="applyConfig()">‚úì Zastosuj i zamknij</button></div>
  </div>
<!-- ==================== KONIEC: TOPBAR + KONFIGURACJA ==================== -->

</div>

<!-- ==================== SEKCJA 4: NAWIGACJA BOCZNA (Sidebar) ==================== -->
<div class="wrap">
<nav class="sidebar" data-ai-id="ai-ID.sidebar">
  <div class="sb-label">G≈Ç√≥wne</div>
  <div class="sb-item act" onclick="showPage('overview')" id="nav-overview"><span>‚äû</span>PrzeglƒÖd og√≥lny</div>
  <div class="sb-sep"></div>
  <div class="sb-label">Wnioski o p≈Çatno≈õƒá</div>
  <div class="sb-item" onclick="showPage('wer')" id="nav-wer"><span>‚óé</span>W weryfikacji<span class="sb-cnt" id="snav-wer">‚Äî</span></div>
  <div class="sb-item" onclick="showPage('pop')" id="nav-pop"><span>‚Ü©</span>W poprawie<span class="sb-cnt y" id="snav-pop">‚Äî</span></div>
  <div class="sb-item" onclick="showPage('zat')" id="nav-zat"><span>‚úì</span>Zatwierdzone<span class="sb-cnt g" id="snav-zat">‚Äî</span></div>
  <div class="sb-item" onclick="showPage('rozliczenie')" id="nav-rozliczenie"><span>üìä</span>Rozliczenie</div>
  <div class="sb-sep"></div>
  <div class="sb-label">Postƒôp projekt√≥w</div>
  <div class="sb-item" onclick="showPage('postep')" id="nav-postep"><span>‚ñ≤</span>Postƒôp finansowy</div>
  <div class="sb-item" onclick="showPage('rzeczowy')" id="nav-rzeczowy"><span>‚óÜ</span>Postƒôp rzeczowy</div>
  <div class="sb-sep"></div>
  <div class="sb-label">Harmonogramy</div>
  <div class="sb-item" onclick="showPage('hp')" id="nav-hp"><span>‚ñ¶</span>Harmonogramy<span class="sb-cnt b" id="snav-hp">‚Äî</span></div>
  <div class="sb-sep"></div>
  <div class="sb-label">Roczny Plan Kontroli</div>
  <div class="sb-item" onclick="showPage('rpk')" id="nav-rpk"><span>‚¨°</span>Wnioski o p≈Çatno≈õƒá</div>
  <div class="sb-item" onclick="showPage('arpk')" id="nav-arpk"><span>‚ö†</span>Analiza ryzyka aRPK</div>
  <div class="sb-item" onclick="showPage('metryki')" id="nav-metryki"><span>üìã</span>Metryki projekt√≥w</div>
  <div class="sb-sep"></div>
  <div class="sb-label">Zesp√≥≈Ç</div>
  <div class="sb-item" onclick="showPage('opiekuni')" id="nav-opiekuni"><span>‚óâ</span>Opiekunowie</div>
  <div class="sb-item" onclick="showPage('obciazenie')" id="nav-obciazenie"><span>üìä</span>ObciƒÖ≈ºenie</div>
  <div class="sb-item" onclick="showPage('wykaz-proj')" id="nav-wykaz-proj"><span>üìã</span>Wykaz projekt√≥w</div>
  <div class="sb-sep"></div>
  <div class="sb-label">Dane</div>
  <div class="sb-item" onclick="showPage('import')" id="nav-import"><span>‚¨Ü</span>Wczytaj dane</div>
<!-- ==================== KONIEC: NAWIGACJA BOCZNA ==================== -->

</nav>

<!-- ==================== SEKCJA 5: STRONY ‚Äî ZAWARTO≈öƒÜ HTML ==================== -->
<main class="main">

<!-- ===== [M01] PRZEGLƒÑD OG√ìLNY | id=page-overview | linie ~430-446 ===== -->
<!-- OVERVIEW -->
<div class="page on" id="page-overview" data-ai-id="ai-ID.page.overview">
  <div class="ph"><div><div class="ph-t"><div class="ph-icon">‚äû</div>PrzeglƒÖd og√≥lny</div><div class="ph-sub">Stan na <span id="ov-date"></span> ¬∑ <span id="ov-dzial">Wszystkie dzia≈Çy</span></div></div><div class="xbar"><button class="btn btn-out btn-sm" onclick="window.print()">‚Üì PDF</button></div></div>
  <div class="kgrid" id="kpi-ov" data-ai-id="ai-ID.overview.kpi-grid"></div>
  <div data-ai-id="ai-ID.overview.charts-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:11px;margin-bottom:14px">
    <div class="ccard" data-ai-id="ai-ID.overview.chart-status"><div class="ctitle">Zatwierdzone wydatki miesiƒôcznie</div><div style="overflow-x:auto"><div id="ch-st-inner" style="position:relative;height:185px"><canvas id="ch-st"></canvas></div></div></div>
    <div class="ccard" data-ai-id="ai-ID.overview.chart-monthly"><div class="ctitle">Zatwierdzone WNP miesiƒôcznie</div><div style="overflow-x:auto"><div id="ch-mies-inner" style="position:relative;height:185px"><canvas id="ch-mies"></canvas></div></div></div>
  </div>
  <div class="ph"><div><div class="ph-t"><div class="ph-icon">‚ö°</div>Projekty wymagajƒÖce dzia≈Çania</div><div class="ph-sub">Przekroczone i zbli≈ºajƒÖce siƒô terminy ¬∑ <span id="ov-alerts-counts" style="font-weight:500;color:var(--red);font-size:.85rem"></span></div></div></div>
  <div class="ccard" data-ai-id="ai-ID.overview.alerts-panel">
    <div id="ov-alerts" data-ai-id="ai-ID.overview.alerts-list"></div>
  </div>
  <!-- Tytu≈Ç sekcji: Aktualne zadania w Dzia≈Çach -->
  <div class="ph" style="margin-top:28px;margin-bottom:0">
    <div>
      <div class="ph-t"><div class="ph-icon">üìã</div>Aktualne zadania w Dzia≈Çach</div>
      <div class="ph-sub">Lista spraw, kt√≥re aktualnie realizowane sƒÖ w poszczeg√≥lnych dzia≈Çach</div>
    </div>
  </div>
  <!-- Lista projekt√≥w wg Dzia≈Çu EFS -->
  <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-top:20px;">
    <div style="background:var(--card);border:1px solid var(--brd);border-radius:10px;padding:14px 14px 10px;border-top:3px solid var(--acc)">
      <div style="font-size:.82rem;font-weight:800;color:var(--acc);margin-bottom:11px;display:flex;align-items:center;gap:7px;text-transform:uppercase;letter-spacing:.06em"><span style="width:10px;height:10px;border-radius:50%;background:var(--acc);display:inline-block"></span>Dzia≈Ç EFS I<span id="dz1-cnt" style="margin-left:auto;font-size:.72rem;background:var(--acc)22;color:var(--acc);border-radius:9px;padding:2px 9px;font-weight:700"></span></div>
      <div id="proj-list-efsi" style="font-size:.8rem;line-height:1.45;color:var(--txt2);overflow-y:auto;padding-right:2px;"></div>
    </div>
    <div style="background:var(--card);border:1px solid var(--brd);border-radius:10px;padding:14px 14px 10px;border-top:3px solid var(--acc2)">
      <div style="font-size:.82rem;font-weight:800;color:var(--acc2);margin-bottom:11px;display:flex;align-items:center;gap:7px;text-transform:uppercase;letter-spacing:.06em"><span style="width:10px;height:10px;border-radius:50%;background:var(--acc2);display:inline-block"></span>Dzia≈Ç EFS II<span id="dz2-cnt" style="margin-left:auto;font-size:.72rem;background:var(--acc2)22;color:var(--acc2);border-radius:9px;padding:2px 9px;font-weight:700"></span></div>
      <div id="proj-list-efsi2" style="font-size:.8rem;line-height:1.45;color:var(--txt2);overflow-y:auto;padding-right:2px;"></div>
    </div>
    <div style="background:var(--card);border:1px solid var(--brd);border-radius:10px;padding:14px 14px 10px;border-top:3px solid var(--acc3)">
      <div style="font-size:.82rem;font-weight:800;color:var(--acc3);margin-bottom:11px;display:flex;align-items:center;gap:7px;text-transform:uppercase;letter-spacing:.06em"><span style="width:10px;height:10px;border-radius:50%;background:var(--acc3);display:inline-block"></span>Dzia≈Ç EFS III<span id="dz3-cnt" style="margin-left:auto;font-size:.72rem;background:var(--acc3)22;color:var(--acc3);border-radius:9px;padding:2px 9px;font-weight:700"></span></div>
      <div id="proj-list-efsi3" style="font-size:.8rem;line-height:1.45;color:var(--txt2);overflow-y:auto;padding-right:2px;"></div>
    </div>
  </div>

</div>

<!-- ===== [M02] W WERYFIKACJI | id=page-wer | linie ~447-470 ===== -->
<!-- ===== KONIEC [M01] PRZEGLƒÑD OG√ìLNY ===== -->

<!-- W WERYFIKACJI -->
<div class="page" id="page-wer" data-ai-id="ai-ID.page.wer">
  <div class="ph"><div><div class="ph-t"><div class="ph-icon">‚óé</div>Wnioski w bie≈ºƒÖcej weryfikacji</div><div class="ph-sub">Statusy: Z≈Ço≈ºony, W trakcie weryfikacji ¬∑ Terminy wg konfiguracji ¬∑ Scoring aRPK</div></div><div class="xbar"><button class="btn btn-out btn-sm" onclick="exportCSV('wer')">‚Üì CSV</button><button class="btn btn-out btn-sm" onclick="exportXLSX('wer')">‚Üì XLSX</button><button class="btn btn-out btn-sm" onclick="exportPDF('wer')">‚Üì PDF</button></div></div>
  <div class="fbar" data-ai-id="ai-ID.wer.filterbar"><span class="flbl">Dzia≈Ç:</span><select id="fw-dz" onchange="werDzialChange()" style="min-width:130px"><option value="">Wszystkie</option><option value="1">Dzia≈Ç EFS I</option><option value="2">Dzia≈Ç EFS II</option><option value="3">Dzia≈Ç EFS III</option></select><span class="flbl">Szukaj:</span><input id="fw-s" placeholder="Nr projektu / beneficjent‚Ä¶" style="width:225px" oninput="renderWer()"><span class="flbl">Opiekun:</span><select id="fw-op" onchange="renderWer()"><option value="">Wszyscy opiekunowie</option></select><span class="flbl">Status:</span><select id="fw-st" onchange="renderWer()"><option value="">Wszystkie</option><option>Z≈Ço≈ºony</option><option>W trakcie weryfikacji</option></select><span class="flbl">Termin:</span><select id="fw-term" onchange="renderWer()"><option value="">Wszystkie</option><option value="ok">W terminie</option><option value="late">Przekroczony</option></select><span class="flbl">aRPK:</span><select id="fw-arpk" onchange="renderWer()"><option value="">Wszystkie</option><option value="niskie">Niskie</option><option value="srednie">≈örednie</option><option value="wysokie">Wysokie</option><option value="krytyczne">Krytyczne</option></select></div>
  <div class="kgrid" id="kpi-wer" data-ai-id="ai-ID.wer.kpi-grid"></div>
  <div class="twrap" data-ai-id="ai-ID.wer.table-wrap"><div class="ttb"><span class="t-info" id="info-wer">‚Äî</span></div><div class="of"><table class="tbl" id="tbl-wer" data-ai-id="ai-ID.wer.table"><thead><tr>
    <th style="cursor:pointer;user-select:none" onclick="sortWer('nr_proj')">Numer projektu <span id="sw-nr_proj"></span></th>
    <th style="cursor:pointer;user-select:none" onclick="sortWer('beneficjent')">Beneficjent <span id="sw-beneficjent"></span></th>
    <th style="cursor:pointer;user-select:none;min-width:200px" onclick="sortWer('nr_wn')">Numer wniosku <span id="sw-nr_wn"></span></th>
    <th style="cursor:pointer;user-select:none" onclick="sortWer('ver')">Wersja <span id="sw-ver"></span></th>
    <th style="cursor:pointer;user-select:none" onclick="sortWer('status')">Status <span id="sw-status"></span></th>
    <th style="cursor:pointer;user-select:none" onclick="sortWer('data_zloz')">Z≈Ço≈ºony <span id="sw-data_zloz"></span></th>
    <th>Termin</th>
    <th style="cursor:pointer;user-select:none" onclick="sortWer('_wd')">Dni roboczych <span id="sw-_wd"></span></th>
    <th class="nr" style="cursor:pointer;user-select:none" onclick="sortWer('zaliczka')">Zaliczka <span id="sw-zaliczka"></span></th>
    <th class="nr" style="cursor:pointer;user-select:none" onclick="sortWer('refundacja')">Refundacja <span id="sw-refundacja"></span></th>
    <th class="nr" style="cursor:pointer;user-select:none" onclick="sortWer('wyd_kwal')">Wydatki kwalifikowane <span id="sw-wyd_kwal"></span></th>
    <th class="nr" style="cursor:pointer;user-select:none" onclick="sortWer('dofinansowanie')">Dofinansowanie <span id="sw-dofinansowanie"></span></th>
    <th class="nr" style="cursor:pointer;user-select:none" onclick="sortWer('wklad_wlasny')">Wk≈Çad w≈Çasny <span id="sw-wklad_wlasny"></span></th>
    <th style="cursor:pointer;user-select:none" onclick="sortWer('opiekun')">Opiekun <span id="sw-opiekun"></span></th>
    <th style="cursor:pointer;user-select:none" onclick="sortWer('_arpk')">Ryzyko aRPK <span id="sw-_arpk"></span></th>
  </tr></thead><tbody id="tb-wer" data-ai-id="ai-ID.wer.tbody"></tbody></table></div><div class="pager" id="pg-wer" data-ai-id="ai-ID.wer.pager"></div></div>
</div>

<!-- ===== [M03] W POPRAWIE | id=page-pop | linie ~471-494 ===== -->
<!-- ===== KONIEC [M02] W WERYFIKACJI ===== -->

<!-- W POPRAWIE -->
<div class="page" id="page-pop" data-ai-id="ai-ID.page.pop">
  <div class="ph"><div><div class="ph-t"><div class="ph-icon">‚Ü©</div>Wnioski w poprawie</div><div class="ph-sub">Statusy: Do poprawy, Poprawiany ¬∑ Limit: <span id="pop-lim">5</span> dni rob.</div></div><div class="xbar"><button class="btn btn-out btn-sm" onclick="exportCSV('pop')">‚Üì CSV</button><button class="btn btn-out btn-sm" onclick="exportXLSX('pop')">‚Üì XLSX</button><button class="btn btn-out btn-sm" onclick="exportPDF('pop')">‚Üì PDF</button></div></div>
  <div class="fbar" data-ai-id="ai-ID.pop.filterbar"><span class="flbl">Dzia≈Ç:</span><select id="fp-dz" onchange="popDzialChange()" style="min-width:130px"><option value="">Wszystkie</option><option value="1">Dzia≈Ç EFS I</option><option value="2">Dzia≈Ç EFS II</option><option value="3">Dzia≈Ç EFS III</option></select><input id="fp-s" placeholder="Szukaj‚Ä¶" style="width:200px" oninput="renderPop()"><span class="flbl">Opiekun:</span><select id="fp-op" onchange="renderPop()"><option value="">Wszyscy opiekunowie</option></select><select id="fp-fl" onchange="renderPop()"><option value="">Wszystkie</option><option value="ok">W terminie</option><option value="late">Przeterminowane</option></select></div>
  <div class="kgrid" id="kpi-pop" data-ai-id="ai-ID.pop.kpi-grid"></div>
  <div class="twrap" data-ai-id="ai-ID.pop.table-wrap"><div class="ttb"><span class="t-info" id="info-pop">‚Äî</span></div><div class="of"><table class="tbl" data-ai-id="ai-ID.pop.table"><thead><tr>
    <th style="cursor:pointer;user-select:none" onclick="sortPop('nr_proj')">Numer projektu <span id="sp-nr_proj"></span></th>
    <th style="cursor:pointer;user-select:none" onclick="sortPop('beneficjent')">Beneficjent <span id="sp-beneficjent"></span></th>
    <th style="cursor:pointer;user-select:none;min-width:200px" onclick="sortPop('nr_wn')">Numer wniosku <span id="sp-nr_wn"></span></th>
    <th style="cursor:pointer;user-select:none" onclick="sortPop('ver')">Wersja <span id="sp-ver"></span></th>
    <th style="cursor:pointer;user-select:none" onclick="sortPop('status')">Status <span id="sp-status"></span></th>
    <th style="cursor:pointer;user-select:none" onclick="sortPop('data_zloz')">Z≈Ço≈ºony <span id="sp-data_zloz"></span></th>
    <th style="cursor:pointer;user-select:none" onclick="sortPop('wd')">Dni roboczych <span id="sp-wd"></span></th>
    <th>Ocena</th>
    <th class="nr" style="cursor:pointer;user-select:none" onclick="sortPop('zaliczka')">Zaliczka <span id="sp-zaliczka"></span></th>
    <th class="nr" style="cursor:pointer;user-select:none" onclick="sortPop('refundacja')">Refundacja <span id="sp-refundacja"></span></th>
    <th class="nr" style="cursor:pointer;user-select:none" onclick="sortPop('wyd_kwal')">Wydatki kwalifikowane <span id="sp-wyd_kwal"></span></th>
    <th class="nr" style="cursor:pointer;user-select:none" onclick="sortPop('dofinansowanie')">Dofinansowanie <span id="sp-dofinansowanie"></span></th>
    <th class="nr" style="cursor:pointer;user-select:none" onclick="sortPop('wklad_wlasny')">Wk≈Çad w≈Çasny <span id="sp-wklad_wlasny"></span></th>
    <th style="cursor:pointer;user-select:none" onclick="sortPop('opiekun')">Opiekun <span id="sp-opiekun"></span></th>
    <th style="cursor:pointer;user-select:none" onclick="sortPop('_arpk')">Ryzyko aRPK <span id="sp-_arpk"></span></th>
  </tr></thead><tbody id="tb-pop" data-ai-id="ai-ID.pop.tbody"></tbody></table></div><div class="pager" id="pg-pop" data-ai-id="ai-ID.pop.pager"></div></div>
</div>

<!-- ===== [M04] ZATWIERDZONE WNP | id=page-zat | linie ~495-517 ===== -->
<!-- ===== KONIEC [M03] W POPRAWIE ===== -->

<!-- ZATWIERDZONE -->
<div class="page" id="page-zat" data-ai-id="ai-ID.page.zat">
  <div class="ph"><div><div class="ph-t"><div class="ph-icon">‚úì</div>Zatwierdzone wnioski o p≈Çatno≈õƒá</div><div class="ph-sub">Dynamiczny wyb√≥r okresu ¬∑ Pe≈Çne dane finansowe</div></div><div class="xbar"><button class="btn btn-out btn-sm" onclick="exportCSV('zat')">‚Üì CSV</button><button class="btn btn-out btn-sm" onclick="exportXLSX('zat')">‚Üì XLSX</button><button class="btn btn-out btn-sm" onclick="exportPDF('zat')">‚Üì PDF</button></div></div>
  <div id="mpills-zat" class="mpills" data-ai-id="ai-ID.zat.month-pills"></div>
  <div class="fbar" data-ai-id="ai-ID.zat.filterbar"><span class="flbl">Dzia≈Ç:</span><select id="fz-dz" onchange="zatDzialChange()" style="min-width:130px"><option value="">Wszystkie</option><option value="1">Dzia≈Ç EFS I</option><option value="2">Dzia≈Ç EFS II</option><option value="3">Dzia≈Ç EFS III</option></select><input id="fz-s" placeholder="Nr projektu / beneficjent‚Ä¶" style="width:215px" oninput="renderZat()"><span class="flbl">Opiekun:</span><select id="fz-op" onchange="renderZat()"><option value="">Wszyscy opiekunowie</option></select></div>
  <div class="kgrid" id="kpi-zat" data-ai-id="ai-ID.zat.kpi-grid"></div>
  <div class="twrap" data-ai-id="ai-ID.zat.table-wrap"><div class="ttb"><span class="t-info" id="info-zat">‚Äî</span></div><div class="of"><table class="tbl" data-ai-id="ai-ID.zat.table"><thead><tr>
    <th style="cursor:pointer;user-select:none" onclick="sortZat('nr_proj')">Numer projektu <span id="sz-nr_proj"></span></th>
    <th style="cursor:pointer;user-select:none" onclick="sortZat('beneficjent')">Beneficjent <span id="sz-beneficjent"></span></th>
    <th style="cursor:pointer;user-select:none;min-width:200px" onclick="sortZat('nr_wn')">Numer wniosku <span id="sz-nr_wn"></span></th>
    <th style="cursor:pointer;user-select:none" onclick="sortZat('ver')">Wersja <span id="sz-ver"></span></th>
    <th style="cursor:pointer;user-select:none" onclick="sortZat('data_wplywu')">Data wp≈Çywu <span id="sz-data_wplywu"></span></th>
    <th style="cursor:pointer;user-select:none" onclick="sortZat('data_zatw')">Data zatwierdzenia <span id="sz-data_zatw"></span></th>
    <th style="cursor:pointer;user-select:none" onclick="sortZat('korekty')">Korekty <span id="sz-korekty"></span></th>
    <th class="nr" style="cursor:pointer;user-select:none" onclick="sortZat('wyd_kwal')">Wydatki kwalifikowalne <span id="sz-wyd_kwal"></span></th>
    <th class="nr" style="cursor:pointer;user-select:none" onclick="sortZat('wyd_uznane')">Wydatki zatwierdzone <span id="sz-wyd_uznane"></span></th>
    <th class="nr" style="cursor:pointer;user-select:none" onclick="sortZat('dofinansowanie')">Dofinansowanie <span id="sz-dofinansowanie"></span></th>
    <th class="nr" style="cursor:pointer;user-select:none" onclick="sortZat('zaliczka')">Zaliczka <span id="sz-zaliczka"></span></th>
    <th class="nr" style="cursor:pointer;user-select:none" onclick="sortZat('refundacja')">Refundacja <span id="sz-refundacja"></span></th>
    <th style="cursor:pointer;user-select:none" onclick="sortZat('opiekun')">Opiekun <span id="sz-opiekun"></span></th>
    <th>Dzia≈Ç</th>
  </tr></thead><tbody id="tb-zat" data-ai-id="ai-ID.zat.tbody"></tbody></table></div><div class="pager" id="pg-zat" data-ai-id="ai-ID.zat.pager"></div></div>
</div>

<!-- ===== [M05] ROZLICZENIE PROJEKTU | id=page-rozliczenie | linie ~518-545 ===== -->
<!-- ===== KONIEC [M04] ZATWIERDZONE WNP ===== -->

<!-- ROZLICZENIE -->
<div class="page" id="page-rozliczenie" data-ai-id="ai-ID.page.rozliczenie">
  <div class="ph"><div><div class="ph-t"><div class="ph-icon">üìä</div>Rozliczenie projektu</div><div class="ph-sub">Dane umowy ¬∑ Realizacja finansowa ¬∑ Wykaz wszystkich wniosk√≥w o p≈Çatno≈õƒá</div></div></div>
  <div class="fbar" data-ai-id="ai-ID.rozliczenie.filterbar">
    <span class="flbl">Szukaj:</span>
    <input id="froz-s" placeholder="Nr projektu lub beneficjent‚Ä¶" style="width:260px;min-width:200px" oninput="renderRozGrid()">
    <span class="flbl" style="margin-left:4px">Dzia≈Ç:</span>
    <select id="froz-dz" onchange="renderRozGrid()" style="min-width:130px">
      <option value="">Wszystkie</option>
      <option value="1">Dzia≈Ç EFS I</option>
      <option value="2">Dzia≈Ç EFS II</option>
      <option value="3">Dzia≈Ç EFS III</option>
    </select>
    <span class="flbl" style="margin-left:4px">Rozliczenie:</span>
    <select id="froz-fl" onchange="renderRozGrid()" style="min-width:130px">
      <option value="">Wszystkie</option>
      <option value="low">Poni≈ºej 25%</option>
      <option value="mid">25‚Äì75%</option>
      <option value="high">Powy≈ºej 75%</option>
    </select>
    <span class="t-info" id="roz-cnt" style="margin-left:auto">‚Äî</span>
  </div>
  <!-- Siatka kafelk√≥w projekt√≥w -->
  <div id="roz-grid" data-ai-id="ai-ID.rozliczenie.grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(310px,1fr));gap:10px;margin-bottom:16px"></div>
  <!-- Szczeg√≥≈Çy wybranego projektu -->
  <div id="roz-content" data-ai-id="ai-ID.rozliczenie.content"></div>
</div>

<!-- ===== [M06] WNIOSKI RPK | id=page-rpk | linie ~546-564 ===== -->
<!-- ===== KONIEC [M05] ROZLICZENIE PROJEKTU ===== -->

<!-- RPK (Roczny Plan Kontroli) -->
<div class="page" id="page-rpk" data-ai-id="ai-ID.page.rpk">
  <div class="ph"><div><div class="ph-t"><div class="ph-icon">‚¨°</div>Wnioski o p≈Çatno≈õƒá ‚Äî RPK</div><div class="ph-sub">Wydatki I wersja vs wersja ostatnia ¬∑ Odchylenia ¬∑ Scoring aRPK</div></div><div class="xbar"><button class="btn btn-out btn-sm" onclick="exportCSV('rpk')">‚Üì CSV</button><button class="btn btn-out btn-sm" onclick="exportXLSX('rpk')">‚Üì XLSX</button><button class="btn btn-out btn-sm" onclick="exportPDF('rpk')">‚Üì PDF</button></div></div>
  <div class="fbar" data-ai-id="ai-ID.rpk.filterbar"><span class="flbl">Dzia≈Ç:</span><select id="fr-dz" onchange="renderRpk()" style="min-width:130px"><option value="">Wszystkie</option><option value="1">Dzia≈Ç EFS I</option><option value="2">Dzia≈Ç EFS II</option><option value="3">Dzia≈Ç EFS III</option></select><input id="fr-s" placeholder="Szukaj projektu‚Ä¶" style="width:200px" oninput="renderRpk()"><select id="fr-op" onchange="renderRpk()"><option value="">Wszyscy opiekunowie</option></select><select id="fr-fl" onchange="renderRpk()"><option value="">Wszystkie</option><option value="kor">Z korektƒÖ</option><option value="bez">Bez korekty</option></select></div>
  <div class="kgrid" id="kpi-rpk" data-ai-id="ai-ID.rpk.kpi-grid"></div>
  <div class="twrap" data-ai-id="ai-ID.rpk.table-wrap"><div class="ttb"><span class="t-info" id="info-rpk">‚Äî</span></div><div class="of"><table class="tbl" data-ai-id="ai-ID.rpk.table"><thead><tr>
    <th style="cursor:pointer;user-select:none" onclick="sortRpk('nr_proj')">Numer projektu <span id="srp-nr_proj"></span></th>
    <th style="cursor:pointer;user-select:none" onclick="sortRpk('beneficjent')">Beneficjent <span id="srp-beneficjent"></span></th>
    <th>Nr wniosku (baza)</th>
    <th>Wersji</th>
    <th class="nr" style="cursor:pointer;user-select:none" onclick="sortRpk('wyd_v1')">Wyd.kwal. v1 <span id="srp-wyd_v1"></span></th>
    <th class="nr" style="cursor:pointer;user-select:none" onclick="sortRpk('wyd_vl')">Wyd.kwal. ostatnia <span id="srp-wyd_vl"></span></th>
    <th class="nr" style="cursor:pointer;user-select:none" onclick="sortRpk('diff')">R√≥≈ºnica <span id="srp-diff"></span></th>
    <th>R√≥≈ºnica %</th>
    <th style="cursor:pointer;user-select:none" onclick="sortRpk('opiekun')">Opiekun <span id="srp-opiekun"></span></th>
    <th>Ryzyko aRPK</th>
  </tr></thead><tbody id="tb-rpk" data-ai-id="ai-ID.rpk.tbody"></tbody></table></div><div class="pager" id="pg-rpk" data-ai-id="ai-ID.rpk.pager"></div></div>
</div>

<!-- ===== [M07] POSTƒòP FINANSOWY | id=page-postep | linie ~565-573 ===== -->
<!-- ===== KONIEC [M06] WNIOSKI RPK ===== -->

<!-- POSTEP FINANSOWY -->
<div class="page" id="page-postep" data-ai-id="ai-ID.page.postep">
  <div class="ph"><div><div class="ph-t"><div class="ph-icon">‚ñ≤</div>Postƒôp finansowy projekt√≥w</div><div class="ph-sub">Podstawa: <span id="postep-od-lbl">‚Äî</span> ¬∑ Rycza≈Çtowe wy≈ÇƒÖczone ¬∑ Kliknij projekt ‚Üí zadania</div></div><div class="xbar"><button class="btn btn-out btn-sm" onclick="window.print()">‚Üì PDF</button></div></div>
  <div class="fbar" data-ai-id="ai-ID.postep.filterbar"><span class="flbl">Dzia≈Ç:</span><select id="fpost-dz" onchange="renderPostep()" style="min-width:105px"><option value="">Wszystkie</option><option value="1">EFS I</option><option value="2">EFS II</option><option value="3">EFS III</option></select><input id="fpost-s" placeholder="Nr projektu / beneficjent‚Ä¶" style="width:200px" oninput="renderPostep()"><select id="fpost-fl" onchange="renderPostep()"><option value="">Wszystkie</option><option value="late">Op√≥≈∫nione</option><option value="ok">Terminowe</option></select><select id="fpost-op" onchange="renderPostep()"><option value="">Wszyscy opiekunowie</option></select></div>
  <div class="kgrid" id="kpi-postep" data-ai-id="ai-ID.postep.kpi-grid"></div>
  <div id="postep-list" data-ai-id="ai-ID.postep.cards-list"></div>
  <div class="pager" id="pg-postep" data-ai-id="ai-ID.postep.pager"></div>
</div>

<!-- ===== [M08] POSTƒòP RZECZOWY | id=page-rzeczowy | linie ~574-582 ===== -->
<!-- ===== KONIEC [M07] POSTƒòP FINANSOWY ===== -->

<!-- POSTEP RZECZOWY -->
<div class="page" id="page-rzeczowy" data-ai-id="ai-ID.page.rzeczowy">
  <div class="ph"><div><div class="ph-t"><div class="ph-icon">‚óÜ</div>Postƒôp rzeczowy projekt√≥w</div><div class="ph-sub">Wska≈∫niki produktu (aRPK) ¬∑ Wska≈∫niki rezultatu (informacyjnie) ¬∑ 211 projekt√≥w z danymi</div></div><div class="xbar"><button class="btn btn-out btn-sm" onclick="window.print()">‚Üì PDF</button></div></div>
  <div class="fbar" data-ai-id="ai-ID.rzeczowy.filterbar"><span class="flbl">Dzia≈Ç:</span><select id="frz-dz" onchange="renderRzeczowy()" style="min-width:105px"><option value="">Wszystkie</option><option value="1">EFS I</option><option value="2">EFS II</option><option value="3">EFS III</option></select><input id="frz-s" placeholder="Nr projektu / beneficjent‚Ä¶" style="width:200px" oninput="renderRzeczowy()"><select id="frz-op" onchange="renderRzeczowy()"><option value="">Wszyscy opiekunowie</option></select><select id="frz-fl" onchange="renderRzeczowy()"><option value="">Wszystkie</option><option value="high">Wysoka realizacja ‚â•70%</option><option value="med">≈örednia 30-70%</option><option value="low">Niska ‚â§30%</option><option value="fin">Zako≈Ñczone</option></select><span class="flbl">Wska≈∫niki:</span><select id="frz-wsk" onchange="renderRzeczowy()"><option value="">Wszystkie</option><option value="P">Produktu</option><option value="R">Rezultatu</option></select></div>
  <div class="kgrid" id="kpi-rzeczowy" data-ai-id="ai-ID.rzeczowy.kpi-grid"></div>
  <div id="rzeczowy-list" data-ai-id="ai-ID.rzeczowy.cards-list"></div>
  <div class="pager" id="pg-rzeczowy" data-ai-id="ai-ID.rzeczowy.pager"></div>
</div>

<!-- ===== [M09] HARMONOGRAMY P≈ÅATNO≈öCI | id=page-hp | linie ~583-601 ===== -->
<!-- ===== KONIEC [M08] POSTƒòP RZECZOWY ===== -->

<!-- HARMONOGRAMY -->
<div class="page" id="page-hp" data-ai-id="ai-ID.page.hp">
  <div class="ph"><div><div class="ph-t"><div class="ph-icon">‚ñ¶</div>Harmonogramy p≈Çatno≈õci</div><div class="ph-sub">HP w weryfikacji (max 5 dni rob.) ¬∑ Zatwierdzone ¬∑ Symulacja termin√≥w</div></div></div>
  <div class="tabs"><div class="tab on" onclick="showHpTab(this,'h-wer')">W weryfikacji</div><div class="tab" onclick="showHpTab(this,'h-zat')">Zatwierdzone</div><div class="tab" onclick="showHpTab(this,'h-sim')">Symulacja</div></div>
  <div id="h-wer" data-ai-id="ai-ID.hp.wer-section">
    <div class="kgrid" id="kpi-hwer" data-ai-id="ai-ID.hp.wer.kpi-grid"></div>
    <div class="twrap" data-ai-id="ai-ID.hp.wer.table-wrap"><div class="ttb"><input id="fhw-s" placeholder="Szukaj‚Ä¶" style="width:180px" oninput="renderHWer()"><span class="flbl" style="margin-left:4px">Dzia≈Ç:</span><select id="fhw-dz" onchange="renderHWer()" style="min-width:105px"><option value="">Wszystkie</option><option value="1">EFS I</option><option value="2">EFS II</option><option value="3">EFS III</option></select><span class="t-info" id="info-hwer">‚Äî</span></div><div class="of"><table class="tbl" data-ai-id="ai-ID.hp.wer.table"><thead><tr><th>Nr projektu</th><th>Beneficjent</th><th>Wersja HP</th><th>Status</th><th>Data przes≈Çania</th><th>Dni roboczych</th><th class="nr">Wyd.kwal.</th><th class="nr">Zaliczka</th><th class="nr">Refundacja</th></tr></thead><tbody id="tb-hwer" data-ai-id="ai-ID.hp.wer.tbody"></tbody></table></div><div class="pager" id="pg-hwer" data-ai-id="ai-ID.hp.wer.pager"></div></div>
  </div>
  <div id="h-zat" class="hidden" data-ai-id="ai-ID.hp.zat-section">
    <div class="kgrid" id="kpi-hzat" data-ai-id="ai-ID.hp.zat.kpi-grid"></div>
    <div class="twrap" data-ai-id="ai-ID.hp.zat.table-wrap"><div class="ttb"><input id="fhz-s" placeholder="Szukaj‚Ä¶" style="width:180px" oninput="renderHZat()"><span class="flbl" style="margin-left:4px">Dzia≈Ç:</span><select id="fhz-dz" onchange="renderHZat()" style="min-width:105px"><option value="">Wszystkie</option><option value="1">EFS I</option><option value="2">EFS II</option><option value="3">EFS III</option></select><span class="t-info" id="info-hzat">‚Äî</span></div><div class="of"><table class="tbl" data-ai-id="ai-ID.hp.zat.table"><thead><tr><th>Nr projektu</th><th>Beneficjent</th><th>Wersja HP</th><th>Data przes≈Çania</th><th>Data zatwierdzenia</th><th class="nr">Wyd.kwal.</th><th class="nr">Zaliczka</th><th class="nr">Refundacja</th></tr></thead><tbody id="tb-hzat" data-ai-id="ai-ID.hp.zat.tbody"></tbody></table></div><div class="pager" id="pg-hzat" data-ai-id="ai-ID.hp.zat.pager"></div></div>
  </div>
  <div id="h-sim" class="hidden" data-ai-id="ai-ID.hp.sim-section">
    <div class="alert ai">‚Ñπ Symulacja estymuje terminy przysz≈Çych WNP na podstawie historycznych odstƒôp√≥w miƒôdzy zatwierdzeniami.</div>
    <div class="fbar" data-ai-id="ai-ID.hp.sim.filterbar"><span class="flbl">Projekt:</span><select id="sim-proj" data-ai-id="ai-ID.hp.sim.projekt-selector" onchange="runSim()" style="min-width:340px"></select></div>
    <div id="sim-out" data-ai-id="ai-ID.hp.sim.output"></div>
  </div>
</div>

<!-- ===== [M10] OPIEKUNOWIE PROJEKT√ìW | id=page-opiekuni | linie ~602-613 ===== -->
<!-- ===== KONIEC [M09] HARMONOGRAMY P≈ÅATNO≈öCI ===== -->

<!-- OPIEKUNOWIE -->
<div class="page" id="page-opiekuni" data-ai-id="ai-ID.page.opiekuni">
  <div class="ph"><div><div class="ph-t"><div class="ph-icon">‚óâ</div>Opiekunowie projekt√≥w</div><div class="ph-sub">Statystyki, portfolio projekt√≥w i ocena efektywno≈õci</div></div></div>
  <div class="fbar" data-ai-id="ai-ID.opiekuni.filterbar"><span class="flbl">Dzia≈Ç:</span><select id="fop-dz" onchange="buildOpGrid()" style="min-width:105px"><option value="">Wszystkie</option><option value="1">EFS I</option><option value="2">EFS II</option><option value="3">EFS III</option></select><input id="fop-s" placeholder="Szukaj opiekuna‚Ä¶" style="width:180px" oninput="buildOpGrid()"></div>
  <div class="op-grid" id="op-grid" data-ai-id="ai-ID.opiekuni.cards-grid"></div>
  <div id="op-detail" class="hidden" data-ai-id="ai-ID.opiekuni.detail-panel">
    <div style="display:flex;align-items:center;gap:9px;margin-bottom:13px"><button class="btn btn-out btn-sm" onclick="closeOpDetail()">‚Üê Powr√≥t</button><div class="ph-t" id="op-det-name"></div><span id="op-det-dz" class="badge bb"></span></div>
    <div class="kgrid" id="kpi-op-det" data-ai-id="ai-ID.opiekuni.detail.kpi-grid"></div>
    <div class="twrap" data-ai-id="ai-ID.opiekuni.detail.table-wrap"><div class="ttb"><input id="fopd-s" placeholder="Szukaj projektu‚Ä¶" style="width:180px" oninput="renderOpProj()"><span class="t-info" id="info-opd">‚Äî</span></div><div class="of"><table class="tbl" data-ai-id="ai-ID.opiekuni.detail.table"><thead><tr><th>Nr projektu</th><th>Beneficjent</th><th class="nr">Bud≈ºet</th><th>Ostatni WNP</th><th>Status</th><th>Postƒôp finansowy</th><th>Postƒôp rzeczowy</th><th>Ryzyko aRPK</th></tr></thead><tbody id="tb-opd" data-ai-id="ai-ID.opiekuni.detail.tbody"></tbody></table></div><div class="pager" id="pg-opd" data-ai-id="ai-ID.opiekuni.detail.pager"></div></div>
  </div>
</div>


<!-- ===== [M10b] OBCIƒÑ≈ªENIE ZESPO≈ÅU | id=page-obciazenie ===== -->
<div class="page" id="page-obciazenie" data-ai-id="ai-ID.page.obciazenie">
  <div class="ph">
    <div>
      <div class="ph-t"><div class="ph-icon">üìä</div>ObciƒÖ≈ºenie zespo≈Çu</div>
      <div class="ph-sub">Projekty aktywne i ko≈ÑczƒÖce siƒô ¬∑ Rozk≈Çad na opiekun√≥w i dzia≈Çy</div>
    </div>
    <div class="xbar">
      <button class="btn btn-out btn-sm" onclick="exportCSV('obciazenie')">‚Üì CSV</button>
    </div>
  </div>

  <!-- Filtry globalne -->
  <div class="fbar" style="flex-wrap:wrap;gap:6px 12px;align-items:center">
    <span class="flbl">Dzia≈Ç:</span>
    <select id="fob-dz" onchange="renderObciazenie()" style="min-width:100px">
      <option value="">Wszystkie</option>
      <option value="1">EFS I</option>
      <option value="2">EFS II</option>
      <option value="3">EFS III</option>
    </select>
    <span class="flbl">Opiekun:</span>
    <select id="fob-op" onchange="renderObciazenie()" style="min-width:140px">
      <option value="">Wszyscy</option>
    </select>
    <div style="width:1px;height:20px;background:var(--brd);flex-shrink:0"></div>
    <span class="flbl">Bufor:</span>
    <select id="ob-bufor" onchange="renderObciazenie()" style="background:var(--bg2);border:1px solid var(--brd);color:var(--txt);border-radius:7px;padding:4px 8px;font-size:.8rem;font-family:var(--font);outline:none;font-weight:600">
      <option value="3">+3 mies.</option>
      <option value="4" selected>+4 mies.</option>
      <option value="6">+6 mies.</option>
      <option value="9">+9 mies.</option>
      <option value="12">+12 mies.</option>
    </select>
    <div style="width:1px;height:20px;background:var(--brd);flex-shrink:0"></div>
    <span class="flbl">Okres od:</span>
    <input type="month" id="fob-od" onchange="obPeriodChange()" style="background:var(--bg2);border:1px solid var(--brd);color:var(--txt);border-radius:7px;padding:4px 8px;font-size:.8rem;outline:none;font-family:var(--font);transition:border-color .1s;font-weight:500;min-width:122px">
    <span class="flbl">do:</span>
    <input type="month" id="fob-do" onchange="obPeriodChange()" style="background:var(--bg2);border:1px solid var(--brd);color:var(--txt);border-radius:7px;padding:4px 8px;font-size:.8rem;outline:none;font-family:var(--font);transition:border-color .1s;font-weight:500;min-width:122px">
    <div style="width:1px;height:20px;background:var(--brd);flex-shrink:0"></div>
    <span class="flbl">Granulacja:</span>
    <div style="display:flex;gap:3px">
      <button class="ob-vtab" id="fob-gran-mies" onclick="obSetGran('mies',this)">MiesiƒÖc</button>
      <button class="ob-vtab on" id="fob-gran-kw" onclick="obSetGran('kw',this)">Kwarta≈Ç</button>
      <button class="ob-vtab" id="fob-gran-pol" onclick="obSetGran('pol',this)">P√≥≈Çrocze</button>
    </div>
    <button class="btn-cfg" onclick="obResetPeriod()" style="font-size:.72rem;padding:4px 9px" title="Resetuj filtr okresu">&#x2715; Resetuj</button>
  </div>

  <!-- KPI row -->
  <div class="kgrid" id="ob-kpi" style="margin-bottom:14px"></div>

  <!-- ‚îÄ‚îÄ SUBMODU≈ÅY (zak≈Çadki) ‚îÄ‚îÄ -->
  <div style="display:flex;gap:0;border-bottom:2px solid var(--brd);margin-bottom:16px" id="ob-submenu">
    <button class="ob-stab on" id="ob-stab-dzialy"  onclick="obSubTab('dzialy',this)">üè¢ Dzia≈Çy</button>
    <button class="ob-stab"     id="ob-stab-opieku"  onclick="obSubTab('opieku',this)">üë§ Opiekunowie</button>
    <button class="ob-stab"     id="ob-stab-przeg"   onclick="obSubTab('przeg',this)">üìÖ PrzeglƒÖd okres√≥w</button>
    <button class="ob-stab"     id="ob-stab-baza"    onclick="obSubTab('baza',this)">üìã Baza projekt√≥w</button>
  </div>

  <!-- SUBMODU≈Å: PrzeglƒÖd okres√≥w -->
  <div id="ob-sub-przeg" class="ob-subpane">
    <div class="fbar" style="margin-bottom:12px">
      <span class="flbl">Granulacja:</span>
      <div style="display:flex;gap:4px">
        <button class="ob-vtab on" id="ob-v-kw"  onclick="obSetView('kw',this)">Kwarta≈Çy</button>
        <button class="ob-vtab"    id="ob-v-pol"  onclick="obSetView('pol',this)">P√≥≈Çrocza</button>
      </div>
    </div>
    <div id="ob-main"></div>
  </div>

  <!-- SUBMODU≈Å: Opiekunowie -->
  <div id="ob-sub-opieku" class="ob-subpane">
    <div id="ob-heat-op-wrap" style="margin-bottom:16px"></div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:14px">
      <div class="chart-card">
        <div class="chart-title">üìä Aktywne projekty wg opiekuna (dzi≈õ)</div>
        <div style="position:relative;height:200px"><canvas id="ob-chart-op-bar"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">ü•ß Udzia≈Ç w portfelu (liczba projekt√≥w)</div>
        <div style="position:relative;height:200px"><canvas id="ob-chart-op-pie"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">üìà Rozk≈Çad obciƒÖ≈ºenia opiekun√≥w w czasie</div>
        <div style="position:relative;height:200px"><canvas id="ob-chart-op-line"></canvas></div>
      </div>
    </div>
  </div>

  <!-- SUBMODU≈Å: Dzia≈Çy -->
  <div id="ob-sub-dzialy" class="ob-subpane on">
    <div style="display:flex;align-items:center;justify-content:flex-end;gap:6px;margin-bottom:10px">
      <button class="btn btn-out btn-sm" onclick="exportXLSX('dzialy')">‚Üì XLSX</button>
      <button class="btn btn-out btn-sm" onclick="exportPDF('dzialy')">‚Üì PDF</button>
    </div>
    <div id="ob-heat-dz-wrap" style="margin-bottom:16px"></div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:14px">
      <div class="chart-card">
        <div class="chart-title">üìä Aktywne projekty wg dzia≈Çu (dzi≈õ)</div>
        <div style="position:relative;height:200px"><canvas id="ob-chart-dz-bar"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">üí∞ ≈ÅƒÖczny bud≈ºet wg dzia≈Çu</div>
        <div style="position:relative;height:200px"><canvas id="ob-chart-dz-bud"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">üìà Rozk≈Çad obciƒÖ≈ºenia dzia≈Ç√≥w w czasie</div>
        <div style="position:relative;height:200px"><canvas id="ob-chart-dz-line"></canvas></div>
      </div>
    </div>
  </div>

  <!-- SUBMODU≈Å: Baza projekt√≥w -->
  <div id="ob-sub-baza" class="ob-subpane">
    <div style="font-size:.75rem;font-weight:900;text-transform:uppercase;letter-spacing:.08em;color:var(--txt3);margin-bottom:8px;display:flex;align-items:center;gap:8px">
      <span>üìã Baza projekt√≥w</span>
      <span id="ob-proj-count" style="font-weight:400;color:var(--txt3)"></span>
      <div style="margin-left:auto;display:flex;gap:6px">
        <button class="btn btn-out btn-sm" onclick="exportCSV('obciazenie')">‚Üì CSV</button>
        <button class="btn btn-out btn-sm" onclick="exportXLSX('obciazenie')">‚Üì XLSX</button>
        <button class="btn btn-out btn-sm" onclick="exportPDF('obciazenie')">‚Üì PDF</button>
      </div>
    </div>
    <div class="of">
      <table class="tbl" id="ob-proj-tbl">
        <thead><tr>
          <th>Nr projektu</th>
          <th>Beneficjent</th>
          <th>Opiekun</th>
          <th>Dzia≈Ç</th>
          <th class="nr">Koniec projektu</th>
          <th class="nr">Koniec z buforem</th>
          <th class="nr">Bud≈ºet</th>
          <th>Status</th>
        </tr></thead>
        <tbody id="ob-proj-tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- ===== AI CHAT: Asystent zarzƒÖdczy obciƒÖ≈ºenia ===== -->
  <div style="margin-top:28px">
    <div class="ph" style="margin-bottom:0">
      <div>
        <div class="ph-t"><div class="ph-icon">ü§ñ</div>Asystent zarzƒÖdczy</div>
        <div class="ph-sub">Zadaj pytanie o obciƒÖ≈ºenie zespo≈Çu ¬∑ dane aktualizowane na bie≈ºƒÖco z dashboardu</div>
      </div>
      <div class="xbar">
        <span id="ob-ai-status" style="font-size:.72rem;color:var(--txt3);font-weight:600"></span>
        <button class="btn btn-out btn-sm" onclick="obAiClear()" title="Wyczy≈õƒá historiƒô">‚úï Wyczy≈õƒá</button>
      </div>
    </div>
    <div class="ccard" style="padding:0;overflow:hidden">
      <!-- Klucz API -->
      <div id="ob-ai-key-bar" style="padding:10px 16px;border-bottom:1px solid var(--brd);display:flex;align-items:center;gap:10px;background:var(--bg3)">
        <span style="font-size:.75rem;color:var(--txt3);font-weight:700;white-space:nowrap">üîë Klucz API:</span>
        <input id="ob-ai-key" type="password" placeholder="sk-ant-... (wklej klucz API Anthropic)" 
          style="flex:1;background:var(--bg2);border:1px solid var(--brd);color:var(--txt);border-radius:6px;padding:5px 10px;font-size:.78rem;font-family:var(--mono);outline:none"
          oninput="obAiKeyChange(this.value)">
        <span id="ob-ai-key-hint" style="font-size:.7rem;color:var(--txt3)">Brak klucza ‚Äî tryb demo</span>
      </div>
      <!-- Historia czatu -->
      <div id="ob-ai-history" style="min-height:120px;max-height:380px;overflow-y:auto;padding:14px 16px;display:flex;flex-direction:column;gap:10px">
        <div style="text-align:center;color:var(--txt3);font-size:.8rem;padding:20px 0">
          Zadaj pytanie o obciƒÖ≈ºenie zespo≈Çu, np.:<br>
          <span style="color:var(--acc);cursor:pointer;font-size:.77rem" onclick="obAiSend('Kt√≥ry dzia≈Ç jest najbardziej obciƒÖ≈ºony i kiedy mo≈ºe przyjƒÖƒá nowe projekty?')">
            ‚Üí Kt√≥ry dzia≈Ç jest najbardziej obciƒÖ≈ºony i kiedy mo≈ºe przyjƒÖƒá nowe projekty?
          </span><br>
          <span style="color:var(--acc);cursor:pointer;font-size:.77rem;margin-top:4px;display:inline-block" onclick="obAiSend('Podsumuj prognozƒô odciƒÖ≈ºenia dzia≈Ç√≥w na kolejne kwarta≈Çy')">
            ‚Üí Podsumuj prognozƒô odciƒÖ≈ºenia dzia≈Ç√≥w na kolejne kwarta≈Çy
          </span><br>
          <span style="color:var(--acc);cursor:pointer;font-size:.77rem;margin-top:4px;display:inline-block" onclick="obAiSend('Kt√≥ry opiekun ma najwy≈ºsze obciƒÖ≈ºenie i ile projekt√≥w ko≈Ñczy w tym roku?')">
            ‚Üí Kt√≥ry opiekun ma najwy≈ºsze obciƒÖ≈ºenie i ile projekt√≥w ko≈Ñczy w tym roku?
          </span>
        </div>
      </div>
      <!-- Input -->
      <div style="padding:10px 16px;border-top:1px solid var(--brd);display:flex;gap:8px;background:var(--bg3)
<button class="sidebar-toggle" onclick="toggleSidebar()" title="Ukryj/poka≈º menu">‚ò∞</button>
">
        <input id="ob-ai-input" type="text" placeholder="Zadaj pytanie o obciƒÖ≈ºenie zespo≈Çu‚Ä¶"
          style="flex:1;background:var(--bg2);border:1px solid var(--brd2);color:var(--txt);border-radius:8px;padding:8px 12px;font-size:.82rem;font-family:var(--font);outline:none"
          onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();obAiSend();}">
        <button id="ob-ai-send-btn" class="btn" onclick="obAiSend()" style="padding:8px 18px;font-size:.8rem">
          Wy≈õlij ‚ñ∂
        </button>
      </div>
    </div>
  </div>


</div>
<!-- ===== KONIEC [M10b] OBCIƒÑ≈ªENIE ===== -->
<!-- ===== [M11] WYKAZ PROJEKT√ìW | id=page-wykaz-proj | linie ~614-697 ===== -->
<!-- ===== KONIEC [M10] OPIEKUNOWIE PROJEKT√ìW ===== -->

<!-- WYKAZ PROJEKT√ìW ‚Äî przypisanie opiekun√≥w -->
<div class="page" id="page-wykaz-proj" data-ai-id="ai-ID.page.wykaz-proj">
  <div class="ph">
    <div>
      <div class="ph-t"><div class="ph-icon">üìã</div>Wykaz projekt√≥w</div>
      <div class="ph-sub">Przypisanie opiekun√≥w ¬∑ Opiekun = osoba odpowiedzialna za weryfikacjƒô ostatniego zatwierdzonego WNP ¬∑ edytowalne rƒôcznie</div>
    </div>
    <div class="xbar">
      <button class="btn btn-out btn-sm" onclick="exportCSV('wykaz')">‚Üì CSV</button>
      <button class="btn btn-out btn-sm" onclick="exportXLSX('wykaz')">‚Üì XLSX</button>
      <button class="btn btn-out btn-sm" onclick="exportPDF('wykaz')">‚Üì PDF</button>
    </div>
  </div>

  <!-- Import pliku FEDS_Podzia≈Ç_Projekt√≥w -->
  <div id="podz-import-bar" style="background:var(--bg3);border:1px solid var(--brd);border-radius:10px;padding:12px 16px;margin-bottom:14px;display:flex;align-items:center;gap:12px;flex-wrap:wrap">
    <div style="flex:1;min-width:240px">
      <div style="font-size:.75rem;font-weight:900;text-transform:uppercase;letter-spacing:.07em;color:var(--txt3);margin-bottom:3px">Import podzia≈Çu projekt√≥w (XLSX)</div>
      <div style="font-size:.8rem;color:var(--txt2)">Plik <strong>FEDS_Podzia≈Ç_Projekt√≥w.xlsx</strong> ¬∑ uzupe≈Çnia opiekun√≥w gdy narzƒôdzie ich nie zmapowa≈Ço ¬∑ <span style="color:var(--txt3)">najni≈ºszy priorytet</span></div>
    </div>
    <div style="display:flex;align-items:center;gap:8px;flex-shrink:0">
      <div id="podz-status" style="font-size:.8rem;color:var(--txt3)">
        <span id="podz-status-txt">Nie wczytano</span>
      </div>
      <div id="podz-dropzone"
        style="border:2px dashed var(--brd2);border-radius:8px;padding:8px 16px;cursor:pointer;text-align:center;min-width:180px;transition:all .15s;background:var(--bg2)"
        onclick="document.getElementById('podz-fileinput').click()"
        ondragover="event.preventDefault();this.style.borderColor='var(--acc)';this.style.background='#2563eb08'"
        ondragleave="this.style.borderColor='';this.style.background='var(--bg2)'"
        ondrop="event.preventDefault();this.style.borderColor='';this.style.background='var(--bg2)';podzFileSelected(event.dataTransfer.files[0])">
        <input type="file" id="podz-fileinput" accept=".xlsx,.xls,.csv" style="display:none" onchange="podzFileSelected(this.files[0])">
        <span style="font-size:.8rem;font-weight:700;color:var(--acc)">üìÇ Wgraj plik podzia≈Çu</span>
      </div>
      <button id="podz-clear-btn" class="btn-cfg danger" style="display:none" onclick="podzClearData()" title="Usu≈Ñ wczytane dane podzia≈Çu projekt√≥w">‚úï Usu≈Ñ</button>
    </div>
  </div>

  <!-- Legenda priorytet√≥w -->
  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;align-items:center">
    <span style="font-size:.65rem;font-weight:900;color:var(--txt3);text-transform:uppercase;letter-spacing:.07em">Priorytety opiekuna:</span>
    <span class="badge bb" style="font-size:.65rem">rƒôczne</span><span style="font-size:.72rem;color:var(--txt3)">‚Ä∫</span>
    <span class="badge bg" style="font-size:.65rem">auto ZAT</span><span style="font-size:.72rem;color:var(--txt3)">‚Ä∫</span>
    <span class="badge by" style="font-size:.65rem">auto WER/POP</span><span style="font-size:.72rem;color:var(--txt3)">‚Ä∫</span>
    <span class="badge bc" style="font-size:.65rem">plik FEDS</span><span style="font-size:.72rem;color:var(--txt3)">‚Ä∫</span>
    <span class="badge bgr-h" style="font-size:.65rem">brak</span>
  </div>
  <div class="fbar" data-ai-id="ai-ID.wykaz.filterbar">
    <span class="flbl">Szukaj:</span>
    <input id="fwp-s" placeholder="Nr projektu lub beneficjent‚Ä¶" style="width:250px" oninput="renderWykazProj()">
    <span class="flbl" style="margin-left:4px">Dzia≈Ç:</span>
    <select id="fwp-dz" onchange="renderWykazProj()" style="min-width:130px">
      <option value="">Wszystkie</option>
      <option value="1">Dzia≈Ç EFS I</option>
      <option value="2">Dzia≈Ç EFS II</option>
      <option value="3">Dzia≈Ç EFS III</option>
    </select>
    <span class="flbl" style="margin-left:4px">Opiekun:</span>
    <select id="fwp-op" onchange="renderWykazProj()" style="min-width:140px">
      <option value="">Wszyscy</option>
      <option value="__brak__">‚Äî Bez opiekuna</option>
    </select>
    <span class="t-info" id="wp-cnt" style="margin-left:auto">‚Äî</span>
  </div>
  <div class="twrap" data-ai-id="ai-ID.wykaz.table-wrap">
    <div class="ttb">
      <span class="t-info" id="wp-info">Wczytaj dane aby wy≈õwietliƒá wykaz</span>
      <span style="font-size:.72rem;color:var(--txt3);margin-left:auto">Kliknij opiekuna w wierszu aby zmieniƒá przypisanie</span>
    </div>
    <div class="of">
      <table class="tbl" data-ai-id="ai-ID.wykaz.table">
        <thead><tr>
          <th style="min-width:230px">Nr projektu</th>
          <th style="min-width:220px">Beneficjent</th>
          <th style="min-width:180px">Opiekun</th>
          <th style="min-width:120px">Dzia≈Ç</th>
          <th style="min-width:110px">≈πr√≥d≈Ço</th>
          <th style="min-width:160px">Ostatni ZAT</th>
          <th class="nr" style="min-width:80px">WNP ZAT</th>
        </tr></thead>
        <tbody id="tb-wykaz" data-ai-id="ai-ID.wykaz.tbody"></tbody>
      </table>
    </div>
    <div class="pager" id="pg-wykaz" data-ai-id="ai-ID.wykaz.pager"></div>
  </div>
</div>

<!-- ===== [M12] ANALIZA RYZYKA aRPK | id=page-arpk | linie ~698-714 ===== -->
<!-- ===== KONIEC [M11] WYKAZ PROJEKT√ìW ===== -->


<div class="page" id="page-arpk" data-ai-id="ai-ID.page.arpk">
  <div class="ph"><div><div class="ph-t"><div class="ph-icon">‚ö†</div>Analiza ryzyka aRPK (RBMV)</div><div class="ph-sub">Automatyczna Roczna Punktacja Kontroli ¬∑ 0-100 ¬∑ 11 kategorii ¬∑ art. 74(2) CPR 2021/1060</div></div><div class="xbar"><button class="btn btn-out btn-sm" onclick="exportCSV('arpk')">‚Üì CSV</button><button class="btn btn-out btn-sm" onclick="exportXLSX('arpk')">‚Üì XLSX</button><button class="btn btn-out btn-sm" onclick="exportPDF('arpk')">‚Üì PDF</button></div></div>
  <!-- Category descriptions -->
  <div id="arpk-cats-overview" data-ai-id="ai-ID.arpk.cats-overview" style="margin-bottom:14px">
    <div class="sec">Kategorie ryzyka aRPK ‚Äî istotno≈õci i opisy</div>
    <div id="arpk-cats-grid" data-ai-id="ai-ID.arpk.cats-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(290px,1fr));gap:8px;margin-bottom:14px"></div>
  </div>
  <div class="fbar" data-ai-id="ai-ID.arpk.filterbar"><span class="flbl">Dzia≈Ç:</span><select id="fa-dz" onchange="renderArpk()" style="min-width:105px"><option value="">Wszystkie</option><option value="1">EFS I</option><option value="2">EFS II</option><option value="3">EFS III</option></select><input id="fa-s" placeholder="Nr projektu / beneficjent‚Ä¶" style="width:210px" oninput="renderArpk()"><select id="fa-op" onchange="renderArpk()"><option value="">Wszyscy opiekunowie</option></select><select id="fa-level" onchange="renderArpk()"><option value="">Wszystkie poziomy</option><option value="niskie">Niskie (0-24)</option><option value="srednie">≈örednie (25-49)</option><option value="wysokie">Wysokie (50-74)</option><option value="krytyczne">Krytyczne (75+)</option></select></div>
  <div class="kgrid" id="kpi-arpk" data-ai-id="ai-ID.arpk.kpi-grid"></div>
  <div class="cgrid" data-ai-id="ai-ID.arpk.charts-grid">
    <div class="ccard" data-ai-id="ai-ID.arpk.chart-distribution"><div class="ctitle">Rozk≈Çad poziomu ryzyka</div><div style="position:relative;height:170px"><canvas id="ch-arpk-dist"></canvas></div></div>
    <div class="ccard" data-ai-id="ai-ID.arpk.chart-categories"><div class="ctitle">DominujƒÖce kategorie ryzyka (suma pkt)</div><div style="position:relative;height:170px"><canvas id="ch-arpk-cat"></canvas></div></div>
  </div>
  <div class="twrap" data-ai-id="ai-ID.arpk.table-wrap"><div class="ttb"><span class="t-info" id="info-arpk">‚Äî</span></div><div class="of"><table class="tbl" data-ai-id="ai-ID.arpk.table"><thead><tr><th>Nr projektu</th><th>Beneficjent</th><th>Ryzyko aRPK</th><th>Poziom</th><th class="nr">R1</th><th class="nr">R2</th><th class="nr">R3</th><th class="nr">R4</th><th class="nr">R5</th><th class="nr">R6</th><th class="nr">R8</th><th class="nr">R9</th><th>Opiekun</th><th>Wymagane dzia≈Çanie</th></tr></thead><tbody id="tb-arpk" data-ai-id="ai-ID.arpk.tbody"></tbody></table></div><div class="pager" id="pg-arpk" data-ai-id="ai-ID.arpk.pager"></div></div>
</div>

<!-- ===== [M13] METRYKI PROJEKT√ìW | id=page-metryki | linie ~715-723 ===== -->
<!-- ===== KONIEC [M12] ANALIZA RYZYKA aRPK ===== -->

<!-- METRYKI PROJEKT√ìW -->
<div class="page" id="page-metryki" data-ai-id="ai-ID.page.metryki">
  <div class="ph"><div><div class="ph-t"><div class="ph-icon">üìã</div>Metryki projekt√≥w</div><div class="ph-sub">Realizacja finansowa i rzeczowa ¬∑ Pe≈Çna ocena aRPK per projekt ¬∑ Wska≈∫niki produktu i rezultatu</div></div><div class="xbar"><button class="btn btn-out btn-sm" onclick="window.print()">‚Üì PDF</button></div></div>
  <div class="fbar" data-ai-id="ai-ID.metryki.filterbar"><span class="flbl">Dzia≈Ç:</span><select id="fm-dz" onchange="renderMetryki()" style="min-width:105px"><option value="">Wszystkie</option><option value="1">EFS I</option><option value="2">EFS II</option><option value="3">EFS III</option></select><input id="fm-s" placeholder="Nr projektu / beneficjent‚Ä¶" style="width:220px" oninput="renderMetryki()"><select id="fm-op" onchange="renderMetryki()"><option value="">Wszyscy opiekunowie</option></select><select id="fm-lv" onchange="renderMetryki()"><option value="">Wszystkie poziomy aRPK</option><option value="niskie">Niskie</option><option value="srednie">≈örednie</option><option value="wysokie">Wysokie</option><option value="krytyczne">Krytyczne</option></select></div>
  <div class="kgrid" id="kpi-metryki" data-ai-id="ai-ID.metryki.kpi-grid"></div>
  <div id="metryki-list" data-ai-id="ai-ID.metryki.cards-list"></div>
  <div class="pager" id="pg-metryki" data-ai-id="ai-ID.metryki.pager"></div>
</div>

<!-- ===== [M14] WCZYTAJ DANE (Import) | id=page-import | linie ~724-832 ===== -->
<!-- ===== KONIEC [M13] METRYKI PROJEKT√ìW ===== -->

<!-- WCZYTAJ DANE -->
<div class="page" id="page-import" data-ai-id="ai-ID.page.import">
  <div class="ph">
    <div>
      <div class="ph-t"><div class="ph-icon">‚¨Ü</div>Wczytaj aktualne dane</div>
      <div class="ph-sub">Obs≈Çugiwane formaty: AiZarzadzanie.xlsx (arkusze WNP/UDA/HP) ¬∑ Raporty systemowe XLSX ¬∑ Numer projektu jako klucz ≈ÇƒÖczƒÖcy</div>
    </div>
  </div>

  <!-- DROP ZONE -->
  <div id="imp-dropzone" class="imp-drop" data-ai-id="ai-ID.import.dropzone" onclick="document.getElementById('imp-fileinput').click()" ondragover="impDragOver(event)" ondragleave="impDragLeave(event)" ondrop="impDrop(event)">
    <input type="file" id="imp-fileinput" accept=".xlsx,.xls,.csv" style="display:none" onchange="impFileSelected(this.files[0])">
    <div class="imp-drop-icon">üìÇ</div>
    <div class="imp-drop-t">PrzeciƒÖgnij plik XLSX lub kliknij aby wybraƒá</div>
    <div class="imp-drop-s">Obs≈Çugiwane arkusze: WNP.biezace ¬∑ WNP.certyfikowane ¬∑ WNP.wszystkie ¬∑ WNP.wskazniki ¬∑ UDA.umowy ¬∑ HP.wszystkie<br>Raporty: Raport wnioski bie≈ºƒÖce ¬∑ Raport wnioski certyfikowane ¬∑ Raport dane z um√≥w ¬∑ Raport HP</div>
  </div>

  <!-- PROGRESS -->
  <div id="imp-prog-wrap" data-ai-id="ai-ID.import.progress-wrap" class="hidden" style="margin:12px 0">
    <div style="font-size:.96rem;color:var(--txt2);margin-bottom:4px" id="imp-prog-lbl" data-ai-id="ai-ID.import.progress-label">Wczytywanie‚Ä¶</div>
    <div class="imp-prog" data-ai-id="ai-ID.import.progress-bar"><div class="imp-prog-b" id="imp-prog-b" style="width:0%"></div></div>
  </div>

  <!-- SHEETS DETECTED -->
  <div id="imp-sheets-wrap" data-ai-id="ai-ID.import.sheets-wrap" class="hidden">
    <div class="sec">Wykryte arkusze</div>
    <div class="imp-sheets" id="imp-sheets-grid" data-ai-id="ai-ID.import.sheets-grid"></div>
  </div>

  <!-- PREVIEW / DELTA -->
  <div id="imp-preview-wrap" data-ai-id="ai-ID.import.preview-wrap" class="hidden">
    <div class="sec">PodglƒÖd zmian</div>
    <div class="imp-preview" data-ai-id="ai-ID.import.preview-panel">
      <div class="imp-prev-hdr">
        <span>üìä Zestawienie zmian danych</span>
        <span id="imp-prev-file" data-ai-id="ai-ID.import.prev-filename" style="color:var(--txt3);font-weight:400"></span>
        <button class="btn btn-sm btn-out" style="margin-left:auto" onclick="impReset()">‚úï Anuluj</button>
      </div>
      <div class="imp-delta" id="imp-delta" data-ai-id="ai-ID.import.delta-grid"></div>
    </div>
    <div id="imp-log" data-ai-id="ai-ID.import.log" class="imp-log"></div>

  <!-- IMPORT FEDS PODZIA≈Å PROJEKT√ìW -->
  <div data-ai-id="ai-ID.import.feds-section" style="margin-top:16px;padding:16px;background:var(--bg2);border:1px solid var(--brd);border-radius:8px">
    <div style="font-size:1rem;font-weight:700;margin-bottom:4px;display:flex;align-items:center;gap:8px">
      <span style="font-size:1.1rem">üìã</span> Podzia≈Ç projekt√≥w ‚Äî przypisanie opiekun√≥w
    </div>
    <div style="font-size:.88rem;color:var(--txt2);margin-bottom:12px">
      Wczytaj plik przypisania projekt√≥w z kolumnami: <span style="font-family:var(--mono);font-size:.82rem;color:var(--acc2)">Numer projektu &middot; Opiekun &middot; Dzia≈Ç &middot; Login</span>.
      Dane sƒÖ <strong>zapisywane trwale</strong>. Kolumna <b>Login</b> ma pierwsze≈Ñstwo przed <b>Opiekun</b> przy dopasowaniu. Kolumna <b>Dzia≈Ç</b> aktualizuje przypisania login√≥w do dzia≈Ç√≥w dla wszystkich modu≈Ç√≥w.
      <span style="color:var(--txt3);font-size:.8rem">Priorytet: auto (ZAT/WER) &gt; plik &gt; brak</span>
    </div>
    <div id="feds-drop"
      style="border:2px dashed var(--brd2);border-radius:8px;padding:20px 16px;text-align:center;cursor:pointer;margin-bottom:10px;transition:all .15s;background:var(--bg3)"
      onclick="document.getElementById('feds-fileinput').click()"
      ondragover="event.preventDefault();this.style.borderColor='var(--acc)';this.style.background='#2563eb08'"
      ondragleave="this.style.borderColor='';this.style.background='var(--bg3)'"
      ondrop="event.preventDefault();this.style.borderColor='';this.style.background='var(--bg3)';fedsFileSelected(event.dataTransfer.files[0])">
      <input type="file" id="feds-fileinput" accept=".xlsx,.xls,.csv" style="display:none" onchange="fedsFileSelected(this.files[0])">
      <div style="font-size:1.2rem;margin-bottom:6px">üìÇ</div>
      <div style="font-size:.9rem;font-weight:600;margin-bottom:3px">PrzeciƒÖgnij plik lub kliknij aby wybraƒá</div>
      <div style="font-size:.78rem;color:var(--txt3)">XLSX lub CSV &middot; FEDS_Podzia≈Ç_Projekt√≥w.xlsx</div>
    </div>
    <div id="feds-status" style="font-size:.84rem;min-height:20px;margin-bottom:6px;color:var(--txt2)"></div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="feds-clear-btn" class="btn btn-out btn-sm" style="display:none" onclick="fedsClearData()">‚úï Usu≈Ñ dane podzia≈Çu</button>
      <span id="feds-count" style="font-size:.78rem;color:var(--txt3)"></span>
    </div>
  </div>

    <div style="display:flex;gap:8px;margin-bottom:20px" data-ai-id="ai-ID.import.apply-bar">
      <button class="btn" id="imp-apply-btn" data-ai-id="ai-ID.import.apply-btn" onclick="impApply()">‚úì Zastosuj dane i od≈õwie≈º dashboard</button>
      <button class="btn btn-out" onclick="impReset()">Anuluj</button>
    </div>
  </div>

  <!-- HISTORY -->
  <div id="imp-history-wrap" data-ai-id="ai-ID.import.history-wrap" style="margin-top:20px">
    <div class="sec">Historia import√≥w</div>
    <div id="imp-history-list" data-ai-id="ai-ID.import.history-list" class="imp-log" style="max-height:200px">Brak importowanych danych w tej sesji.</div>
  </div>
</div>

</main>
</div>

<div class="modal-ov" id="detModal" data-ai-id="ai-ID.modal.wnp-detail"><div class="modal" data-ai-id="ai-ID.modal.wnp-detail.body"><button class="modal-x" onclick="closeModal()">‚úï</button><div class="modal-t" id="det-t" data-ai-id="ai-ID.modal.wnp-detail.title"></div><div class="dg" id="det-c" data-ai-id="ai-ID.modal.wnp-detail.fields"></div></div></div>
<!-- ==================== KONIEC: SEKCJA 5 ‚Äî STRONY HTML ==================== -->

<!-- ===== KONIEC [M14] WCZYTAJ DANE ===== -->

<script>
// ‚îÄ‚îÄ STORAGE SHIM ‚Äî dzia≈Ça lokalnie bez localStorage (Edge/Firefox ochrona prywatno≈õci) ‚îÄ‚îÄ
// ‚îÄ‚îÄ SAVE-STATE: saveState u≈ºywa XMLSerializer().serializeToString(document) ‚îÄ‚îÄ
// Zachowuje surowa tresc blokow skryptow bez HTML-encodowania (w przeciwienstwie do outerHTML).
// Dane RAW i PERSONEL sƒÖ wstrzykiwane przez regex na markery /*__RAW_START__*/ i /*__PER_START__*/
var _MEM_STORE = {};
// ===== [JS-A] NARZƒòDZIA / STORAGE / UTILS ‚Äî isWd, badge, arpkColor, getWeightedScore =====
var _STORAGE = (function(){
  // Sprawd≈∫ czy localStorage dzia≈Ça
  try{ _STORAGE.setItem('__t','1'); _STORAGE.removeItem('__t'); return localStorage; }catch(e){}
  // Sprawd≈∫ sessionStorage
  try{ sessionStorage.setItem('__t','1'); sessionStorage.removeItem('__t'); return sessionStorage; }catch(e){}
  // Fallback: in-memory (dane tracone po zamkniƒôciu karty, ale narzƒôdzie dzia≈Ça)
  return {
    getItem: function(k){ return _MEM_STORE[k]!==undefined ? _MEM_STORE[k] : null; },
    setItem: function(k,v){ _MEM_STORE[k]=v; },
    removeItem: function(k){ delete _MEM_STORE[k]; }
  };
})();

/*__RAW_START__*/const RAW={"wer":[],"pop":[],"zat":[],"rpk":[],"arpk":[],"arpk_map":{},"hp":[],"hp_wer":[],"hp_zat":[],"postep":[],"rzeczowy":[],"metryki":[],"umowy":[],"wskazniki":[],"zadania":{},"op_stats":{},"projOpiekun_xlsx":{}};/*__RAW_END__*/
/*__FEDS_START__*/const _EMBEDDED_FEDS={"projOpiekun_feds":{},"projDzial_feds":{}};/*__FEDS_END__*/

// ‚îÄ‚îÄ‚îÄ CALENDAR ‚îÄ‚îÄ‚îÄ
const PL_HOL=new Set(["2024-01-01","2024-01-06","2024-03-31","2024-04-01","2024-05-01","2024-05-03","2024-05-19","2024-05-30","2024-08-15","2024-11-01","2024-11-11","2024-12-25","2024-12-26","2025-01-01","2025-01-06","2025-04-20","2025-04-21","2025-05-01","2025-05-03","2025-06-08","2025-06-19","2025-08-15","2025-11-01","2025-11-11","2025-12-25","2025-12-26","2026-01-01","2026-01-06","2026-04-05","2026-04-06","2026-05-01","2026-05-03","2026-05-24","2026-06-04","2026-08-15","2026-11-01","2026-11-11","2026-12-25","2026-12-26"]);
function isWd(d){const w=d.getDay();if(w===0||w===6)return false;return!PL_HOL.has(d.toISOString().slice(0,10));}
function addWd(s,n){if(!s)return null;let d=new Date(s),c=0;while(c<n){d=new Date(d.getTime()+86400000);if(isWd(d))c++;}return d;}
function wdBetween(a,b){if(!a||!b)return 0;let d=new Date(typeof a==='string'?a:a.toISOString()),c=0;const e=new Date(typeof b==='string'?b:b.toISOString());while(d<e){d=new Date(d.getTime()+86400000);if(isWd(d))c++;}return c;}
function wdSince(s){if(!s)return null;return wdBetween(new Date(s),new Date());}

// ‚îÄ‚îÄ‚îÄ FORMAT ‚îÄ‚îÄ‚îÄ
const _f2=new Intl.NumberFormat("pl-PL",{minimumFractionDigits:2,maximumFractionDigits:2});
const fmt=n=>(n==null)?"‚Äî":_f2.format(n);
const fmtK=n=>{if(n==null)return"‚Äî";return _f2.format(n)+"\u00a0z≈Ç";};
const fmtPLN=n=>{if(n==null)return"‚Äî";return _f2.format(n)+"¬†z≈Ç";};
const fmtD=s=>{if(!s)return"‚Äî";const d=new Date(s);if(isNaN(d))return String(s);const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),dd=String(d.getDate()).padStart(2,'0');return`${y}-${m}-${dd}`;};
const clamp=(s,n=28)=>{if(!s)return"‚Äî";const t=String(s);return t.length>n?t.slice(0,n)+"‚Ä¶":t;};
const NOW=new Date();
const ST_CLS={"Zatwierdzony":"g","Do korekty":"y","Do poprawy":"y","W trakcie weryfikacji":"b","Z≈Ço≈ºony":"c","Poprawiany":"o","Anulowany":"r","Zako≈Ñczona":"g","Przes≈Çany":"b"};
function badge(s,c){return`<span class="badge b${c||(ST_CLS[s]||"gr")}">${s||"‚Äî"}</span>`;}
function arpkColor(sc){return sc>=75?"var(--red)":sc>=50?"var(--orn)":sc>=25?"var(--yel)":"var(--grn)";}
function arpkBadge(sc){sc=sc||0;const[lbl,cl]=sc>=75?["KRYTYCZNE","r"]:sc>=50?["WYSOKIE","o"]:sc>=25?["≈öREDNIE","y"]:["NISKIE","g"];return{lbl,cl,badge:`<span class="badge b${cl}" style="min-width:68px;text-align:center;justify-content:center">${sc}\u00b7${lbl}</span>`};}
function arpkAction(sc){return sc>=75?"Weryfikacja 100% ¬∑ Eskalacja ¬∑ OTS obligatoryjna":sc>=50?"Weryfikacja rozszerzona ¬∑ OTS planowane":sc>=25?"Weryfikacja standardowa":"Weryfikacja uproszczona";}
function arpkLevel(sc){return sc>=75?"krytyczne":sc>=50?"wysokie":sc>=25?"srednie":"niskie";}
function pctColor(p){return p>=70?"var(--grn)":p>=40?"var(--acc)":p>=20?"var(--yel)":"var(--red)";}

// ‚îÄ‚îÄ‚îÄ aRPK CATEGORY DEFINITIONS ‚îÄ‚îÄ‚îÄ
const ARPK_CATS=[
  {id:"r1",code:"R1",name:"Rodzaj beneficjenta",desc:"Ryzyko zwiƒÖzane z formƒÖ prawnƒÖ i do≈õwiadczeniem beneficjenta. Podmioty prywatne i mikroprzedsiƒôbiorstwa niosƒÖ wy≈ºsze ryzyko ni≈º podmioty publiczne z do≈õwiadczeniem w rozliczaniu funduszy UE.",maxOrig:10,col:"var(--acc)"},
  {id:"r2",code:"R2",name:"Wielko≈õƒá projektu",desc:"Projekty o wy≈ºszej warto≈õci kwalifikowalnej w stosunku do mediany populacji podlegajƒÖ intensywniejszej kontroli. Du≈ºe kwoty zwiƒôkszajƒÖ ryzyko nieprawid≈Çowo≈õci finansowych.",maxOrig:10,col:"var(--acc2)"},
  {id:"r3",code:"R3",name:"Realizatorzy i partnerzy",desc:"Projekty realizowane w partnerstwie lub z udzia≈Çem podmiot√≥w realizujƒÖcych charakteryzujƒÖ siƒô wy≈ºszym ryzykiem ze wzglƒôdu na z≈Ço≈ºono≈õƒá zarzƒÖdzania i rozliczania.",maxOrig:8,col:"var(--acc3)"},
  {id:"r4",code:"R4",name:"Postƒôp rzeczowy wska≈∫nik√≥w",desc:"Niska realizacja wska≈∫nik√≥w PRODUKTU sygnalizuje trudno≈õci wykonawcze lub rozbie≈ºno≈õƒá miƒôdzy planowanymi a osiƒÖganymi efektami projektu. Wska≈∫niki rezultatu sƒÖ traktowane informacyjnie. Ocena na tle populacji aktywnych projekt√≥w.",maxOrig:13,col:"var(--orn)"},
  {id:"r5",code:"R5",name:"R√≥wnoleg≈Çe projekty beneficjenta",desc:"Beneficjenci realizujƒÖcy jednocze≈õnie wiele projekt√≥w nara≈ºeni sƒÖ na ryzyko rozproszenia zasob√≥w zarzƒÖdczych i administracyjnych, co mo≈ºe prowadziƒá do b≈Çƒôd√≥w w rozliczaniu.",maxOrig:8,col:"var(--grn)"},
  {id:"r6",code:"R6",name:"Liczba wersji wniosku o p≈Çatno≈õƒá",desc:"Wysokia liczba wersji i korekt wniosk√≥w o p≈Çatno≈õƒá wskazuje na trudno≈õci beneficjenta w prawid≈Çowym rozliczaniu wydatk√≥w lub problemy z kwalifikowalno≈õciƒÖ ponoszonych koszt√≥w.",maxOrig:15,col:"var(--yel)"},
  {id:"r7",code:"R7",name:"Skargi i odwo≈Çania",desc:"Wp≈Çyw skarg na projekt od beneficjent√≥w, uczestnik√≥w lub podmiot√≥w trzecich wskazuje na potencjalne nieprawid≈Çowo≈õci w realizacji lub naruszenia zasad r√≥wno≈õci szans. Dane wprowadzane rƒôcznie.",maxOrig:5,col:"var(--red)"},
  {id:"r8",code:"R8",name:"Nieprawid≈Çowo≈õci i korekty",desc:"Historia wykrytych nieprawid≈Çowo≈õci w poprzednich wnioskach o p≈Çatno≈õƒá i dokonanych korektach finansowych bezpo≈õrednio ≈õwiadczy o podwy≈ºszonym ryzyku w bie≈ºƒÖcym i przysz≈Çych wnioskach.",maxOrig:15,col:"var(--red)"},
  {id:"r9",code:"R9",name:"Odchylenie wyd. v1 vs zatwierdzona",desc:"Istotne r√≥≈ºnice miƒôdzy warto≈õciƒÖ wydatk√≥w kwalifikowalnych w pierwszej a ostatniej wersji wniosku wskazujƒÖ na trudno≈õci z utrzymaniem planowanego zakresu finansowego lub korekty kwalifikowalno≈õci.",maxOrig:15,col:"var(--orn)"},
];

// ‚îÄ‚îÄ‚îÄ WEIGHT STATE (editable per category) ‚îÄ‚îÄ‚îÄ
const W={};
ARPK_CATS.forEach(c=>{W[c.id]=c.maxOrig;});
// Load persisted weights (after defaults set)
// Will be called after function defs: loadWeights()
// Will be called after function defs: loadPersonel()

function getWeightedScore(entry){
  const b=entry.breakdown||{};
  const cats={
    r1:{raw:b.r1_beneficjent||0,maxOrig:10},
    r2:{raw:b.r2_wielkosc||0,maxOrig:10},
    r3:{raw:b.r3_realizatorzy||0,maxOrig:8},
    r4:{raw:b.r4_rzeczowy||0,maxOrig:13},
    r5:{raw:b.r5_rownolegle||0,maxOrig:8},
    r6:{raw:b.r6_wersje||0,maxOrig:15},
    r7:{raw:b.r7_skargi||0,maxOrig:5},
    r8:{raw:b.r8_nieprawidlowosci||0,maxOrig:15},
    r9:{raw:b.r9_odchylenie||0,maxOrig:15},
  };
  let total=0;
  const sumMaxW=Object.values(W).reduce((s,v)=>s+v,0);
  const sumMaxOrig=ARPK_CATS.reduce((s,c)=>s+c.maxOrig,0);
  Object.entries(cats).forEach(([k,v])=>{
    if(v.maxOrig===0)return;
    const ratio=v.raw/v.maxOrig;
    const weighted=ratio*(W[k]||0);
    total+=weighted;
  });
  // Normalize to 0-100
  return Math.min(100,Math.round(total/sumMaxW*100));
}

function getCatPts(entry,catId){
  const b=entry.breakdown||{};
  const map={r1:b.r1_beneficjent,r2:b.r2_wielkosc,r3:b.r3_realizatorzy,r4:b.r4_rzeczowy,r5:b.r5_rownolegle,r6:b.r6_wersje,r7:b.r7_skargi,r8:b.r8_nieprawidlowosci,r9:b.r9_odchylenie};
  return map[catId]||0;
}

function catStateDesc(entry,catId,umowa){
  const b=entry.breakdown||{};
  switch(catId){
    case"r1":{const lf=umowa.forma_prawna||"nieznana";return`Forma prawna: ${lf} ¬∑ ${b.r1_beneficjent>=7?"Podmiot prywatny (wy≈ºsze ryzyko)":b.r1_beneficjent>=4?"Podmiot mieszany":"Podmiot publiczny (ni≈ºsze ryzyko)"}`;}
    case"r2":{const bud=umowa.budzet||0;return`Bud≈ºet: ${fmtK(bud)} ¬∑ ${b.r2_wielkosc>=8?"Znacznie powy≈ºej mediany populacji":b.r2_wielkosc>=5?"Powy≈ºej mediany":b.r2_wielkosc>=3?"Zbli≈ºony do mediany":"Poni≈ºej mediany"}`;}
    case"r3":{return b.r3_realizatorzy>0?"Projekt partnerski lub wielopodmiotowy":"Beneficjent realizuje projekt samodzielnie";}
    case"r4":{const w=RAW.wskazniki[entry.nr]||RAW.wskazniki[Object.keys(RAW.arpk_map).find(k=>k===entry.nr)]||{};const avg=w.avg_prod;return avg!=null?`≈ör. realizacja wsk. produktu: ${avg}% (${w.cnt_prod||0} wsk.) ¬∑ Rezultaty: ${w.avg_rez!=null?w.avg_rez+'%':'‚Äî'} (inf.)`:"Brak danych wska≈∫nikowych";}
    case"r5":{const cnt=b.r5_rownolegle>=7?">5":b.r5_rownolegle>=4?"3-5":b.r5_rownolegle>=2?"2":b.r5_rownolegle>0?"1":"0";return`Beneficjent ma ${cnt} r√≥wnoleg≈Çych projekt√≥w w systemie`;}
    case"r6":{return b.r6_wersje>=12?"Bardzo wysoka liczba wersji WNP (‚â•3 ≈õr.)":b.r6_wersje>=6?"Podwy≈ºszona liczba wersji WNP (‚â•2 ≈õr.)":b.r6_wersje>0?"Nieznacznie podwy≈ºszona":"Standardowa liczba wersji";}
    case"r7":{return b.r7_skargi>0?`${b.r7_skargi} pkt ‚Äî skargi na projekt zaewidencjonowane`:"Brak skarg zaewidencjonowanych (dane rƒôczne)";}
    case"r8":{return b.r8_nieprawidlowosci>=12?"Liczne nieprawid≈Çowo≈õci w historii WNP":b.r8_nieprawidlowosci>=7?"Kilka nieprawid≈Çowo≈õci":b.r8_nieprawidlowosci>0?"Jednostkowe nieprawid≈Çowo≈õci":"Brak stwierdzonych nieprawid≈Çowo≈õci";}
    case"r9":{return b.r9_odchylenie>=12?"Bardzo du≈ºe odchylenia finansowe v1‚Üízatw. (>30%)":b.r9_odchylenie>=7?"Istotne odchylenia (>15%)":b.r9_odchylenie>0?"Umiarkowane odchylenia (>5%)":"Odchylenia w normie";}
    default:return"‚Äî";
  }
}

// ‚îÄ‚îÄ‚îÄ CFG STATE ‚îÄ‚îÄ‚îÄ
// ‚îÄ‚îÄ‚îÄ PERSONEL (skr√≥ty ‚Üí pe≈Çne dane) ‚îÄ‚îÄ‚îÄ
/*__PER_START__*/const DEFAULT_PERSONEL={
  "JOAPRZYB2":{skrot:"JOAPRZYB2",nazwisko:"Przyby≈Ça",imie:"Joanna",dzial:"Dzia≈Ç EFS I"},
  "KATOLEJ2":{skrot:"KATOLEJ2",nazwisko:"Olejarz",imie:"Katarzyna",dzial:"Dzia≈Ç EFS II"},
  "MARMICK2":{skrot:"MARMICK2",nazwisko:"Mickiewicz",imie:"Marzena",dzial:"Dzia≈Ç EFS I"},
  "MARKUCZ2":{skrot:"MARKUCZ2",nazwisko:"Kuczak",imie:"Mariusz",dzial:"Dzia≈Ç EFS I"},
  "MAGNOB2":{skrot:"MAGNOB2",nazwisko:"Nobis",imie:"Magdalena",dzial:"Dzia≈Ç EFS III"},
  "ANNOCH2":{skrot:"ANNOCH2",nazwisko:"Ochnik",imie:"Anna",dzial:"Dzia≈Ç EFS III"},
  "MICPLO2":{skrot:"MICPLO2",nazwisko:"Plotan",imie:"Michalina",dzial:"Dzia≈Ç EFS I"},
  "AGAMIL2":{skrot:"AGAMIL2",nazwisko:"Milczarska",imie:"Agata",dzial:"Dzia≈Ç EFS III"},
  "LUCOKR2":{skrot:"LUCOKR2",nazwisko:"Okraszewski",imie:"Lucjan",dzial:"Dzia≈Ç EFS I"},
  "MICMASE2":{skrot:"MICMASE2",nazwisko:"Mase≈Çko",imie:"Micha≈Ç",dzial:"Dzia≈Ç EFS II"},
  "AGNMOT2":{skrot:"AGNMOT2",nazwisko:"Motylska",imie:"Agnieszka",dzial:"Dzia≈Ç EFS III"},
  "KATGORN2":{skrot:"KATGORN2",nazwisko:"G√≥rniak",imie:"Katarzyna",dzial:"Dzia≈Ç EFS III"},
  "MAGSTY2":{skrot:"MAGSTY2",nazwisko:"Stychno",imie:"Magdalena",dzial:"Dzia≈Ç EFS I"},
  "ALEJAKU2":{skrot:"ALEJAKU2",nazwisko:"Jakubek",imie:"Aleksandra",dzial:"Dzia≈Ç EFS II"},
  "SYLWIT2":{skrot:"SYLWIT2",nazwisko:"Witowska",imie:"Sylwia",dzial:"Dzia≈Ç EFS II"},
  "ALEZMO2":{skrot:"ALEZMO2",nazwisko:"Zmonarska",imie:"Aleksandra",dzial:"Dzia≈Ç EFS II"},
  "KRYWLO2":{skrot:"KRYWLO2",nazwisko:"W≈Çodek",imie:"Karystian",dzial:"Dzia≈Ç EFS II"},
  "PIOKAC2":{skrot:"PIOKAC2",nazwisko:"Kaczmarek",imie:"Piotr",dzial:"Dzia≈Ç EFS I"},
  "ANNDUDE2":{skrot:"ANNDUDE2",nazwisko:"Dudek",imie:"Anna",dzial:"Dzia≈Ç EFS II"},
  "KARJAK2":{skrot:"KARJAK2",nazwisko:"Jakubczak",imie:"Karolina",dzial:"Dzia≈Ç EFS II"},
  "DARSTEP2":{skrot:"DARSTEP2",nazwisko:"Stƒôpie≈Ñ",imie:"Daria",dzial:"Dzia≈Ç EFS I"},
  "BARKORE2":{skrot:"BARKORE2",nazwisko:"Korecka",imie:"Barbara",dzial:"Dzia≈Ç EFS III"},
  "MAGDRYG2":{skrot:"MAGDRYG2",nazwisko:"Dryga≈Ça",imie:"Magdalena",dzial:"Dzia≈Ç EFS II"},
  "KATDOL2":{skrot:"KATDOL2",nazwisko:"Dolecka",imie:"Katarzyna",dzial:"Dzia≈Ç EFS I"},
  "RAFMAT2":{skrot:"RAFMAT2",nazwisko:"Matejko",imie:"Rafa≈Ç",dzial:"Dzia≈Ç EFS II"},
  "JOASAW2":{skrot:"JOASAW2",nazwisko:"Sawicka",imie:"Joanna",dzial:"Dzia≈Ç EFS III"},
  "JULAFA2":{skrot:"JULAFA2",nazwisko:"Afanasiew",imie:"Julia",dzial:"Dzia≈Ç EFS II"}
}; /*__PER_END__*/ // default workers
const PERSONEL=Object.assign({},DEFAULT_PERSONEL); // always has defaults

// ‚îÄ‚îÄ‚îÄ CFG STATE + PERSISTENCE ‚îÄ‚îÄ‚îÄ
// ===== [JS-B] ZAPIS / WCZYTANIE KONFIGURACJI ‚Äî loadSaved, saveCFG, loadPersonel, savePersonel =====
function loadSaved(){
  // Dane wbudowane w plik (zapisane przez saveState) ‚Äî najwy≈ºszy priorytet
  const embedded = (typeof _EMBEDDED_FEDS !== 'undefined') ? _EMBEDDED_FEDS : {};
  const hasFeds = Object.keys(embedded.projOpiekun_feds||{}).length > 0;
  try{
    const s=_STORAGE.getItem("rbmv_cfg");
    if(s){
      const p=JSON.parse(s);
      return{
        dzialy:new Set(p.dzialy||["all"]),
        opDzial:p.opDzial||{},
        postepOd:p.postepOd||"projekt",
        opozn:p.opozn||20,
        d1:p.d1||20,
        dn:p.dn||15,
        dp:p.dp||5,
        // Je≈õli plik ma wbudowane dane FEDS ‚Äî u≈ºyj ich; inaczej z localStorage
        projOpiekun_feds: hasFeds ? embedded.projOpiekun_feds : (p.projOpiekun_feds||{}),
        projDzial_feds:   hasFeds ? embedded.projDzial_feds   : (p.projDzial_feds||{}),
      };
    }
  }catch(e){}
  return{
    dzialy:new Set(["all"]),opDzial:{},postepOd:"projekt",
    opozn:20,d1:20,dn:15,dp:5,
    projOpiekun_feds: embedded.projOpiekun_feds||{},
    projDzial_feds:   embedded.projDzial_feds||{},
  };
}
const CFG=loadSaved();
CFG.projOpiekun=RAW.projOpiekun||{};
// CFG.projOpiekun_feds ju≈º za≈Çadowane z loadSaved()

function saveCFG(){
  try{
    _STORAGE.setItem("rbmv_cfg",JSON.stringify({
      dzialy:[...CFG.dzialy],
      opDzial:CFG.opDzial,
      postepOd:CFG.postepOd,
      opozn:CFG.opozn,
      d1:CFG.d1,
      dn:CFG.dn,
      dp:CFG.dp,
      projOpiekun_feds:CFG.projOpiekun_feds||{},
      projDzial_feds:CFG.projDzial_feds||{},
    }));
  }catch(e){}
}

// Load & save W weights
function loadWeights(){
  try{
    const s=_STORAGE.getItem("rbmv_weights");
    if(s){const p=JSON.parse(s);ARPK_CATS.forEach(c=>{if(p[c.id]!=null)W[c.id]=p[c.id];});if(p.__locked!=null)WEIGHTS_LOCKED=p.__locked;}
  }catch(e){}
}
function saveWeights(){
  try{_STORAGE.setItem("rbmv_weights",JSON.stringify({...W,__locked:WEIGHTS_LOCKED}));}catch(e){}
}

// Load & save PERSONEL
function loadPersonel(){
  // Zawsze zaczynaj od danych domy≈õlnych
  Object.assign(PERSONEL, DEFAULT_PERSONEL);
  // Do≈ÇƒÖcz dane z pamiƒôci (zapisane przez u≈ºytkownika)
  try{
    const s=_STORAGE.getItem("rbmv_personel");
    if(s){const p=JSON.parse(s);Object.assign(PERSONEL,p);}
  }catch(e){}
  // Sync opDzial z dzia≈Çu w PERSONEL
  Object.values(PERSONEL).forEach(function(p){
    if(p.skrot&&p.dzial){var code=dzialToCode(p.dzial);if(code)CFG.opDzial[p.skrot]=code;}
  });
}
function savePersonel(){
  try{_STORAGE.setItem("rbmv_personel",JSON.stringify(PERSONEL));}catch(e){}
  // Aktualizuj licznik w sekcji konfiguracji
  var s=document.getElementById("per-status");
  var cnt=Object.keys(PERSONEL).length;
  if(s) s.textContent=cnt+" pracownik√≥w w s≈Çowniku";
  var sImp=document.getElementById("per-status-imp");
  if(sImp) sImp.textContent=cnt+" pracownik√≥w w s≈Çowniku";
}

// Helper: get display name for operator code
function opName(skrot){
  const p=PERSONEL[skrot];
  if(p)return`${p.nazwisko} ${p.imie}`;
  return skrot||"‚Äî";
}
function opFullInfo(skrot){
  const p=PERSONEL[skrot];
  if(p)return{name:`${p.nazwisko} ${p.imie}`,dzial:p.dzial||CFG.opDzial[skrot]||"",skrot};
  return{name:skrot||"‚Äî",dzial:CFG.opDzial[skrot]||"",skrot};
}

function opiekInDzial(op){if(CFG.dzialy.has("all"))return true;if(!op||op==="‚Äî")return true;return CFG.dzialy.has(CFG.opDzial[op]);}
function projInScope(nr){const op=(RAW.arpk_map[nr]||{}).opiekun||"‚Äî";return opiekInDzial(op);}
function dzialFilter(op,selDzial){if(!selDzial)return true;return CFG.opDzial[op]===selDzial;}

document.getElementById("tb-date").textContent=NOW.toLocaleString("pl-PL");
document.getElementById("ov-date").textContent=NOW.toLocaleDateString("pl-PL");

// ===== [JS-C] NAWIGACJA I KONFIGURACJA UI ‚Äî showPage, toggleCfg, buildArpkCatEditor =====
function showPage(id){
  document.querySelectorAll(".page").forEach(p=>p.classList.remove("on"));
  document.querySelectorAll(".sb-item").forEach(i=>i.classList.remove("act"));
  document.getElementById("page-"+id).classList.add("on");
  const n=document.getElementById("nav-"+id);if(n)n.classList.add("act");
  // Przy wej≈õciu na Rozliczenie zawsze od≈õwie≈º siatkƒô kafelk√≥w
  if(id==='rozliczenie') renderRozGrid();
  // Przy wej≈õciu na Wykaz projekt√≥w od≈õwie≈º
  if(id==='wykaz-proj') buildWykazProj();
  if(id==='obciazenie') buildObciazenie();
}
function toggleCfg(){document.getElementById("cfgOverlay").classList.toggle("on");document.getElementById("btn-cfg").classList.toggle("on");}
function overlayClick(e){if(e.target===document.getElementById("cfgOverlay"))toggleCfg();}
function showCfgTab(el,id){document.querySelectorAll(".cfg-tab").forEach(t=>t.classList.remove("on"));document.querySelectorAll(".cfg-pane").forEach(p=>p.classList.remove("on"));el.classList.add("on");document.getElementById(id).classList.add("on");}
function toggleDzial(d){
  if(d==="all"){CFG.dzialy=new Set(["all"]);document.querySelectorAll(".dz-pill").forEach(p=>p.classList.remove("on"));document.getElementById("dp-all").classList.add("on");}
  else{CFG.dzialy.delete("all");document.getElementById("dp-all").classList.remove("on");if(CFG.dzialy.has(d))CFG.dzialy.delete(d);else CFG.dzialy.add(d);if(!CFG.dzialy.size){CFG.dzialy.add("all");document.getElementById("dp-all").classList.add("on");}["1","2","3"].forEach(x=>document.getElementById("dp-"+x).classList.toggle("on",CFG.dzialy.has(x)));}
  const dzLbl=CFG.dzialy.has("all")?"Wszystkie dzia≈Çy":[...CFG.dzialy].map(x=>({"1":"Dzia≈Ç EFS I","2":"Dzia≈Ç EFS II","3":"Dzia≈Ç EFS III"}[x]||"Dzia≈Ç EFS "+x)).join(", ");
  const tbDz=document.getElementById("tb-dzial");if(tbDz)tbDz.textContent=dzLbl;
  const ovDz=document.getElementById("ov-dzial");if(ovDz)ovDz.textContent=dzLbl;
  const activeDz=CFG.dzialy.has("all")?"":([...CFG.dzialy].length===1?[...CFG.dzialy][0]:"");
  syncDzialFilters(activeDz);
  saveCFG();
  buildOverview();buildWer();buildPop();buildZat();buildRpk();buildPostep();buildOpGrid();
}
function buildOpAssign(){
  if(!RAW.op_stats||typeof RAW.op_stats!=="object")return;
  const ops=Object.keys(RAW.op_stats).sort();
  var _oal=document.getElementById("op-assign-list"); if(!_oal)return;
  _oal.innerHTML=ops.map(o=>{
    const p=PERSONEL[o];
    const label=p?`<span class="op-aname" style="min-width:160px"><strong>${p.nazwisko} ${p.imie}</strong> <span style="font-family:var(--mono);color:var(--txt3);font-size:.8rem">${o}</span></span>`:`<span class="op-aname">${o}</span>`;
    return`<div class="op-arow">${label}<select class="cfg-sel" style="width:110px" onchange="CFG.opDzial['${o}']=this.value;saveCFG()"><option value="">‚Äî</option><option value="1"${CFG.opDzial[o]==="1"?" selected":""}>EFS I</option><option value="2"${CFG.opDzial[o]==="2"?" selected":""}>EFS II</option><option value="3"${CFG.opDzial[o]==="3"?" selected":""}>EFS III</option></select></div>`;
  }).join("");
}
// ‚îÄ‚îÄ WEIGHT LOCK STATE ‚îÄ‚îÄ
let WEIGHTS_LOCKED=true;
function toggleWeightsLock(){
  WEIGHTS_LOCKED=!WEIGHTS_LOCKED;
  buildArpkCatEditor();
  saveWeights();
}
function adjustWeight(id,delta){
  if(WEIGHTS_LOCKED)return;
  var cat=null;
  for(var i=0;i<ARPK_CATS.length;i++){if(ARPK_CATS[i].id===id){cat=ARPK_CATS[i];break;}}
  if(!cat)return;
  var mx=Math.round(cat.maxOrig*2);
  W[id]=Math.max(0,Math.min(mx,(W[id]||0)+delta));
  var rng=document.getElementById("rng-"+id);
  var val=document.getElementById("val-"+id);
  if(rng)rng.value=W[id];
  if(val)val.textContent=W[id]+"¬†pkt";
  saveWeights();
  renderArpk();
}
function onWeightInput(id,v){
  W[id]=+v;
  var val=document.getElementById("val-"+id);
  if(val)val.textContent=v+"¬†pkt";
  saveWeights();
  renderArpk();
}

function buildArpkCatEditor(){
  var el=document.getElementById("arpk-cat-editor");
  if(!el)return;
  var lk=WEIGHTS_LOCKED;
  var lockBg=lk?"var(--bg3)":"var(--acc)";
  var lockCol=lk?"var(--txt1)":"#fff";
  var lockBd=lk?"var(--brd)":"var(--acc)";
  var lockIco=lk?"&#x1F512;":"&#x1F513;";
  var lockLbl=lk?"Wagi zablokowane":"Wagi odblokowane";
  var lockBtn=lk?"Odblokuj":"Zablokuj";
  var html="<div style=\"display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:16px;padding:10px 14px;background:var(--bg2);border:1px solid var(--brd);border-radius:8px\">"
    +"<span style=\"font-size:.85rem;color:var(--txt2)\">"+lockIco+" "+lockLbl+"</span>"
    +"<button onclick=\"toggleWeightsLock()\" style=\"padding:6px 18px;border-radius:6px;cursor:pointer;font-size:.88rem;font-weight:700;border:1px solid "+lockBd+";background:"+lockBg+";color:"+lockCol+";transition:all .15s\">"+lockBtn+"</button>"
    +"</div>";
  for(var i=0;i<ARPK_CATS.length;i++){
    var c=ARPK_CATS[i];
    var mx=Math.round(c.maxOrig*2);
    var bstyle="display:inline-flex;align-items:center;justify-content:center;width:30px;height:30px;border-radius:5px;border:1px solid var(--brd);font-size:1.15rem;font-weight:700;background:var(--bg3);transition:all .1s;"+(lk?"cursor:not-allowed;color:var(--txt3);opacity:.35":"cursor:pointer;color:var(--txt1)");
    var dis=lk?" disabled":"";
    var rngStyle=lk?" style=\"pointer-events:none;opacity:.4\"":" style=\"\"" ;
    var oninputAttr=lk?"":(" oninput=\"onWeightInput('"+c.id+"',this.value)\"");
    html+="<div class=\"arpk-cat-row\" style=\"opacity:"+(lk?".82":"1")+"\">";
    html+="<div class=\"arpk-cat-hdr\">";
    html+="<span class=\"arpk-cat-code\">"+c.code+"</span>";
    html+="<span class=\"arpk-cat-name\">"+c.name+"</span>";
    html+="<span class=\"arpk-cat-badge\" style=\"background:"+c.col+"\">"+c.maxOrig+"¬†pkt max</span>";
    html+="</div>";
    html+="<div class=\"arpk-cat-desc\">"+c.desc+"</div>";
    html+="<div class=\"arpk-cat-ctl\" style=\"align-items:center;gap:8px\">";
    html+="<label style=\"white-space:nowrap\">Waga istotno≈õci:</label>";
    html+="<button style=\""+bstyle+"\""+dis+" onclick=\"adjustWeight('"+c.id+"',-1)\" title=\"Zmniejsz wagƒô\">‚àí</button>";
    html+="<input type=\"range\" id=\"rng-"+c.id+"\" min=\"0\" max=\""+mx+"\" value=\""+W[c.id]+"\" step=\"1\""+rngStyle+oninputAttr+">";
    html+="<button style=\""+bstyle+"\""+dis+" onclick=\"adjustWeight('"+c.id+"',+1)\" title=\"Zwiƒôksz wagƒô\">+</button>";
    html+="<span class=\"arpk-cat-val\" id=\"val-"+c.id+"\" style=\"min-width:52px;text-align:right\">"+W[c.id]+"¬†pkt</span>";
    html+="</div></div>";
  }
  el.innerHTML=html;
}

function buildArpkCatsOverview(){
  const sumW=ARPK_CATS.reduce((s,x)=>s+W[x.id],0);
  document.getElementById("arpk-cats-grid").innerHTML=ARPK_CATS.map(c=>{
    const pct=sumW>0?W[c.id]/sumW*100:0;
    return`<div class="arpk-cat-item" style="border-left:3px solid ${c.col}">
      <div class="arpk-ci-hdr">
        <span class="arpk-ci-code" style="color:${c.col}">${c.code}</span>
        <span class="arpk-ci-name">${c.name}</span>
        <span class="arpk-ci-max" style="color:${c.col};font-weight:700;font-size:.96rem">${W[c.id]}\u00a0pkt</span>
      </div>
      <div class="arpk-ci-state">${c.desc}</div>
      <div style="display:flex;align-items:center;gap:7px;margin-top:7px">
        <span style="font-size:.78rem;color:var(--txt3);white-space:nowrap">Waga:</span>
        <input type="range" min="0" max="${Math.round(c.maxOrig*2)}" value="${W[c.id]}" step="1" style="flex:1;accent-color:${c.col};height:3px;cursor:pointer"
          oninput="W['${c.id}']=+this.value;this.nextElementSibling.textContent=this.value+'\u00a0pkt';saveWeights();buildArpkCatsOverview();renderArpk();">
        <span style="font-family:var(--mono);font-size:.78rem;color:${c.col};min-width:38px;text-align:right;font-weight:700">${W[c.id]}\u00a0pkt</span>
      </div>
      <div class="arpk-ci-bar" style="margin-top:5px"><div class="arpk-ci-fill" style="width:${pct.toFixed(0)}%;background:${c.col}"></div></div>
      <div style="font-size:.7rem;color:var(--txt3);text-align:right;margin-top:2px">${pct.toFixed(0)}% sumy wag</div>
    </div>`;}).join("");
}
function cfgChange(){
  CFG.postepOd=document.getElementById("cfg-postep-od").value;
  CFG.opozn=+document.getElementById("cfg-opozn").value||20;
  CFG.d1=+document.getElementById("cfg-d1").value||20;
  CFG.dn=+document.getElementById("cfg-dn").value||15;
  CFG.dp=+document.getElementById("cfg-dp").value||5;
  document.getElementById("pop-lim").textContent=CFG.dp;
}
function applyConfig(){cfgChange();saveCFG();const dzLbl=CFG.dzialy.has("all")?"Wszystkie dzia≈Çy":[...CFG.dzialy].map(x=>({"1":"Dzia≈Ç EFS I","2":"Dzia≈Ç EFS II","3":"Dzia≈Ç EFS III"}[x]||"Dzia≈Ç EFS "+x)).join(", ");document.getElementById("tb-dzial").textContent=dzLbl;document.getElementById("ov-dzial").textContent=dzLbl;document.getElementById("postep-od-lbl").textContent=CFG.postepOd==="umowa"?"podpisania umowy":"rozpoczƒôcia projektu";toggleCfg();rebuildAll();}
function renderPager(id,cur,tot,cb){
  const el=document.getElementById(id);if(!el)return;if(tot<=1){el.innerHTML="";return;}
  let h=`<button ${cur<=1?"disabled":""} onclick="(${cb})(${cur-1})">‚Äπ</button>`;
  for(let p=1;p<=tot;p++){if(p===1||p===tot||(p>=cur-2&&p<=cur+2))h+=`<button class="${p===cur?"on":""}" onclick="(${cb})(${p})">${p}</button>`;else if(p===cur-3||p===cur+3)h+=`<button disabled>‚Ä¶</button>`;}
  h+=`<button ${cur>=tot?"disabled":""} onclick="(${cb})(${cur+1})">‚Ä∫</button>`;h+=`<span class="pg-info">str.${cur}/${tot}</span>`;el.innerHTML=h;
}
function populateSel(id,items,key,lbl0){
  if(lbl0===undefined)lbl0="Wszyscy opiekunowie";
  var vals=[...new Set(items.map(function(r){return r[key];}).filter(Boolean))].sort();
  var el=document.getElementById(id);if(!el)return;
  // Dla klucza 'opiekun' - wy≈õwietlaj pe≈Çne imiƒô i nazwisko zamiast kodu
  if(key==="opiekun"){
    el.innerHTML='<option value="">'+lbl0+'</option>'+vals.map(function(v){
      var n=opName(v);
      return '<option value="'+v+'">'+n+'</option>';
    }).join("");
  } else {
    el.innerHTML='<option value="">'+lbl0+'</option>'+vals.map(function(v){return '<option>'+v+'</option>';}).join("");
  }
}
function deadlineInfo(r){
  const ver=r.ver||1;const days=ver===1?CFG.d1:CFG.dn;
  if(!r.data_zloz)return{lbl:"‚Äî",remain:null,dlStr:"‚Äî"};
  const dl=addWd(r.data_zloz,days);if(!dl)return{lbl:"‚Äî",remain:null,dlStr:"‚Äî"};
  const remain=wdBetween(NOW,dl);
  const dlStr=fmtD(dl);
  let lbl;
  if(remain<0)lbl=`<span style="color:var(--red);font-weight:700">Przekr. o ${-remain}\u00a0d.r.</span>`;
  else if(remain<=3)lbl=`<span style="color:var(--yel)">${remain}\u00a0dni\u00a0rob.</span>`;
  else lbl=`<span style="color:var(--grn)">${remain}\u00a0dni\u00a0rob.</span>`;
  return{lbl,remain,dlStr};
}

// ‚îÄ‚îÄ‚îÄ OVERVIEW ‚îÄ‚îÄ‚îÄ
let chSt,chMies;
// ===== [JS-D] PRZEGLƒÑD OG√ìLNY ‚Äî buildOverview, buildAlerts, deadlineInfo =====

// ‚îÄ‚îÄ KOLUMNY DZIA≈ÅOWE ‚Äî wszystkie WNP w weryfikacji + w poprawie + HP, per dzia≈Ç ‚îÄ‚îÄ
function buildDzialCols(fw, fp){
  const TC={WNP:"var(--acc)",POP:"var(--orn)",HP:"var(--acc3)"};
  const TL={WNP:"Weryfikacja WNP",POP:"Poprawa WNP",HP:"Harmonogram p≈Çatno≈õci"};
  const ORD=["WNP","POP","HP"];

  // Zbierz wszystkie pozycje z opiekunem i dzia≈Çem
  const allItems=[];

  for(const r of fw){
    const effOp=getEffectiveProjOp(r.nr_proj).op||r.opiekun||"";
    if(!opiekInDzial(effOp))continue;
    const dz=CFG.opDzial[effOp]||"";
    const days=r.ver===1?CFG.d1:CFG.dn;
    const dl=addWd(r.data_zloz,days);
    const remain=dl?wdBetween(NOW,dl):null;
    allItems.push({type:"WNP",dz,ben:r.beneficjent,nr:r.nr_proj,
      detail:`${r.nr_wn&&!r.nr_wn.startsWith("__")?r.nr_wn:r.nr_proj} ¬∑ wer.${r.ver||1}${dl?" ¬∑ termin "+fmtD(dl):""}`,
      op:effOp, remain, page:"wer"});
  }

  for(const r of fp){
    const effOp=getEffectiveProjOp(r.nr_proj).op||r.opiekun||"";
    if(!opiekInDzial(effOp))continue;
    const dz=CFG.opDzial[effOp]||"";
    const dl=addWd(r.data_zloz,CFG.dp);
    const remain=dl?wdBetween(NOW,dl):null;
    allItems.push({type:"POP",dz,ben:r.beneficjent,nr:r.nr_proj,
      detail:`${r.nr_wn&&!r.nr_wn.startsWith("__")?r.nr_wn:r.nr_proj}${dl?" ¬∑ termin poprawy "+fmtD(dl):""}`,
      op:effOp, remain, page:"pop"});
  }

  for(const r of RAW.hp_wer){
    const nr=r["Numer projektu"];if(!projInScope(nr))continue;
    const effOp=getEffectiveProjOp(nr).op||(RAW.arpk_map[nr]||{}).opiekun||"";
    if(!opiekInDzial(effOp))continue;
    const dz=CFG.opDzial[effOp]||"";
    const dl=r["Data przes≈Çania"]?addWd(r["Data przes≈Çania"],5):null;
    const remain=dl?wdBetween(NOW,dl):null;
    allItems.push({type:"HP",dz,ben:r["Beneficjent Nazwa"]||nr,nr,
      detail:`HP ver.${r["Numer wersji harmonogramu"]||"?"}${dl?" ¬∑ termin "+fmtD(dl):""}`,
      op:effOp, remain, page:"hp"});
  }

  // Sort each group: overdue first, then by remain asc
  allItems.sort((a,b)=>{
    const aOv=a.remain!==null&&a.remain<0;
    const bOv=b.remain!==null&&b.remain<0;
    if(aOv!==bOv) return aOv?-1:1;
    return (a.remain??99)-(b.remain??99);
  });

  // Partition by dzia≈Ç (1,2,3); no-dzia≈Ç ‚Üí osobna grupa lub ignorowana
  const grp={"1":[],"2":[],"3":[],"":[]};
  for(const it of allItems){
    const k=(it.dz==="1"||it.dz==="2"||it.dz==="3")?it.dz:"";
    grp[k].push(it);
  }
  // Do≈ÇƒÖcz nieprzypisanych do dzia≈Çu 1 jako fallback
  grp["1"]=[...grp["1"],...grp[""]];

  function renderCol(elId, items){
    const el=document.getElementById(elId);
    if(!el) return;
    if(!items.length){
      el.innerHTML=`<div style="color:var(--txt3);font-size:.78rem;padding:8px 0;text-align:center">‚úì Brak projekt√≥w wymagajƒÖcych dzia≈Çania</div>`;
      return;
    }
    const byType={};
    for(const it of items){
      if(!byType[it.type]) byType[it.type]=[];
      byType[it.type].push(it);
    }
    let html="";
    let first=true;
    for(const tp of ORD){
      if(!byType[tp]||!byType[tp].length) continue;
      if(!first) html+=`<div style="border-top:1px solid var(--brd2);margin:9px 0 7px"></div>`;
      first=false;
      html+=`<div style="font-size:.63rem;font-weight:900;color:${TC[tp]};text-transform:uppercase;letter-spacing:.07em;margin-bottom:5px;display:flex;align-items:center;gap:5px">
        <span style="width:7px;height:7px;border-radius:50%;background:${TC[tp]};display:inline-block;flex-shrink:0"></span>${TL[tp]}
        <span style="margin-left:auto;font-size:.62rem;background:${TC[tp]}22;border:1px solid ${TC[tp]}44;color:${TC[tp]};border-radius:9px;padding:1px 7px">${byType[tp].length}</span>
      </div>`;
      for(const it of byType[tp]){
        const isOv=it.remain!==null&&it.remain<0;
        const isUrgent=it.remain!==null&&it.remain>=0&&it.remain<=3;
        const brd=isOv?"var(--red)":isUrgent?"var(--yel)":"var(--brd2)";
        const remainTxt=it.remain===null?"":isOv?`<span style="color:var(--red);font-weight:700;font-family:var(--mono);font-size:.68rem">+${-it.remain}d.r.</span>`:`<span style="color:${isUrgent?"var(--yel)":"var(--txt3)"};font-family:var(--mono);font-size:.68rem">${it.remain}d.r.</span>`;
        html+=`<div style="border-left:2px solid ${brd};padding:5px 8px;margin-bottom:3px;background:var(--bg3);border-radius:0 5px 5px 0;cursor:pointer;transition:background .1s" onmouseover="this.style.background='var(--card)'" onmouseout="this.style.background='var(--bg3)'" onclick="showPage('${it.page}')">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:5px">
            <div style="font-size:.77rem;font-weight:700;color:var(--txt);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1">${it.ben}</div>
            ${remainTxt}
          </div>
          <div style="font-size:.67rem;color:var(--txt3);margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${it.detail}</div>
          <div style="font-size:.66rem;color:var(--txt2);margin-top:2px">üë§ ${opName(it.op)||"‚Äî"}</div>
        </div>`;
      }
    }
    el.innerHTML=html;
  }

  renderCol("proj-list-efsi",  grp["1"]);
  renderCol("proj-list-efsi2", grp["2"]);
  renderCol("proj-list-efsi3", grp["3"]);
  const c1=document.getElementById("dz1-cnt"),c2=document.getElementById("dz2-cnt"),c3=document.getElementById("dz3-cnt");
  if(c1)c1.textContent=grp["1"].length+" proj.";
  if(c2)c2.textContent=grp["2"].length+" proj.";
  if(c3)c3.textContent=grp["3"].length+" proj.";
}

function buildOverview(){
  // Filtrowanie z uwzglƒôdnieniem efektywnego opiekuna (nie tylko arpk_map)
  function inScope(nr){
    const effOp=getEffectiveProjOp(nr).op||(RAW.arpk_map[nr]||{}).opiekun;
    if(effOp)return opiekInDzial(effOp);
    return opiekInDzial(null); // brak opiekuna ‚Äî przepu≈õƒá przy "Wszystkie"
  }
  const fw=RAW.wer.filter(r=>inScope(r.nr_proj));
  const fp=RAW.pop.filter(r=>inScope(r.nr_proj));
  const fz=RAW.zat.filter(r=>inScope(r.nr_proj));
  const fu=RAW.umowy.filter(u=>inScope(u.nr)&&u.ma_umowe);
  const ps=RAW.postep.filter(p=>inScope(p.nr));
  const opoC=ps.filter(p=>p.opozniony).length;
  const totalB=fu.reduce((s,u)=>s+(u.budzet||0),0);
  const totalZ=fz.reduce((s,r)=>s+(r.wyd_kwal||0),0);
  const arpkScores=Object.entries(RAW.arpk_map).filter(([nr])=>projInScope(nr)).map(([,v])=>getWeightedScore(v));
  const highRisk=arpkScores.filter(s=>s>=50).length;

  // KPI row
  document.getElementById("kpi-ov").innerHTML=`
    <div class="kpi b"><div class="kpi-l">Projekty z umowƒÖ</div><div class="kpi-v">${fu.length}</div></div>
    <div class="kpi r"><div class="kpi-l">W weryfikacji</div><div class="kpi-v">${fw.length}</div></div>
    <div class="kpi y"><div class="kpi-l">W poprawie</div><div class="kpi-v">${fp.length}</div></div>
    <div class="kpi g"><div class="kpi-l">Zatwierdzonych WNP</div><div class="kpi-v">${fz.length}</div></div>
    <div class="kpi o"><div class="kpi-l">Z op√≥≈∫nieniami fin.</div><div class="kpi-v">${opoC}</div><div class="kpi-s">odch.&gt;${CFG.opozn}pp</div></div>
    <div class="kpi p"><div class="kpi-l">Wysokie ryzyko aRPK</div><div class="kpi-v">${highRisk}</div><div class="kpi-s">aRPK‚â•50</div></div>
    <div class="kpi c"><div class="kpi-l">Bud≈ºet kwalif.</div><div class="kpi-v" style="font-size:1rem">${fmtK(totalB)}</div></div>
    <div class="kpi g"><div class="kpi-l">Rozliczone wyd.</div><div class="kpi-v" style="font-size:1rem">${fmtK(totalZ)}</div><div class="kpi-s">${totalB?(totalZ/totalB*100).toFixed(1):0}% bud≈ºetu</div></div>`;

  document.getElementById("tb-pcnt").textContent=fu.length;
  document.getElementById("snav-wer").textContent=fw.length;
  document.getElementById("snav-pop").textContent=fp.length;
  document.getElementById("snav-zat").textContent=fz.length;
  document.getElementById("snav-hp").textContent=RAW.hp_wer.length;

  // ‚îÄ‚îÄ DEADLINE ALERTS ‚îÄ‚îÄ
  buildAlerts(fw, fp);
  buildDzialCols(fw, fp);

  // ‚îÄ‚îÄ CHARTS ‚îÄ‚îÄ
  // ‚îÄ‚îÄ Wykres: Zatwierdzone wydatki miesiƒôcznie (wyd_kwal z RAW.zat, filtrowane) ‚îÄ‚îÄ
  const stMap={};fz.filter(r=>r.miesiac).forEach(r=>{
    if(!stMap[r.miesiac])stMap[r.miesiac]={w:0,c:0};
    stMap[r.miesiac].w+=r.wyd_kwal||0;
    stMap[r.miesiac].c++;
  });
  const stMs=Object.keys(stMap).sort();
  const stW=Math.max(500,stMs.length*38);
  document.getElementById("ch-st-inner").style.width=stW+"px";
  if(chSt)chSt.destroy();
  chSt=new Chart(document.getElementById("ch-st"),{type:"bar",
    plugins:[ChartDataLabels],
    data:{labels:stMs.map(m=>m.replace("-","/")),
    datasets:[
      {label:"Wyd.kwal.(mln)",data:stMs.map(m=>+(stMap[m].w/1e6).toFixed(2)),backgroundColor:"#3b82f680",borderColor:"#3b82f6",borderWidth:1,yAxisID:"y1",
        datalabels:{display:true,anchor:"end",align:"end",rotation:-90,color:"#7c8db5",font:{size:8,weight:"700"},formatter:v=>v>0?v+"M":"",clip:false,padding:{bottom:2},
          listeners:{beforeDraw:(ctx)=>{return ctx.chart.data.datasets[0].data[ctx.dataIndex]>0;}}}},
      {label:"Liczba WNP",data:stMs.map(m=>stMap[m].c),type:"line",borderColor:"#10b981",backgroundColor:"transparent",pointRadius:2,borderWidth:1.5,yAxisID:"y2",
        datalabels:{display:false}}
    ]},
    options:{responsive:true,maintainAspectRatio:false,
      layout:{padding:{top:22}},
      scales:{
        x:{ticks:{color:"#4a5578",font:{size:9},maxRotation:50}},
        y1:{position:"left",ticks:{color:"#7c8db5",font:{size:9},callback:v=>v+"M"},title:{display:true,text:"mln z≈Ç",color:"#7c8db5",font:{size:9}}},
        y2:{position:"right",ticks:{color:"#10b981",font:{size:9}},grid:{display:false}}
      },
      plugins:{legend:{labels:{color:"#7c8db5",font:{size:10},boxWidth:12}},datalabels:{display:true}}}});

  const mMap={};fz.filter(r=>r.miesiac).forEach(r=>{if(!mMap[r.miesiac])mMap[r.miesiac]={c:0,w:0};mMap[r.miesiac].c++;mMap[r.miesiac].w+=r.wyd_kwal||0;});
  const ms=Object.keys(mMap).sort();
  const iW=Math.max(500,ms.length*38);
  document.getElementById("ch-mies-inner").style.width=iW+"px";
  if(chMies)chMies.destroy();
  chMies=new Chart(document.getElementById("ch-mies"),{type:"bar",
    plugins:[ChartDataLabels],
    data:{labels:ms.map(m=>m.replace("-","/")),
    datasets:[
      {label:"Liczba WNP",data:ms.map(m=>mMap[m].c),backgroundColor:"#3b82f680",borderColor:"#3b82f6",borderWidth:1,yAxisID:"y1",
        datalabels:{display:true,anchor:"end",align:"end",rotation:-90,color:"#7c8db5",font:{size:8,weight:"700"},formatter:v=>v>0?String(v):"",clip:false,padding:{bottom:2}}},
      {label:"Wyd.kwal.(mln)",data:ms.map(m=>+(mMap[m].w/1e6).toFixed(2)),type:"line",borderColor:"#10b981",backgroundColor:"transparent",pointRadius:2,borderWidth:1.5,yAxisID:"y2",
        datalabels:{display:false}}
    ]},
    options:{responsive:true,maintainAspectRatio:false,
      layout:{padding:{top:22}},
      scales:{x:{ticks:{color:"#4a5578",font:{size:9},maxRotation:50}},y1:{position:"left",ticks:{color:"#7c8db5",font:{size:9}}},y2:{position:"right",ticks:{color:"#10b981",font:{size:9}},grid:{display:false}}},
      plugins:{legend:{labels:{color:"#7c8db5",font:{size:10},boxWidth:12}},datalabels:{display:true}}}});
}

function buildAlerts(fw, fp){
  const items=[];

  // WER ‚Äî deadline per wniosek
  for(const r of fw){
    if(!r.data_zloz)continue;
    const days=r.ver===1?CFG.d1:CFG.dn;
    const dl=addWd(r.data_zloz,days);if(!dl)continue;
    const remain=wdBetween(NOW,dl);
    const effOp=getEffectiveProjOp(r.nr_proj).op||r.opiekun||"‚Äî";
    if(!opiekInDzial(effOp))continue;
    const dzial=CFG.opDzial[effOp]||"";
    const base={type:"WNP",nr:r.nr_proj,ben:r.beneficjent,op:effOp,dzial,action:"Wer. wniosku",page:"wer"};
    if(remain<0)items.push({...base,urgency:"overdue",remain,detail:`${r.nr_wn||r.nr_proj} ¬∑ wer.${r.ver||1} ¬∑ termin up≈ÇynƒÖ≈Ç ${fmtD(dl)}`});
    else if(remain<=3)items.push({...base,urgency:"urgent",remain,detail:`${r.nr_wn||r.nr_proj} ¬∑ wer.${r.ver||1} ¬∑ termin ${fmtD(dl)}`});
  }

  // POP ‚Äî correction deadline
  for(const r of fp){
    if(!r.data_zloz)continue;
    const dl=addWd(r.data_zloz,CFG.dp);if(!dl)continue;
    const remain=wdBetween(NOW,dl);
    const effOp=getEffectiveProjOp(r.nr_proj).op||r.opiekun||"‚Äî";
    if(!opiekInDzial(effOp))continue;
    const dzial=CFG.opDzial[effOp]||"";
    const base={type:"POP",nr:r.nr_proj,ben:r.beneficjent,op:effOp,dzial,action:"Poprawa WNP",page:"pop"};
    if(remain<0)items.push({...base,urgency:"overdue",remain,detail:`${r.nr_wn||r.nr_proj} ¬∑ termin poprawy up≈ÇynƒÖ≈Ç ${fmtD(dl)}`});
    else if(remain<=3)items.push({...base,urgency:"urgent",remain,detail:`${r.nr_wn||r.nr_proj} ¬∑ termin poprawy ${fmtD(dl)}`});
  }

  // HP ‚Äî 5 day deadline
  for(const r of RAW.hp_wer){
    const nr=r["Numer projektu"];if(!projInScope(nr))continue;
    if(!r["Data przes≈Çania"])continue;
    const dl=addWd(r["Data przes≈Çania"],5);if(!dl)continue;
    const remain=wdBetween(NOW,dl);
    const effOp=getEffectiveProjOp(nr).op||(RAW.arpk_map[nr]||{}).opiekun||"‚Äî";
    if(!opiekInDzial(effOp))continue;
    const dzial=CFG.opDzial[effOp]||"";
    const base={type:"HP",nr,ben:r["Beneficjent Nazwa"]||nr,op:effOp,dzial,action:"Wer. harmonogramu",page:"hp"};
    if(remain<0)items.push({...base,urgency:"overdue",remain,detail:`HP ver.${r["Numer wersji harmonogramu"]||"?"} ¬∑ termin up≈ÇynƒÖ≈Ç ${fmtD(dl)}`});
    else if(remain<=3)items.push({...base,urgency:"urgent",remain,detail:`HP ver.${r["Numer wersji harmonogramu"]||"?"} ¬∑ termin ${fmtD(dl)}`});
  }

  items.sort((a,b)=>a.urgency===b.urgency?a.remain-b.remain:a.urgency==="overdue"?-1:1);

  const overdueC=items.filter(i=>i.urgency==="overdue").length;
  const urgentC=items.filter(i=>i.urgency==="urgent").length;

  const cntEl=document.getElementById("ov-alerts-counts");
  if(cntEl){
    if(overdueC)cntEl.innerHTML=`<span style="color:var(--red);font-weight:700">üî¥ ${overdueC} po terminie</span>${urgentC?` &nbsp;¬∑&nbsp; <span style="color:var(--yel);font-weight:700">üü° ${urgentC} pilne</span>`:""}`;
    else if(urgentC)cntEl.innerHTML=`<span style="color:var(--yel);font-weight:700">üü° ${urgentC} up≈Çywa w ciƒÖgu 3 d.r.</span>`;
    else cntEl.innerHTML=`<span style="color:var(--grn)">‚úì Brak pilnych</span>`;
  }

  const typeColor={WNP:"var(--acc)",POP:"var(--orn)",HP:"var(--acc3)"};
  const typeBg={WNP:"#3b82f614",POP:"#fb923c14",HP:"#8b5cf614"};
  const dzialColor={"1":"var(--acc)","2":"var(--acc2)","3":"var(--acc3)"};

  const el=document.getElementById("ov-alerts");
  if(!items.length){
    el.innerHTML=`<div style="text-align:center;padding:28px;color:var(--grn);font-size:.9rem">‚úì Brak przekroczonych lub zbli≈ºajƒÖcych siƒô termin√≥w</div>`;
    return;
  }

  el.innerHTML=`
    <div style="display:flex;gap:8px;margin-bottom:11px;flex-wrap:wrap;align-items:center">
      ${overdueC?`<span style="background:#f43f5e18;border:1px solid #f43f5e40;color:var(--red);border-radius:5px;padding:4px 13px;font-size:.78rem;font-weight:700">üî¥ ${overdueC} przekroczony${overdueC===1?"":overdueC<5?"e":"ch"} termin${overdueC===1?"":"y"}</span>`:""}
      ${urgentC?`<span style="background:#f59e0b18;border:1px solid #f59e0b40;color:var(--yel);border-radius:5px;padding:4px 13px;font-size:.78rem;font-weight:700">üü° ${urgentC} up≈Çywa w ciƒÖgu 3 dni roboczych</span>`:""}
      <span style="font-size:.72rem;color:var(--txt3);margin-left:auto">Kliknij wiersz ‚Üí przejd≈∫ do modu≈Çu</span>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px">
    ${items.map(it=>{
      const isOv=it.urgency==="overdue";
      const brd=isOv?"var(--red)":"var(--yel)";
      const remainLbl=isOv
        ?`<span style="color:var(--red);font-weight:700;font-family:var(--mono);font-size:.78rem">+${-it.remain} d.r.</span>`
        :`<span style="color:var(--yel);font-weight:700;font-family:var(--mono);font-size:.78rem">${it.remain} d.r.</span>`;
      const DZ_FULL={"1":"Dzia≈Ç EFS I","2":"Dzia≈Ç EFS II","3":"Dzia≈Ç EFS III"};const dzialLbl=it.dzial?`<span style="font-size:.62rem;color:${dzialColor[it.dzial]||"var(--txt3)"};font-weight:700;text-transform:uppercase;letter-spacing:.04em">${DZ_FULL[it.dzial]||"Dzia≈Ç EFS "+it.dzial}</span>`:"";
      return`<div style="background:var(--card);border:1px solid ${brd}28;border-left:3px solid ${brd};border-radius:6px;padding:8px 11px;display:flex;flex-direction:column;gap:5px;cursor:pointer;transition:background .1s" onmouseover="this.style.background='var(--bg3)'" onmouseout="this.style.background='var(--card)'" onclick="showPage('${it.page}')">
        <div style="display:flex;align-items:center;gap:7px">
          <span style="background:${typeBg[it.type]};color:${typeColor[it.type]};border:1px solid ${typeColor[it.type]}28;border-radius:4px;padding:2px 7px;font-size:.68rem;font-weight:700;white-space:nowrap;flex-shrink:0">${it.type}</span>
          <div style="font-size:.84rem;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1">${it.ben}</div>
          <div style="flex-shrink:0;text-align:right">${remainLbl}<div style="font-size:.65rem;color:var(--txt3)">${isOv?"po terminie":"pozosta≈Ço"}</div></div>
        </div>
        <div style="font-size:.7rem;color:var(--txt3);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${it.detail}</div>
        <div style="display:flex;align-items:center;gap:6px;border-top:1px solid var(--brd);padding-top:5px;margin-top:1px">
          <span style="font-size:.68rem;color:var(--txt2);font-weight:600;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">üë§ ${opName(it.op)}</span>
          ${dzialLbl}
          <span style="font-size:.62rem;color:var(--txt3);background:var(--bg3);border:1px solid var(--brd);border-radius:3px;padding:1px 5px;white-space:nowrap;flex-shrink:0">${it.action}</span>
        </div>
      </div>`;
    }).join("")}
    </div>`;

}


// ‚îÄ‚îÄ‚îÄ W WERYFIKACJI ‚îÄ‚îÄ‚îÄ
let WER_SORT={col:null,dir:1};
function werDzialChange(){
  const dz=document.getElementById("fw-dz").value;
  populateSelByDzial("fw-op",RAW.wer,"opiekun",dz);
  renderWer();
}
function sortWer(col){
  if(WER_SORT.col===col)WER_SORT.dir*=-1;else{WER_SORT.col=col;WER_SORT.dir=1;}
  document.querySelectorAll('[id^="sw-"]').forEach(el=>el.textContent="");
  const el=document.getElementById("sw-"+col);if(el)el.textContent=WER_SORT.dir===1?" ‚ñ≤":" ‚ñº";
  renderWer();
}
// ===== [JS-E] WERYFIKACJA I POPRAWA WNP ‚Äî buildWer, renderWer, buildPop, renderPop =====
function buildWer(){populateSel("fw-op",RAW.wer.map(r=>({opiekun:getEffectiveProjOp(r.nr_proj).op||r.opiekun})),"opiekun");renderWer();}
function renderWer(pg=1){
  const srch=document.getElementById("fw-s").value.toLowerCase(),op=document.getElementById("fw-op").value,st=document.getElementById("fw-st").value,term=document.getElementById("fw-term").value,arpkF=document.getElementById("fw-arpk").value,dz=document.getElementById("fw-dz").value;
  let f=RAW.wer.filter(r=>{const _effOp=getEffectiveProjOp(r.nr_proj).op||r.opiekun;if(dz&&!dzialFilter(_effOp,dz))return false;if(!projInScope(r.nr_proj))return false;if(op&&_effOp!==op)return false;if(st&&r.status!==st)return false;const sc=getWeightedScore(RAW.arpk_map[r.nr_proj]||{});if(arpkF&&arpkLevel(sc)!==arpkF)return false;if(srch&&!`${r.nr_proj} ${r.beneficjent} ${r.nr_wn}`.toLowerCase().includes(srch))return false;if(term){const{remain}=deadlineInfo(r);if(term==="ok"&&remain!==null&&remain<0)return false;if(term==="late"&&(remain===null||remain>=0))return false;}return true;});
  // Add computed cols for sort
  f=f.map(r=>{const sc=getWeightedScore(RAW.arpk_map[r.nr_proj]||{});const{remain}=deadlineInfo(r);return{...r,_arpk:sc,_wd:remain===null?9999:remain};});
  if(WER_SORT.col){const col=WER_SORT.col,dir=WER_SORT.dir;f.sort((a,b)=>{const av=a[col]??'';const bv=b[col]??'';return typeof av==='number'?( av-bv)*dir:String(av).localeCompare(String(bv),'pl')*dir;});}
  const lateCnt=f.filter(r=>r._wd!==null&&r._wd<0).length;
  document.getElementById("kpi-wer").innerHTML=`<div class="kpi r"><div class="kpi-l">W weryfikacji</div><div class="kpi-v">${f.length}</div></div><div class="kpi y"><div class="kpi-l">Przekroczony termin</div><div class="kpi-v">${lateCnt}</div></div><div class="kpi b"><div class="kpi-l">Wyd.kwal.</div><div class="kpi-v" style="font-size:.96rem">${fmtK(f.reduce((s,r)=>s+(r.wyd_kwal||0),0))}</div></div><div class="kpi c"><div class="kpi-l">Zaliczki</div><div class="kpi-v" style="font-size:.96rem">${fmtK(f.reduce((s,r)=>s+(r.zaliczka||0),0))}</div></div>`;
  document.getElementById("info-wer").textContent=`${f.length} wniosk√≥w`;
  const PP=20,sl=f.slice((pg-1)*PP,pg*PP);
  document.getElementById("tb-wer").innerHTML=sl.map(r=>{const{lbl,dlStr}=deadlineInfo(r);const ab=arpkBadge(r._arpk);return`<tr onclick="showDetail(${JSON.stringify({...r,_wd:undefined,_arpk:undefined}).replace(/"/g,"&quot;")})"><td class="mono" style="font-size:.85rem">${clamp(r.nr_proj,28)}</td><td><div class="clamp">${clamp(r.beneficjent,26)}</div></td><td class="mono" style="font-size:.71rem;white-space:normal;min-width:200px;line-height:1.3">${r.nr_wn&&!r.nr_wn.startsWith('__ZAT__')?r.nr_wn:'‚Äî'}</td><td style="text-align:center">${badge(String(r.ver),r.ver===1?"b":"y")}</td><td>${badge(r.status)}</td><td class="mono" style="font-size:.85rem">${fmtD(r.data_zloz)}</td><td class="mono" style="font-size:.85rem">${dlStr}</td><td style="font-size:.85rem">${lbl}</td><td class="nr mono" style="font-size:.85rem">${fmtK(r.zaliczka)}</td><td class="nr mono" style="font-size:.85rem">${fmtK(r.refundacja)}</td><td class="nr mono" style="font-size:.85rem">${fmtK(r.wyd_kwal)}</td><td class="nr mono" style="font-size:.85rem">${fmtK(r.dofinansowanie)}</td><td class="nr mono" style="font-size:.85rem">${fmtK(r.wklad_wlasny)}</td><td class="mono" style="font-size:.85rem">${opName(getEffectiveProjOp(r.nr_proj).op||r.opiekun)}</td><td>${ab.badge}</td></tr>`;}).join("")||"<tr><td colspan='15' class='empty'>Brak wynik√≥w</td></tr>";
  renderPager("pg-wer",pg,Math.ceil(f.length/PP),p=>renderWer(p));
}

// ‚îÄ‚îÄ‚îÄ W POPRAWIE ‚îÄ‚îÄ‚îÄ
let POP_SORT={col:null,dir:1};
function popDzialChange(){
  const dz=document.getElementById("fp-dz").value;
  populateSelByDzial("fp-op",RAW.pop,"opiekun",dz);
  renderPop();
}
function sortPop(col){
  if(POP_SORT.col===col)POP_SORT.dir*=-1;else{POP_SORT.col=col;POP_SORT.dir=1;}
  document.querySelectorAll('[id^="sp-"]').forEach(el=>el.textContent="");
  const el=document.getElementById("sp-"+col);if(el)el.textContent=POP_SORT.dir===1?" ‚ñ≤":" ‚ñº";
  renderPop();
}
function buildPop(){populateSel("fp-op",RAW.pop.map(r=>({opiekun:getEffectiveProjOp(r.nr_proj).op||r.opiekun})),"opiekun");renderPop();}
function renderPop(pg=1){
  const srch=document.getElementById("fp-s").value.toLowerCase(),op=document.getElementById("fp-op").value,fl=document.getElementById("fp-fl").value,dz=document.getElementById("fp-dz").value;
  let f=RAW.pop.filter(r=>{const _effOp=getEffectiveProjOp(r.nr_proj).op||r.opiekun;if(dz&&!dzialFilter(_effOp,dz))return false;if(!projInScope(r.nr_proj))return false;if(op&&_effOp!==op)return false;if(srch&&!`${r.nr_proj} ${r.beneficjent} ${r.nr_wn}`.toLowerCase().includes(srch))return false;return true;}).map(r=>{const wd=wdSince(r.data_zloz)||0;const sc=getWeightedScore(RAW.arpk_map[r.nr_proj]||{});return{...r,wd,over:wd>CFG.dp,_arpk:sc};});
  if(fl==="ok")f=f.filter(r=>!r.over);if(fl==="late")f=f.filter(r=>r.over);
  if(POP_SORT.col){const col=POP_SORT.col,dir=POP_SORT.dir;f.sort((a,b)=>{const av=a[col]??'';const bv=b[col]??'';return typeof av==='number'?( av-bv)*dir:String(av).localeCompare(String(bv),'pl')*dir;});}
  document.getElementById("kpi-pop").innerHTML=`<div class="kpi o"><div class="kpi-l">W poprawie</div><div class="kpi-v">${f.length}</div></div><div class="kpi r"><div class="kpi-l">Przeterminowane</div><div class="kpi-v">${f.filter(r=>r.over).length}</div><div class="kpi-s">&gt;${CFG.dp}\u00a0d.r.</div></div><div class="kpi b"><div class="kpi-l">Wyd.kwal.</div><div class="kpi-v" style="font-size:.96rem">${fmtK(f.reduce((s,r)=>s+(r.wyd_kwal||0),0))}</div></div>`;
  document.getElementById("info-pop").textContent=`${f.length} wniosk√≥w`;
  const PP=20,sl=f.slice((pg-1)*PP,pg*PP);
  document.getElementById("tb-pop").innerHTML=sl.map(r=>{const ocena=r.over?`<span class="badge br">PRZETERMINOWANY</span>`:`<span class="badge bg">W terminie</span>`;const wdC=r.over?"var(--red)":r.wd>CFG.dp-2?"var(--yel)":"var(--grn)";return`<tr onclick="showDetail(${JSON.stringify({...r,over:undefined,_arpk:undefined}).replace(/"/g,"&quot;")})"><td class="mono" style="font-size:.85rem">${clamp(r.nr_proj,28)}</td><td><div class="clamp">${clamp(r.beneficjent,26)}</div></td><td class="mono" style="font-size:.71rem;white-space:normal;min-width:200px;line-height:1.3">${r.nr_wn&&!r.nr_wn.startsWith('__ZAT__')?r.nr_wn:'‚Äî'}</td><td style="text-align:center;font-size:.85rem">${badge(String(r.ver),r.ver===1?"b":"y")}</td><td style="font-size:.85rem">${badge(r.status)}</td><td class="mono" style="font-size:.85rem">${fmtD(r.data_zloz)}</td><td style="text-align:center;font-family:var(--mono);font-size:.85rem;color:${wdC};font-weight:700">${r.wd}</td><td style="font-size:.85rem">${ocena}</td><td class="nr mono" style="font-size:.85rem">${fmtK(r.zaliczka||0)}</td><td class="nr mono" style="font-size:.85rem">${fmtK(r.refundacja||0)}</td><td class="nr mono" style="font-size:.85rem">${fmtK(r.wyd_kwal)}</td><td class="nr mono" style="font-size:.85rem">${fmtK(r.dofinansowanie||0)}</td><td class="nr mono" style="font-size:.85rem">${fmtK(r.wklad_wlasny||0)}</td><td class="mono" style="font-size:.85rem">${opName(getEffectiveProjOp(r.nr_proj).op||r.opiekun)}</td><td>${arpkBadge(r._arpk).badge}</td></tr>`;}).join("")||"<tr><td colspan='15' class='empty'>Brak wynik√≥w</td></tr>";
  renderPager("pg-pop",pg,Math.ceil(f.length/PP),p=>renderPop(p));
}

// ‚îÄ‚îÄ‚îÄ ZATWIERDZONE ‚îÄ‚îÄ‚îÄ
let ZAT_SORT={col:null,dir:1};
let selMonths=new Set();
function zatDzialChange(){
  const dz=document.getElementById("fz-dz").value;
  populateSelByDzial("fz-op",RAW.zat,"opiekun",dz);
  renderZat();
}
function sortZat(col){
  if(ZAT_SORT.col===col)ZAT_SORT.dir*=-1;else{ZAT_SORT.col=col;ZAT_SORT.dir=1;}
  document.querySelectorAll('[id^="sz-"]').forEach(el=>el.textContent="");
  const el=document.getElementById("sz-"+col);if(el)el.textContent=ZAT_SORT.dir===1?" ‚ñ≤":" ‚ñº";
  renderZat();
}
// ===== [JS-F] ZATWIERDZONE WNP ‚Äî buildZat, renderZat, sortZat, toggleM =====
// Rejestr grup miesiƒôcy ‚Äî unika JSON w onclick (problem z HTML escaping cudzys≈Çowi√≥w)
const _ZAT_GROUPS={};
function buildZat(){
  const months=[...new Set(RAW.zat.filter(r=>r.miesiac).map(r=>r.miesiac))].sort().reverse();
  const curYear=NOW.getFullYear();
  const prevYear=curYear-1;
  Object.keys(_ZAT_GROUPS).forEach(k=>delete _ZAT_GROUPS[k]);
  let pillsHtml='';
  const curYearMonths=months.filter(m=>m.startsWith(String(curYear)));
  const prevYearMonths=months.filter(m=>m.startsWith(String(prevYear)));
  const olderYears=[...new Set(months.filter(m=>parseInt(m.slice(0,4))<prevYear).map(m=>m.slice(0,4)))].sort().reverse();
  if(curYearMonths.length>0){
    pillsHtml+=`<span style="font-size:.65rem;font-weight:900;color:var(--txt3);text-transform:uppercase;letter-spacing:.08em;align-self:center">${curYear}</span>`;
    pillsHtml+=curYearMonths.map(m=>`<div class="mp" onclick="toggleM('${m}')" id="mp-${m.replace('-','_')}">${m.slice(5).replace(/^0/,'')}</div>`).join('');
  }
  if(prevYearMonths.length>0){
    const quarters={Q1:['01','02','03'],Q2:['04','05','06'],Q3:['07','08','09'],Q4:['10','11','12']};
    pillsHtml+=`<span style="font-size:.65rem;font-weight:900;color:var(--txt3);text-transform:uppercase;letter-spacing:.08em;align-self:center;margin-left:4px">${prevYear}</span>`;
    for(const [qName,qMonths] of Object.entries(quarters)){
      const qMs=prevYearMonths.filter(m=>qMonths.includes(m.slice(5)));
      if(!qMs.length)continue;
      const gid='q_'+prevYear+'_'+qName;
      _ZAT_GROUPS[gid]=qMs;
      pillsHtml+=`<div class="mp" id="${gid}" onclick="toggleGroup('${gid}')">${qName}</div>`;
    }
  }
  if(olderYears.length>0){
    pillsHtml+=`<span style="font-size:.65rem;font-weight:900;color:var(--txt3);text-transform:uppercase;letter-spacing:.08em;align-self:center;margin-left:4px">wcze≈õniej</span>`;
    for(const yr of olderYears){
      const yMs=months.filter(m=>m.startsWith(yr));
      const gid='y_'+yr;
      _ZAT_GROUPS[gid]=yMs;
      pillsHtml+=`<div class="mp" id="${gid}" onclick="toggleGroup('${gid}')">${yr}</div>`;
    }
  }
  document.getElementById("mpills-zat").innerHTML=pillsHtml;
  populateSel("fz-op",RAW.zat.map(r=>({opiekun:getEffectiveProjOp(r.nr_proj).op||r.opiekun})),"opiekun");
  renderZat();
}
function toggleGroup(gid){
  const gMs=_ZAT_GROUPS[gid];if(!gMs||!gMs.length)return;
  const el=document.getElementById(gid);if(!el)return;
  const allOn=gMs.every(m=>selMonths.has(m));
  if(allOn){gMs.forEach(m=>selMonths.delete(m));el.classList.remove('on');}
  else{gMs.forEach(m=>selMonths.add(m));el.classList.add('on');}
  renderZat();
}
function toggleQuarter(yr,qName,qMs){toggleGroup('q_'+yr+'_'+qName);}
function toggleYear(yr){toggleGroup('y_'+yr);}
function toggleM(m){selMonths.has(m)?selMonths.delete(m):selMonths.add(m);document.getElementById("mp-"+m.replace("-","_")).classList.toggle("on",selMonths.has(m));renderZat();}
function renderZat(pg=1){
  const srch=document.getElementById("fz-s").value.toLowerCase(),op=document.getElementById("fz-op").value,dz=document.getElementById("fz-dz").value;
  let f=RAW.zat.filter(r=>{const _effOp=getEffectiveProjOp(r.nr_proj).op||r.opiekun;if(dz&&!dzialFilter(_effOp,dz))return false;if(!projInScope(r.nr_proj))return false;if(op&&_effOp!==op)return false;if(selMonths.size&&!selMonths.has(r.miesiac))return false;if(srch&&!`${r.nr_proj} ${r.beneficjent} ${r.nr_wn}`.toLowerCase().includes(srch))return false;return true;});
  if(ZAT_SORT.col){const col=ZAT_SORT.col,dir=ZAT_SORT.dir;f.sort((a,b)=>{const av=a[col]??'';const bv=b[col]??'';return typeof av==='number'?( av-bv)*dir:String(av).localeCompare(String(bv),'pl')*dir;});}
  document.getElementById("kpi-zat").innerHTML=`<div class="kpi g"><div class="kpi-l">WNP</div><div class="kpi-v">${f.length}</div></div><div class="kpi b"><div class="kpi-l">Wyd.kwal.</div><div class="kpi-v" style="font-size:.96rem">${fmtK(f.reduce((s,r)=>s+(r.wyd_kwal||0),0))}</div></div><div class="kpi c"><div class="kpi-l">Zaliczki</div><div class="kpi-v" style="font-size:.96rem">${fmtK(f.reduce((s,r)=>s+(r.zaliczka||0),0))}</div></div><div class="kpi p"><div class="kpi-l">Refundacje</div><div class="kpi-v" style="font-size:.96rem">${fmtK(f.reduce((s,r)=>s+(r.refundacja||0),0))}</div></div><div class="kpi y"><div class="kpi-l">Z korektƒÖ</div><div class="kpi-v">${f.filter(r=>r.korekty>0).length}</div></div>`;
  document.getElementById("info-zat").textContent=`${f.length} wniosk√≥w`;
  const PP=25,sl=f.slice((pg-1)*PP,pg*PP);
  document.getElementById("tb-zat").innerHTML=sl.map(r=>{const verMatch=r.nr_wn&&r.nr_wn.match(/-(\d{2,3})$/);const ver=verMatch?parseInt(verMatch[1]):1;const effOp=getEffectiveProjOp(r.nr_proj).op||r.opiekun;return`<tr onclick="showRozliczenieForProject('${r.nr_proj}')"><td class="mono" style="font-size:.85rem">${clamp(r.nr_proj,28)}</td><td><div class="clamp">${clamp(r.beneficjent,26)}</div></td><td class="mono" style="font-size:.85rem;white-space:normal;min-width:200px;line-height:1.3">${r.nr_wn&&!r.nr_wn.startsWith('__ZAT__')?r.nr_wn:'‚Äî'}</td><td style="text-align:center;font-size:.85rem">${badge(String(ver),ver===1?'b':'y')}</td><td class="mono" style="font-size:.85rem">${fmtD(r.data_wplywu||r.data_zloz)}</td><td class="mono" style="font-size:.85rem">${fmtD(r.data_zatw)}</td><td style="text-align:center;font-size:.85rem">${r.korekty>0?`<span class="badge by">${r.korekty}</span>`:`<span class="badge bgr">0</span>`}</td><td class="nr mono" style="font-size:.85rem">${fmtK(r.wyd_kwal)}</td><td class="nr mono" style="font-size:.85rem">${fmtK(r.wyd_uznane)}</td><td class="nr mono" style="font-size:.85rem">${fmtK(r.dofinansowanie)}</td><td class="nr mono" style="font-size:.85rem">${fmtK(r.zaliczka)}</td><td class="nr mono" style="font-size:.85rem">${fmtK(r.refundacja)}</td><td class="mono" style="font-size:.85rem">${opName(effOp)}</td></tr>`;}).join("")||"<tr><td colspan='14' class='empty'>Brak wynik√≥w</td></tr>";
  renderPager("pg-zat",pg,Math.ceil(f.length/PP),p=>renderZat(p));
}

// ‚îÄ‚îÄ‚îÄ RPK ‚îÄ‚îÄ‚îÄ
let RPK_SORT={col:null,dir:1};
function sortRpk(col){
  if(RPK_SORT.col===col)RPK_SORT.dir*=-1;else{RPK_SORT.col=col;RPK_SORT.dir=1;}
  document.querySelectorAll('[id^="srp-"]').forEach(el=>el.textContent="");
  const el=document.getElementById("srp-"+col);if(el)el.textContent=RPK_SORT.dir===1?" ‚ñ≤":" ‚ñº";
  renderRpk();
}
// ===== [JS-G] RPK / POSTƒòP FINANSOWY I RZECZOWY ‚Äî buildRpk, buildPostep, buildRzeczowy =====
function buildRpk(){populateSel("fr-op",RAW.rpk.map(r=>({opiekun:getEffectiveProjOp(r.nr_proj).op||r.opiekun})),"opiekun");renderRpk();}
function renderRpk(pg=1){
  const srch=document.getElementById("fr-s").value.toLowerCase(),op=document.getElementById("fr-op").value,fl=document.getElementById("fr-fl").value,dz=document.getElementById("fr-dz").value;
  let f=RAW.rpk.filter(r=>{const _effOp=getEffectiveProjOp(r.nr_proj).op||r.opiekun;if(dz&&!dzialFilter(_effOp,dz))return false;if(!projInScope(r.nr_proj))return false;if(op&&_effOp!==op)return false;if(fl==="kor"&&r.ver_count<2)return false;if(fl==="bez"&&r.ver_count>1)return false;if(srch&&!`${r.nr_proj} ${r.beneficjent}`.toLowerCase().includes(srch))return false;return true;});
  if(RPK_SORT.col){const col=RPK_SORT.col,dir=RPK_SORT.dir;f.sort((a,b)=>{const av=a[col]??'';const bv=b[col]??'';return typeof av==='number'?( av-bv)*dir:String(av).localeCompare(String(bv),'pl')*dir;});}
  document.getElementById("kpi-rpk").innerHTML=`<div class="kpi b"><div class="kpi-l">Wniosk√≥w (baza)</div><div class="kpi-v">${f.length}</div></div><div class="kpi y"><div class="kpi-l">Z korektƒÖ</div><div class="kpi-v">${f.filter(r=>r.ver_count>1).length}</div></div><div class="kpi ${f.reduce((s,r)=>s+r.diff,0)<0?"r":"g"}"><div class="kpi-l">≈ÅƒÖczna r√≥≈ºnica</div><div class="kpi-v" style="font-size:.96rem">${fmtK(f.reduce((s,r)=>s+r.diff,0))}</div></div>`;
  document.getElementById("info-rpk").textContent=`${f.length} wniosk√≥w`;
  const PP=20,sl=f.slice((pg-1)*PP,pg*PP);
  document.getElementById("tb-rpk").innerHTML=sl.map(r=>{const dc=r.diff<-1000?"br":r.diff>1000?"bg":"bgr";const sc=getWeightedScore(RAW.arpk_map[r.nr_proj]||{});return`<tr onclick="showDetail(${JSON.stringify(r).replace(/"/g,"&quot;")})"><td class="mono" style="font-size:.85rem">${clamp(r.nr_proj,28)}</td><td><div class="clamp">${clamp(r.beneficjent,26)}</div></td><td class="mono" style="font-size:.71rem">${r.nr_wn_base||"‚Äî"}</td><td style="text-align:center;font-size:.85rem">${badge(String(r.ver_count),r.ver_count===1?"gr":"y")}</td><td class="nr mono" style="font-size:.85rem">${fmtK(r.wyd_v1)}</td><td class="nr mono" style="font-size:.85rem">${fmtK(r.wyd_vl)}</td><td class="nr" style="font-size:.85rem"><span class="badge ${dc}">${r.diff>=0?"+":""}${fmtK(r.diff)}</span></td><td class="nr" style="font-size:.85rem"><span class="badge ${dc}">${r.diff>=0?"+":""}${r.diff_pct}%</span></td><td class="mono" style="font-size:.85rem">${opName(r.opiekun)}</td><td>${arpkBadge(sc).badge}</td></tr>`;}).join("")||"<tr><td colspan='10' class='empty'>Brak wynik√≥w</td></tr>";
  renderPager("pg-rpk",pg,Math.ceil(f.length/PP),p=>renderRpk(p));
}

// ‚îÄ‚îÄ‚îÄ POSTEP FINANSOWY ‚îÄ‚îÄ‚îÄ
function buildPostep(){populateSel("fpost-op",RAW.postep,"opiekun");document.getElementById("postep-od-lbl").textContent=CFG.postepOd==="umowa"?"podpisania umowy":"rozpoczƒôcia projektu";renderPostep();}
function postepScoreBadge(sc,ryczalt){
  if(ryczalt)return`<span class="badge bg" title="Projekt rycza≈Çtowy ‚Äî max ocena">‚¨° 20/20</span>`;
  if(sc==null)return`<span class="badge bgr-h">‚Äî/20</span>`;
  const c=sc>=15?"bg":sc>=8?"by":"br";
  return`<span class="badge ${c}" title="Ocena postƒôpu finansowego">‚¨° ${sc}/20</span>`;
}
function renderPostep(pg=1){
  const srch=document.getElementById("fpost-s").value.toLowerCase(),fl=document.getElementById("fpost-fl").value,op=document.getElementById("fpost-op").value,dz=document.getElementById("fpost-dz").value;
  const useOd=CFG.postepOd==="umowa";
  let f=RAW.postep.filter(p=>{const _effOp=getEffectiveProjOp(p.nr).op||p.opiekun;if(dz&&!dzialFilter(_effOp,dz))return false;if(!projInScope(p.nr))return false;if(op&&_effOp!==op)return false;if(fl==="late"&&!p.opozniony)return false;if(fl==="ok"&&p.opozniony)return false;if(srch&&!`${p.nr} ${p.beneficjent}`.toLowerCase().includes(srch))return false;return true;});
  const ryczCnt=f.filter(p=>p.ryczalt).length;
  const aktywne=f.filter(p=>!p.ryczalt);
  const srAvg=aktywne.length?Math.round(aktywne.reduce((s,p)=>s+(p.score_postep||0),0)/aktywne.length*10)/10:0;
  document.getElementById("kpi-postep").innerHTML=`<div class="kpi b"><div class="kpi-l">Projekt√≥w</div><div class="kpi-v">${f.length}</div></div><div class="kpi r"><div class="kpi-l">Z op√≥≈∫nieniami</div><div class="kpi-v">${aktywne.filter(p=>p.opozniony).length}</div><div class="kpi-s">odch.&gt;${CFG.opozn}pp</div></div><div class="kpi g"><div class="kpi-l">Terminowe</div><div class="kpi-v">${aktywne.filter(p=>!p.opozniony).length}</div></div><div class="kpi y"><div class="kpi-l">≈ör. realizacja</div><div class="kpi-v">${aktywne.length?(aktywne.reduce((s,p)=>s+(p.poziom_fakt||0),0)/aktywne.length).toFixed(1):0}%</div></div><div class="kpi c"><div class="kpi-l">≈ör. score</div><div class="kpi-v">${srAvg}/20</div></div><div class="kpi p"><div class="kpi-l">Rycza≈Çtowe</div><div class="kpi-v">${ryczCnt}</div><div class="kpi-s">max score</div></div>`;
  const sl=f.slice((pg-1)*15,pg*15);
  document.getElementById("postep-list").innerHTML=sl.map(p=>{
    const pog=p.poziom_fakt!=null?p.poziom_fakt:0;
    const pop=(useOd?p.poziom_plan_umowa:p.poziom_plan_proj)||0;
    const barC=p.opozniony?"var(--red)":pog>=pop?"var(--grn)":"var(--acc)";
    const ab=arpkBadge(getWeightedScore(RAW.arpk_map[p.nr]||{}));
    const sb=postepScoreBadge(p.score_postep,p.ryczalt);
    const mies=useOd?p.mies_od_umowy:p.mies_od_proj;
    const kwotaMc=useOd?p.kwota_na_mc_umowy:p.kwota_na_mc_proj;
    const miesInfo=mies!=null?`${mies} mies.`:"‚Äî";
    const mcInfo=kwotaMc?fmtPLN(kwotaMc)+"/mies.":"‚Äî";
    // Tabela zada≈Ñ: nr | nazwa | planowane (UDA) | poniesione (WNP)
    const hasPon=p.zadania&&p.zadania.some(z=>z.poniesione!=null);
    const hasPlan=p.zadania&&p.zadania.some(z=>z.planowane!=null);
    const zadList=(p.zadania||[]).filter(z=>z.planowane!=null||z.poniesione!=null||z.nazwa);
    // LP: zadania z nr_zad zachowujƒÖ sw√≥j numer; bez nr_zad (koszty po≈õrednie) dostajƒÖ kolejny po max
    const maxNr=Math.max(0,...zadList.map(z=>z.nr_zad||0));
    let nullIdx=0;
    const zadFinal=zadList.map(z=>({...z,_lp:z.nr_zad!=null?z.nr_zad:maxNr+(++nullIdx)}));
    const sumPlan=zadFinal.reduce((s,z)=>s+(z.planowane||0),0);
    const sumPon=zadFinal.reduce((s,z)=>s+(z.poniesione||0),0);
    const hasPonAny=zadFinal.some(z=>z.poniesione!=null);
    const sumPct=sumPlan>0?Math.min(100,sumPon/sumPlan*100):null;
    const zadRows=zadFinal.map(z=>{
      const nm=z.nazwa||"‚Äî";
      const plan=z.planowane!=null
        ?`<td class="zd-kwota" style="color:var(--acc2)">${fmtPLN(z.planowane)}</td>`
        :`<td class="zd-kwota" style="color:var(--txt3)">‚Äî</td>`;
      const pon=z.poniesione!=null
        ?`<td class="zd-kwota" style="color:var(--grn)">${fmtPLN(z.poniesione)}</td>`
        :`<td class="zd-kwota" style="color:var(--txt3)">‚Äî</td>`;
      const pct=z.planowane&&z.planowane>0?Math.min(100,(z.poniesione||0)/z.planowane*100):null;
      const pctC=pct==null?"var(--txt3)":pct>=100?"var(--grn)":pct>=50?"var(--acc)":"var(--yel)";
      const pctTxt=pct!=null?`<td class="zd-pct" style="color:${pctC}">${pct.toFixed(0)}%</td>`:`<td class="zd-pct" style="color:var(--txt3)">‚Äî</td>`;
      return`<tr><td class="zd-nr">${z._lp}</td><td class="zd-nazwa">${nm}</td>${plan}${pon}${pctTxt}</tr>`;
    }).join("");
    const sumPctC=sumPct==null?"var(--txt3)":sumPct>=100?"var(--grn)":sumPct>=50?"var(--acc)":"var(--yel)";
    const sumRow=`<tr style="font-weight:700;border-top:2px solid var(--brd2);background:var(--bg3)">
      <td class="zd-nr" style="color:var(--txt3)">Œ£</td>
      <td class="zd-nazwa" style="color:var(--txt);font-weight:800">Suma</td>
      <td class="zd-kwota" style="color:var(--acc2);font-weight:800">${sumPlan>0?fmtPLN(sumPlan):"‚Äî"}</td>
      <td class="zd-kwota" style="color:var(--grn);font-weight:800">${hasPonAny?fmtPLN(sumPon):"‚Äî"}</td>
      <td class="zd-pct" style="color:${sumPctC};font-weight:800">${sumPct!=null?sumPct.toFixed(0)+"%":"‚Äî"}</td>
    </tr>`;
    const zadTable=`<table class="zd-tbl"><thead><tr>
      <th class="zd-nr">#</th>
      <th class="zd-nazwa">Nazwa zadania</th>
      <th class="zd-kwota">Wydatki planowane</th>
      <th class="zd-kwota">Wydatki poniesione</th>
      <th class="zd-pct">%</th>
    </tr></thead><tbody>${zadRows||`<tr><td colspan="5" style="text-align:center;color:var(--txt3);padding:10px">Brak danych zada≈Ñ</td></tr>`}${sumRow}</tbody></table>`;
        // Sekcja finansowa (dla rycza≈Çtowych: uproszczona)
    let finSection;
    if(p.ryczalt){
      finSection=`<div style="font-size:.82rem;color:var(--txt3);padding:4px 0;font-style:italic">Projekt rycza≈Çtowy ‚Äî postƒôp finansowy nieobowiƒÖzkowy ¬∑ Ocena: <b>20/20</b></div>`;
    } else {
      finSection=`<div style="margin-bottom:4px"><div style="display:flex;gap:6px;align-items:center;margin-bottom:3px"><span style="font-size:.82rem;color:var(--txt3);min-width:115px">Rozliczono: ${pog.toFixed(1)}%</span><div class="prog" style="flex:1"><div class="prog-b" style="width:${Math.min(100,pog)}%;background:${barC}"></div></div></div><div style="display:flex;gap:6px;align-items:center"><span style="font-size:.82rem;color:var(--txt3);min-width:115px">Plan: ${pop.toFixed(1)}%</span><div class="prog" style="flex:1"><div class="prog-b" style="width:${Math.min(100,pop)}%;background:var(--yel);opacity:.5"></div></div></div></div>`;
    }
    return`<div class="pcard ${p.opozniony?"late":"ok"}" onclick="this.querySelector('.zd').classList.toggle('on')">
<div class="pcard-hdr"><div><div class="pcard-nr">${p.nr}</div><div class="pcard-nm">${clamp(p.beneficjent,50)}</div></div><div style="display:flex;gap:5px;align-items:center;flex-shrink:0">${p.ryczalt?`<span class="badge bc">RYCZA≈ÅT</span>`:p.opozniony?`<span class="badge br">OP√ì≈πNIENIE</span>`:`<span class="badge bg">OK</span>`}${sb}${ab.badge}<span class="badge bgr-h">${opName(getEffectiveProjOp(p.nr).op||p.opiekun)}</span></div></div>
<div class="pcard-meta"><span>Okres: <b>${fmtD(p.od)} ‚Äì ${fmtD(p.do)}</b></span><span>Bud≈ºet: <b>${fmtPLN(p.budzet)}</b></span><span>Rozliczono WNP: <b>${fmtPLN(p.rozliczone)}</b></span><span>Up≈Çynƒô≈Ço: <b>${miesInfo}</b></span><span>Oczekiwane/mies.: <b>${mcInfo}</b></span></div>
${finSection}
<div class="zd">${zadList.length?zadTable:`<div style="font-size:.82rem;color:var(--txt3);padding:6px 0">Brak danych zada≈Ñ ‚Äî wczytaj UDA.zad.rozliczenie i WNP.zad.rozliczone</div>`}</div>
<div style="font-size:.8rem;color:var(--txt3);margin-top:3px;text-align:right">‚ñº kliknij ‚Üí zadania</div></div>`;
  }).join("")||"<div class='empty'>Brak projekt√≥w</div>";
  renderPager("pg-postep",pg,Math.ceil(f.length/15),p=>renderPostep(p));
}

// ‚îÄ‚îÄ‚îÄ POSTEP RZECZOWY ‚îÄ‚îÄ‚îÄ
function buildRzeczowy(){populateSel("frz-op",Object.entries(RAW.arpk_map).map(([nr,v])=>({opiekun:v.opiekun})),"opiekun");renderRzeczowy();}
function renderRzeczowy(pg=1){
  const srch=document.getElementById("frz-s").value.toLowerCase(),op=document.getElementById("frz-op").value,fl=document.getElementById("frz-fl").value,dz=document.getElementById("frz-dz").value,wsk=document.getElementById("frz-wsk").value;
  let entries=Object.entries(RAW.wskazniki).filter(([nr])=>{
    if(!projInScope(nr))return false;
    const opk=(RAW.arpk_map[nr]||{}).opiekun||"";
    if(dz&&!dzialFilter(opk,dz))return false;
    if(op&&opk!==op)return false;
    const u=RAW.umowy.find(u=>u.nr===nr)||{};
    if(srch&&!`${nr} ${u.beneficjent||""}`.toLowerCase().includes(srch))return false;
    return true;
  }).map(([nr,w])=>({nr,w,u:RAW.umowy.find(u=>u.nr===nr)||{},opk:(RAW.arpk_map[nr]||{}).opiekun||"‚Äî"}));
  if(fl==="high")entries=entries.filter(e=>e.w.avg_prod>=70);
  else if(fl==="med")entries=entries.filter(e=>e.w.avg_prod>=30&&e.w.avg_prod<70);
  else if(fl==="low")entries=entries.filter(e=>e.w.avg_prod!=null&&e.w.avg_prod<30);
  else if(fl==="fin")entries=entries.filter(e=>e.w.zakoncz);
  entries.sort((a,b)=>(b.w.avg_prod||0)-(a.w.avg_prod||0));
  const avgAll=entries.length?entries.reduce((s,e)=>s+(e.w.avg_prod||0),0)/entries.length:0;
  document.getElementById("kpi-rzeczowy").innerHTML=`<div class="kpi b"><div class="kpi-l">Projekt√≥w z danymi</div><div class="kpi-v">${entries.length}</div></div><div class="kpi g"><div class="kpi-l">≈ör. real. produktu</div><div class="kpi-v">${avgAll.toFixed(1)}%</div></div><div class="kpi g"><div class="kpi-l">Realizacja ‚â•70%</div><div class="kpi-v">${entries.filter(e=>e.w.avg_prod>=70).length}</div></div><div class="kpi y"><div class="kpi-l">Realizacja 30-70%</div><div class="kpi-v">${entries.filter(e=>e.w.avg_prod>=30&&e.w.avg_prod<70).length}</div></div><div class="kpi r"><div class="kpi-l">Realizacja &lt;30%</div><div class="kpi-v">${entries.filter(e=>e.w.avg_prod!=null&&e.w.avg_prod<30).length}</div></div><div class="kpi p"><div class="kpi-l">Zako≈Ñczone</div><div class="kpi-v">${entries.filter(e=>e.w.zakoncz).length}</div></div>`;
  const sl=entries.slice((pg-1)*30,pg*30);
  document.getElementById("rzeczowy-list").innerHTML=sl.map(({nr,w,u,opk})=>{
    const avgP=w.avg_prod,avgR=w.avg_rez,avgA=w.avg_all;
    const colA=pctColor(avgA||0);const r4=w.r4_score;
    const wsksAll=(w.wskazniki||[]).filter(s=>!wsk||s.r===wsk);
    const wsksPro=wsksAll.filter(s=>s.r==='P');
    const wsksRez=wsksAll.filter(s=>s.r==='R');
    const rowPro=wsksPro.map(s=>{const c=pctColor(s.p);return`<tr><td><span class="badge bc" style="font-size:.55rem">PRO</span></td><td style="font-size:.91rem;color:var(--txt2)">${s.n}</td><td class="nr mono">${s.a}</td><td class="nr mono">${s.d}</td><td><div class="wsk-pct"><div class="wsk-pct-bar"><div class="wsk-pct-fill" style="width:${Math.min(100,s.p)}%;background:${c}"></div></div><span style="font-family:var(--mono);font-size:1.05rem;color:${c}">${s.p}%</span></div></td></tr>`;}).join('');
    const rowRez=wsksRez.map(s=>{const c=pctColor(s.p);return`<tr style="opacity:.75"><td><span class="badge bp" style="font-size:.55rem">REZ</span></td><td style="font-size:.91rem;color:var(--txt2)">${s.n}</td><td class="nr mono">${s.a}</td><td class="nr mono">${s.d}</td><td><div class="wsk-pct"><div class="wsk-pct-bar"><div class="wsk-pct-fill" style="width:${Math.min(100,s.p)}%;background:${c}"></div></div><span style="font-family:var(--mono);font-size:1.05rem;color:${c}">${s.p}%</span></div></td></tr>`;}).join('');
    const sepRow=wsksPro.length>0&&wsksRez.length>0?`<tr><td colspan="5" style="padding:3px 0;background:var(--bg3);border-bottom:2px solid var(--brd2)"><span style="font-size:.6rem;color:var(--txt3);padding:0 9px;text-transform:uppercase;letter-spacing:.08em;font-weight:900">‚Äî Wska≈∫niki rezultatu (informacyjnie) ‚Äî</span></td></tr>`:'';
    const wskRows=rowPro+sepRow+rowRez;
    const effOp=getEffectiveProjOp(nr).op||opk||"";
    const opInf=effOp&&effOp!=="‚Äî"?opFullInfo(effOp):null;
    const opLabel=opInf?(opInf.name!==effOp?opInf.name:effOp):null;
    const dzCode=effOp&&effOp!=="‚Äî"?CFG.opDzial[effOp]:'';
    const dzLabel=dzCode?`Dzia≈Ç EFS ${dzCode}`:'';
    return`<div class="proj-metric">
      <div class="pm-hdr" onclick="this.nextElementSibling.classList.toggle('on')">
        <div><div class="pm-nr">${nr}</div><div class="pm-name">${clamp(u.beneficjent||"‚Äî",55)}</div></div>
        <div class="pm-badges">
          ${w.zakoncz?`<span class="badge bgr">ZAKO≈ÉCZONY</span>`:""}
          <span class="badge" style="background:${pctColor(avgP||0)}18;color:${pctColor(avgP||0)};border:1px solid ${pctColor(avgP||0)}40">PRO ${avgP!=null?avgP+"%":"‚Äî"}</span>
          ${opLabel?`<span class="badge bgr-h" title="Opiekun projektu">${opLabel}</span>`:""}
          ${dzLabel?`<span class="badge bc" title="Dzia≈Ç">${dzLabel}</span>`:""}
        </div>
      </div>
      <div class="pm-body">
        <div class="pm-grid">
          <div class="pm-kpi"><div class="pm-kpi-l">≈ör. real. produktu (aRPK)</div><div class="pm-kpi-v" style="color:${pctColor(avgP||0)}">${avgP!=null?avgP+"%":"‚Äî"}</div></div>
          <div class="pm-kpi"><div class="pm-kpi-l">Wska≈∫niki produktu</div><div class="pm-kpi-v" style="color:${pctColor(avgP||0)}">${avgP!=null?avgP+"%":"‚Äî"} <span style="font-size:.81rem;color:var(--txt3)">(${w.cnt_prod})</span></div></div>
          <div class="pm-kpi"><div class="pm-kpi-l">Wska≈∫niki rezultatu</div><div class="pm-kpi-v" style="color:${pctColor(avgR||0)}">${avgR!=null?avgR+"%":"‚Äî"} <span style="font-size:.81rem;color:var(--txt3)">(${w.cnt_rez})</span></div></div>
        </div>
        <div class="pm-section"><div class="pm-sec-t">Wska≈∫niki <span style="color:var(--txt3);font-size:.92rem;text-transform:none;font-weight:400">(${wsksAll.length} z ${(w.wskazniki||[]).length})</span></div>
        <div class="of"><table class="wsk-tbl"><thead><tr><th>Typ</th><th>Nazwa wska≈∫nika</th><th class="nr">OsiƒÖgniƒôto</th><th class="nr">Cel</th><th>Realizacja</th></tr></thead><tbody>${wskRows||"<tr><td colspan='5' class='empty'>Brak wska≈∫nik√≥w</td></tr>"}</tbody></table></div></div>
      </div>
    </div>`;}).join("")||"<div class='empty'>Brak projekt√≥w z danymi wska≈∫nikowymi</div>";
  renderPager("pg-rzeczowy",pg,Math.ceil(entries.length/30),p=>renderRzeczowy(p));
}

// ‚îÄ‚îÄ‚îÄ HARMONOGRAMY ‚îÄ‚îÄ‚îÄ
// ===== [JS-H] HARMONOGRAMY P≈ÅATNO≈öCI ‚Äî buildHp, showHpTab, renderHWer, runSim =====
function buildHp(){renderHWer();renderHZat();buildSimProj();}
function showHpTab(el,id){["h-wer","h-zat","h-sim"].forEach(t=>document.getElementById(t).classList.add("hidden"));document.querySelectorAll(".tab").forEach(t=>t.classList.remove("on"));document.getElementById(id).classList.remove("hidden");el.classList.add("on");}
function renderHWer(pg=1){const srch=document.getElementById("fhw-s").value.toLowerCase(),dz=document.getElementById("fhw-dz").value;let f=RAW.hp_wer.filter(r=>{const op=(RAW.arpk_map[r["Numer projektu"]]||{}).opiekun||"";if(dz&&!dzialFilter(op,dz))return false;return!srch||`${r["Numer projektu"]} ${r["Beneficjent Nazwa"]}`.toLowerCase().includes(srch);});document.getElementById("kpi-hwer").innerHTML=`<div class="kpi b"><div class="kpi-l">HP w weryfikacji</div><div class="kpi-v">${f.length}</div></div><div class="kpi c"><div class="kpi-l">Wyd.kwal.</div><div class="kpi-v" style="font-size:.96rem">${fmtK(f.reduce((s,r)=>s+(r["Wydatki kwalifikowalne"]||0),0))}</div></div><div class="kpi y"><div class="kpi-l">Przekroczone 5 dni</div><div class="kpi-v">${f.filter(r=>(wdSince(r["Data przes≈Çania"])||0)>5).length}</div></div>`;document.getElementById("info-hwer").textContent=`${f.length} HP`;const PP=20,sl=f.slice((pg-1)*PP,pg*PP);document.getElementById("tb-hwer").innerHTML=sl.map(r=>{const wd=wdSince(r["Data przes≈Çania"])||0;const late=wd>5;return`<tr><td class="mono" style="font-size:.92rem">${r["Numer projektu"]}</td><td><div class="clamp">${clamp(r["Beneficjent Nazwa"],26)}</div></td><td style="text-align:center"><span class="badge bc">${r["Numer wersji harmonogramu"]||"‚Äî"}</span></td><td>${badge(r["Status"]||"‚Äî")}</td><td class="mono">${fmtD(r["Data przes≈Çania"])}</td><td style="text-align:center;font-family:var(--mono);font-size:.91rem;color:${late?"var(--red)":"var(--grn)"};font-weight:${late?700:400}">${wd}${late?" ‚ö†":""}</td><td class="nr mono">${fmtK(r["Wydatki kwalifikowalne"])}</td><td class="nr mono">${fmtK(r["Zaliczka"])}</td><td class="nr mono">${fmtK(r["Refundacja"])}</td></tr>`;}).join("")||"<tr><td colspan='9' class='empty'>Brak danych</td></tr>";renderPager("pg-hwer",pg,Math.ceil(f.length/PP),p=>renderHWer(p));}
function renderHZat(pg=1){const srch=document.getElementById("fhz-s").value.toLowerCase(),dz=document.getElementById("fhz-dz").value;let f=RAW.hp_zat.filter(r=>{const op=(RAW.arpk_map[r["Numer projektu"]]||{}).opiekun||"";if(dz&&!dzialFilter(op,dz))return false;return!srch||`${r["Numer projektu"]} ${r["Beneficjent Nazwa"]}`.toLowerCase().includes(srch);});document.getElementById("kpi-hzat").innerHTML=`<div class="kpi g"><div class="kpi-l">HP zatwierdzonych</div><div class="kpi-v">${f.length}</div></div><div class="kpi b"><div class="kpi-l">Wyd.kwal.</div><div class="kpi-v" style="font-size:.96rem">${fmtK(f.reduce((s,r)=>s+(r["Wydatki kwalifikowalne"]||0),0))}</div></div>`;document.getElementById("info-hzat").textContent=`${f.length} HP`;const PP=25,sl=f.slice((pg-1)*PP,pg*PP);document.getElementById("tb-hzat").innerHTML=sl.map(r=>`<tr><td class="mono" style="font-size:.92rem">${r["Numer projektu"]}</td><td><div class="clamp">${clamp(r["Beneficjent Nazwa"],26)}</div></td><td style="text-align:center"><span class="badge bg">${r["Numer wersji harmonogramu"]||"‚Äî"}</span></td><td class="mono">${fmtD(r["Data przes≈Çania"])}</td><td class="mono">${fmtD(r["Data zatwierdzenia"])}</td><td class="nr mono">${fmtK(r["Wydatki kwalifikowalne"])}</td><td class="nr mono">${fmtK(r["Zaliczka"])}</td><td class="nr mono">${fmtK(r["Refundacja"])}</td></tr>`).join("")||"<tr><td colspan='8' class='empty'>Brak danych</td></tr>";renderPager("pg-hzat",pg,Math.ceil(f.length/PP),p=>renderHZat(p));}
function buildSimProj(){const nrs=[...new Set(RAW.zat.map(r=>r.nr_proj))].sort();document.getElementById("sim-proj").innerHTML=nrs.map(nr=>{const u=RAW.umowy.find(u=>u.nr===nr)||{};return`<option value="${nr}">${nr} ‚Äì ${clamp(u.beneficjent||"",34)}</option>`;}).join("");if(nrs.length)runSim();}
function runSim(){const nr=document.getElementById("sim-proj").value;const pw=RAW.zat.filter(r=>r.nr_proj===nr&&r.data_zatw).sort((a,b)=>a.data_zatw.localeCompare(b.data_zatw));const out=document.getElementById("sim-out");if(pw.length<2){out.innerHTML="<div class='empty'>Za ma≈Ço zatwierdzonych WNP (min. 2)</div>";return;}const intervals=[];for(let i=1;i<pw.length;i++){const a=new Date(pw[i-1].data_zatw),b=new Date(pw[i].data_zatw);intervals.push((b-a)/86400000);}const avgInt=intervals.reduce((s,v)=>s+v,0)/intervals.length;const u=RAW.umowy.find(u=>u.nr===nr)||{};const endD=u.do?new Date(u.do):new Date(NOW.getFullYear()+2,0);const future=[];let d=new Date(pw[pw.length-1].data_zatw);for(let i=0;i<6;i++){d=new Date(d.getTime()+avgInt*86400000);if(d>endD)break;future.push(new Date(d));}out.innerHTML=`<div class="alert ai">Projekt <b>${nr}</b> ¬∑ ≈ör. odstƒôp miƒôdzy WNP: <b>${Math.round(avgInt)} dni</b> ¬∑ Podstawa: ${pw.length} WNP</div><div style="font-size:.81rem;color:var(--txt3);margin-bottom:7px;text-transform:uppercase;letter-spacing:.5px">Historia zatwierdzonych WNP</div><div class="mpills">${pw.map((r,i)=>`<span class="mp on" style="cursor:default">WNP ${i+1} ¬∑ ${fmtD(r.data_zatw)}</span>`).join("")}</div><div style="font-size:.81rem;color:var(--txt3);margin:11px 0 7px;text-transform:uppercase;letter-spacing:.5px">Prognozowane terminy (${future.length})</div><div class="mpills">${future.map((fd,i)=>`<span class="mp" style="cursor:default;border-color:var(--acc2);color:var(--acc2)">WNP ${pw.length+i+1} ¬∑ ${fmtD(fd)}</span>`).join("")}</div>`;}

// ‚îÄ‚îÄ‚îÄ OPIEKUNOWIE ‚îÄ‚îÄ‚îÄ
let curOp=null;
// ===== [JS-I] OPIEKUNOWIE I WYKAZ PROJEKT√ìW ‚Äî buildOpGrid, setProjOpiekun, buildWykazProj =====
function buildOpGrid(){
  if(!RAW.op_stats||typeof RAW.op_stats!=="object")return;
  const srch=document.getElementById("fop-s").value.toLowerCase(),dz=document.getElementById("fop-dz").value;
  const ops=Object.entries(RAW.op_stats).filter(([op])=>{if(dz&&!dzialFilter(op,dz))return false;return!srch||op.toLowerCase().includes(srch)||opName(op).toLowerCase().includes(srch);});
  document.getElementById("op-grid").innerHTML=ops.map(([op,st])=>{const dept=CFG.opDzial[op];const opoC=RAW.postep.filter(p=>p.opiekun===op&&p.opozniony).length;const inf=opFullInfo(op);return`<div class="opcard" onclick="openOpDetail('${op}')"><div class="opcard-nm">${inf.name!==op?inf.name:'‚óâ '+op}</div>${inf.name!==op?`<div style="font-family:var(--mono);font-size:.75rem;color:var(--txt3);margin-bottom:2px">${op}</div>`:''}<div class="opcard-dz">${dept?"Dzia≈Ç EFS "+dept:inf.dzial||"Nieprzypisany"}</div><div class="op-stats"><div class="opst"><div class="opst-v" style="color:var(--acc)">${st.projekty}</div><div class="opst-l">Proj.</div></div><div class="opst"><div class="opst-v" style="color:var(--red)">${st.w_weryfikacji}</div><div class="opst-l">Wer.</div></div><div class="opst"><div class="opst-v" style="color:var(--yel)">${opoC}</div><div class="opst-l">Op√≥≈∫n.</div></div><div class="opst"><div class="opst-v" style="font-size:.94rem;color:var(--acc2)">${fmtK(st.budzet)}</div><div class="opst-l">Bud≈ºet</div></div></div></div>`;}).join("");
}
function openOpDetail(op){curOp=op;document.getElementById("op-grid").classList.add("hidden");document.getElementById("op-detail").classList.remove("hidden");const inf=opFullInfo(op);document.getElementById("op-det-name").innerHTML=inf.name!==op?`${inf.name} <span style="font-family:var(--mono);font-size:.72rem;color:var(--txt3)">${op}</span>`:"‚óâ "+op;const dept=CFG.opDzial[op]||inf.dzial;document.getElementById("op-det-dz").textContent=dept?"Dzia≈Ç EFS "+dept:"Nieprzypisany";const st=RAW.op_stats[op]||{};const opoC=RAW.postep.filter(p=>p.opiekun===op&&p.opozniony).length;const opWer=RAW.wer.filter(r=>r.opiekun===op);const avgWd=opWer.length?opWer.reduce((s,r)=>s+(wdSince(r.data_zloz)||0),0)/opWer.length:0;const perf=Math.max(0,Math.round(100-avgWd*3));document.getElementById("kpi-op-det").innerHTML=`<div class="kpi b"><div class="kpi-l">Projekt√≥w</div><div class="kpi-v">${st.projekty||0}</div></div><div class="kpi r"><div class="kpi-l">W weryfikacji</div><div class="kpi-v">${st.w_weryfikacji||0}</div></div><div class="kpi o"><div class="kpi-l">W poprawie</div><div class="kpi-v">${st.w_poprawie||0}</div></div><div class="kpi y"><div class="kpi-l">Z op√≥≈∫nieniami</div><div class="kpi-v">${opoC}</div></div><div class="kpi c"><div class="kpi-l">≈ÅƒÖczny bud≈ºet</div><div class="kpi-v" style="font-size:.96rem">${fmtK(st.budzet)}</div></div><div class="kpi ${perf>=70?"g":perf>=50?"y":"r"}"><div class="kpi-l">Ocena efektywno≈õci</div><div class="kpi-v">${perf}/100</div></div>`;document.getElementById("fopd-s").value="";renderOpProj();}
function renderOpProj(pg=1){
  const srch=document.getElementById("fopd-s").value.toLowerCase();const st=RAW.op_stats[curOp]||{};let projs=(st.proj_nrs||[]).filter(nr=>{if(!srch)return true;const u=RAW.umowy.find(u=>u.nr===nr)||{};return nr.toLowerCase().includes(srch)||(u.beneficjent||"").toLowerCase().includes(srch);});document.getElementById("info-opd").textContent=`${projs.length} projekt√≥w`;
  const PP=20,sl=projs.slice((pg-1)*PP,pg*PP);
  document.getElementById("tb-opd").innerHTML=sl.map(nr=>{const u=RAW.umowy.find(u=>u.nr===nr)||{};const lastWnp=RAW.zat.filter(r=>r.nr_proj===nr).sort((a,b)=>(b.data_zatw||"").localeCompare(a.data_zatw||""))[0];const pp=RAW.postep.find(p=>p.nr===nr);const poz=pp&&pp.poziom_fakt!=null?pp.poziom_fakt.toFixed(1)+"%":"‚Äî";const w=RAW.wskazniki[nr];const rzecPct=w&&w.avg_all!=null?w.avg_all+"%":"‚Äî";const sc=getWeightedScore(RAW.arpk_map[nr]||{});return`<tr onclick="showDetail(${JSON.stringify({nr,...u}).replace(/"/g,"&quot;")})"><td class="mono" style="font-size:.91rem">${nr}</td><td><div class="clamp">${clamp(u.beneficjent||"‚Äî",28)}</div></td><td class="nr mono">${fmtK(u.budzet)}</td><td class="mono" style="font-size:.81rem">${lastWnp?clamp(lastWnp.nr_wn,24):"‚Äî"}</td><td>${lastWnp?`<span class="badge bg">Zatw.</span>`:"‚Äî"}</td><td><div style="display:flex;align-items:center;gap:5px"><div class="prog" style="width:55px"><div class="prog-b" style="width:${Math.min(100,parseFloat(poz)||0)}%;background:var(--grn)"></div></div><span class="mono" style="font-size:.81rem">${poz}</span></div></td><td style="font-family:var(--mono);font-size:.94rem;color:${pctColor(parseFloat(rzecPct)||0)}">${rzecPct}</td><td>${arpkBadge(sc).badge}</td></tr>`;}).join("")||"<tr><td colspan='8' class='empty'>Brak projekt√≥w</td></tr>";renderPager("pg-opd",pg,Math.ceil(projs.length/PP),p=>renderOpProj(p));}
function closeOpDetail(){curOp=null;document.getElementById("op-grid").classList.remove("hidden");document.getElementById("op-detail").classList.add("hidden");}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WYKAZ PROJEKT√ìW ‚Äî przypisanie i edycja opiekun√≥w
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ≈πr√≥d≈Ça opiekuna (priorytet): 1=rƒôczne (CFG.projOpiekun), 2=ostatni ZAT, 3=WER/POP, 4=brak
var CFG_PROJ_OP_KEY='rbmv_proj_opiekun';

function loadProjOpiekun(){
  try{const s=_STORAGE.getItem(CFG_PROJ_OP_KEY);return s?JSON.parse(s):{};}catch(e){return{};}
}
function saveProjOpiekun(){
  try{_STORAGE.setItem(CFG_PROJ_OP_KEY,JSON.stringify(CFG.projOpiekun||{}));}catch(e){}
}

function getEffectiveProjOp(nr){
  // PRIORYTETY (malejƒÖco):
  // 1. Rƒôczne (Wykaz projekt√≥w)  2. auto ZAT  3. auto WER/POP  4. plik FEDS  5. brak
  const manual=(CFG.projOpiekun||{})[nr];
  if(manual)return{op:manual,src:'rƒôczne'};
  const zatForProj=RAW.zat.filter(r=>r.nr_proj===nr&&r.opiekun&&!r.opiekun.startsWith('__'));
  if(zatForProj.length){
    const last=zatForProj.sort((a,b)=>(b.data_zatw||'').localeCompare(a.data_zatw||''))[0];
    const nrWnOk=last.nr_wn&&!last.nr_wn.startsWith('__ZAT__')?last.nr_wn:null;
    return{op:last.opiekun,src:'auto ZAT',data:last.data_zatw,nr_wn:nrWnOk};
  }
  const werP=RAW.wer.find(r=>r.nr_proj===nr&&r.opiekun);
  if(werP)return{op:werP.opiekun,src:'WER'};
  const popP=RAW.pop.find(r=>r.nr_proj===nr&&r.opiekun);
  if(popP)return{op:popP.opiekun,src:'POP'};
  const xlsxOp=(CFG.projOpiekun_feds||{})[nr];
  if(xlsxOp)return{op:xlsxOp,src:'plik FEDS',dzial:(CFG.projDzial_feds||{})[nr]||''};
  return{op:null,src:'brak'};
}

function buildWykazProj(){
  if(!CFG.projOpiekun)CFG.projOpiekun=loadProjOpiekun();
  // Zbierz wszystkich opiekun√≥w do selecta
  const ops=new Set();
  RAW.zat.forEach(r=>{if(r.opiekun&&!r.opiekun.startsWith('__'))ops.add(r.opiekun);});
  RAW.wer.forEach(r=>{if(r.opiekun)ops.add(r.opiekun);});
  RAW.pop.forEach(r=>{if(r.opiekun)ops.add(r.opiekun);});
  Object.values(CFG.projOpiekun||{}).forEach(op=>{if(op)ops.add(op);});
  Object.values(CFG.projOpiekun_feds||{}).forEach(op=>{if(op)ops.add(op);});
  const sel=document.getElementById('fwp-op');if(!sel)return;
  const cur=sel.value;
  sel.innerHTML='<option value="">Wszyscy</option><option value="__brak__">‚Äî Bez opiekuna</option>';
  [...ops].sort().forEach(op=>{
    const inf=opFullInfo(op);
    sel.innerHTML+=`<option value="${op}"${op===cur?' selected':''}>${inf.name!==op?inf.name:op}</option>`;
  });
  renderWykazProj();
}

function renderWykazProj(pg=1){
  const PP=50;
  const srch=(document.getElementById('fwp-s')||{value:''}).value.toLowerCase();
  const dz=(document.getElementById('fwp-dz')||{value:''}).value;
  const opF=(document.getElementById('fwp-op')||{value:''}).value;

  // Zbierz wszystkie projekty
  const allNrs=[...new Set([
    ...RAW.umowy.map(u=>u.nr),
    ...RAW.zat.map(r=>r.nr_proj),
    ...RAW.wer.map(r=>r.nr_proj),
    ...RAW.pop.map(r=>r.nr_proj),
  ].filter(Boolean))].sort();

  const rows=allNrs.map(nr=>{
    const u=RAW.umowy.find(u=>u.nr===nr)||{};
    const ef=getEffectiveProjOp(nr);
    const zatCnt=RAW.zat.filter(r=>r.nr_proj===nr).length;
    const lastZat=RAW.zat.filter(r=>r.nr_proj===nr&&r.data_zatw).sort((a,b)=>b.data_zatw.localeCompare(a.data_zatw))[0];
    return{nr,beneficjent:u.beneficjent||lastZat?.beneficjent||'',ef,zatCnt,lastZat};
  });

  const f=rows.filter(r=>{
    if(dz&&CFG.opDzial[r.ef.op]!==dz)return false;
    if(opF==='__brak__'&&r.ef.op)return false;
    if(opF&&opF!=='__brak__'&&r.ef.op!==opF)return false;
    if(srch&&!`${r.nr} ${r.beneficjent}`.toLowerCase().includes(srch))return false;
    return true;
  });

  const cnt=document.getElementById('wp-cnt');if(cnt)cnt.textContent=`${f.length} projekt√≥w`;
  const info=document.getElementById('wp-info');if(info)info.textContent=`${f.length} z ${rows.length} projekt√≥w`;

  const sl=f.slice((pg-1)*PP,pg*PP);
  const brak=f.filter(r=>!r.ef.op).length;

  // Lista wszystkich opiekun√≥w dla selecta w wierszu
  const allOps=[...new Set([
    ...Object.keys(RAW.op_stats||{}),
    ...Object.values(CFG.projOpiekun||{}),
    ...Object.keys(PERSONEL||{}),
  ])].filter(Boolean).sort();

  document.getElementById('tb-wykaz').innerHTML=sl.map(r=>{
    const inf=r.ef.op?opFullInfo(r.ef.op):null;
    const opLabel=inf?(inf.name!==r.ef.op?inf.name:r.ef.op):'‚Äî';
    const dzCode=r.ef.op?CFG.opDzial[r.ef.op]:'';
    const dzLabel=dzCode?'Dzia≈Ç EFS '+dzCode:'‚Äî';
    const isManual=!!(CFG.projOpiekun||{})[r.nr];
    const srcBadge=r.ef.src==='rƒôczne'
      ?`<span class="badge bb" title="Przypisany rƒôcznie">rƒôczne</span>`
      :r.ef.src==='auto ZAT'
        ?`<span class="badge bg" title="Z ostatniego ZAT${r.ef.nr_wn?' ¬∑ '+r.ef.nr_wn:''}${r.ef.data?' ('+r.ef.data+')':''}">auto ZAT</span>`
        :r.ef.src==='WER'||r.ef.src==='POP'
          ?`<span class="badge by">auto ${r.ef.src}</span>`
          :r.ef.src==='plik FEDS'
            ?`<span class="badge bc" title="Z importu FEDS_Podzia≈Ç_Projekt√≥w.xlsx">plik FEDS</span>`
            :`<span class="badge bgr-h">brak</span>`;

    // Opcje selecta z aktualnym opiekunem
    const optsHtml=`<option value=""></option>`+allOps.map(op=>{
      const i=opFullInfo(op);
      return`<option value="${op}"${r.ef.op===op?' selected':''}>${i.name!==op?i.name:op}</option>`;
    }).join('');

    return`<tr id="wrow-${r.nr.replace(/[^a-z0-9]/gi,'_')}">
      <td class="mono" style="font-size:.82rem;color:var(--txt)">${r.nr}</td>
      <td style="font-size:.84rem;color:var(--txt)">${r.beneficjent||'‚Äî'}</td>
      <td style="padding:4px 8px">
        <select class="cfg-sel" style="width:100%;font-size:.8rem;padding:4px 7px"
          title="Zmie≈Ñ opiekuna projektu"
          onchange="setProjOpiekun('${r.nr}',this.value)">
          ${optsHtml}
        </select>
        ${isManual?`<button onclick="clearProjOpiekun('${r.nr}')" title="Usu≈Ñ rƒôczne przypisanie ‚Äî wr√≥ƒá do automatycznego" style="margin-top:3px;font-size:.65rem;color:var(--txt3);background:none;border:none;cursor:pointer;padding:0;text-decoration:underline">‚Ü∫ auto</button>`:''}
      </td>
      <td style="font-size:.82rem;color:var(--txt2)">${dzLabel}</td>
      <td>${srcBadge}</td>
      <td class="mono" style="font-size:.78rem">${r.lastZat?r.lastZat.data_zatw:'‚Äî'}</td>
      <td class="nr mono" style="font-size:.84rem;font-weight:700">${r.zatCnt||0}</td>
    </tr>`;
  }).join('')||`<tr><td colspan="7" class="empty">Brak projekt√≥w. Wczytaj dane w zak≈Çadce Dane.</td></tr>`;

  renderPager('pg-wykaz',pg,Math.ceil(f.length/PP),p=>renderWykazProj(p));
}

function setProjOpiekun(nr,op){
  if(!CFG.projOpiekun)CFG.projOpiekun={};
  if(op){
    CFG.projOpiekun[nr]=op;
    // Zaktualizuj arpk_map i umowy
    if(RAW.arpk_map[nr])RAW.arpk_map[nr].opiekun=op;
    const u=RAW.umowy.find(u=>u.nr===nr);if(u)u.opiekun=op;
    // Zaktualizuj w ZAT/WER/POP je≈õli by≈Ç tam ten projekt
    RAW.zat.filter(r=>r.nr_proj===nr).forEach(r=>r.opiekun=op);
    RAW.wer.filter(r=>r.nr_proj===nr).forEach(r=>r.opiekun=op);
    RAW.pop.filter(r=>r.nr_proj===nr).forEach(r=>r.opiekun=op);
  }else{
    delete CFG.projOpiekun[nr];
  }
  saveProjOpiekun();
  rebuildOpStats(RAW);
  renderWykazProj();
  // Od≈õwie≈º inne widoki w tle
  buildZat();buildWer();buildPop();buildOpGrid();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// IMPORT FEDS_Podzia≈Ç_Projekt√≥w.xlsx ‚Äî uzupe≈Çnia opiekun√≥w z pliku
// Priorytet: najni≈ºszy (po rƒôcznym, auto ZAT, auto WER/POP)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function fedsFileSelected(file){
  if(!file)return;
  fedsSetStatus('Wczytywanie‚Ä¶');
  if(!window.XLSX){fedsSetStatus('B≈ÇƒÖd: biblioteka XLSX nie jest za≈Çadowana (brak internetu?)','err');return;}
  const ext=file.name.split('.').pop().toLowerCase();
  if(ext==='csv'||ext==='txt'){
    const reader=new FileReader();
    reader.onload=e=>fedsParseRows(file.name,null,e.target.result);
    reader.readAsText(file,'UTF-8');
  } else if(ext==='xlsx'||ext==='xls'){
    const reader=new FileReader();
    reader.onload=e=>{
      try{
        const wb=XLSX.read(e.target.result,{type:'array',cellDates:true});
        // We≈∫ pierwszy arkusz (lub ten z "projekt"/"podzia" w nazwie)
        const sn=wb.SheetNames.find(n=>/projekt|podzia|opiekun/i.test(n))||wb.SheetNames[0];
        const ws=wb.Sheets[sn];
        const rows=XLSX.utils.sheet_to_json(ws,{defval:''});
        fedsParseRows(file.name,rows,null);
      }catch(err){
        fedsSetStatus('B≈ÇƒÖd odczytu XLSX: '+err.message,'err');
        console.error('[FEDS]',err);
      }
    };
    reader.readAsArrayBuffer(file);
  } else {
    fedsSetStatus('Nieobs≈Çugiwany format ‚Äî u≈ºyj XLSX lub CSV','err');
  }
}

function fedsParseRows(fname,rows,csvText){
  if(!rows&&csvText){
    const sep=csvText.split('\n')[0].includes(';')?';':',';
    const lines=csvText.trim().split('\n');
    const hdrs=lines[0].split(sep).map(h=>h.trim().replace(/^"|"$/g,''));
    rows=lines.slice(1).map(l=>{
      const cells=l.split(sep);
      const o={};
      hdrs.forEach((h,j)=>{o[h]=(cells[j]||'').trim().replace(/^"|"$/g,'');});
      return o;
    }).filter(r=>Object.values(r).some(v=>v));
  }
  if(!rows||!rows.length){fedsSetStatus('Plik pusty lub nie uda≈Ço siƒô go odczytaƒá','err');return;}

  const keys=Object.keys(rows[0]);
  // findKey ‚Äî najpierw dok≈Çadne dopasowanie, potem czƒô≈õciowe
  const fk=(...c)=>{
    for(const x of c){const k=keys.find(k=>k.trim().toLowerCase()===x.toLowerCase());if(k)return k;}
    for(const x of c){const k=keys.find(k=>k.toLowerCase().includes(x.toLowerCase()));if(k)return k;}
    return null;
  };
  const kNr =fk('Numer projektu','Nr projektu','nr_proj','Projekt');
  const kOp =fk('Opiekun','opiekun','Osoba odpowiedzialna','Pracownik');
  const kDz =fk('Dzia≈Ç','Dzial','dzia≈Ç','dzial','Department');
  const kLog=fk('Login','login','Skr√≥t','skrot','skr√≥t');

  if(!kNr){fedsSetStatus('Brak kolumny z numerem projektu. Kolumny: '+keys.join(' | '),'err');return;}
  if(!kOp&&!kLog){fedsSetStatus('Brak kolumny Opiekun lub Login. Kolumny: '+keys.join(' | '),'err');return;}

  let imported=0,noNr=0,noOp=0,noDz=0;
  const result={};       // nr ‚Üí login
  const resultDz={};     // nr ‚Üí kod dzia≈Çu ('1'/'2'/'3')
  const loginDzMap={};   // login ‚Üí kod dzia≈Çu (aktualizuje CFG.opDzial)

  for(const r of rows){
    const nr=String(r[kNr]||'').trim();
    if(!nr){noNr++;continue;}

    // Login: kolumna Login ma pierwsze≈Ñstwo, potem Opiekun
    const loginRaw=kLog?String(r[kLog]||'').trim():'';
    const opRaw   =kOp?String(r[kOp]||'').trim():'';
    const dzRaw   =kDz?String(r[kDz]||'').trim():'';

    // Ustal login opiekuna
    let op=loginRaw||opRaw;
    if(!op){noOp++;continue;}
    const opU=op.toUpperCase();
    // Normalizuj ‚Äî je≈õli to login w PERSONEL, u≈ºyj go wprost
    if(PERSONEL[opU]){
      op=opU;
    } else if(!loginRaw){
      // Opiekun podany jako Nazwisko / Nazwisko Imiƒô ‚Äî szukaj w PERSONEL
      const found=Object.values(PERSONEL).find(p=>{
        const raw=opRaw.toLowerCase();
        return (p.nazwisko+' '+p.imie).trim().toLowerCase()===raw
            ||(p.imie+' '+p.nazwisko).trim().toLowerCase()===raw
            ||p.nazwisko.toLowerCase()===raw;
      });
      if(found)op=found.skrot;
    }

    result[nr]=op;

    // Ustal dzia≈Ç ‚Äî z kolumny Dzia≈Ç je≈õli dostƒôpna
    if(dzRaw){
      const dzCode=dzialToCode(dzRaw)||dzRaw.replace(/[^123]/g,'').slice(0,1)||'';
      if(dzCode){
        resultDz[nr]=dzCode;
        loginDzMap[op]=dzCode; // przypisz login ‚Üí dzia≈Ç
      } else {
        noDz++;
      }
    }

    imported++;
  }

  if(!imported){fedsSetStatus('Nie znaleziono danych. Kolumny: '+keys.join(' | '),'err');return;}

  // Zapisz trwale w CFG (localStorage)
  if(!CFG.projOpiekun_feds)CFG.projOpiekun_feds={};
  if(!CFG.projDzial_feds)CFG.projDzial_feds={};
  Object.assign(CFG.projOpiekun_feds,result);
  Object.assign(CFG.projDzial_feds,resultDz);
  // Zaktualizuj CFG.opDzial loginami z pliku (nadpisuje DEFAULT_PERSONEL dla tych login√≥w)
  Object.assign(CFG.opDzial,loginDzMap);
  saveCFG();

  const total=Object.keys(CFG.projOpiekun_feds).length;
  const filled=Object.keys(result).filter(nr=>getEffectiveProjOp(nr).src==='plik FEDS').length;
  const dzInfo=Object.keys(loginDzMap).length?` ¬∑ ${Object.keys(loginDzMap).length} login√≥w z dzia≈Çem`:'';
  fedsSetStatus(`‚úì Wczytano ${imported} projekt√≥w${dzInfo}`+(noOp?` ¬∑ ${noOp} bez opiekuna`:'')+(noDz?` ¬∑ ${noDz} bez dzia≈Çu`:''),'ok');
  fedsUpdateCount();
  rebuildOpStats(RAW);
  if(document.getElementById('page-wykaz-proj').classList.contains('on'))buildWykazProj();
  showToast(`Podzia≈Ç projekt√≥w: ${imported} wczytanych ¬∑ ${filled} uzupe≈Çnionych ‚úì`);
}

function fedsSetStatus(msg,type){
  const el=document.getElementById('feds-status');
  if(!el)return;
  const col=type==='ok'?'var(--grn)':type==='err'?'var(--red)':'var(--txt2)';
  el.style.color=col;
  el.textContent=msg;
}

function fedsUpdateCount(){
  const n=Object.keys(CFG.projOpiekun_feds||{}).length;
  const el=document.getElementById('feds-count');
  if(el)el.textContent=n>0?`${n} projekt√≥w w bazie`:'';
  const btn=document.getElementById('feds-clear-btn');
  if(btn)btn.style.display=n>0?'':'none';
  // Synchronizuj te≈º stary pasek w Wykazie projekt√≥w
  const st=document.getElementById('podz-status-txt');
  if(st)st.textContent=n>0?`${n} projekt√≥w z importu FEDS`:'Nie wczytano';
}

function fedsClearData(){
  if(!confirm('UsunƒÖƒá wszystkie dane z importu podzia≈Çu projekt√≥w?\nRƒôczne przypisania i dane auto pozostanƒÖ.'))return;
  CFG.projOpiekun_feds={};
  CFG.projDzial_feds={};
  // Przywr√≥ƒá opDzial z DEFAULT_PERSONEL
  CFG.opDzial={};
  Object.values(PERSONEL).forEach(p=>{if(p.skrot&&p.dzial){const c=dzialToCode(p.dzial);if(c)CFG.opDzial[p.skrot]=c;}});
  saveCFG();
  fedsSetStatus('Dane usuniƒôte','');
  fedsUpdateCount();
  rebuildOpStats(RAW);
  if(document.getElementById('page-wykaz-proj').classList.contains('on'))buildWykazProj();
}

// Alias dla starego kodu w Wykazie projekt√≥w
function podzFileSelected(file){fedsFileSelected(file);}
function podzClearData(){fedsClearData();}


function podzClearData(){
  if(!confirm('UsunƒÖƒá wczytane dane podzia≈Çu projekt√≥w?\nRƒôczne przypisania i dane auto pozostanƒÖ.'))return;
  CFG.projOpiekun_feds={};
  saveCFG();
  podzSetStatus('Usuniƒôto dane z pliku FEDS','var(--txt3)');
  const btn=document.getElementById('podz-clear-btn');
  if(btn)btn.style.display='none';
  rebuildOpStats(RAW);
  buildWykazProj();
}

function clearProjOpiekun(nr){
  if(!CFG.projOpiekun)return;
  delete CFG.projOpiekun[nr];
  saveProjOpiekun();
  // Przywr√≥ƒá automatycznego opiekuna z danych
  rebuildOpStats(RAW);
  renderWykazProj();
  buildZat();buildWer();buildPop();buildOpGrid();
}

// ‚îÄ‚îÄ‚îÄ aRPK ANALIZA ‚îÄ‚îÄ‚îÄ
let chArpkDist,chArpkCat;
// ===== [JS-J] ANALIZA aRPK I METRYKI ‚Äî buildArpk, renderArpk, buildMetryki, showDetail =====
function buildArpk(){const ops=[...new Set(Object.values(RAW.arpk_map).map(v=>v.opiekun).filter(Boolean))].sort();const el=document.getElementById("fa-op");el.innerHTML='<option value="">Wszyscy opiekunowie</option>'+ops.map(o=>'<option value="'+o+'">'+opName(o)+'</option>').join("");buildArpkCatsOverview();renderArpk();}
function renderArpk(pg=1){
  const srch=document.getElementById("fa-s").value.toLowerCase(),op=document.getElementById("fa-op").value,lv=document.getElementById("fa-level").value,dz=document.getElementById("fa-dz").value;
  let entries=Object.entries(RAW.arpk_map).filter(([nr,v])=>{if(!projInScope(nr))return false;if(dz&&!dzialFilter(v.opiekun,dz))return false;if(op&&v.opiekun!==op)return false;const sc=getWeightedScore(v);if(lv&&arpkLevel(sc)!==lv)return false;const u=RAW.umowy.find(u=>u.nr===nr)||{};if(srch&&!`${nr} ${u.beneficjent||""}`.toLowerCase().includes(srch))return false;return true;}).map(([nr,v])=>({nr,...v,sc:getWeightedScore(v),u:RAW.umowy.find(u=>u.nr===nr)||{}}));
  entries.sort((a,b)=>b.sc-a.sc);
  const lvlC={niskie:0,srednie:0,wysokie:0,krytyczne:0};entries.forEach(e=>{lvlC[arpkLevel(e.sc)]++;});
  document.getElementById("kpi-arpk").innerHTML=`<div class="kpi r"><div class="kpi-l">Krytyczne (‚â•75)</div><div class="kpi-v">${lvlC.krytyczne}</div></div><div class="kpi o"><div class="kpi-l">Wysokie (50-74)</div><div class="kpi-v">${lvlC.wysokie}</div></div><div class="kpi y"><div class="kpi-l">≈örednie (25-49)</div><div class="kpi-v">${lvlC.srednie}</div></div><div class="kpi g"><div class="kpi-l">Niskie (0-24)</div><div class="kpi-v">${lvlC.niskie}</div></div><div class="kpi b"><div class="kpi-l">Projekt√≥w</div><div class="kpi-v">${entries.length}</div></div>`;
  buildArpkCatsOverview();
  if(chArpkDist)chArpkDist.destroy();chArpkDist=new Chart(document.getElementById("ch-arpk-dist"),{type:"doughnut",data:{labels:["Niskie","≈örednie","Wysokie","Krytyczne"],datasets:[{data:[lvlC.niskie,lvlC.srednie,lvlC.wysokie,lvlC.krytyczne],backgroundColor:["#10b981","#f59e0b","#fb923c","#f43f5e"],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:"right",labels:{color:"#7c8db5",font:{size:9},boxWidth:10}}}}});
  const catT={};ARPK_CATS.forEach(c=>{catT[c.code]=0;});entries.forEach(e=>{const b=e.breakdown||{};catT.R1+=(b.r1_beneficjent||0);catT.R2+=(b.r2_wielkosc||0);catT.R3+=(b.r3_realizatorzy||0);catT.R4+=(b.r4_rzeczowy||0);catT.R5+=(b.r5_rownolegle||0);catT.R6+=(b.r6_wersje||0);catT.R7+=(b.r7_skargi||0);catT.R8+=(b.r8_nieprawidlowosci||0);catT.R9+=(b.r9_odchylenie||0);});
  if(chArpkCat)chArpkCat.destroy();chArpkCat=new Chart(document.getElementById("ch-arpk-cat"),{type:"bar",data:{labels:ARPK_CATS.map(c=>c.code+" "+c.name.split(" ")[0]),datasets:[{label:"Suma pkt",data:ARPK_CATS.map(c=>catT[c.code]||0),backgroundColor:ARPK_CATS.map(c=>c.col+"80"),borderColor:ARPK_CATS.map(c=>c.col),borderWidth:1}]},options:{responsive:true,maintainAspectRatio:false,scales:{x:{ticks:{color:"#4a5578",font:{size:7},maxRotation:35}},y:{ticks:{color:"#7c8db5",font:{size:8}}}},plugins:{legend:{display:false}}}});
  document.getElementById("info-arpk").textContent=`${entries.length} projekt√≥w`;
  const PP=25,sl=entries.slice((pg-1)*PP,pg*PP);
  document.getElementById("tb-arpk").innerHTML=sl.map(e=>{const b=e.breakdown||{};const ab=arpkBadge(e.sc);return`<tr onclick="showPage('metryki');setTimeout(()=>{document.getElementById('fm-s').value='${e.nr}';renderMetryki();},50)"><td class="mono" style="font-size:1.05rem">${e.nr}</td><td><div class="clamp">${clamp(e.u.beneficjent||"‚Äî",26)}</div></td><td><div class="arpk-bar"><span class="arpk-score" style="color:${arpkColor(e.sc)}">${e.sc}</span><div class="arpk-prog"><div class="arpk-fill" style="width:${e.sc}%;background:${arpkColor(e.sc)}"></div></div></div></td><td>${ab.badge}</td><td class="nr">${b.r1_beneficjent||0}</td><td class="nr">${b.r2_wielkosc||0}</td><td class="nr">${b.r3_realizatorzy||0}</td><td class="nr">${(b.r4_rzeczowy||0).toFixed(1)}</td><td class="nr">${b.r5_rownolegle||0}</td><td class="nr">${b.r6_wersje||0}</td><td class="nr">${b.r8_nieprawidlowosci||0}</td><td class="nr">${b.r9_odchylenie||0}</td><td class="mono">${opName(e.opiekun)}</td><td style="font-size:.71rem;color:var(--txt2)">${arpkAction(e.sc)}</td></tr>`;}).join("")||"<tr><td colspan='14' class='empty'>Brak danych</td></tr>";
  renderPager("pg-arpk",pg,Math.ceil(entries.length/PP),p=>renderArpk(p));
}

// ‚îÄ‚îÄ‚îÄ METRYKI PROJEKT√ìW ‚îÄ‚îÄ‚îÄ
function buildMetryki(){const ops=[...new Set(Object.values(RAW.arpk_map).map(v=>v.opiekun).filter(Boolean))].sort();const el=document.getElementById("fm-op");el.innerHTML=`<option value="">Wszyscy opiekunowie</option>`+ops.map(o=>`<option>${o}</option>`).join("");renderMetryki();}
function renderMetryki(pg=1){
  const srch=document.getElementById("fm-s").value.toLowerCase(),op=document.getElementById("fm-op").value,lv=document.getElementById("fm-lv").value,dz=document.getElementById("fm-dz").value;
  let entries=Object.entries(RAW.arpk_map).filter(([nr,v])=>{
    if(!projInScope(nr))return false;
    if(dz&&!dzialFilter(v.opiekun,dz))return false;
    if(op&&v.opiekun!==op)return false;
    const sc=getWeightedScore(v);if(lv&&arpkLevel(sc)!==lv)return false;
    const u=RAW.umowy.find(u=>u.nr===nr)||{};
    if(srch&&!`${nr} ${u.beneficjent||""}`.toLowerCase().includes(srch))return false;
    return true;
  }).map(([nr,v])=>{const sc=getWeightedScore(v);return{nr,...v,sc,u:RAW.umowy.find(u=>u.nr===nr)||{},pp:RAW.postep.find(p=>p.nr===nr)||null,wsk:RAW.wskazniki[nr]||null};});
  entries.sort((a,b)=>b.sc-a.sc);
  document.getElementById("kpi-metryki").innerHTML=`<div class="kpi b"><div class="kpi-l">Projekt√≥w</div><div class="kpi-v">${entries.length}</div></div><div class="kpi r"><div class="kpi-l">Wys. ryzyko</div><div class="kpi-v">${entries.filter(e=>e.sc>=50).length}</div></div><div class="kpi y"><div class="kpi-l">≈ör. aRPK</div><div class="kpi-v">${entries.length?Math.round(entries.reduce((s,e)=>s+e.sc,0)/entries.length):0}</div></div><div class="kpi g"><div class="kpi-l">≈ör. real. rzecz.</div><div class="kpi-v">${entries.filter(e=>e.wsk&&e.wsk.avg_all!=null).length?Math.round(entries.filter(e=>e.wsk&&e.wsk.avg_all!=null).reduce((s,e)=>s+e.wsk.avg_all,0)/entries.filter(e=>e.wsk&&e.wsk.avg_all!=null).length):0}%</div></div>`;
  const sl=entries.slice((pg-1)*8,pg*8);
  document.getElementById("metryki-list").innerHTML=sl.map(({nr,sc,u,pp,wsk,breakdown,opiekun})=>{
    const ab=arpkBadge(sc);const poz=pp&&pp.poziom_fakt!=null?pp.poziom_fakt.toFixed(1)+"%":"‚Äî";const popp=pp&&pp.poziom_plan_proj!=null?pp.poziom_plan_proj.toFixed(1)+"%":"‚Äî";const useOd=CFG.postepOd==="umowa";
    const avgWsk=wsk&&wsk.avg_all!=null?wsk.avg_all+"%":"‚Äî";
    const b=breakdown||{};
    // Build aRPK category breakdown
    const catRows=ARPK_CATS.map(c=>{
      const pts=getCatPts({breakdown:b},c.id);const maxW=W[c.id]||c.maxOrig;const pct=maxW>0?(pts/c.maxOrig)*100:0;const col=pts>=maxW*0.7?"var(--red)":pts>=maxW*0.4?"var(--yel)":"var(--grn)";
      const stateD=catStateDesc({breakdown:b,nr},c.id,u);
      return`<div class="arpk-cat-item" style="border-left:3px solid ${c.col}">
        <div class="arpk-ci-hdr"><span class="arpk-ci-code">${c.code}</span><span class="arpk-ci-name">${c.name}</span><span class="arpk-ci-pts" style="color:${col}">${pts%1===0?pts:pts.toFixed(1)}</span><span class="arpk-ci-max">/ ${maxW}pkt</span></div>
        <div class="arpk-ci-state">${stateD}</div>
        <div class="arpk-ci-bar"><div class="arpk-ci-fill" style="width:${Math.min(100,pct)}%;background:${col}"></div></div>
      </div>`;}).join("");
    // Fin progress section
    const finSection=pp?`<div class="pm-kpi"><div class="pm-kpi-l">Realizacja finansowa</div><div class="pm-kpi-v" style="color:${pctColor(pp.poziom_fakt||0)}">${poz}</div></div><div class="pm-kpi"><div class="pm-kpi-l">Plan finansowy</div><div class="pm-kpi-v" style="color:var(--txt2)">${popp}</div></div><div class="pm-kpi"><div class="pm-kpi-l">Odchylenie</div><div class="pm-kpi-v" style="color:${pp.opozniony?"var(--red)":"var(--grn)"}">${pp.odch_proj>=0?"+":""}${pp.odch_proj}pp</div></div>`:
    `<div class="pm-kpi" style="grid-column:1/-1"><div class="pm-kpi-l">Postƒôp finansowy</div><div class="pm-kpi-v" style="color:var(--txt3)">Brak danych (projekt rycza≈Çtowy)</div></div>`;
    const wskSection=wsk?`<div class="pm-kpi"><div class="pm-kpi-l">≈örednia realizacja wska≈∫nik√≥w</div><div class="pm-kpi-v" style="color:${pctColor(wsk.avg_all||0)}">${avgWsk}</div></div><div class="pm-kpi"><div class="pm-kpi-l">Wska≈∫niki produktu</div><div class="pm-kpi-v" style="color:${pctColor(wsk.avg_prod||0)}">${wsk.avg_prod!=null?wsk.avg_prod+"%":"‚Äî"} <span style="font-size:.81rem;color:var(--txt3)">(${wsk.cnt_prod})</span></div></div><div class="pm-kpi"><div class="pm-kpi-l">Wska≈∫niki rezultatu</div><div class="pm-kpi-v" style="color:${pctColor(wsk.avg_rez||0)}">${wsk.avg_rez!=null?wsk.avg_rez+"%":"‚Äî"} <span style="font-size:.81rem;color:var(--txt3)">(${wsk.cnt_rez})</span></div></div>`:
    `<div class="pm-kpi" style="grid-column:1/-1"><div class="pm-kpi-l">Postƒôp rzeczowy</div><div class="pm-kpi-v" style="color:var(--txt3)">Brak danych wska≈∫nikowych</div></div>`;
    return`<div class="proj-metric">
      <div class="pm-hdr" onclick="this.nextElementSibling.classList.toggle('on')">
        <div><div class="pm-nr">${nr}</div><div class="pm-name">${clamp(u.beneficjent||"‚Äî",55)}</div></div>
        <div class="pm-badges">${ab.badge}<span class="badge bgr">${opiekun}</span><span class="badge bc">${fmtK(u.budzet)}</span></div>
      </div>
      <div class="pm-body">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:11px">
          <div style="flex:1">
            <div style="font-size:.92rem;color:var(--txt3);margin-bottom:4px">aRPK SCORE</div>
            <div style="display:flex;align-items:center;gap:8px">
              <span style="font-size:1.8rem;font-weight:700;font-family:var(--mono);color:${arpkColor(sc)}">${sc}</span>
              ${ab.badge}
              <div style="flex:1"><div class="prog" style="height:7px"><div class="prog-b" style="width:${sc}%;height:7px;background:${arpkColor(sc)}"></div></div></div>
            </div>
            <div style="font-size:.92rem;color:var(--txt2);margin-top:3px">${arpkAction(sc)}</div>
          </div>
          <div style="text-align:right;flex-shrink:0">
            <div style="font-size:.92rem;color:var(--txt3)">Opiekun</div>
            <div style="font-family:var(--mono);font-size:.91rem;color:var(--acc2)">${opiekun}</div>
            <div style="font-size:.92rem;color:var(--txt3);margin-top:4px">Bud≈ºet kwal.</div>
            <div style="font-family:var(--mono);font-size:.96rem">${fmtK(u.budzet)}</div>
          </div>
        </div>
        <div class="pm-section"><div class="pm-sec-t">Realizacja finansowa i rzeczowa</div>
          <div class="pm-grid">${finSection}${wskSection}</div>
        </div>
        <div class="pm-section"><div class="pm-sec-t">Ocena aRPK ‚Äî pe≈Çna analiza kategorii (suma: <span style="color:${arpkColor(sc)};font-family:var(--mono)">${sc}</span> pkt)</div>
          <div class="arpk-breakdown">${catRows}</div>
        </div>
      </div>
    </div>`;}).join("")||"<div class='empty'>Brak projekt√≥w</div>";
  renderPager("pg-metryki",pg,Math.ceil(entries.length/8),p=>renderMetryki(p));
}

// ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ
const MODAL_LABELS={
  nr_proj:'Numer projektu',beneficjent:'Nazwa Beneficjenta',nr_wn:'Numer wniosku o p≈Çatno≈õƒá',
  ver:'Wersja',status:'Status',data_zloz:'Data z≈Ço≈ºenia',data_wplywu:'Data wp≈Çywu',
  data_zatw:'Data zatwierdzenia',zaliczka:'Zaliczka',refundacja:'Refundacja',
  wyd_kwal:'Wydatki kwalifikowalne',dofinansowanie:'Dofinansowanie',
  wklad_wlasny:'Wk≈Çad w≈Çasny',opiekun:'Opiekun',arpk:'aRPK',
  certyfikowana:'Certyfikowane',korekty:'Korekty',wyd_uznane:'Wydatki zatwierdzone',
  miesiac:'MiesiƒÖc',nr:'Numer projektu'
};
function showDetail(r){
  const nr=r.nr_proj||r.nr||r["Numer projektu"]||"Szczeg√≥≈Çy";
  document.getElementById("det-t").textContent=nr;
  const skip=["arpk_bd","zadania","proj_nrs","breakdown","u","wsk","pp","wskazniki","over","wd","_wd","_arpk"];
  const kv=Object.entries(r).filter(([k])=>!skip.includes(k));
  const lbl=k=>MODAL_LABELS[k]||(k.replace(/_/g,' ').charAt(0).toUpperCase()+k.replace(/_/g,' ').slice(1));
  const fmtVal=(k,v)=>{
    if(k==='opiekun')return opName(v);
    if(k==='arpk')return String(v||0)+' pkt';
    if(v==null)return'‚Äî';
    if(typeof v==='number')return fmt(v);
    return String(v);
  };
  // Group into grid
  let html=kv.map(([k,v])=>`<div class="dr${String(v||"").length>40?" full":""}"><div class="dk">${lbl(k)}</div><div class="dv">${fmtVal(k,v)}</div></div>`).join("");
  // Add project WNP list if we have a project number
  const projNr=r.nr_proj||r.nr;
  if(projNr){
    const allWnp=[...RAW.wer,...RAW.pop,...RAW.zat].filter(w=>w.nr_proj===projNr&&['Zatwierdzony','Z≈Ço≈ºony','W trakcie weryfikacji'].some(s=>w.status&&w.status.includes(s))||
      (w.nr_proj===projNr&&(RAW.zat.includes(w))));
    const projWnps=[...RAW.wer,...RAW.pop,...RAW.zat].filter(w=>w.nr_proj===projNr);
    if(projWnps.length>0){
      const totKwal=projWnps.reduce((s,w)=>s+(w.wyd_kwal||0),0);
      const totDof=projWnps.reduce((s,w)=>s+(w.dofinansowanie||0),0);
      const totWl=projWnps.reduce((s,w)=>s+(w.wklad_wlasny||0),0);
      const totZal=projWnps.reduce((s,w)=>s+(w.zaliczka||0),0);
      const totRef=projWnps.reduce((s,w)=>s+(w.refundacja||0),0);
      html+=`<div class="dr full" style="margin-top:10px"><div class="dk">Wykaz wniosk√≥w o p≈Çatno≈õƒá w projekcie</div><div style="overflow-x:auto;margin-top:6px"><table style="width:100%;border-collapse:collapse;font-size:.82rem">
        <thead><tr style="background:var(--bg2)">
          <th style="padding:4px 7px;text-align:left;border-bottom:1px solid var(--brd);white-space:nowrap">Numer wniosku</th>
          <th style="padding:4px 7px;text-align:left;border-bottom:1px solid var(--brd)">Status</th>
          <th style="padding:4px 7px;text-align:right;border-bottom:1px solid var(--brd);white-space:nowrap">Wyd. kwal.</th>
          <th style="padding:4px 7px;text-align:right;border-bottom:1px solid var(--brd)">Dofinansowanie</th>
          <th style="padding:4px 7px;text-align:right;border-bottom:1px solid var(--brd);white-space:nowrap">Wk≈Çad w≈Çasny</th>
          <th style="padding:4px 7px;text-align:right;border-bottom:1px solid var(--brd)">Zaliczka</th>
          <th style="padding:4px 7px;text-align:right;border-bottom:1px solid var(--brd)">Refundacja</th>
        </tr></thead><tbody>
        ${projWnps.map(w=>`<tr style="border-bottom:1px solid var(--brd)">
          <td style="padding:3px 7px;font-family:var(--mono);font-size:.78rem">${w.nr_wn||'‚Äî'}</td>
          <td style="padding:3px 7px">${badge(w.status)}</td>
          <td style="padding:3px 7px;text-align:right;font-family:var(--mono);font-size:.78rem">${fmtK(w.wyd_kwal)}</td>
          <td style="padding:3px 7px;text-align:right;font-family:var(--mono);font-size:.78rem">${fmtK(w.dofinansowanie)}</td>
          <td style="padding:3px 7px;text-align:right;font-family:var(--mono);font-size:.78rem">${fmtK(w.wklad_wlasny)}</td>
          <td style="padding:3px 7px;text-align:right;font-family:var(--mono);font-size:.78rem">${fmtK(w.zaliczka)}</td>
          <td style="padding:3px 7px;text-align:right;font-family:var(--mono);font-size:.78rem">${fmtK(w.refundacja)}</td>
        </tr>`).join('')}
        </tbody><tfoot><tr style="background:var(--bg2);font-weight:700">
          <td style="padding:4px 7px;border-top:1px solid var(--brd2)" colspan="2">Suma</td>
          <td style="padding:4px 7px;text-align:right;border-top:1px solid var(--brd2);font-family:var(--mono);font-size:.78rem">${fmtK(totKwal)}</td>
          <td style="padding:4px 7px;text-align:right;border-top:1px solid var(--brd2);font-family:var(--mono);font-size:.78rem">${fmtK(totDof)}</td>
          <td style="padding:4px 7px;text-align:right;border-top:1px solid var(--brd2);font-family:var(--mono);font-size:.78rem">${fmtK(totWl)}</td>
          <td style="padding:4px 7px;text-align:right;border-top:1px solid var(--brd2);font-family:var(--mono);font-size:.78rem">${fmtK(totZal)}</td>
          <td style="padding:4px 7px;text-align:right;border-top:1px solid var(--brd2);font-family:var(--mono);font-size:.78rem">${fmtK(totRef)}</td>
        </tr></tfoot>
      </table></div></div>`;
    }
  }
  document.getElementById("det-c").innerHTML=html;
  document.getElementById("detModal").classList.add("on");
}
function closeModal(){document.getElementById("detModal").classList.remove("on");}
document.getElementById("detModal").addEventListener("click",e=>{if(e.target===document.getElementById("detModal"))closeModal();});

// ‚îÄ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ‚îÄ
// ===== [JS-K] EKSPORT CSV / XLSX / PDF ‚Äî exportCSV, exportXLSX, exportPDF =====

// ‚îÄ‚îÄ‚îÄ Pomocnicze: zbuduj hdr+rows dla danego typu ‚îÄ‚îÄ‚îÄ
function _exportGetData(type){
  let rows=[],hdr=[];
  if(type==="wer"){hdr=["Nr projektu","Beneficjent","Nr wniosku","Wersja","Status","Data z≈Ço≈ºenia","Zaliczka","Refundacja","Wyd.kwal.","Dofinansowanie","Wk≈Çad w≈Çasny","Opiekun","aRPK"];rows=RAW.wer.filter(r=>projInScope(r.nr_proj)).map(r=>[r.nr_proj,r.beneficjent,r.nr_wn,r.ver,r.status,r.data_zloz,r.zaliczka,r.refundacja,r.wyd_kwal,r.dofinansowanie,r.wklad_wlasny,opName(r.opiekun),getWeightedScore(RAW.arpk_map[r.nr_proj]||{})]);}
  else if(type==="pop"){hdr=["Nr projektu","Beneficjent","Nr wniosku","Status","Data z≈Ço≈ºenia","Wyd.kwal.","Opiekun","aRPK"];rows=RAW.pop.filter(r=>projInScope(r.nr_proj)).map(r=>[r.nr_proj,r.beneficjent,r.nr_wn,r.status,r.data_zloz,r.wyd_kwal,opName(r.opiekun),getWeightedScore(RAW.arpk_map[r.nr_proj]||{})]);}
  else if(type==="zat"){hdr=["Nr projektu","Beneficjent","Nr wniosku","Data zatw.","Certyfik.","Korekty","Wyd.kwal.","Opiekun"];rows=RAW.zat.filter(r=>projInScope(r.nr_proj)).map(r=>[r.nr_proj,r.beneficjent,r.nr_wn,r.data_zatw,r.certyfikowana,r.korekty,r.wyd_kwal,opName(r.opiekun)]);}
  else if(type==="rpk"){hdr=["Nr projektu","Beneficjent","Wersji","Wyd.v1","Wyd.ostatnia","R√≥≈ºnica","R√≥≈ºnica %","Opiekun","aRPK"];rows=RAW.rpk.filter(r=>projInScope(r.nr_proj)).map(r=>[r.nr_proj,r.beneficjent,r.ver_count,r.wyd_v1,r.wyd_vl,r.diff,r.diff_pct,opName(r.opiekun),getWeightedScore(RAW.arpk_map[r.nr_proj]||{})]);}
  else if(type==="arpk"){hdr=["Nr projektu","Beneficjent","aRPK","Poziom","R1","R2","R3","R4","R5","R6","R7","R8","R9","Opiekun","Dzia≈Çanie"];rows=Object.entries(RAW.arpk_map).filter(([nr])=>projInScope(nr)).map(([nr,v])=>{const u=RAW.umowy.find(u=>u.nr===nr)||{};const b=v.breakdown||{};const sc=getWeightedScore(v);return[nr,u.beneficjent||"",sc,arpkLevel(sc),b.r1_beneficjent||0,b.r2_wielkosc||0,b.r3_realizatorzy||0,(b.r4_rzeczowy||0).toFixed(1),b.r5_rownolegle||0,b.r6_wersje||0,b.r7_skargi||0,b.r8_nieprawidlowosci||0,b.r9_odchylenie||0,v.opiekun,arpkAction(sc)];}).sort((a,b)=>b[2]-a[2]);}
  else if(type==="wykaz"){
    hdr=["Nr projektu","Beneficjent","Opiekun (skr√≥t)","Opiekun (imiƒô i nazwisko)","Dzia≈Ç","≈πr√≥d≈Ço opiekuna","Ostatni ZAT","WNP ZAT"];
    const allNrs=[...new Set([...RAW.umowy.map(u=>u.nr),...RAW.zat.map(r=>r.nr_proj),...RAW.wer.map(r=>r.nr_proj),...RAW.pop.map(r=>r.nr_proj)].filter(Boolean))].sort();
    rows=allNrs.map(nr=>{
      const u=RAW.umowy.find(u=>u.nr===nr)||{};
      const ef=getEffectiveProjOp(nr);
      const inf=ef.op?opFullInfo(ef.op):null;
      const lastZat=RAW.zat.filter(r=>r.nr_proj===nr&&r.data_zatw).sort((a,b)=>b.data_zatw.localeCompare(a.data_zatw))[0];
      const dzCode=ef.op?CFG.opDzial[ef.op]:'';
      return[nr,u.beneficjent||lastZat?.beneficjent||'',ef.op||'',inf?(inf.name!==ef.op?inf.name:ef.op):'',dzCode?'Dzia≈Ç EFS '+dzCode:'',ef.src,lastZat?lastZat.data_zatw:'',RAW.zat.filter(r=>r.nr_proj===nr).length];
    });
  }
  else if(type==="obciazenie"){
    const bufor=parseInt(document.getElementById('ob-bufor')?.value||'4');
    hdr=["Nr projektu","Beneficjent","Opiekun","Dzia≈Ç","Koniec projektu","Koniec z buforem ("+bufor+"mies.)","Bud≈ºet","Status"];
    const now=new Date();
    rows=obGetProjects().map(p=>{
      const isAct=obIsActiveAt(p,now);
      return[p.nr,p.ben,opName(p.op),p.dz?'Dzia≈Ç EFS '+p.dz:'',
        p.endD?p.endD.toISOString().slice(0,10):'',
        p.endBuf?p.endBuf.toISOString().slice(0,10):'',
        p.budzet,isAct?'Aktywny':'Zamkniƒôty'];
    });
  }
  else if(type==="dzialy"){
    // Eksport heatmapy dzia≈Ç√≥w ‚Äî agregacja per dzia≈Ç per p√≥≈Çrocze
    const projs=obGetProjects();
    const now=new Date();
    const periods=obGetPeriods(projs,'pol');
    const dzMap=new Map();
    projs.forEach(p=>{
      const key=p.dz?`Dzia≈Ç EFS ${p.dz}`:'Nieprzypisany';
      if(!dzMap.has(key))dzMap.set(key,{label:key,projs:[],budzet:0});
      dzMap.get(key).projs.push(p);
      dzMap.get(key).budzet+=(p.budzet||0);
    });
    const dzArr=[...dzMap.values()].sort((a,b)=>a.label.localeCompare(b.label));
    hdr=['Dzia≈Ç','Aktywne dzi≈õ','Bud≈ºet (PLN)',...periods.map(p=>p.label)];
    rows=dzArr.map(d=>{
      const aktywne=d.projs.filter(p=>obIsActiveAt(p,now)).length;
      const perCnts=periods.map(per=>d.projs.filter(p=>obIsActiveAt(p,per.start)).length);
      return[d.label,aktywne,d.budzet,...perCnts];
    });
    // Wiersz RAZEM
    if(rows.length){
      const sumAkt=rows.reduce((s,r)=>s+(r[1]||0),0);
      const sumBud=rows.reduce((s,r)=>s+(r[2]||0),0);
      const sumPers=periods.map((_,i)=>rows.reduce((s,r)=>s+(r[3+i]||0),0));
      rows.push(['RAZEM',sumAkt,sumBud,...sumPers]);
    }
  }
  return {hdr, rows};
}

// ‚îÄ‚îÄ‚îÄ EKSPORT CSV ‚îÄ‚îÄ‚îÄ
function exportCSV(type){
  const {hdr,rows}=_exportGetData(type);
  const esc=v=>{const s=String(v??'');return s.includes(',')||s.includes('"')||s.includes('\n')?'"'+s.replace(/"/g,'""')+'"':s;};
  const csv=[hdr,...rows].map(r=>r.map(esc).join(',')).join('\r\n');
  const a=document.createElement("a");a.href=URL.createObjectURL(new Blob(["\ufeff"+csv],{type:"text/csv;charset=utf-8"}));a.download=`RBMV_${type}_${NOW.toISOString().slice(0,10)}.csv`;a.click();
}

// ‚îÄ‚îÄ‚îÄ EKSPORT XLSX ‚Äî styl raportu EFS+ ‚îÄ‚îÄ‚îÄ
function exportXLSX(type){
  if(!window.XLSX){showToast('B≈ÇƒÖd: biblioteka XLSX nie jest za≈Çadowana');return;}
  const {hdr,rows}=_exportGetData(type);
  const now=NOW.toLocaleDateString('pl-PL');
  const title=_exportTitle(type);

  const wb=XLSX.utils.book_new();
  const wsData=[];

  // Wiersz 1: Nag≈Ç√≥wek raportu
  wsData.push(['FUNDUSZE EUROPEJSKIE DLA DOLNEGO ≈öLƒÑSKA 2021-2027','','','','DATA WYGENEROWANIA','','',now]);
  // Wiersz 2: Pusty
  wsData.push([]);
  // Wiersz 3: Tytu≈Ç sekcji
  wsData.push([title]);
  // Wiersz 4: Liczby podsumowujƒÖce (zale≈ºne od typu)
  const summary=_exportSummary(type,rows);
  wsData.push(summary.map(s=>s.label+': '+s.val));
  wsData.push([]);
  // Wiersz 6+: nag≈Ç√≥wki kolumn
  wsData.push(hdr);
  rows.forEach(r=>wsData.push(r));

  const ws=XLSX.utils.aoa_to_sheet(wsData);

  // Szeroko≈õci kolumn (auto)
  const maxW=hdr.map((_,ci)=>Math.min(40,Math.max(10,...[hdr,...rows].map(r=>String(r[ci]??'').length))));
  ws['!cols']=maxW.map(w=>({wch:w+2}));

  XLSX.utils.book_append_sheet(wb,ws,title.slice(0,28));
  XLSX.writeFile(wb,`RBMV_${type}_${NOW.toISOString().slice(0,10)}.xlsx`);
  showToast('Pobrano XLSX: RBMV_'+type+'_'+NOW.toISOString().slice(0,10)+'.xlsx ‚úì');
}

// ‚îÄ‚îÄ‚îÄ EKSPORT PDF ‚Äî raport poziomy w stylu FEDS ‚îÄ‚îÄ‚îÄ
function exportPDF(type){
  const {hdr,rows}=_exportGetData(type);
  const now=NOW.toLocaleDateString('pl-PL');
  const title=_exportTitle(type);
  const summary=_exportSummary(type,rows);
  const progName='FEDS.08.01';

  // Budujemy HTML do druku
  const kpiBoxes=summary.map(s=>`
    <div class="kpi-box" style="border-color:${s.color||'#2563eb'}">
      <div class="kpi-num" style="color:${s.color||'#2563eb'}">${s.val}</div>
      <div class="kpi-lbl">${s.label.toUpperCase()}</div>
    </div>`).join('');

  // Kolory poziom√≥w w tabeli
  const lvlColor=v=>{
    const s=String(v??'').toUpperCase();
    if(s.includes('B≈ÅƒÑD')||s.includes('KRYT')||s.includes('WYSOK'))return'#dc2626';
    if(s.includes('UWAAG')||s.includes('UWA≈ª')||s.includes('≈öRED')||s.includes('OSTRZE≈ª'))return'#d97706';
    if(s.includes('INFO')||s.includes('NISKI'))return'#2563eb';
    if(s.includes('OK')||s.includes('AKTYAW'))return'#059669';
    return null;
  };

  const tBody=rows.map((r,ri)=>{
    const cells=r.map((v,ci)=>{
      const cl=ci===1||hdr[ci]==='Poziom'||hdr[ci]==='Status'?lvlColor(v):null;
      const badge=cl?`<span style="background:${cl}15;color:${cl};border:1px solid ${cl}40;padding:1px 7px;border-radius:4px;font-weight:800;font-size:.78rem;white-space:nowrap">${v}</span>`:v;
      return `<td>${cl?badge:(v??'‚Äî')}</td>`;
    }).join('');
    return `<tr style="${ri%2===0?'':'background:#f8fafc'}">${cells}</tr>`;
  }).join('');

  const html=`<!DOCTYPE html><html lang="pl"><head><meta charset="UTF-8">
<title>${title}</title>
<style>
  @page{size:A4 landscape;margin:10mm 12mm}
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:'Segoe UI',Arial,sans-serif;font-size:9pt;color:#0f172a;background:#fff}
  .report-hdr{display:flex;align-items:flex-start;justify-content:space-between;border-bottom:3px solid #0f172a;padding-bottom:6px;margin-bottom:10px}
  .report-logo{font-weight:900;font-size:10pt;line-height:1.25;text-transform:uppercase;letter-spacing:-.01em}
  .report-logo span{color:#2563eb}
  .report-meta{text-align:right;font-size:8pt;color:#64748b}
  .report-meta strong{color:#0f172a;font-size:9pt}
  .badge-program{display:inline-block;background:#0f172a;color:#fff;font-size:7.5pt;font-weight:800;padding:2px 8px;border-radius:3px;text-transform:uppercase;letter-spacing:.08em;margin-top:3px}
  h2{font-size:12pt;font-weight:900;text-transform:uppercase;letter-spacing:.03em;border-left:4px solid #2563eb;padding-left:8px;margin:10px 0 8px}
  .kpi-row{display:flex;gap:10px;margin-bottom:12px}
  .kpi-box{border:2px solid #2563eb;border-radius:8px;padding:8px 14px;min-width:100px;text-align:center}
  .kpi-num{font-size:22pt;font-weight:900;line-height:1}
  .kpi-lbl{font-size:6.5pt;font-weight:900;text-transform:uppercase;letter-spacing:1px;margin-top:2px}
  table{width:100%;border-collapse:collapse;font-size:7.8pt}
  th{background:#0f172a;color:#94a3b8;padding:5px 7px;text-align:left;font-size:6.5pt;font-weight:900;text-transform:uppercase;letter-spacing:.08em;white-space:nowrap}
  td{padding:4px 7px;border-bottom:1px solid #e2e8f0;vertical-align:middle;white-space:nowrap;max-width:200px;overflow:hidden;text-overflow:ellipsis}
  .report-ftr{margin-top:12px;border-top:1px solid #e2e8f0;padding-top:6px;font-size:7pt;color:#94a3b8;display:flex;justify-content:space-between}
  .acc{color:#2563eb}.grn{color:#059669}.red{color:#dc2626}.yel{color:#d97706}
</style></head><body>
  <div class="report-hdr">
    <div>
      <div class="report-logo">FUNDUSZE EUROPEJSKIE<br>DLA DOLNEGO <span>≈öLƒÑSKA</span> 2021‚Äì2027</div>
      <div class="badge-program">${progName} ¬∑ IZ</div>
    </div>
    <div class="report-meta">
      <div>DATA WYGENEROWANIA</div>
      <strong>${now}</strong>
    </div>
  </div>
  <h2>${title}</h2>
  <div class="kpi-row">${kpiBoxes}</div>
  <table>
    <thead><tr>${hdr.map(h=>`<th>${h}</th>`).join('')}</tr></thead>
    <tbody>${tBody}</tbody>
  </table>
  <div class="report-ftr">
    <span>Niniejszy raport zosta≈Ç wygenerowany automatycznie przez system AIZarzadzanie v10.6 ¬∑ Wydzia≈Ç Wdra≈ºania EFS+ ¬∑ Departament Funduszy Europejskich</span>
    <span>${rows.length} rekord√≥w</span>
  </div>
<script>window.onload=()=>{window.print();}<\/script>
</body></html>`;

  const w=window.open('','_blank','width=1200,height=800');
  if(w){w.document.write(html);w.document.close();}
  else showToast('Zezw√≥l na otwieranie okien pop-up');
}

// ‚îÄ‚îÄ‚îÄ Pomocnicze: tytu≈Ç raportu ‚îÄ‚îÄ‚îÄ
function _exportTitle(type){
  return{
    wer:'Wnioski w bie≈ºƒÖcej weryfikacji',
    pop:'Wnioski w poprawie',
    zat:'Zatwierdzone wnioski o p≈Çatno≈õƒá',
    rpk:'Wnioski o p≈Çatno≈õƒá ‚Äî RPK',
    arpk:'Analiza ryzyka aRPK (RBMV)',
    wykaz:'Wykaz projekt√≥w i opiekun√≥w',
    obciazenie:'Baza projekt√≥w ‚Äî obciƒÖ≈ºenie',
    dzialy:'Heatmapa obciƒÖ≈ºenia dzia≈Ç√≥w'
  }[type]||type;
}

// ‚îÄ‚îÄ‚îÄ Pomocnicze: podsumowanie KPI ‚îÄ‚îÄ‚îÄ
function _exportSummary(type,rows){
  if(type==='wer') return[
    {label:'Razem w weryfikacji',val:rows.length,color:'#2563eb'},
    {label:'≈ÅƒÖczne wyd.kwal.',val:fmtK(rows.reduce((s,r)=>s+(parseFloat(r[8])||0),0)),color:'#059669'}
  ];
  if(type==='pop') return[
    {label:'Razem w poprawie',val:rows.length,color:'#ea580c'},
    {label:'≈ÅƒÖczne wyd.kwal.',val:fmtK(rows.reduce((s,r)=>s+(parseFloat(r[5])||0),0)),color:'#059669'}
  ];
  if(type==='zat') return[
    {label:'Razem zatwierdzonych',val:rows.length,color:'#059669'},
    {label:'Z korektami',val:rows.filter(r=>(parseFloat(r[5])||0)>0).length,color:'#d97706'},
    {label:'≈ÅƒÖczne wyd.kwal.',val:fmtK(rows.reduce((s,r)=>s+(parseFloat(r[6])||0),0)),color:'#0891b2'}
  ];
  if(type==='rpk') return[
    {label:'Razem wniosk√≥w',val:rows.length,color:'#2563eb'},
    {label:'Z korektami',val:rows.filter(r=>(parseFloat(r[2])||0)>1).length,color:'#d97706'}
  ];
  if(type==='arpk') return[
    {label:'Projekt√≥w',val:rows.length,color:'#2563eb'},
    {label:'Krytyczne (‚â•75)',val:rows.filter(r=>(parseFloat(r[2])||0)>=75).length,color:'#dc2626'},
    {label:'Wysokie (50‚Äì74)',val:rows.filter(r=>{const s=parseFloat(r[2])||0;return s>=50&&s<75;}).length,color:'#d97706'},
    {label:'Niskie (<25)',val:rows.filter(r=>(parseFloat(r[2])||0)<25).length,color:'#059669'}
  ];
  if(type==='obciazenie') return[
    {label:'Projekt√≥w',val:rows.length,color:'#2563eb'},
    {label:'Aktywnych dzi≈õ',val:rows.filter(r=>r[7]==='Aktywny').length,color:'#059669'},
    {label:'Zamkniƒôtych',val:rows.filter(r=>r[7]==='Zamkniƒôty').length,color:'#94a3b8'}
  ];
  if(type==='dzialy'){
    // Ostatni wiersz to RAZEM
    const sumRow=rows.find(r=>r[0]==='RAZEM');
    const dzialy=rows.filter(r=>r[0]!=='RAZEM');
    return[
      {label:'Dzia≈Ç√≥w',val:dzialy.length,color:'#2563eb'},
      {label:'Aktywnych projekt√≥w (dzi≈õ)',val:sumRow?sumRow[1]:dzialy.reduce((s,r)=>s+(r[1]||0),0),color:'#059669'},
      {label:'≈ÅƒÖczny bud≈ºet',val:fmtK(dzialy.reduce((s,r)=>s+(r[2]||0),0)),color:'#0891b2'}
    ];
  }
  return[{label:'Rekord√≥w',val:rows.length,color:'#2563eb'}];
}

// ‚îÄ‚îÄ‚îÄ IMPORT ENGINE ‚îÄ‚îÄ‚îÄ
const IMP_HISTORY=[];
let IMP_PENDING=null; // parsed data waiting for apply

// ‚îÄ‚îÄ SHEET MAPPINGS: sheet name patterns ‚Üí parser function ‚îÄ‚îÄ
// ‚îÄ‚îÄ PARSERY ARKUSZY ‚îÄ‚îÄ data-ai-id: ai-ID.parser.sheet-parsers
const SHEET_PARSERS=[
  { // data-ai-id: ai-ID.parser.wnp-biezace
    match: s=>s==='WNP.biezace'||s==='Raport wnioski bie≈ºƒÖce'||s==='Raport wnioski z≈Ço≈ºone',
    label:'Wnioski bie≈ºƒÖce (WER/POP)',
    parse: parseWnpBiezace
  },
  { // data-ai-id: ai-ID.parser.wnp-certyfikowane
    match: s=>s==='WNP.certyfikowane'||s==='Raport wnioski certyfikowane',
    label:'Wnioski certyfikowane (ZAT)',
    parse: parseWnpCert
  },
  { // data-ai-id: ai-ID.parser.wnp-wszystkie
    match: s=>s==='WNP.wszystkie',
    label:'Wszystkie wnioski (WER+ZAT+RPK)',
    parse: parseWnpWszystkie
  },
  { // data-ai-id: ai-ID.parser.uda-umowy
    match: s=>s==='UDA.umowy'||s==='Raport dane z um√≥w',
    label:'Umowy projekt√≥w',
    parse: parseUdaUmowy
  },
  { // data-ai-id: ai-ID.parser.hp-wszystkie
    match: s=>s==='HP.wszystkie'||s==='Raport HP',
    label:'Harmonogramy p≈Çatno≈õci',
    parse: parseHp
  },
  { // data-ai-id: ai-ID.parser.wnp-wskazniki
    match: s=>s==='WNP.wskazniki',
    label:'Wska≈∫niki projekt√≥w',
    parse: parseWskazniki
  },
  { // data-ai-id: ai-ID.parser.uda-zad-planowane
    match: s=>s==='UDA.zad.rozliczenie',
    label:'Zadania ‚Äî wydatki planowane (UDA)',
    parse: (rows,log)=>parseZadaniaUda(rows,log)
  },
  { // data-ai-id: ai-ID.parser.wnp-zad-poniesione
    match: s=>s==='WNP.zad.rozliczone'||s==='Rozliczenie zada≈Ñ',
    label:'Zadania ‚Äî wydatki poniesione (WNP)',
    parse: (rows,log)=>parseZadaniaWnp(rows,log)
  },
  { // data-ai-id: ai-ID.parser.wnp-zadania-legacy (zachowany dla kompatybilno≈õci wstecznej)
    match: s=>false, // legacy - zastƒÖpiony przez parseZadaniaUda i parseZadaniaWnp
    label:'Rozliczenie zada≈Ñ (legacy)',
    parse: parseZadania
  },
  { // data-ai-id: ai-ID.parser.rodzaj-weryfikacji
    match: s=>s==='Raport rodzaj weryfikacji',
    label:'Rodzaj weryfikacji (opiekunowie)',
    parse: parseRodzajWeryfikacji
  },
];

// ‚îÄ‚îÄ COL FINDER: find column by multiple possible names ‚îÄ‚îÄ
function col(row, ...names){
  for(const n of names){if(row[n]!==undefined && row[n]!==null && row[n]!=='') return row[n];}
  return null;
}
function colStr(row,...names){const v=col(row,...names);return v!=null?String(v).trim():null;}
function colNum(row,...names){
  const v=col(row,...names);
  if(v==null)return null;
  // If already a number (XLSX parsed it natively), return directly
  if(typeof v==='number')return isNaN(v)?null:v;
  let s=String(v).trim();
  // Remove currency symbols and whitespace separators
  s=s.replace(/[z≈Ç\s\u00a0]/g,'');
  // Detect format:
  // Polish: 1.234.567,89 or 1 234 567,89 ‚Üí comma is decimal
  // English: 1,234,567.89 ‚Üí dot is decimal
  // Ambiguous: 1.234 or 1,234 (could be either)
  if(/,\d{1,2}$/.test(s)){
    // Comma at end = decimal separator (Polish format)
    s=s.replace(/\./g,'').replace(',','.');
  } else if(/\.\d{1,2}$/.test(s)&&s.indexOf(',')!==-1){
    // Dot at end with comma separators (English format)
    s=s.replace(/,/g,'');
  } else if(/,\d{3}/.test(s)&&s.indexOf('.')===-1){
    // Comma as thousands separator only (English: 1,234,567)
    s=s.replace(/,/g,'');
  } else if(/\.\d{3}/.test(s)&&s.indexOf(',')===-1){
    // Dot as thousands separator only (Polish: 1.234.567)
    s=s.replace(/\./g,'');
  } else {
    // Last resort: replace any single comma with dot
    s=s.replace(',','.');
  }
  const n=parseFloat(s);
  return isNaN(n)?null:n;
}
function colDate(row,...names){
  const v=col(row,...names);if(!v)return null;
  if(v instanceof Date){const y=v.getFullYear(),m=String(v.getMonth()+1).padStart(2,'0'),d=String(v.getDate()).padStart(2,'0');return`${y}-${m}-${d}`;}
  const s=String(v).trim();if(/^\d{4}-\d{2}-\d{2}/.test(s))return s.slice(0,10);
  // Excel serial
  if(!isNaN(v)){const d=new Date(Math.round((+v-25569)*86400000));return d.toISOString().slice(0,10);}
  return null;
}
// ===== [JS-L] PARSOWANIE DANYCH XLSX ‚Äî projKey, parseWnpBiezace, parseUdaUmowy, mergeImport =====
function projKey(row,...names){
  const v=colStr(row,...names);if(!v)return null;
  // Normalize: extract base project number
  const m=v.match(/(FEDS\.\d+\.\d+-IZ\.00-\d+\/\d{2})/i);
  return m?m[1]:v;
}
function wnToProj(wn){
  if(!wn)return null;
  const m=String(wn).match(/(FEDS\.\d+\.\d+-IZ\.00-\d+\/\d{2})/i);
  return m?m[1]:null;
}

// ‚îÄ‚îÄ PARSERS ‚îÄ‚îÄ

// Normalizacja numeru wniosku: wyciƒÖga czƒô≈õƒá bazowƒÖ i numer korekty
// np. "FEDS.08.01-IZ.00-0001/23-001-K01" ‚Üí {base:"FEDS.08.01-IZ.00-0001/23-001", korNr:1, isKorekta:true}
// np. "FEDS.08.01-IZ.00-0001/23-001" ‚Üí {base:"FEDS.08.01-IZ.00-0001/23-001", korNr:0, isKorekta:false}
function parseNrWn(nr_wn){
  if(!nr_wn)return{base:nr_wn,korNr:0,isKorekta:false};
  const s=String(nr_wn).trim();
  const m=s.match(/^(.+?)-K(\d+)$/i);
  if(m)return{base:m[1],korNr:parseInt(m[2]),isKorekta:true};
  return{base:s,korNr:0,isKorekta:false};
}

// Scala wnioski g≈Ç√≥wne z ich korektami -K** w jeden wpis (sumuje kwoty)
// Identyfikatorem jest nr_wn bazowy (bez -K**)
// Korekty tej samej wersji wniosku sumujƒÖ swoje kwoty do wniosku bazowego
function mergeKorekty(records){
  const byBase={};
  // Wnioski z null/brak nr_wn ‚Äî zachowaj ka≈ºdy osobno u≈ºywajƒÖc index jako klucza awaryjnego
  let nullIdx=0;
  // Najpierw przejd≈∫ g≈Ç√≥wne wnioski (nie-korekty)
  for(const r of records){
    const{base,isKorekta}=parseNrWn(r.nr_wn);
    if(!isKorekta){
      // Je≈õli nr_wn jest null/pusty ‚Äî u≈ºyj klucza awaryjnego ≈ºeby nie nadpisywaƒá
      const key=base!=null&&base!==''?base:`__null_${nullIdx++}`;
      byBase[key]={...r,nr_wn:base,korekty_cnt:0,_korektaList:[]};
    }
  }
  // Potem dodaj korekty do wniosk√≥w bazowych
  for(const r of records){
    const{base,isKorekta}=parseNrWn(r.nr_wn);
    if(isKorekta){
      if(byBase[base]){
        byBase[base].zaliczka=(byBase[base].zaliczka||0)+(r.zaliczka||0);
        byBase[base].refundacja=(byBase[base].refundacja||0)+(r.refundacja||0);
        byBase[base].wyd_kwal=(byBase[base].wyd_kwal||0)+(r.wyd_kwal||0);
        byBase[base].dofinansowanie=(byBase[base].dofinansowanie||0)+(r.dofinansowanie||0);
        byBase[base].wklad_wlasny=(byBase[base].wklad_wlasny||0)+(r.wklad_wlasny||0);
        byBase[base].wyd_uznane=(byBase[base].wyd_uznane||0)+(r.wyd_uznane||0);
        byBase[base].korekty_cnt=(byBase[base].korekty_cnt||0)+1;
        byBase[base]._korektaList.push(r.nr_wn);
        if(r.data_zatw&&(!byBase[base].data_zatw||r.data_zatw>byBase[base].data_zatw))
          byBase[base].data_zatw=r.data_zatw;
      } else {
        // Korekta bez wniosku bazowego ‚Äî samodzielny wpis
        byBase[base]={...r,nr_wn:base,korekty_cnt:1,_korektaList:[r.nr_wn]};
      }
    }
  }
  return Object.values(byBase).map(r=>{
    const{_korektaList,...rest}=r;
    return{...rest,korekty:r.korekty_cnt||0};
  });
}

// ai-ID.parser.fn.wnp-biezace ‚Äî zasila: RAW.wer (statusy WER) + RAW.pop (statusy POP)
// Arkusze: WNP.biezace | Raport wnioski bie≈ºƒÖce | Raport wnioski z≈Ço≈ºone
// Kolumny kwotowe: Zaliczka, Refundacja, Wydatki kwalifikowalne, Dofinansowanie, Razem wk≈Çad w≈Çasny - Wydatki kwalifikowalne
function parseWnpBiezace(rows,log){
  const werAll=[],popAll=[];
  const POP_ST=new Set(['Do poprawy','Poprawiany','Poprawiony','Do korekty','Korygowany']);
  // SKIP_ST: wszystkie statusy kt√≥re oznaczajƒÖ wniosek zako≈Ñczony/zatwierdzony
  // Pe≈Çna lista ‚Äî im szerzej tym lepiej, bo mergeImport i tak wyczy≈õci duplikaty z ZAT
  const SKIP_ST=new Set([
    'Zatwierdzony','Zatwierdzono','Zatwierdzono weryfikacjƒô',
    'Zatwierdzony do p≈Çatno≈õci','Zatwierdzony do certyfikacji',
    'Certyfikowany','Certyfikowane','Zatwierdzone',
    'Wycofany','Anulowany','Odrzucony','Zako≈Ñczony','Zamkniƒôty',
    'Wyp≈Çacony','Zrealizowany','Rozliczony',
  ]);
  let ok=0,skip=0;
  // Diagnostyka ‚Äî sprawd≈∫ dostƒôpne kolumny z pierwszego wiersza
  if(rows.length>0){
    const cols=Object.keys(rows[0]);
    const wnCols=cols.filter(c=>/wnios|numer|nr/i.test(c));
    const stCols=cols.filter(c=>/status/i.test(c));
    log(`  ‚Ñπ Kolumny nr wniosku: ${wnCols.join(', ')||'brak'} ¬∑ status: ${stCols.join(', ')||'brak'}`);
  }
  for(const r of rows){
    const nr_proj=projKey(r,'Numer projektu');if(!nr_proj){skip++;continue;}
    const nr_wn_raw=colStr(r,'Numer wniosku','Numer wniosku o p≈Çatno≈õƒá/korekty');
    const status=colStr(r,'Status wniosku','Status weryfikacji','Status');
    if(SKIP_ST.has(status)){skip++;continue;}
    // Dodatkowe sprawdzenie: je≈õli status zawiera s≈Çowo kluczowe zatwierdzenia ‚Äî pomi≈Ñ
    if(status&&/(zatwierdzon|certyfikow|zamkniƒôt|zako≈Ñczon|rozliczon|wycofan|anulown|wyp≈Çacon)/i.test(status)){
      skip++;continue;
    }
    // Version from wniosek base number suffix (ignore -K** suffix for version)
    const{base:nr_wn_base}=parseNrWn(nr_wn_raw||'');
    const verMatch=nr_wn_base&&nr_wn_base.match(/-0*(\d+)$/);const ver=verMatch?parseInt(verMatch[1]):1;
    const data_zloz=colDate(r,'Data z≈Ço≈ºenia','Data przes≈Çania')||null;
    const base={
      nr_proj,
      beneficjent:colStr(r,'Nazwa Beneficjenta','Beneficjent Nazwa','Beneficjent')||'',
      nr_wn:nr_wn_raw,ver,status,data_zloz,
      zaliczka:colNum(r,'Zaliczka')||0,
      refundacja:colNum(r,'Refundacja')||0,
      wyd_kwal:colNum(r,'Wydatki kwalifikowalne')||0,
      dofinansowanie:colNum(r,'Dofinansowanie')||0,
      wklad_wlasny:colNum(r,'Razem wk≈Çad w≈Çasny - Wydatki kwalifikowalne','Wk≈Çad w≈Çasny')||0,
      opiekun:colStr(r,'Osoba odpowiedzialna za weryfikacjƒô')||
               colStr(r,'Opiekun')||
               (RAW.arpk_map[nr_proj]||{}).opiekun||'',
      arpk:(RAW.arpk_map[nr_proj]||{}).score||0,
    };
    if(POP_ST.has(status))popAll.push(base);
    else werAll.push(base);
    ok++;
  }
  // Scalamy korekty -K** z wnioskami bazowymi i deduplikujemy po nr_wn_base
  const wer=mergeKorekty(werAll);
  const pop=mergeKorekty(popAll);
  log(`  ‚úì Wnioski bie≈ºƒÖce: ${wer.length} w weryfikacji, ${pop.length} w poprawie (${ok} wierszy, ${skip} pominiƒôtych)`);
  return{wer,pop};
}

// ai-ID.parser.fn.wnp-certyfikowane ‚Äî zasila: RAW.zat
// Arkusze: WNP.certyfikowane | Raport wnioski certyfikowane
// Kolumny kwotowe: Wydatki kwalifikowalne WOP, Wydatki uznane za kwalifikowalne WOP,
//   Dofinansowanie WOP, Kwota udzielonej zaliczki WOP, Kwota refundacji WOP
function parseWnpCert(rows,log){
  const zatAll=[];let ok=0,skip=0,nullNrWn=0;
  // Diagnostyka ‚Äî sprawd≈∫ dostƒôpne kolumny z pierwszego wiersza
  if(rows.length>0){
    const cols=Object.keys(rows[0]);
    const wnCols=cols.filter(c=>/wnios|numer|nr/i.test(c));
    log(`  ‚Ñπ Kolumny numeru wniosku w WNP.cert: ${wnCols.join(', ')||'brak dopasowania'}`);
  }
  for(const r of rows){
    const nr_proj=projKey(r,'Numer projektu','nr_proj');if(!nr_proj){skip++;continue;}
    // Pr√≥buj wszystkich mo≈ºliwych nazw kolumny numeru wniosku
    let nr_wn_raw=colStr(r,
      'Numer wniosku o p≈Çatno≈õƒá/korekty',
      'Numer wniosku o platno≈õƒá/korekty',
      'Numer wniosku o p≈Çatno≈õƒá / korekty',
      'Numer wniosku',
      'Numer WNP',
      'Nr wniosku',
      'nr_wn'
    );
    // Fallback: je≈õli nr_wn jest null ale mamy data_zatw, wygeneruj nr z nr_proj + daty
    // To pozwala zaimportowaƒá wszystkie ZAT nawet gdy kolumna ma nieznazwanƒÖ nazwƒô
    const data_zatw=colDate(r,'Data zatwierdzenia wniosku','Data zatwierdzenia weryfikacji','Data zatwierdzenia','data_zatw');
    if(!nr_wn_raw){
      nullNrWn++;
      // Wygeneruj unikalny nr_wn z nr_proj + data_zatw (lub indeks)
      nr_wn_raw='__ZAT__:'+nr_proj+(data_zatw?':'+data_zatw:':'+ok);
    }
    const data_wplywu=colDate(r,'Data wp≈Çywu','Data z≈Ço≈ºenia','Data przes≈Çania','Data przyjƒôcia','data_wplywu')||null;
    const miesiac=data_zatw?data_zatw.slice(0,7):null;
    zatAll.push({
      nr_proj,beneficjent:colStr(r,'Beneficjent Nazwa','Nazwa Beneficjenta','Beneficjent','beneficjent')||'',
      nr_wn:nr_wn_raw,data_zatw,data_wplywu,miesiac,
      wyd_kwal:colNum(r,'Wydatki kwalifikowalne WOP','Wydatki kwalifikowalne','wyd_kwal')||0,
      wyd_uznane:colNum(r,'Wydatki uznane za kwalifikowalne WOP','Wydatki uznane','wyd_uznane')||0,
      dofinansowanie:colNum(r,'Dofinansowanie WOP','Dofinansowanie','dofinansowanie')||0,
      zaliczka:colNum(r,'Kwota udzielonej zaliczki WOP','Zaliczka','zaliczka')||0,
      refundacja:colNum(r,'Kwota refundacji WOP','Refundacja','refundacja')||0,
      korekty:0,
      certyfikowana:colStr(r,'Certyfikowana','certyfikowana')||'N',
      opiekun:colStr(r,'Osoba odpowiedzialna za weryfikacjƒô','Opiekun','opiekun')||'',
      arpk:(RAW.arpk_map[nr_proj]||{}).score||0,
    });ok++;
  }
  if(nullNrWn>0)log(`  <span class="warn">‚ö† WNP.cert: ${nullNrWn} wierszy bez numeru wniosku ‚Äî sprawd≈∫ nazwy kolumn w pliku!</span>`);
  const zat=mergeKorekty(zatAll);
  log(`  ‚úì Wnioski certyfikowane: ${zat.length} (z ${ok} wierszy${nullNrWn>0?`, ${nullNrWn} bez nr_wn`:''})`);
  return{zat};
}

// ai-ID.parser.fn.wnp-wszystkie ‚Äî zasila: RAW.wer + RAW.pop + RAW.zat (≈ÇƒÖczy oba parsery)
// Arkusze: WNP.wszystkie
// Logika: wiersze z datƒÖ zatwierdzenia ‚Üí parseWnpCert, pozosta≈Çe ‚Üí parseWnpBiezace
function parseWnpWszystkie(rows,log){
  // Similar to biezace + cert combined - build wer, pop, zat, rpk
  const all=parseWnpBiezace(rows.filter(r=>!colDate(r,'Data zatwierdzenia weryfikacji','data_zatw')),log);
  const cert=parseWnpCert(rows.filter(r=>colDate(r,'Data zatwierdzenia weryfikacji','data_zatw')),log);
  return{...all,...cert};
}

// ai-ID.parser.fn.uda-umowy ‚Äî zasila: RAW.umowy ‚Üí Rozliczenie, Postƒôp fin., Opiekunowie, aRPK
// Arkusze: UDA.umowy | Raport dane z um√≥w
// Kolumny kwotowe: Suma - Wydatki kwalifikowalne (bud≈ºet!), Dofinansowanie,
//   Rzeczywi≈õcie ponoszone - Wydatki kwalifikowalne, Uproszczona metoda rozliczania - Wydatki kwalifikowalne
function parseUdaUmowy(rows,log){
  const umowy=[];let ok=0,skip=0;
  for(const r of rows){
    const nr=projKey(r,'Numer projektu','nr');if(!nr){skip++;continue;}
    umowy.push({
      nr,
      beneficjent:colStr(r,'Beneficjent','Wn/Ben Nazwa','beneficjent')||'',
      tytu:colStr(r,'Tytu≈Ç projektu','tytu')||'',
      status:colStr(r,'Status projektu','status')||'',
      od:colDate(r,'Okres realizacji projektu od','od'),
      do:colDate(r,'Okres realizacji projektu do','do'),
      data_umowy:colDate(r,'Data podpisania umowy','data_umowy'),
      budzet:colNum(r,'Suma - Wydatki kwalifikowalne','budzet')||0,
      dofinansowanie:colNum(r,'Dofinansowanie','dofinansowanie')||0,
      rzeczywiste:colNum(r,'Rzeczywi≈õcie ponoszone - Wydatki kwalifikowalne','rzeczywiste')||0,
      ryczalt:colNum(r,'Uproszczona metoda rozliczania - Wydatki kwalifikowalne','ryczalt')||0,
      forma_prawna:colStr(r,'Wn/Ben Forma prawna','forma_prawna')||'',
      typ_proj:colStr(r,'Typ projektu','typ_proj')||'',
      rodzaj_proj:colStr(r,'Rodzaj projektu (podmioty/rozliczenie)','rodzaj_proj')||'',
      ma_umowe:(colStr(r,'Czy umowa (T/N)','ma_umowe')||'N')==='T',
      opiekun:colStr(r,'Osoba odpowiedzialna za weryfikacjƒô','opiekun')||(RAW.umowy.find(u=>u.nr===nr)||{}).opiekun||'',
    });ok++;
  }
  log(`  ‚úì Umowy: ${ok} przetworzonych, ${skip} pominiƒôtych`);
  return{umowy};
}

// ai-ID.parser.fn.hp ‚Äî zasila: RAW.hp_wer + RAW.hp_zat
// Arkusze: HP.wszystkie | Raport HP
// Kolumny kwotowe: Wydatki kwalifikowalne, Zaliczka, Refundacja
function parseHp(rows,log){
  const hp_wer=[],hp_zat=[];let ok=0;
  const WER_HP=new Set(['Przes≈Çany','W weryfikacji','Do akceptacji']);
  for(const r of rows){
    const nr=projKey(r,'Numer projektu');if(!nr){continue;}
    const rec={
      'Numer projektu':nr,
      'Beneficjent Nazwa':colStr(r,'Beneficjent Nazwa','Beneficjent')||'',
      'Numer wersji harmonogramu':colNum(r,'Numer wersji harmonogramu')||1,
      'Status':colStr(r,'Status')||'',
      'Data przes≈Çania':colDate(r,'Data przes≈Çania'),
      'Data zatwierdzenia':colDate(r,'Data zatwierdzenia'),
      'Wydatki kwalifikowalne':colNum(r,'Wydatki kwalifikowalne')||0,
      'Zaliczka':colNum(r,'Zaliczka')||0,
      'Refundacja':colNum(r,'Refundacja')||0,
    };
    if(WER_HP.has(rec.Status)||!rec['Data zatwierdzenia']) hp_wer.push(rec);
    else hp_zat.push(rec);
    ok++;
  }
  log(`  ‚úì Harmonogramy: ${ok} rekord√≥w (${hp_wer.length} w weryfikacji, ${hp_zat.length} zatwierdzonych)`);
  return{hp_wer,hp_zat};
}

// ai-ID.parser.fn.wskazniki ‚Äî zasila: RAW.wskazniki ‚Üí Postƒôp rzeczowy, aRPK kategoria R4
// Arkusze: WNP.wskazniki
// Kolumny: Warto≈õƒá docelowa/O, Warto≈õƒá osiƒÖgniƒôta od poczƒÖtku realizacji projektu/O
// LOGIKA: wska≈∫niki sƒÖ narastajƒÖce ‚Äî bierzemy tylko OSTATNI wniosek na projekt
//   Tryb A (preferowany): kolumna "Czy ostatni wniosek (za najp√≥≈∫niejszy okres)" = "T"
//   Tryb B (fallback):    parsowanie numeru FEDS.XX-IZ.00-XXXX/XX-SEQ-VER ‚Üí max(seq), max(ver)
function parseWsnSeqVer(nr_wn){
  if(!nr_wn)return{seq:0,ver:0};
  const s=String(nr_wn).trim().replace(/-K\d+$/i,'');
  const m=s.match(/-(\d{3})-(\d{2,3})$/);
  if(m)return{seq:parseInt(m[1]),ver:parseInt(m[2])};
  const m2=s.match(/-(\d{3})$/);
  if(m2)return{seq:parseInt(m2[1]),ver:0};
  return{seq:0,ver:0};
}
function parseWskazniki(rows,log){
  // Wykryj czy plik zawiera kolumnƒô "Czy ostatni wniosek"
  const hasOstatniCol=rows.length>0&&'Czy ostatni wniosek (za najp√≥≈∫niejszy okres)' in rows[0];
  const hasAktualnaCol=rows.length>0&&'Czy aktualna wersja wniosku' in rows[0];
  let tryb=hasOstatniCol?'A':'B';
  log(`  ¬∑ Wska≈∫niki: tryb filtrowania = ${tryb} (${tryb==='A'?'kolumna Czy ostatni wniosek':'parsowanie numeru wniosku'})`);

  let filteredRows=rows;
  if(tryb==='A'){
    // Tryb A: filtruj wiersze gdzie ostatni=T (i opcjonalnie aktualna=T)
    filteredRows=rows.filter(r=>{
      const ostatni=colStr(r,'Czy ostatni wniosek (za najp√≥≈∫niejszy okres)');
      const aktualna=hasAktualnaCol?colStr(r,'Czy aktualna wersja wniosku'):null;
      // Wymagamy ostatni=T; je≈õli jest kolumna aktualna ‚Äî te≈º T
      return ostatni==='T'&&(aktualna===null||aktualna==='T');
    });
    log(`  ¬∑ Wska≈∫niki: po filtrze ostatni=T: ${filteredRows.length}/${rows.length} wierszy`);
  }

  // Tryb B (fallback) lub budowanie bestWn do last_wn badge
  const bestWn={};
  for(const r of filteredRows.length?filteredRows:rows){
    const nr_wn=colStr(r,'Numer wniosku');
    const nr=wnToProj(nr_wn)||projKey(r,'Numer projektu');
    if(!nr||!nr_wn)continue;
    const {seq,ver}=parseWsnSeqVer(nr_wn);
    const cur=bestWn[nr];
    if(!cur||seq>cur.seq||(seq===cur.seq&&ver>cur.ver)){
      bestWn[nr]={nr_wn:String(nr_wn).trim(),seq,ver};
    }
  }

  // W trybie B dodatkowo odfiltruj do najlepszego wniosku
  const workRows=tryb==='A'?filteredRows:(()=>{
    const bestBase={};
    for(const [nr,b] of Object.entries(bestWn))bestBase[nr]=b.nr_wn.replace(/-K\d+$/i,'');
    return rows.filter(r=>{
      const nr_wn=colStr(r,'Numer wniosku');
      const nr=wnToProj(nr_wn)||projKey(r,'Numer projektu');
      if(!nr)return false;
      const wnBase=String(nr_wn||'').trim().replace(/-K\d+$/i,'');
      return !bestBase[nr]||wnBase===bestBase[nr];
    });
  })();

  const wskazniki={};let ok=0,skip=0;
  for(const r of workRows){
    const nr_wn=colStr(r,'Numer wniosku');
    const nr=wnToProj(nr_wn)||projKey(r,'Numer projektu');
    if(!nr){skip++;continue;}
    if(!wskazniki[nr])wskazniki[nr]={avg_prod:null,avg_rez:null,avg_all:null,cnt_prod:0,cnt_rez:0,zakoncz:false,wskazniki:[],r4_score:null,last_wn:bestWn[nr]?.nr_wn||String(nr_wn||'').trim()};
    const tgt=colNum(r,'Warto≈õƒá docelowa/O')||0;if(tgt<=0)continue;
    const ach=colNum(r,'Warto≈õƒá osiƒÖgniƒôta od poczƒÖtku realizacji projektu/O')||0;
    const pct=Math.min(100,Math.round(ach/tgt*100*10)/10);
    const rodzaj=colStr(r,'Rodzaj wska≈∫nika (produktu/rezultatu)')||'';
    wskazniki[nr].wskazniki.push({
      n:colStr(r,'Nazwa wska≈∫nika')||'',
      r:rodzaj.startsWith('P')?'P':'R',
      a:ach,d:tgt,p:pct
    });ok++;
  }
  // Compute averages
  for(const [nr,w] of Object.entries(wskazniki)){
    const pp=w.wskazniki.filter(s=>s.r==='P');const rr=w.wskazniki.filter(s=>s.r==='R');
    const avg=arr=>arr.length?Math.round(arr.reduce((s,x)=>s+x.p,0)/arr.length*10)/10:null;
    w.cnt_prod=pp.length;w.cnt_rez=rr.length;
    w.avg_prod=avg(pp);w.avg_rez=avg(rr);w.avg_all=avg(w.wskazniki);
    // aRPK R4 bazuje wy≈ÇƒÖcznie na wska≈∫nikach PRODUKTU (rezultaty ‚Äî informacyjnie)
    w.r4_score=w.avg_prod!=null?Math.min(50,Math.round(w.avg_prod/100*50*10)/10):null;
  }
  const nProj=Object.keys(wskazniki).length;
  const nBest=Object.keys(bestWn).length;
  log(`  ‚úì Wska≈∫niki: ${ok} warto≈õci, ${nProj} projekt√≥w (z ${nBest} wykryto ostatni WNP, pominiƒôto wiersze starszych wniosk√≥w)`);
  return{wskazniki};
}

// ai-ID.parser.fn.zadania-legacy ‚Äî zachowany dla kompatybilno≈õci wstecznej
function parseZadania(rows,log){
  return parseZadaniaUda(rows,log);
}

// ai-ID.parser.fn.zadania-uda ‚Äî zasila: RAW.zadania[nr].planowane (wydatki planowane z UDA)
// Arkusz: UDA.zad.rozliczenie
// Kolumny kwotowe: Kwalifikowalne, Kwalifikowalne PBD, Kwalifikowalne PBD - bez dzielnika
function parseZadaniaUda(rows,log){
  const zadMap={};let ok=0;
  for(const r of rows){
    const nr=projKey(r,'Numer projektu');if(!nr)continue;
    if(!zadMap[nr])zadMap[nr]=[];
    const isRyczalt=!!(colNum(r,'Uproszczona metoda rozliczania - Wydatki kwalifikowalne')||0);
    zadMap[nr].push({
      nr_zad:(v=>v!=null&&v>0?v:null)(colNum(r,'Numer zadania','Zadanie','Nr zadania','nr_zadania')),
      nazwa:colStr(r,'Nazwa zadania')||'',
      od:colDate(r,'Data rozpoczƒôcia realizacji zadania'),
      do:colDate(r,'Data zako≈Ñczenia realizacji zadania'),
      planowane:colNum(r,'Kwalifikowalne','Kwalifikowalne PBD','Kwalifikowalne PBD - bez dzielnika',
                        'Suma - Wydatki kwalifikowalne','Wydatki kwalifikowalne')||0,
      poniesione:null, // uzupe≈Çniane z WNP.zad.rozliczone
      ryczalt:isRyczalt,
    });ok++;
  }
  log(`  ‚úì Zadania UDA (planowane): ${ok} rekord√≥w, ${Object.keys(zadMap).length} projekt√≥w`);
  // Scalamy: je≈õli istnieje ju≈º wpis w RAW.zadania dla tych projekt√≥w (z WNP), to zachowaj poniesione
  const merged={};
  for(const [nr,tasks] of Object.entries(zadMap)){
    const existing=(typeof RAW!=='undefined'&&RAW.zadania&&RAW.zadania[nr])||[];
    merged[nr]=tasks.map(t=>{
      const ex=existing.find(e=>e.nr_zad===t.nr_zad);
      return{...t,poniesione:ex&&ex.poniesione!=null?ex.poniesione:null};
    });
  }
  return{zadania:merged};
}

// ai-ID.parser.fn.zadania-wnp ‚Äî zasila: RAW.zadania[nr].poniesione (wydatki poniesione z WNP)
// Arkusz: WNP.zad.rozliczone
// Kolumny kwotowe: Kwalifikowalne, Kwalifikowalne PBD, Kwalifikowalne PBD - bez dzielnika
function parseZadaniaWnp(rows,log){
  // Wykryj kolumnƒô kwoty raz z pierwszego wiersza
  let kwotaCol='Kwalifikowalne';
  if(rows.length>0){
    const cols=Object.keys(rows[0]);
    // Kolumna K: "bie≈ºƒÖcym wnioskiem" + "kwalifikowalne" (priorytet)
    // Kolumna J: "bie≈ºƒÖcym wnioskiem" + "og√≥≈Çem" (fallback)
    kwotaCol=cols.find(c=>/bie≈ºƒÖcym wnioskiem/i.test(c)&&/kwalifikowalne/i.test(c))
           ||cols.find(c=>/bie≈ºƒÖcym wnioskiem/i.test(c)&&/og√≥≈Çem/i.test(c))
           ||cols.find(c=>/bie≈ºƒÖcym wnioskiem/i.test(c))
           ||cols.find(c=>/kwota wydatk/i.test(c))
           ||'Kwalifikowalne';
    const allKwota=cols.filter(c=>/bie≈ºƒÖcym|kwota|kwalif/i.test(c));
    log(`  ‚Ñπ WNP.zad ‚Äî wybrana kolumna kwoty: <b>"${kwotaCol}"</b> ¬∑ wszystkie pasujƒÖce: ${allKwota.join(' | ')||'brak'}`);
  }
  // Budujemy mapƒô nr_proj ‚Üí lista {nr_zad, nazwa, kwota}
  const ponList={};let ok=0;
  for(const r of rows){
    const nr=projKey(r,'Numer projektu');if(!nr)continue;
    if(!ponList[nr])ponList[nr]=[];
    const _nr_zad_raw=colNum(r,'Numer zadania','Zadanie','Nr zadania','nr_zadania');
    // Warto≈õƒá 0 = koszty po≈õrednie (brak numeru zadania merytorycznego)
    const nr_zad=(_nr_zad_raw!=null&&_nr_zad_raw>0)?_nr_zad_raw:null;
    const nazwa=colStr(r,'Nazwa zadania','Nazwa Zadania')||'';
    const kwota=colNum(r,kwotaCol)||0;
    // Szukaj czy ju≈º mamy taki wpis (sumujemy wiersze tego samego zadania)
    const normNr=nr_zad!=null?Math.round(nr_zad):null;
    const existing=ponList[nr].find(x=>
      (normNr!=null&&x.nr_zad===normNr)||
      (normNr==null&&x.nr_zad===null&&x.nazwa===nazwa)
    );
    if(existing) existing.kwota+=kwota;
    else ponList[nr].push({nr_zad:normNr,nazwa,kwota});
    ok++;
  }
  log(`  ‚úì Zadania WNP (poniesione): ${ok} wierszy, ${Object.keys(ponList).length} projekt√≥w`);
  // Scalamy z istniejƒÖcymi zadaniami z RAW
  const merged={};
  for(const [nr,wnpItems] of Object.entries(ponList)){
    const existing=(typeof RAW!=='undefined'&&RAW.zadania&&RAW.zadania[nr])||[];
    if(existing.length){
      merged[nr]=existing.map(t=>{
        const normT=t.nr_zad!=null?Math.round(t.nr_zad):null;
        // Dopasuj po nr_zad (priorytet) lub nazwie (fallback dla koszty po≈õrednie)
        let match=null;
        if(normT!=null) match=wnpItems.find(w=>w.nr_zad===normT);
        if(!match&&t.nazwa) match=wnpItems.find(w=>w.nr_zad===null&&
          w.nazwa.toLowerCase().trim()===t.nazwa.toLowerCase().trim());
        // Fallback: je≈õli tylko jeden wpis bez nr_zad i jedno zadanie bez nr
        if(!match&&normT===null){
          const nullItems=wnpItems.filter(w=>w.nr_zad===null);
          if(nullItems.length===1) match=nullItems[0];
        }
        return match?{...t,poniesione:match.kwota}:t;
      });
    } else {
      // Brak danych z UDA ‚Äî utw√≥rz zadania tylko z WNP
      merged[nr]=wnpItems.map(w=>({
        nr_zad:w.nr_zad,nazwa:w.nazwa,
        od:null,do:null,planowane:null,poniesione:w.kwota,ryczalt:false
      }));
    }
  }
  return{zadania_poniesione:merged};
}

// ai-ID.parser.fn.rodzaj-weryfikacji ‚Äî zasila: mapƒô opiekun√≥w (RAW.arpk_map + RAW.umowy)
// Arkusze: Raport rodzaj weryfikacji
// Kolumny: Numer projektu, Osoba odpowiedzialna za weryfikacjƒô
function parseRodzajWeryfikacji(rows,log){
  // Maps wniosek number -> opiekun login
  const opMap={};let ok=0;
  for(const r of rows){
    const nr_proj=projKey(r,'Numer projektu');
    const op=colStr(r,'Osoba odpowiedzialna za weryfikacjƒô');
    if(nr_proj&&op){opMap[nr_proj]=op;ok++;}
  }
  log(`  ‚úì Opiekunowie z weryfikacji: ${ok} przypisa≈Ñ`);
  return{opiekunMap:opMap};
}

// ‚îÄ‚îÄ MERGE ENGINE ‚îÄ‚îÄ ai-ID.parser.merge-engine
// ≈ÅƒÖczy sparsowane dane z istniejƒÖcym RAW, obs≈Çuguje deduplikacjƒô i przep≈Çyw WER‚ÜíZAT
function mergeImport(parsed,log){
  const newRAW=JSON.parse(JSON.stringify(RAW)); // deep copy
  const stats={proj_new:0,proj_upd:0,wnp_new:0,wnp_upd:0,hp_new:0,umowy_new:0,wskazniki_upd:0,zadania_upd:0,wnp_dup_wer:0,wnp_dup_pop:0};

  // OPIEKUN MAP ‚Äî assign from rodzaj weryfikacji
  if(parsed.opiekunMap){
    for(const [nr,op] of Object.entries(parsed.opiekunMap)){
      const u=newRAW.umowy.find(u=>u.nr===nr);
      if(u&&!u.opiekun)u.opiekun=op;
      if(newRAW.arpk_map[nr]&&!newRAW.arpk_map[nr].opiekun)newRAW.arpk_map[nr].opiekun=op;
    }
    log(`  ‚Üí Przypisano opiekun√≥w: ${Object.keys(parsed.opiekunMap).length} projekt√≥w`);
  }

  // UMOWY
  if(parsed.umowy){
    for(const u of parsed.umowy){
      const idx=newRAW.umowy.findIndex(x=>x.nr===u.nr);
      if(idx>=0){
        // Preserve opiekun if existing has one and new doesn't
        if(!u.opiekun&&newRAW.umowy[idx].opiekun)u.opiekun=newRAW.umowy[idx].opiekun;
        newRAW.umowy[idx]={...newRAW.umowy[idx],...u};stats.proj_upd++;
      } else {
        newRAW.umowy.push(u);stats.proj_new++;
        if(!newRAW.arpk_map[u.nr])newRAW.arpk_map[u.nr]={score:0,breakdown:{},opiekun:u.opiekun||''};
      }
    }
    log(`  ‚Üí Umowy: +${stats.proj_new} nowych, ${stats.proj_upd} zaktualizowanych`);
  }

  // ‚îÄ‚îÄ STRATEGIA MERGE ‚îÄ‚îÄ
  // ZAT (certyfikowane) ma zawsze pierwsze≈Ñstwo nad WER/POP (bie≈ºƒÖce)
  // Je≈õli wniosek jest w ZAT, to wersja z WER/POP jest IGNOROWANA
  // (WNP.certyfikowane ma bogatsze dane: kwoty WOP, data zatwierdzenia, certyfikacja)

  // ZAT ‚Äî merge/append (przetwarzamy PIERWSZE, ≈ºeby wiedzieƒá kt√≥re nr_wn sƒÖ zatwierdzone)
  if(parsed.zat&&parsed.zat.length>0){
    for(const r of parsed.zat){
      const idx=newRAW.zat.findIndex(x=>x.nr_wn===r.nr_wn);
      if(idx>=0)newRAW.zat[idx]={...newRAW.zat[idx],...r};
      else{newRAW.zat.push(r);stats.wnp_new++;}
    }
    log(`  ‚Üí ZAT: ${parsed.zat.length} zatwierdzonych wniosk√≥w`);
  }

  // Zbuduj kompletny zbi√≥r numer√≥w zatwierdzonych (z newRAW.zat po merge)
  // Zawiera zar√≥wno nr_wn bazowe jak i ich warianty z -K** na wypadek r√≥≈ºnic w raportach
  const allZatNrs=new Set(newRAW.zat.map(r=>r.nr_wn).filter(Boolean));
  const allZatBase=new Set([...allZatNrs].map(n=>parseNrWn(n).base));

  // Pomocnik: czy wniosek o danym nr_wn jest ju≈º w ZAT?
  const isInZat=nr=>{
    if(!nr)return false;
    const base=parseNrWn(nr).base;
    return allZatNrs.has(nr)||allZatBase.has(base)||allZatBase.has(nr);
  };

  // WER ‚Äî ignoruj te kt√≥re sƒÖ ju≈º w ZAT
  if(parsed.wer&&parsed.wer.length>0){
    const werFiltered=parsed.wer.filter(r=>!isInZat(r.nr_wn));
    stats.wnp_dup_wer=parsed.wer.length-werFiltered.length;
    const importedNrs=new Set(werFiltered.map(r=>r.nr_wn).filter(Boolean));
    const kept=newRAW.wer.filter(r=>!importedNrs.has(r.nr_wn)&&!isInZat(r.nr_wn));
    newRAW.wer=[...kept,...werFiltered];
    stats.wnp_new=werFiltered.length;
    log(`  ‚Üí WER: ${werFiltered.length} w weryfikacji${stats.wnp_dup_wer>0?` ¬∑ pominiƒôto ${stats.wnp_dup_wer} (sƒÖ w ZAT)`:''}`);
  }

  // POP ‚Äî ignoruj te kt√≥re sƒÖ ju≈º w ZAT
  if(parsed.pop&&parsed.pop.length>0){
    const popFiltered=parsed.pop.filter(r=>!isInZat(r.nr_wn));
    stats.wnp_dup_pop=parsed.pop.length-popFiltered.length;
    const importedNrs=new Set(popFiltered.map(r=>r.nr_wn).filter(Boolean));
    const kept=newRAW.pop.filter(r=>!importedNrs.has(r.nr_wn)&&!isInZat(r.nr_wn));
    newRAW.pop=[...kept,...popFiltered];
    log(`  ‚Üí POP: ${popFiltered.length} w poprawie${stats.wnp_dup_pop>0?` ¬∑ pominiƒôto ${stats.wnp_dup_pop} (sƒÖ w ZAT)`:''}`);
  }

  // Wyczy≈õƒá z WER/POP wszelkie pozosta≈Ço≈õci kt√≥re trafi≈Çy do ZAT (sprzƒÖtanie ko≈Ñcowe)
  newRAW.wer=newRAW.wer.filter(r=>!isInZat(r.nr_wn));
  newRAW.pop=newRAW.pop.filter(r=>!isInZat(r.nr_wn));

  // Deduplikacja wewnƒôtrzna WER i POP po nr_wn (na wypadek gdyby WNP.wszystkie
  // by≈Ç parsowany razem z WNP.biezace ‚Äî ostatni wpis wygrywa)
  const deduplicateByNrWn=arr=>{
    const seen=new Map();
    for(const r of arr)seen.set(r.nr_wn,r); // ostatni wpis wygrywa
    return [...seen.values()];
  };
  newRAW.wer=deduplicateByNrWn(newRAW.wer);
  newRAW.pop=deduplicateByNrWn(newRAW.pop);

  // HP ‚Äî full replace hp_wer, merge hp_zat
  if(parsed.hp_wer){
    newRAW.hp_wer=parsed.hp_wer;stats.hp_new=parsed.hp_wer.length;
    log(`  ‚Üí HP weryfikacja: ${parsed.hp_wer.length} harmonogram√≥w`);
  }
  if(parsed.hp_zat){
    for(const r of parsed.hp_zat){
      const idx=newRAW.hp_zat.findIndex(x=>x['Numer projektu']===r['Numer projektu']&&x['Numer wersji harmonogramu']===r['Numer wersji harmonogramu']);
      if(idx>=0)newRAW.hp_zat[idx]=r; else newRAW.hp_zat.push(r);
    }
    log(`  ‚Üí HP zatwierdzone: ${parsed.hp_zat.length} harmonogram√≥w`);
  }

  // WSKAZNIKI
  if(parsed.wskazniki){
    for(const [nr,w] of Object.entries(parsed.wskazniki)){
      newRAW.wskazniki[nr]={...(newRAW.wskazniki[nr]||{}),...w};
      if(newRAW.arpk_map[nr]&&w.avg_all!=null&&!w.zakoncz){
        const r4_risk=Math.round((50-(w.r4_score||0))/50*13*10)/10;
        newRAW.arpk_map[nr].breakdown.r4_rzeczowy=r4_risk;
      }
      stats.wskazniki_upd++;
    }
    log(`  ‚Üí Wska≈∫niki: ${stats.wskazniki_upd} projekt√≥w`);
  }

  // WNP_WSZYSTKIE_NRS ‚Äî dane o wersjach WNP wyodrƒôbnione z arkusza WNP.wszystkie
  // U≈ºywane wy≈ÇƒÖcznie przez rebuildArpkScores do obliczania R6 (liczba wersji)
  // Przechowujemy w newRAW.wnp_ver_nrs jako lista {nr_proj, nr_wn}
  if(parsed.wnp_wszystkie_nrs&&parsed.wnp_wszystkie_nrs.length>0){
    if(!newRAW.wnp_ver_nrs) newRAW.wnp_ver_nrs=[];
    // ZastƒÖp stare dane nowymi (full replace per projekt)
    const projsInNew=new Set(parsed.wnp_wszystkie_nrs.map(r=>r.nr_proj));
    newRAW.wnp_ver_nrs=newRAW.wnp_ver_nrs.filter(r=>!projsInNew.has(r.nr_proj));
    newRAW.wnp_ver_nrs=newRAW.wnp_ver_nrs.concat(parsed.wnp_wszystkie_nrs);
    log(`  ‚Üí Wersje WNP (R6): ${parsed.wnp_wszystkie_nrs.length} wierszy z WNP.wszystkie`);
  }

  // ZADANIA ‚Äî full replace per project
  if(parsed.zadania){
    if(!newRAW.zadania)newRAW.zadania={};
    for(const [nr,tasks] of Object.entries(parsed.zadania)){
      newRAW.zadania[nr]=tasks;stats.zadania_upd++;
      const pp=newRAW.postep.find(p=>p.nr===nr);
      if(pp)pp.zadania=tasks;
    }
    log(`  ‚Üí Zadania (planowane): ${stats.zadania_upd} projekt√≥w (${Object.values(parsed.zadania).reduce((s,v)=>s+v.length,0)} zada≈Ñ)`);
  }
  if(parsed.zadania_poniesione){
    if(!newRAW.zadania)newRAW.zadania={};
    let ponUpd=0;
    for(const [nr,tasks] of Object.entries(parsed.zadania_poniesione)){
      if(newRAW.zadania[nr]){
        newRAW.zadania[nr]=newRAW.zadania[nr].map(t=>{
          const match=tasks.find(w=>w.nr_zad===t.nr_zad);
          return match?{...t,poniesione:match.poniesione}:t;
        });
      } else {
        newRAW.zadania[nr]=tasks;
      }
      // Aktualizuj postep.zadania po scaleniu poniesione
      const pp=newRAW.postep.find(p=>p.nr===nr);
      if(pp)pp.zadania=newRAW.zadania[nr];
      ponUpd++;stats.zadania_upd++;
    }
    log(`  ‚Üí Zadania (poniesione): ${ponUpd} projekt√≥w zaktualizowanych`);
  }

  // Rebuild op_stats
  rebuildOpStats(newRAW);
  // Rebuild derived: RAW.rpk from ZAT + RAW.postep from umowy+zadania
  rebuildRpkData(newRAW);
  rebuildPostepData(newRAW);
  // Rebuild aRPK breakdown scores (R1‚ÄìR9) from all available data
  rebuildArpkScores(newRAW,log);

  return{newRAW,stats};
}

function rebuildOpStats(data){
  // Krok 1: Zbierz opiekun√≥w z ZAT ‚Äî opiekun projektu = osoba odpowiedzialna za weryfikacjƒô
  // ostatniego zatwierdzonego wniosku (posortowanego wg data_zatw DESC, nr_wn DESC)
  const projLastZatOp={};
  const zatSorted=[...data.zat].sort((a,b)=>{
    const d=(b.data_zatw||'').localeCompare(a.data_zatw||'');
    return d!==0?d:(b.nr_wn||'').localeCompare(a.nr_wn||'');
  });
  for(const r of zatSorted){
    if(r.nr_proj&&r.opiekun&&!projLastZatOp[r.nr_proj]){
      projLastZatOp[r.nr_proj]=r.opiekun;
    }
  }
  // Uzupe≈Çnij opiekuna w arpk_map (je≈õli brak, u≈ºyj z ostatniego ZAT)
  for(const [nr,v] of Object.entries(data.arpk_map)){
    if(!v.opiekun&&projLastZatOp[nr]) v.opiekun=projLastZatOp[nr];
  }
  // Uzupe≈Çnij opiekuna w umowach
  for(const u of data.umowy){
    if(!u.opiekun&&projLastZatOp[u.nr]) u.opiekun=projLastZatOp[u.nr];
  }
  // Krok 2: Zbierz wszystkie projekty ‚Äî z um√≥w PLUS te kt√≥re majƒÖ WNP ale brak umowy
  const allProjNrs=new Set([
    ...data.umowy.map(u=>u.nr),
    ...data.zat.map(r=>r.nr_proj),
    ...data.wer.map(r=>r.nr_proj),
    ...data.pop.map(r=>r.nr_proj),
  ].filter(Boolean));
  const ops={};
  // Funkcja: zwr√≥ƒá opiekuna projektu (umowa ‚Üí ostatni ZAT ‚Üí WER ‚Üí POP)
  const projOp=nr=>{
    const u=data.umowy.find(u=>u.nr===nr);
    if(u&&u.opiekun)return u.opiekun;
    if(projLastZatOp[nr])return projLastZatOp[nr];
    const w=data.wer.find(r=>r.nr_proj===nr&&r.opiekun);
    if(w)return w.opiekun;
    const p=data.pop.find(r=>r.nr_proj===nr&&r.opiekun);
    if(p)return p.opiekun;
    return null;
  };
  for(const nr of allProjNrs){
    const op=projOp(nr);
    if(!op)continue;
    if(!ops[op])ops[op]={projekty:0,proj_nrs:[],w_weryfikacji:0,w_poprawie:0,opoznienia:0,budzet:0,cert_wyd:0,avg_arpk:0};
    const o=ops[op];
    if(!o.proj_nrs.includes(nr)){
      o.proj_nrs.push(nr);o.projekty++;
      const u=data.umowy.find(u=>u.nr===nr);
      o.budzet+=(u&&u.budzet)||0;
    }
    // Upewnij siƒô ≈ºe arpk_map ma opiekuna
    if(data.arpk_map[nr]&&!data.arpk_map[nr].opiekun) data.arpk_map[nr].opiekun=op;
  }
  for(const r of data.wer){if(r.opiekun&&ops[r.opiekun])ops[r.opiekun].w_weryfikacji++;}
  for(const r of data.pop){if(r.opiekun&&ops[r.opiekun])ops[r.opiekun].w_poprawie++;}
  for(const r of data.zat){if(r.opiekun&&ops[r.opiekun])ops[r.opiekun].cert_wyd+=r.wyd_kwal||0;}
  for(const [op,o] of Object.entries(ops)){
    const scores=o.proj_nrs.map(nr=>(data.arpk_map[nr]||{}).score||0);
    o.avg_arpk=scores.length?Math.round(scores.reduce((s,v)=>s+v,0)/scores.length):0;
  }
  data.op_stats=ops;
}

// ai-ID.parser.merge-engine.rpk ‚Äî buduje RAW.rpk z RAW.zat
// Grupuje zatwierdzone WNP per projekt, sortuje wg nr_wn, wylicza r√≥≈ºnice wyd. v1 vs ostatnia
function rebuildRpkData(data){
  const byProj={};
  for(const r of data.zat){
    if(!r.nr_proj)continue;
    if(!byProj[r.nr_proj])byProj[r.nr_proj]={
      nr_proj:r.nr_proj,
      beneficjent:r.beneficjent||'',
      opiekun:r.opiekun||'',
      wnps:[]
    };
    byProj[r.nr_proj].wnps.push(r);
  }
  data.rpk=Object.values(byProj).map(p=>{
    p.wnps.sort((a,b)=>(a.nr_wn||'').localeCompare(b.nr_wn||'','pl'));
    const v1=p.wnps[0];
    const vl=p.wnps[p.wnps.length-1];
    const wyd_v1=v1?v1.wyd_kwal:0;
    const wyd_vl=vl?vl.wyd_kwal:0;
    const diff=wyd_vl-wyd_v1;
    const diff_pct=wyd_v1>0?+(diff/wyd_v1*100).toFixed(1):0;
    const opiekun=p.opiekun||(data.arpk_map[p.nr_proj]||{}).opiekun||'';
    return{
      nr_proj:p.nr_proj,
      beneficjent:p.beneficjent,
      nr_wn_base:v1?v1.nr_wn:'',
      ver_count:p.wnps.length,
      wyd_v1,wyd_vl,diff,diff_pct,
      opiekun,
      arpk:(data.arpk_map[p.nr_proj]||{}).score||0
    };
  });
}

// ai-ID.parser.merge-engine.postep ‚Äî buduje RAW.postep z RAW.umowy + RAW.zadania + RAW.zat + RAW.wer
// Algorytm postƒôpu finansowego:
// 1. Wydatki poniesione = suma wyd_kwal z ZAT + WER (aktualna wersja per projekt)
// 2. Poziom planowany = proporcja up≈Çynionego czasu projektu
// 3. Miesiƒôczna kwota oczekiwana = bud≈ºet / liczba_miesiƒôcy_projektu
// 4. Projekt rycza≈Çtowy (ryczalt>=budzet) ‚Üí pomi≈Ñ obliczenia, score=20
// 5. Score 0-20: 20=brak op√≥≈∫nienia lub wyprzedzenie, 0=op√≥≈∫nienie >=50pp
function rebuildPostepData(data){
  const now=new Date();
  data.postep=[];
  const monthsDiff=(a,b)=>{
    if(!a||!b)return null;
    const da=new Date(a),db=new Date(b);
    return(db-da)/(1000*60*60*24*30.4375);
  };
  // Wydatki z ZAT ‚Äî suma per projekt
  const zatSuma={};
  for(const r of (data.zat||[])){
    if(!r.nr_proj)continue;
    zatSuma[r.nr_proj]=(zatSuma[r.nr_proj]||0)+(r.wyd_kwal||0);
  }
  // WER ‚Äî tylko aktualna wersja per projekt (max ver)
  const werLatest={};
  for(const r of (data.wer||[])){
    if(!r.nr_proj)continue;
    if(!werLatest[r.nr_proj]||(r.ver||1)>(werLatest[r.nr_proj].ver||1))
      werLatest[r.nr_proj]=r;
  }
  for(const u of data.umowy){
    if(!u.ma_umowe&&!u.budzet)continue;
    const zadania=((data.zadania||{})[u.nr])||[];
    const opiekun=u.opiekun||(data.arpk_map[u.nr]||{}).opiekun||'';
    // Czy projekt jest w pe≈Çni rycza≈Çtowy?
    const isRyczalt=u.ryczalt>0&&u.rzeczywiste===0&&u.ryczalt>=(u.budzet||0)*0.98;
    if(isRyczalt){
      data.postep.push({
        nr:u.nr,beneficjent:u.beneficjent||'',opiekun,
        budzet:u.budzet||0,
        rozliczone:0,
        wyd_planowane:u.budzet||0,
        wyd_poniesione:null,
        poziom_fakt:null,
        poziom_plan_proj:null,poziom_plan_umowa:null,
        mies_od_proj:null,mies_od_umowy:null,
        kwota_na_mc_proj:null,kwota_na_mc_umowy:null,
        opozniony:false,score_postep:20,
        odch_proj:0,odch_umowa:0,
        zadania,od:u.od,do:u.do,data_umowy:u.data_umowy,ryczalt:true
      });
      continue;
    }
    // Wydatki rozliczone = ZAT + aktualna WER
    const zatKwal=zatSuma[u.nr]||0;
    const werKwal=(werLatest[u.nr]&&werLatest[u.nr].wyd_kwal)||0;
    const rozliczone=zatKwal+werKwal;
    // Wydatki planowane z zada≈Ñ UDA
    const wyd_planowane=zadania.reduce((s,z)=>s+(z.planowane||0),0)||u.budzet||0;
    // Wydatki poniesione z WNP.zad.rozliczone
    const wyd_poniesione=zadania.some(z=>z.poniesione!=null)
      ?zadania.reduce((s,z)=>s+(z.poniesione||0),0)
      :null;
    // Poziom faktyczny
    const poziom_fakt=u.budzet>0?Math.round(rozliczone/u.budzet*1000)/10:null;
    // MiesiƒÖce up≈Çynione
    const doD=u.do?new Date(Math.min(now,new Date(u.do))):now;
    const mies_od_proj=u.od?Math.max(0,monthsDiff(u.od,doD)):null;
    const mies_od_umowy=u.data_umowy?Math.max(0,monthsDiff(u.data_umowy,doD)):null;
    // Czas ca≈Çkowity projektu w miesiƒÖcach
    const total_mies_proj=u.od&&u.do?Math.max(1,monthsDiff(u.od,u.do)):null;
    const total_mies_umowy=u.data_umowy&&u.do?Math.max(1,monthsDiff(u.data_umowy,u.do)):null;
    // Kwota oczekiwana na miesiƒÖc
    const kwota_na_mc_proj=total_mies_proj?(u.budzet||0)/total_mies_proj:null;
    const kwota_na_mc_umowy=total_mies_umowy?(u.budzet||0)/total_mies_umowy:null;
    // Planowany poziom na dzi≈õ
    let poziom_plan_proj=null,poziom_plan_umowa=null;
    if(u.od&&u.do){
      const s=new Date(u.od),e=new Date(u.do),total=e-s;
      if(total>0)poziom_plan_proj=Math.min(100,Math.round((now-s)/total*1000)/10);
    }
    if(u.data_umowy&&u.do){
      const s=new Date(u.data_umowy),e=new Date(u.do),total=e-s;
      if(total>0)poziom_plan_umowa=Math.min(100,Math.round((now-s)/total*1000)/10);
    }
    const pp_active=CFG&&CFG.postepOd==='umowa'?poziom_plan_umowa:poziom_plan_proj;
    const odch_proj=poziom_fakt!=null&&poziom_plan_proj!=null?Math.round((poziom_fakt-poziom_plan_proj)*10)/10:0;
    const odch_umowa=poziom_fakt!=null&&poziom_plan_umowa!=null?Math.round((poziom_fakt-poziom_plan_umowa)*10)/10:0;
    const odch_active=CFG&&CFG.postepOd==='umowa'?odch_umowa:odch_proj;
    const prog=CFG&&CFG.opozn!=null?CFG.opozn:20;
    const opozniony=poziom_fakt!=null&&pp_active!=null&&(pp_active-poziom_fakt)>prog;
    // Score 0-20: op√≥≈∫nienie 0pp‚Üí20pkt; op√≥≈∫nienie >=50pp‚Üí0pkt; liniowe
    let score_postep=20;
    if(poziom_fakt!=null&&pp_active!=null){
      const opozn_pp=pp_active-poziom_fakt;
      score_postep=opozn_pp<=0?20:opozn_pp>=50?0:Math.round((1-opozn_pp/50)*20);
    }
    data.postep.push({
      nr:u.nr,beneficjent:u.beneficjent||'',opiekun,
      budzet:u.budzet||0,
      rozliczone,
      wyd_planowane,
      wyd_poniesione,
      poziom_fakt,
      poziom_plan_proj,poziom_plan_umowa,
      mies_od_proj:mies_od_proj!=null?Math.round(mies_od_proj*10)/10:null,
      mies_od_umowy:mies_od_umowy!=null?Math.round(mies_od_umowy*10)/10:null,
      kwota_na_mc_proj,kwota_na_mc_umowy,
      opozniony,score_postep,
      odch_proj,odch_umowa,
      zadania,od:u.od,do:u.do,data_umowy:u.data_umowy,ryczalt:false
    });
  }
}
// ‚îÄ‚îÄ aRPK SCORES REBUILD ‚îÄ‚îÄ
// ai-ID.parser.merge-engine.arpk-scores
// Przelicza breakdown R1‚ÄìR9 dla ka≈ºdego projektu na podstawie dostƒôpnych danych.
// Wywo≈Çywana po ka≈ºdym mergeImport. Wyniki trafiajƒÖ do data.arpk_map[nr].breakdown
// i sƒÖ od razu wa≈ºone przez getWeightedScore() przy renderowaniu.
//
// Kategorie:
//   R1 (0-10): Typ beneficjenta ‚Äî forma prawna: podmiot prywatny = wy≈ºsze ryzyko
//   R2 (0-10): Wielko≈õƒá bud≈ºetu ‚Äî relacja do mediany projekt√≥w w danych
//   R3 (0-8):  Realizatorzy ‚Äî liczba partner√≥w / realizator√≥w projektu (brak danych ‚Üí 0)
//   R4 (0-13): Realizacja wska≈∫nik√≥w ‚Äî obliczana oddzielnie przez parseWskazniki (zachowujemy)
//   R5 (0-8):  R√≥wnoleg≈Çe projekty ‚Äî beneficjent realizuje wiele projekt√≥w jednocze≈õnie
//   R6 (0-15): Wersje WNP ‚Äî ≈ÇƒÖczna liczba nadmiarowych wersji wniosk√≥w (suma ver-1 per WNP)
//   R7 (0-5):  Skargi i sygna≈Çy zewnƒôtrzne ‚Äî brak danych ‚Üí 0 (rƒôczna aktualizacja)
//   R8 (0-15): Nieprawid≈Çowo≈õci ‚Äî suma odrzuconych/korekt wydatk√≥w w ZAT (Liczba korekt)
//   R9 (0-15): Odchylenie wyd. v1 vs zatwierdzona ‚Äî obliczane z RAW.rpk (diff_pct)
// ‚îÄ‚îÄ R7 SKARGI: trwa≈Çy rƒôczny rejestr (localStorage) ‚îÄ‚îÄ
const R7_KEY = "arpk_r7_skargi";
function r7GetAll(){try{return JSON.parse(localStorage.getItem(R7_KEY)||"{}");}catch(e){return {};}}
function r7Set(nr_proj,count){const store=r7GetAll();store[nr_proj]=Math.max(0,parseInt(count)||0);localStorage.setItem(R7_KEY,JSON.stringify(store));}
function r7Get(nr_proj){return r7GetAll()[nr_proj]??0;}
function r7Adjust(nr_proj,delta){
  r7Set(nr_proj, r7Get(nr_proj)+delta);
  if(RAW.arpk_map&&RAW.arpk_map[nr_proj]){
    const b=RAW.arpk_map[nr_proj].breakdown||{};
    const cnt=r7Get(nr_proj);
    b.r7_skargi=cnt>0?5:0;
    b.r7_count=cnt;
    RAW.arpk_map[nr_proj].score=getWeightedScore(RAW.arpk_map[nr_proj]);
  }
  renderMetryki();
}
function rebuildArpkScores(data, log){
  const logFn = log || (()=>{});

  // ‚îÄ‚îÄ Zbierz dane pomocnicze ‚îÄ‚îÄ

  // Mediana bud≈ºet√≥w (do R2)
  const budgets = data.umowy.map(u=>u.budzet||0).filter(b=>b>0).sort((a,b)=>a-b);
  const median = budgets.length ? budgets[Math.floor(budgets.length/2)] : 1;

  // Mapa: beneficjent NIP/nazwa ‚Üí lista nr projekt√≥w (do R5 r√≥wnoleg≈Çe)
  // U≈ºywamy nazwy beneficjenta jako klucza (NIP niedostƒôpny)
  const benProjMap = {};
  for(const u of data.umowy){
    const ben = (u.beneficjent||'').trim().toLowerCase();
    if(!ben) continue;
    if(!benProjMap[ben]) benProjMap[ben]=new Set();
    benProjMap[ben].add(u.nr);
  }

  // Mapa: nr_proj ‚Üí liczba nadmiarowych wersji WNP (R6)
  // ≈πr√≥d≈Ço 1 (preferowane): data.wnp_ver_nrs ‚Äî dane z WNP.wszystkie (pe≈Çne numery SEQ-VER)
  // ≈πr√≥d≈Ço 2 (fallback):    RAW.zat + RAW.wer + RAW.pop (mogƒÖ nie mieƒá starszych wersji)
  const r6Map = {};
  const seqVersions = {}; // "proj_seq" ‚Üí {proj, seq, vers:Set}
  const verSource = (data.wnp_ver_nrs&&data.wnp_ver_nrs.length>0)
    ? data.wnp_ver_nrs
    : [...(data.zat||[]), ...(data.wer||[]), ...(data.pop||[])];
  for(const r of verSource){
    const np = r.nr_proj; if(!np) continue;
    const nr_wn = r.nr_wn; if(!nr_wn) continue;
    const s = String(nr_wn).trim();
    const mFull = s.match(/-(\d{3})-(\d{2,3})$/);
    if(!mFull) continue;
    const seq = mFull[1], ver = parseInt(mFull[2]);
    const key = np+'_'+seq;
    if(!seqVersions[key]) seqVersions[key] = {proj:np, seq, vers:new Set()};
    seqVersions[key].vers.add(ver);
  }
  for(const {proj, vers} of Object.values(seqVersions)){
    const extra = Math.max(0, vers.size - 1);
    r6Map[proj] = (r6Map[proj]||0) + extra;
  }

  // Mapa: nr_proj ‚Üí suma Liczba korekt (R8, z WNP.certyfikowane)
  // Parser WNP.cert nie przechowuje 'Liczba korekt' w RAW.zat ‚Äî liczymy z r6Map jako proxy
  // R8 = nieprawid≈Çowo≈õci/korekty finansowe ‚Äî u≈ºywamy sumy extra_versions jako przybli≈ºenia
  // (docelowo: gdy parser bƒôdzie czyta≈Ç 'Liczba korekt', podmieniƒá tutaj)

  // Mapa: nr_proj ‚Üí diff_pct (R9, z RAW.rpk)
  const r9Map = {};
  for(const r of (data.rpk||[])){
    if(r.nr_proj) r9Map[r.nr_proj] = r.diff_pct||0;
  }

  // ‚îÄ‚îÄ Przelicz scores per projekt ‚îÄ‚îÄ
  let updated = 0;
  for(const [nr, entry] of Object.entries(data.arpk_map)){
    const u = data.umowy.find(u=>u.nr===nr)||{};
    if(!entry.breakdown) entry.breakdown = {};
    const b = entry.breakdown;

    // R1: Typ beneficjenta / forma prawna (0-10)
    // JST/uczelnia/stowarzyszenie publiczne ‚Üí niskie, sp√≥≈Çka prywatna/NGO bez historii ‚Üí wy≈ºsze
    const fp = (u.forma_prawna||'').toLowerCase();
    const isPublic = /jst|gmina|powiat|wojew√≥dztw|samorzƒÖd|publiczn|uczelnia|szko≈ÇƒÖ|szko≈Ça|akademia|instytut|centrum|fundacja publiczn/i.test(fp+' '+(u.beneficjent||''));
    const isPrivate = /sp\. z o\.o|s\.a\.|sp√≥≈Çka|sp\.j|sp\.k|przedsiƒôbiorstw|firma/i.test(fp+' '+(u.beneficjent||''));
    const typRodzaj = (u.typ_proj||'').toLowerCase();
    b.r1_beneficjent = isPrivate ? 8 : isPublic ? 2 : 5; // prywatny=8, publiczny=2, nieznany=5

    // R2: Wielko≈õƒá bud≈ºetu (0-10)
    // Relacja do mediany: >3x median=10, 2-3x=7, 1-2x=4, <median=1
    const bud = u.budzet||0;
    if(bud <= 0) b.r2_wielkosc = 0;
    else if(bud >= median*3) b.r2_wielkosc = 10;
    else if(bud >= median*2) b.r2_wielkosc = 7;
    else if(bud >= median)   b.r2_wielkosc = 4;
    else                      b.r2_wielkosc = 1;

    // R3: Realizatorzy/partnerzy (0-8) ‚Äî brak danych ‚Üí 0 (parser nie czyta)
    if(b.r3_realizatorzy == null) b.r3_realizatorzy = 0;

    // R4: Realizacja wska≈∫nik√≥w (0-13) ‚Äî obliczana przez parseWskazniki, zachowujemy
    // (nie nadpisujemy je≈õli ju≈º ustawiona)

    // R5: R√≥wnoleg≈Çe projekty (0-8)
    // Ten sam beneficjent realizuje N projekt√≥w: 1=0, 2=2, 3=4, 4=6, ‚â•5=8
    const ben = (u.beneficjent||'').trim().toLowerCase();
    const nParallel = ben ? (benProjMap[ben]||new Set()).size : 1;
    b.r5_rownolegle = nParallel>=5?8 : nParallel>=4?6 : nParallel>=3?4 : nParallel>=2?2 : 0;

    // R6: Wersje WNP (0-15) ‚Äî G≈Å√ìWNA NAPRAWA
    // Suma nadmiarowych wersji per WNP (extra_versions = suma(ver-1) dla wszystkich WNP projektu)
    // Progi: 0 extra=0, 1-2=3, 3-5=6, 6-9=10, 10-13=13, ‚â•14=15
    const extra = r6Map[nr]||0;
    b.r6_wersje = extra>=14?15 : extra>=10?13 : extra>=6?10 : extra>=3?6 : extra>=1?3 : 0;
    b.r6_extra_raw = extra;

    // R7: Skargi/sygna≈Çy zewnƒôtrzne (0-5) ‚Äî zawsze z trwa≈Çego rejestru rƒôcznego (localStorage)
    const _r7cnt = r7Get(nr);
    b.r7_skargi = _r7cnt > 0 ? 5 : 0;
    b.r7_count  = _r7cnt;

    // R8: Nieprawid≈Çowo≈õci (0-15)
    // Proxy: wnioski z korektami (ver>1) wskazujƒÖ na b≈Çƒôdy; skalujemy jak R6 ale max 15
    // Extra wersje > 0 ‚Üí oznaka nieprawid≈Çowo≈õci; u≈ºywamy tej samej liczby co R6 source
    // R√≥≈ºnica R6/R8: R6=liczba wersji (trudno≈õƒá beneficjenta), R8=korekty finansowe (b≈Çƒôdy)
    // Bez danych o korektach finansowych u≈ºywamy heurystyki: R8 = round(R6 * 0.7)
    b.r8_nieprawidlowosci = Math.round((b.r6_wersje||0) * 0.7);

    // R9: Odchylenie wyd. v1 vs zatwierdzona (0-15)
    // diff_pct z RPK: |diff_pct| 0%=0, 1-10%=3, 11-25%=6, 26-50%=10, >50%=15
    const dp = Math.abs(r9Map[nr]||0);
    b.r9_odchylenie = dp>50?15 : dp>25?10 : dp>10?6 : dp>0?3 : 0;

    // Zapisz ≈ÇƒÖczny score do entry.score (dla kompatybilno≈õci z getWeightedScore)
    entry.score = getWeightedScore(entry);
    updated++;
  }
  logFn(`  ‚Üí aRPK scores rebuilt: ${updated} projekt√≥w (R1‚ÄìR9)`);
  logFn(`  ‚Üí R6 extra versions: ${Object.entries(r6Map).map(([k,v])=>`${k.split('/').pop()}=${v}`).join(', ')||'brak'}`);
}

// ‚îÄ‚îÄ UI HANDLERS ‚îÄ‚îÄ
// ===== [JS-N] IMPORT PLIKU XLSX (UI) ‚Äî impDragOver, impFileSelected, impApply, impReset =====
function impDragOver(e){e.preventDefault();document.getElementById('imp-dropzone').classList.add('over');}
function impDragLeave(e){document.getElementById('imp-dropzone').classList.remove('over');}
function impDrop(e){e.preventDefault();document.getElementById('imp-dropzone').classList.remove('over');const f=e.dataTransfer.files[0];if(f)impFileSelected(f);}

function impFileSelected(file){
  if(!file)return;
  if(!window.XLSX){logImp('<span class="warn">‚ö† Biblioteka XLSX nie jest za≈Çadowana. Sprawd≈∫ po≈ÇƒÖczenie internetowe.</span>');return;}
  const reader=new FileReader();
  document.getElementById('imp-prog-wrap').classList.remove('hidden');
  setImpProg(10,'Wczytywanie pliku‚Ä¶');
  reader.onload=e=>impProcessXlsx(e.target.result,file.name);
  reader.readAsArrayBuffer(file);
}

function setImpProg(pct,lbl){
  document.getElementById('imp-prog-b').style.width=pct+'%';
  document.getElementById('imp-prog-lbl').textContent=lbl;
}

async function impProcessXlsx(buffer,fname){
  const logLines=[];
  const log=s=>{logLines.push(s);};

  log(`<span class="info">üìÇ Plik: ${fname}</span>`);
  setImpProg(20,'Parsowanie arkuszy‚Ä¶');

  let wb;
  try{wb=XLSX.read(buffer,{type:'array',cellDates:true});}
  catch(err){logImp(`<span class="warn">‚úó B≈ÇƒÖd odczytu pliku: ${err.message}</span>`);setImpProg(0,'');return;}

  const sheets=wb.SheetNames;
  log(`<span class="info">Znaleziono ${sheets.length} arkuszy: ${sheets.join(', ')}</span>`);

  // Detect & display sheets
  const detectedSheets=[];
  const sheetGrid=document.getElementById('imp-sheets-grid');
  sheetGrid.innerHTML='';
  document.getElementById('imp-sheets-wrap').classList.remove('hidden');

  // Sprawd≈∫ kt√≥re arkusze WNP sƒÖ w pliku ‚Äî WNP.wszystkie jest FALLBACK
  // i nie powinno byƒá parsowane gdy obecne sƒÖ WNP.biezace lub WNP.certyfikowane
  const hasWnpBiezace=sheets.some(s=>s==='WNP.biezace'||s==='Raport wnioski bie≈ºƒÖce'||s==='Raport wnioski z≈Ço≈ºone');
  const hasWnpCert=sheets.some(s=>s==='WNP.certyfikowane'||s==='Raport wnioski certyfikowane');
  const hasWnpWszystkie=sheets.some(s=>s==='WNP.wszystkie');
  const skipWszystkie=hasWnpWszystkie&&(hasWnpBiezace||hasWnpCert);
  if(skipWszystkie){
    log(`<span class="info">‚Ñπ WNP.wszystkie pominiƒôty ‚Äî obecne szczeg√≥≈Çowe arkusze (${[hasWnpBiezace?'WNP.biezace':'',hasWnpCert?'WNP.certyfikowane':''].filter(Boolean).join(', ')})</span>`);
  }

  let parsed={};
  let sheetIdx=0;

  for(const sname of sheets){
    sheetIdx++;
    setImpProg(20+sheetIdx/sheets.length*50,`Przetwarzam: ${sname}‚Ä¶`);

    // Pomi≈Ñ WNP.wszystkie gdy dostƒôpne sƒÖ bardziej szczeg√≥≈Çowe arkusze ‚Äî
    // ALE wyodrƒôbnij z niego dane o wersjach WNP (nr_wn z SEQ-VER), kt√≥re nie sƒÖ
    // dostƒôpne w WNP.certyfikowane (tam numery bazowe bez wersji) ani WNP.biezace.
    // Te dane trafiajƒÖ do parsed.wnp_wszystkie_nrs i sƒÖ u≈ºywane przez rebuildArpkScores (R6).
    if(skipWszystkie&&sname==='WNP.wszystkie'){
      const ws2=wb.Sheets[sname];
      const rows2=XLSX.utils.sheet_to_json(ws2,{defval:null,raw:true});
      // Zbierz tylko pary (nr_proj, nr_wn) ‚Äî lekkie, bez pe≈Çnego parsowania
      const nrs=[];
      for(const r of rows2){
        const np=projKey(r,'Numer projektu');
        const wn=colStr(r,'Numer wniosku','Numer wniosku o p≈Çatno≈õƒá/korekty');
        if(np&&wn) nrs.push({nr_proj:np,nr_wn:wn});
      }
      if(nrs.length>0) parsed.wnp_wszystkie_nrs=(parsed.wnp_wszystkie_nrs||[]).concat(nrs);
      const card=document.createElement('div');
      card.className='imp-sheet skip';
      card.innerHTML=`<div class="imp-sheet-name">¬∑ ${sname}</div><div class="imp-sheet-info">Pominiƒôty (tre≈õƒá zastƒÖpiona przez WNP.biezace + WNP.certyfikowane) ¬∑ <span style="color:var(--grn)">wersje WNP: ${nrs.length} wierszy odczytanych dla R6 aRPK</span></div>`;
      sheetGrid.appendChild(card);
      continue;
    }

    const parser=SHEET_PARSERS.find(p=>p.match(sname));
    const ws=wb.Sheets[sname];
    // raw:true ‚Äî liczby wychodzƒÖ jako number (nie sformatowany string)
    // cellDates:true w XLSX.read zapewnia ≈ºe daty sƒÖ Date, nie seryjne liczby
    const rows=XLSX.utils.sheet_to_json(ws,{defval:null,raw:true});

    // Loguj kolumny arkusza gdy parser jest przypisany (pomo≈ºe zidentyfikowaƒá z≈Çe nazwy kolumn)
    if(parser&&rows.length>0){
      const cols=Object.keys(rows[0]);
      log(`<span class="info">  üìã ${sname} [${rows.length} wierszy] ¬∑ kolumny: ${cols.slice(0,8).join(' | ')}${cols.length>8?` ‚Ä¶ (+${cols.length-8})`:''}</span>`);
    }

    let status='skip',info=`${rows.length} wierszy ¬∑ brak mapowania`;
    if(parser&&rows.length>0){
      try{
        const result=parser.parse(rows,log);
        // Merge result into parsed
        for(const [k,v] of Object.entries(result)){
          if(Array.isArray(v)){
            if(!parsed[k])parsed[k]=[];
            parsed[k].push(...v);
          }else if(typeof v==='object'&&v!==null){
            if(!parsed[k])parsed[k]={};
            Object.assign(parsed[k],v);
          }
        }
        status='ok';info=`${rows.length} wierszy ¬∑ ${parser.label}`;
      }catch(err){status='warn';info=`B≈ÇƒÖd: ${err.message}`;log(`<span class="warn">‚ö† B≈ÇƒÖd w ${sname}: ${err.message}</span>`);}
    }

    // Card
    const card=document.createElement('div');
    card.className=`imp-sheet ${status}`;
    card.innerHTML=`<div class="imp-sheet-name">${status==='ok'?'‚úì':status==='warn'?'‚ö†':'¬∑'} ${sname}</div><div class="imp-sheet-info">${info}</div>`;
    sheetGrid.appendChild(card);
  }

  setImpProg(80,'Obliczanie zmian‚Ä¶');
  await new Promise(r=>setTimeout(r,0));

  // Compute delta
  const mergeLog=[];
  const mergeLogFn=s=>mergeLog.push(s);
  const{newRAW,stats}=mergeImport(parsed,mergeLogFn);
  IMP_PENDING={newRAW,fname};

  // Count zadania
  const zadCount=newRAW.zadania?Object.values(newRAW.zadania).reduce((s,v)=>s+v.length,0):0;
  const zadProj=newRAW.zadania?Object.keys(newRAW.zadania).length:0;

  // Display delta
  const dupWer=(stats.wnp_dup_wer||0);
  const dupPop=(stats.wnp_dup_pop||0);
  const dupInfo=dupWer+dupPop>0?`<div class="imp-delta-item"><div class="imp-delta-l" style="color:var(--yel)">Pominiƒôte duplikaty (WER/POP‚ÜíZAT)</div><div class="imp-delta-v" style="color:var(--yel)">${dupWer+dupPop}</div></div>`:'';
  document.getElementById('imp-delta').innerHTML=`
    <div class="imp-delta-item"><div class="imp-delta-l">Projekty z umowƒÖ</div><div class="imp-delta-v" style="color:var(--acc)">${newRAW.umowy.filter(u=>u.ma_umowe).length}</div></div>
    <div class="imp-delta-item"><div class="imp-delta-l">Nowe projekty</div><div class="imp-delta-v" style="color:var(--grn)">${stats.proj_new>0?'+'+stats.proj_new:'brak'}</div></div>
    <div class="imp-delta-item"><div class="imp-delta-l">W weryfikacji</div><div class="imp-delta-v" style="color:var(--red)">${newRAW.wer.length}</div></div>
    <div class="imp-delta-item"><div class="imp-delta-l">W poprawie</div><div class="imp-delta-v" style="color:var(--orn)">${newRAW.pop.length}</div></div>
    <div class="imp-delta-item"><div class="imp-delta-l">Certyfikowane WNP</div><div class="imp-delta-v" style="color:var(--grn)">${newRAW.zat.length}</div></div>
    ${dupInfo}
    <div class="imp-delta-item"><div class="imp-delta-l">HP w weryfikacji</div><div class="imp-delta-v" style="color:var(--acc3)">${newRAW.hp_wer.length}</div></div>
    <div class="imp-delta-item"><div class="imp-delta-l">Zadania finansowe</div><div class="imp-delta-v" style="color:var(--acc2)">${zadCount} (${zadProj} proj.)</div></div>
    <div class="imp-delta-item"><div class="imp-delta-l">Proj. ze wska≈∫nikami</div><div class="imp-delta-v">${Object.keys(newRAW.wskazniki||{}).length}</div></div>
  `;
  document.getElementById('imp-prev-file').textContent=fname;

  // Combined log
  const fullLog=[...logLines,...mergeLog];
  logImp(fullLog.join('\n'));
  document.getElementById('imp-preview-wrap').classList.remove('hidden');
  setImpProg(100,`Gotowe ‚Äî ${fullLog.filter(l=>l.includes('‚úì')).length} arkuszy przetworzonych`);
}

function logImp(html){document.getElementById('imp-log').innerHTML=html;}

function impApply(){
  if(!IMP_PENDING)return;
  const{newRAW,fname}=IMP_PENDING;

  // Apply to RAW (in-place replacement of all keys)
  for(const k of Object.keys(RAW))delete RAW[k];
  Object.assign(RAW,newRAW);

  // History
  const zadP=RAW.zadania?Object.keys(RAW.zadania).length:0;
  IMP_HISTORY.push({fname,ts:new Date().toLocaleString('pl-PL'),wer:RAW.wer.length,pop:RAW.pop.length,zat:RAW.zat.length,umowy:RAW.umowy.filter(u=>u.ma_umowe).length,zadP});
  document.getElementById('imp-history-list').innerHTML=IMP_HISTORY.map(h=>`<span class="ok">‚úì ${h.ts}</span> ¬∑ ${h.fname} ¬∑ Projekty: ${h.umowy} ¬∑ WER: ${h.wer} ¬∑ POP: ${h.pop} ¬∑ ZAT: ${h.zat} ¬∑ Zadania: ${h.zadP} proj.`).join('\n');

  IMP_PENDING=null;
  impReset();
  rebuildAll();

  // Flash confirmation
  const dz=document.getElementById('imp-dropzone');
  dz.style.borderColor='var(--grn)';
  dz.querySelector('.imp-drop-t').textContent=`‚úì Dane wczytane ‚Äî ${RAW.umowy.filter(u=>u.ma_umowe).length} projekt√≥w, ${RAW.wer.length} WNP w weryfikacji`;
  setTimeout(()=>{dz.style.borderColor='';dz.querySelector('.imp-drop-t').textContent='PrzeciƒÖgnij plik XLSX lub kliknij aby wybraƒá';},4000);

  showPage('overview');
}

function impReset(){
  IMP_PENDING=null;
  document.getElementById('imp-preview-wrap').classList.add('hidden');
  document.getElementById('imp-sheets-wrap').classList.add('hidden');
  document.getElementById('imp-prog-wrap').classList.add('hidden');
  document.getElementById('imp-fileinput').value='';
  document.getElementById('imp-log').innerHTML='';
  setImpProg(0,'');
}

// ‚îÄ‚îÄ‚îÄ PERSONEL TAB ‚îÄ‚îÄ‚îÄ
// ===== [JS-O] PERSONEL / PRACOWNICY ‚Äî buildPersonelTab, perFileSelected, perParseRows =====
function buildPersonelTab(){/* personel tab usuniƒôty */}
function renderPerList(){/* usuniƒôto */}
function renderPerListImp(){/* usuniƒôto */}

function perParseRowsImp(fname,rows,csvText){
  // Je≈õli CSV - sparsuj najpierw
  if(!rows&&csvText){
    var firstLine=csvText.split('\n')[0];
    var sep=firstLine.includes(';')?';':',';
    var lines=csvText.trim().split('\n');
    var headers=lines[0].split(sep).map(function(h){return h.trim().replace(/^"|"$/g,'');});
    rows=[];
    for(var i=1;i<lines.length;i++){
      var cells=lines[i].split(sep);
      var obj={};
      headers.forEach(function(h,j){obj[h]=(cells[j]||'').trim().replace(/^"|"$/g,'');});
      rows.push(obj);
    }
  }
  // U≈ºyj istniejƒÖcej logiki parsowania
  perParseRows(rows,fname);
  // Zaktualizuj te≈º status i listƒô w sekcji Dane
  var st=document.getElementById("per-status");
  var stImp=document.getElementById("per-status-imp");
  if(st&&stImp)stImp.innerHTML=st.innerHTML;
  renderPerListImp();
}
function perParseCSV(text,fname){
  // Auto-detect separator
  const firstLine=text.split('\n')[0];
  const sep=firstLine.includes(';')?';':',';
  const lines=text.trim().split('\n');
  const headers=lines[0].split(sep).map(h=>h.trim().replace(/^["']|["']$/g,'').toLowerCase());
  const rows=lines.slice(1).map(l=>{
    const vals=l.split(sep).map(v=>v.trim().replace(/^["']|["']$/g,''));
    const obj={};headers.forEach((h,i)=>{obj[h]=vals[i]||'';});
    return obj;
  }).filter(r=>Object.values(r).some(v=>v));
  perParseRows(rows,fname);
}

function perParseRows(rows,fname){
  var added=0,updated=0;
  // Akceptowane nazwy kolumn - rozszerzone o format z pliku Pracownicy.xlsx
  var COL_SKROT=['pracownik','skr√≥t','skrot','kod','login','id','username'];
  var COL_OPIEKUN_FULL=['opiekun']; // Kolumna z pe≈Çnym "Nazwisko Imiƒô"
  var COL_NAZW=['nazwisko','name','last name','last_name'];
  var COL_IMIE=['imiƒô','imie','first name','first_name'];
  var COL_DZIAL=['dzia≈Ç','dzial','dzia≈Ç projekt√≥w','dept','department','dzia≈Ç proj.','skr√≥t dzia≈Çu','skrot dzialu','dz.'];

  function findCol(row,candidates){
    var keys=Object.keys(row).map(function(k){return k.toLowerCase().trim();});
    for(var i=0;i<candidates.length;i++){var idx=keys.indexOf(candidates[i]);if(idx>=0)return Object.keys(row)[idx];}
    return null;
  }

  if(!rows.length){
    document.getElementById("per-status").textContent="Plik jest pusty lub nie uda≈Ço siƒô go odczytaƒá";
    return;
  }

  var sK=findCol(rows[0],COL_SKROT);
  var opK=findCol(rows[0],COL_OPIEKUN_FULL); // kolumna "Opiekun" z pe≈Çnym imieniem
  var nK=findCol(rows[0],COL_NAZW);
  var iK=findCol(rows[0],COL_IMIE);
  var dK=findCol(rows[0],COL_DZIAL);

  if(!sK){
    document.getElementById("per-status").innerHTML='<span style="color:var(--red)">&#x2717; Nie znaleziono kolumny z loginem pracownika. Oczekiwane nazwy kolumny: Pracownik, Skr√≥t, Login</span>';
    return;
  }

  for(var ri=0;ri<rows.length;ri++){
    var r=rows[ri];
    var skrot=String(r[sK]||'').trim().toUpperCase();
    if(!skrot)continue;
    // Obs≈Çuga formatu "Opiekun" = "Nazwisko Imiƒô" (format z Pracownicy.xlsx)
    var nazwisko='', imie='';
    if(opK && r[opK]){
      var parts=String(r[opK]).trim().split(/\s+/);
      nazwisko=parts[0]||'';
      imie=parts.slice(1).join(' ')||'';
    } else {
      nazwisko=nK?String(r[nK]||'').trim():'';
      imie=iK?String(r[iK]||'').trim():'';
    }
    var dzial=dK?String(r[dK]||'').trim():'';
    var entry={skrot:skrot, nazwisko:nazwisko, imie:imie, dzial:dzial};
    if(PERSONEL[skrot])updated++;else added++;
    PERSONEL[skrot]=entry;
    if(entry.dzial){
      var dzCode=dzialToCode(entry.dzial);
      if(dzCode)CFG.opDzial[skrot]=dzCode;
    }
  }

  savePersonel();saveCFG();
  // Zaktualizuj __SRC__ tak by zawiera≈Ç nowe dane PERSONEL ‚Äî konieczne dla saveState
  _syncPersonelToSrc();
  rebuildAll();
}

function dzialToCode(dzialStr){
  if(!dzialStr)return null;
  const s=String(dzialStr).trim().toLowerCase();
  // Normalizacja: "Dzia≈Ç EFS I/II/III", "Dzia≈Ç Projekt√≥w EFS I", "DP I/II/III", "1/2/3"
  // III i II muszƒÖ byƒá przed I ‚Äî inaczej "iii" matchuje /\bi\b/
  if(/\biii\b|dp\s*3|efs\s*iii|efs\s*3|\b3\b/.test(s)) return '3';
  if(/\bii\b|dp\s*2|efs\s*ii|efs\s*2|\b2\b/.test(s)) return '2';
  if(/\bi\b|dp\s*1|efs\s*i|efs\s*1|\b1\b/.test(s)) return '1';
  return null;
}

// ‚îÄ‚îÄ‚îÄ HELPER: Populate opiekun select filtered by dzia≈Ç ‚îÄ‚îÄ‚îÄ
function populateSelByDzial(selId,data,field,dz){
  const sel=document.getElementById(selId);if(!sel)return;
  const cur=sel.value;
  let opts=['<option value="">Wszyscy opiekunowie</option>'];
  const seen=new Set();
  data.forEach(r=>{
    const v=r[field];if(!v||seen.has(v))return;
    if(dz&&!dzialFilter(v,dz))return;
    seen.add(v);
    opts.push(`<option value="${v}"${v===cur?" selected":""}>${opName(v)}</option>`);
  });
  sel.innerHTML=opts.join("");
}

// ‚îÄ‚îÄ‚îÄ TOPBAR DZIA≈Å SELECTOR ‚îÄ‚îÄ‚îÄ

// ===== [JS-OB] OBCIƒÑ≈ªENIE ZESPO≈ÅU ‚Äî buildObciazenie, renderObciazenie =====

let _obView = 'kw'; // kw | pol | mies
let _obSubTab = 'dzialy'; // przeg | opieku | dzialy | baza
let _obGran   = 'kw';    // mies | kw | pol ‚Äî granulacja wybrana przez u≈ºytkownika
let _obOd     = null;    // Date | null ‚Äî filtr okresu od
let _obDo     = null;    // Date | null ‚Äî filtr okresu do
let _obCharts = {}; // cache chart√≥w

function obSubTab(tab, btn) {
  _obSubTab = tab;
  document.querySelectorAll('.ob-stab').forEach(b=>b.classList.remove('on'));
  if(btn) btn.classList.add('on');
  document.querySelectorAll('.ob-subpane').forEach(p=>p.classList.remove('on'));
  const pane = document.getElementById('ob-sub-'+tab);
  if(pane) pane.classList.add('on');
  renderObciazenie();
}

function obSetView(v, btn) {
  _obView = v;
  // sync granulacja if kw/pol
  if(v==='kw'||v==='pol') { _obGran = v; }
  document.querySelectorAll('.ob-vtab').forEach(b => b.classList.remove('on'));
  if (btn) btn.classList.add('on');
  // sync fob-gran buttons
  ['mies','kw','pol'].forEach(g=>{
    const el=document.getElementById('fob-gran-'+g);
    if(el) el.classList.toggle('on', g===_obGran);
  });
  renderObciazenie();
}

// Granulacja w filtrze okresu
function obSetGran(g, btn) {
  _obGran = g;
  // Synchronizuj z widokiem w zak≈Çadce PrzeglƒÖd okres√≥w
  _obView = (g === 'mies') ? 'mies' : (g === 'pol') ? 'pol' : 'kw';
  document.querySelectorAll('#fob-gran-mies,#fob-gran-kw,#fob-gran-pol').forEach(b=>b.classList.remove('on'));
  if(btn) btn.classList.add('on');
  // Synchronizuj przyciski w submodule PrzeglƒÖd (je≈õli istniejƒÖ)
  const vkw = document.getElementById('ob-v-kw');
  const vpol = document.getElementById('ob-v-pol');
  if(vkw) vkw.classList.toggle('on', g==='kw'||g==='mies');
  if(vpol) vpol.classList.toggle('on', g==='pol');
  renderObciazenie();
}

function obPeriodChange() {
  const odVal = document.getElementById('fob-od')?.value;
  const doVal = document.getElementById('fob-do')?.value;
  _obOd = odVal ? new Date(odVal+'-01') : null;
  _obDo = doVal ? new Date(doVal+'-01') : null;
  // Ustaw koniec miesiƒÖca "do"
  if(_obDo) { _obDo.setMonth(_obDo.getMonth()+1); _obDo.setDate(_obDo.getDate()-1); }
  renderObciazenie();
}

function obResetPeriod() {
  const now = new Date();
  const ym = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0');
  _obDo = null;
  _obOd = new Date(now.getFullYear(), now.getMonth(), 1);
  const od = document.getElementById('fob-od'); if(od) od.value = ym;
  const doEl = document.getElementById('fob-do'); if(doEl) doEl.value = '';
  renderObciazenie();
}

function buildObciazenie() {
  // Ustaw domy≈õlny miesiƒÖc "od" = aktualny miesiƒÖc (tylko przy pierwszym za≈Çadowaniu)
  const odEl = document.getElementById('fob-od');
  if (odEl && !odEl.value) {
    const now = new Date();
    const ym = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0');
    odEl.value = ym;
    _obOd = new Date(now.getFullYear(), now.getMonth(), 1);
  }
  // Zasilij select opiekun√≥w
  const ops = new Set();
  RAW.umowy.forEach(u => {
    const ef = getEffectiveProjOp(u.nr);
    if (ef.op) ops.add(ef.op);
  });
  RAW.postep.forEach(p => {
    const ef = getEffectiveProjOp(p.nr);
    if (ef.op) ops.add(ef.op);
  });
  const sel = document.getElementById('fob-op');
  if (sel) {
    const cur = sel.value;
    sel.innerHTML = '<option value="">Wszyscy</option>' +
      [...ops].sort((a,b)=>opName(a).localeCompare(opName(b)))
        .map(o=>`<option value="${o}"${o===cur?' selected':''}>${opName(o)}</option>`).join('');
  }
  renderObciazenie();
}

function obGetProjects() {
  const bufor = parseInt(document.getElementById('ob-bufor')?.value || '4');
  const dz    = document.getElementById('fob-dz')?.value || '';
  const op    = document.getElementById('fob-op')?.value || '';
  const now   = new Date();

  const allNrs = [...new Set([
    ...RAW.umowy.map(u=>u.nr),
    ...RAW.postep.map(p=>p.nr),
    ...RAW.wer.map(r=>r.nr_proj),
    ...RAW.zat.map(r=>r.nr_proj)
  ].filter(Boolean))];

  return allNrs.map(nr => {
    const u   = RAW.umowy.find(x=>x.nr===nr) || {};
    const ef  = getEffectiveProjOp(nr);
    const opK = ef.op || u.opiekun || '';
    const dzK = ef.dzial || (opK ? CFG.opDzial[opK] : '') || '';
    const endD = u.do ? new Date(u.do) : null;
    const endBuf = endD ? new Date(endD) : null;
    if (endBuf) endBuf.setMonth(endBuf.getMonth() + bufor);
    return { nr, ben: u.beneficjent || '', op: opK, dz: dzK, budzet: u.budzet || 0, endD, endBuf, bufor };
  }).filter(p => {
    if (!p.endD && !p.endBuf) return false;
    if (dz && p.dz !== dz) return false;
    if (op && p.op !== op) return false;
    // Filtr okresu: projekt musi byƒá aktywny (endBuf >= od) i zaczynaƒá siƒô przed do
    if (_obOd && p.endBuf && p.endBuf < _obOd) return false;
    if (_obDo && p.endD   && p.endD   > _obDo) return false;
    return true;
  }).sort((a,b)=>(a.endD||a.endBuf)-(b.endD||b.endBuf));
}

function obIsActiveAt(p, date) {
  return p.endBuf && p.endBuf >= date;
}

function obGetPeriods(projs, mode) {
  // mode mo≈ºe byƒá 'mies' | 'kw' | 'pol'
  // Je≈õli ustawiony filtr okresu, u≈ºywamy go jako minD/maxD
  const effectiveMode = (mode === 'mies' || _obGran === 'mies') ? 'mies' :
                        (mode === 'pol'  || _obGran === 'pol')  ? 'pol'  : 'kw';

  if (!projs.length && !_obOd && !_obDo) return [];

  let minD, maxD;
  if (_obOd && _obDo) {
    minD = new Date(_obOd); maxD = new Date(_obDo);
  } else if (_obOd) {
    const dates = projs.map(p=>[p.endD,p.endBuf]).flat().filter(Boolean);
    minD = new Date(_obOd);
    maxD = dates.length ? new Date(Math.max(...dates)) : new Date(_obOd.getFullYear()+2, 11, 31);
  } else if (_obDo) {
    const dates = projs.map(p=>[p.endD,p.endBuf]).flat().filter(Boolean);
    maxD = new Date(_obDo);
    minD = dates.length ? new Date(Math.min(...dates)) : new Date();
    minD = new Date(Math.max(minD, new Date(2025,0,1)));
  } else {
    if (!projs.length) return [];
    const dates = projs.map(p=>[p.endD,p.endBuf]).flat().filter(Boolean);
    minD = new Date(Math.min(...dates));
    maxD = new Date(Math.max(...dates));
    minD = new Date(Math.max(minD, new Date(2025,0,1)));
  }

  const now = new Date();
  const periods = [];

  if (effectiveMode === 'mies') {
    let cur = new Date(minD.getFullYear(), minD.getMonth(), 1);
    while (cur <= maxD) {
      const start = new Date(cur);
      const end   = new Date(cur.getFullYear(), cur.getMonth()+1, 0);
      const mNames = ['Sty','Lut','Mar','Kwi','Maj','Cze','Lip','Sie','Wrz','Pa≈∫','Lis','Gru'];
      const label = `${mNames[start.getMonth()]} ${start.getFullYear()}`;
      const isCurrent = start <= now && now <= end;
      periods.push({start, end, label, isCurrent});
      cur.setMonth(cur.getMonth()+1);
    }
  } else {
    const step = effectiveMode === 'kw' ? 3 : 6;
    let cur = new Date(minD.getFullYear(),
      effectiveMode === 'kw'  ? Math.floor(minD.getMonth()/3)*3 :
      (minD.getMonth() < 6 ? 0 : 6), 1);
    while (cur <= maxD) {
      const start = new Date(cur);
      const end   = new Date(cur.getFullYear(), cur.getMonth()+step, 0);
      const label = effectiveMode === 'kw'
        ? `Q${Math.floor(start.getMonth()/3)+1} ${start.getFullYear()}`
        : (start.getMonth()===0 ? `H1 ${start.getFullYear()}` : `H2 ${start.getFullYear()}`);
      const isCurrent = start <= now && now <= end;
      periods.push({start, end, label, isCurrent});
      cur.setMonth(cur.getMonth()+step);
    }
  }
  return periods;
}

// Pomocnik: odczytuje warto≈õƒá CSS custom property przez obliczony styl
function _cssVar(name, fallback) {
  // Tworzymy pomocniczy div na document.body, ≈ºeby mieƒá aktualny theme
  const el = document.createElement('div');
  document.body.appendChild(el);
  const val = getComputedStyle(el).getPropertyValue(name).trim();
  document.body.removeChild(el);
  return val || fallback;
}

// Niszczy i tworzy wykres
function obChart(id, type, data, opts) {
  const canvas = document.getElementById(id);
  if (!canvas) return;
  if (_obCharts[id]) { try { _obCharts[id].destroy(); } catch(e){} }
  canvas.style.background = 'transparent';

  // Odczytaj colory z aktualnego motywu (przez obliczony styl)
  const txtColor  = _cssVar('--txt2',  '#64748b');
  const gridColor = _cssVar('--brd',   'rgba(148,163,184,.15)');
  const tickColor = _cssVar('--txt3',  '#94a3b8');
  const cardBg    = _cssVar('--card',  '#ffffff');
  const bgColor   = _cssVar('--bg2',   '#ffffff');

  // Ustaw globalne kolory Chart.js dla tej sesji renderowania
  Chart.defaults.color = txtColor;

  _obCharts[id] = new Chart(canvas, { type, data, options: {
    responsive: true, maintainAspectRatio: false,
    animation: { duration: 220 },
    plugins: {
      legend: { labels: { color: txtColor, font:{size:11} } }
    },
    scales: type!=='pie'&&type!=='doughnut' ? {
      x: { ticks: { color: tickColor, font:{size:10} }, grid:{color:gridColor} },
      y: { ticks: { color: tickColor, font:{size:10}, stepSize:1, precision:0 }, grid:{color:gridColor} }
    } : undefined,
    ...opts
  }, plugins: [{
    id: 'themeBg',
    beforeDraw(chart) {
      const ctx = chart.ctx;
      ctx.save();
      // Zawsze u≈ºyj aktualnego koloru --card (pobieranego w czasie rysowania)
      const bg = _cssVar('--card', '#ffffff');
      ctx.fillStyle = bg;
      ctx.fillRect(0, 0, chart.width, chart.height);
      ctx.restore();
    }
  }]});
}

const OB_COLORS = ['#2563eb','#059669','#d97706','#7c3aed','#0891b2','#dc2626','#ea580c','#0d9488','#6366f1','#f59e0b'];

function renderObciazenie() {
  const projs = obGetProjects();
  const now   = new Date();

  // KPI
  const active = projs.filter(p=>obIsActiveAt(p,now)).length;
  const ending90 = projs.filter(p=>p.endD&&p.endD>=now&&p.endD<=new Date(now.getTime()+90*864e5)).length;
  const opSet = new Set(projs.map(p=>p.op).filter(Boolean));
  const dzSet = new Set(projs.map(p=>p.dz).filter(Boolean));
  document.getElementById('ob-kpi').innerHTML =
    `<div class="kpi b"><div class="kpi-l">Projekt√≥w w bazie</div><div class="kpi-v">${projs.length}</div></div>`+
    `<div class="kpi r"><div class="kpi-l">Aktywnych dzi≈õ (z buf.)</div><div class="kpi-v">${active}</div></div>`+
    `<div class="kpi y"><div class="kpi-l">Ko≈Ñczy siƒô w 90 dni</div><div class="kpi-v">${ending90}</div></div>`+
    `<div class="kpi g"><div class="kpi-l">Opiekun√≥w</div><div class="kpi-v">${opSet.size}</div></div>`+
    `<div class="kpi c"><div class="kpi-l">Dzia≈Ç√≥w</div><div class="kpi-v">${dzSet.size}</div></div>`+
    ((_obOd||_obDo)?`<div class="kpi p"><div class="kpi-l">Filtr okresu</div><div class="kpi-v" style="font-size:.82rem;margin-top:2px">${_obOd?_obOd.toLocaleDateString('pl-PL',{month:'short',year:'numeric'}):'‚Ä¶'} ‚Äì ${_obDo?_obDo.toLocaleDateString('pl-PL',{month:'short',year:'numeric'}):'‚Ä¶'}</div><div class="kpi-s">${_obGran==='mies'?'MiesiƒÖce':_obGran==='pol'?'P√≥≈Çrocza':'Kwarta≈Çy'}</div></div>`:'');

  if (_obSubTab === 'przeg') {
    renderObKwartaly(projs, _obGran || _obView || 'kw');
  } else if (_obSubTab === 'opieku') {
    renderObOpiekunowie(projs);
  } else if (_obSubTab === 'dzialy') {
    renderObDzialy(projs);
  } else if (_obSubTab === 'baza') {
    renderObProjTable(projs);
  }
}

// ‚îÄ‚îÄ SUBMODU≈Å: PRZEGLƒÑD KWARTA≈ÅY/P√ì≈ÅROCZA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderObKwartaly(projs, mode) {
  const periods = obGetPeriods(projs, mode);
  const now = new Date();
  if (!periods.length) { document.getElementById('ob-main').innerHTML='<p style="color:var(--txt3);padding:16px">Brak danych z datami zako≈Ñczenia</p>'; return; }

  const maxEnd = Math.max(...periods.map(p=>projs.filter(pr=>pr.endD&&pr.endD>=p.start&&pr.endD<=p.end).length));
  const maxAct = Math.max(...periods.map(p=>projs.filter(pr=>obIsActiveAt(pr,p.start)).length));

  let rows = periods.map(per => {
    const ending = projs.filter(p=>p.endD&&p.endD>=per.start&&p.endD<=per.end);
    const active = projs.filter(p=>obIsActiveAt(p,per.start));
    const pctEnd = maxEnd>0 ? Math.round(ending.length/maxEnd*100) : 0;
    const pctAct = maxAct>0 ? Math.round(active.length/maxAct*100) : 0;
    const now_badge = per.isCurrent ? `<span class="ob-now-marker">TERAZ</span>` : '';
    return `<div class="ob-qrow">
      <div class="ob-qperiod">${per.label}${now_badge}</div>
      <div style="display:flex;flex-direction:column;gap:4px">
        <div style="display:flex;align-items:center;gap:6px">
          <span style="font-size:.65rem;color:var(--txt3);width:72px;flex-shrink:0">Ko≈Ñczy siƒô</span>
          <div class="ob-qbar-wrap" style="flex:1"><div class="ob-qbar end" style="width:${pctEnd}%"></div></div>
        </div>
        <div style="display:flex;align-items:center;gap:6px">
          <span style="font-size:.65rem;color:var(--txt3);width:72px;flex-shrink:0">Aktywne+buf.</span>
          <div class="ob-qbar-wrap" style="flex:1"><div class="ob-qbar act" style="width:${pctAct}%"></div></div>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:center;gap:4px">
        <span class="ob-qlbl" style="color:var(--acc)">${ending.length}</span>
        <span class="ob-qlbl" style="color:var(--grn)">${active.length}</span>
      </div>
      <div style="display:flex;flex-direction:column;gap:4px;font-size:.7rem;color:var(--txt3)">
        <span>ko≈Ñczy projekt</span>
        <span>aktywnych</span>
      </div>
    </div>`;
  }).join('');

  const legend = `<div style="display:flex;gap:16px;margin-bottom:12px;font-size:.78rem">
    <span><span style="display:inline-block;width:12px;height:12px;border-radius:3px;background:var(--acc);margin-right:4px;vertical-align:middle"></span>Ko≈Ñczy siƒô (data z umowy)</span>
    <span><span style="display:inline-block;width:12px;height:12px;border-radius:3px;background:var(--grn);margin-right:4px;vertical-align:middle"></span>Aktywne z buforem +${projs[0]?.bufor||4} mies.</span>
  </div>`;

  const futurePers = periods.filter(p=>p.start>new Date());
  const minActPer = [...futurePers].sort((a,b)=>
    projs.filter(pr=>obIsActiveAt(pr,a.start)).length - projs.filter(pr=>obIsActiveAt(pr,b.start)).length)[0];
  const minInfo = minActPer
    ? `<div style="margin-top:14px;padding:10px 14px;background:var(--bg3);border-left:3px solid var(--grn);border-radius:0 6px 6px 0;font-size:.84rem">
        <strong>Najmniejsze obciƒÖ≈ºenie:</strong> ${minActPer.label} ‚Äî 
        ${projs.filter(p=>obIsActiveAt(p,minActPer.start)).length} aktywnych projekt√≥w
       </div>` : '';

  document.getElementById('ob-main').innerHTML =
    `<div class="ob-section"><div class="ob-section-t">${mode==='mies'?'Rozk≈Çad miesiƒôczny':mode==='kw'?'Rozk≈Çad kwartalny':'Rozk≈Çad p√≥≈Çroczny'}</div>
    ${legend}<div class="ob-qgrid">${rows}</div>${minInfo}</div>`;
}

// ‚îÄ‚îÄ SUBMODU≈Å: OPIEKUNOWIE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderObOpiekunowie(projs) {
  const now = new Date();
  const periods = obGetPeriods(projs, _obGran || 'kw');

  // Zbierz opiekun√≥w
  const opMap = new Map();
  projs.forEach(p => {
    if (!p.op) return;
    if (!opMap.has(p.op)) opMap.set(p.op, { label: opName(p.op), dz: p.dz, projs: [] });
    opMap.get(p.op).projs.push(p);
  });
  const opArr = [...opMap.values()].sort((a,b)=>a.label.localeCompare(b.label));
  if (!opArr.length) {
    document.getElementById('ob-heat-op-wrap').innerHTML = '<p style="color:var(--txt3);padding:16px">Brak danych opiekun√≥w</p>';
    return;
  }

  // Chart 1: bar ‚Äî aktywne dzi≈õ
  const barLabels = opArr.map(o=>o.label);
  const barData   = opArr.map(o=>o.projs.filter(p=>obIsActiveAt(p,now)).length);
  setTimeout(()=>obChart('ob-chart-op-bar','bar',{
    labels: barLabels,
    datasets:[{ label:'Aktywne projekty', data: barData,
      backgroundColor: barData.map((_,i)=>OB_COLORS[i%OB_COLORS.length]+'cc'),
      borderColor: barData.map((_,i)=>OB_COLORS[i%OB_COLORS.length]),
      borderWidth:1.5, borderRadius:5 }]
  },{plugins:{legend:{display:false}}}),0);

  // Chart 2: doughnut ‚Äî udzia≈Ç w portfelu
  setTimeout(()=>obChart('ob-chart-op-pie','doughnut',{
    labels: barLabels,
    datasets:[{ data: barData,
      backgroundColor: barData.map((_,i)=>OB_COLORS[i%OB_COLORS.length]+'cc'),
      borderColor: barData.map((_,i)=>OB_COLORS[i%OB_COLORS.length]),
      borderWidth:2 }]
  }),0);

  // Chart 3: line ‚Äî rozk≈Çad w czasie
  if (periods.length) {
    const lineDatasets = opArr.map((o,i)=>({
      label: o.label,
      data: periods.map(per=>o.projs.filter(p=>obIsActiveAt(p,per.start)).length),
      borderColor: OB_COLORS[i%OB_COLORS.length],
      backgroundColor: OB_COLORS[i%OB_COLORS.length]+'22',
      tension:.35, fill:false, pointRadius:3, borderWidth:2
    }));
    setTimeout(()=>obChart('ob-chart-op-line','line',{
      labels: periods.map(p=>p.label),
      datasets: lineDatasets
    }),0);
  }

  // Heatmapa
  obRenderHeatWrap('ob-heat-op-wrap', opArr, periods, now, 'op');
}

// ‚îÄ‚îÄ SUBMODU≈Å: DZIA≈ÅY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderObDzialy(projs) {
  const now = new Date();
  const periods = obGetPeriods(projs, _obGran || 'kw');

  // Zbierz dzia≈Çy
  const dzMap = new Map();
  projs.forEach(p => {
    const key = p.dz ? `Dzia≈Ç EFS ${p.dz}` : 'Nieprzypisany';
    if (!dzMap.has(key)) dzMap.set(key, { label: key, projs: [], budzet: 0 });
    dzMap.get(key).projs.push(p);
    dzMap.get(key).budzet += p.budzet||0;
  });
  const dzArr = [...dzMap.values()].sort((a,b)=>a.label.localeCompare(b.label));
  if (!dzArr.length) {
    document.getElementById('ob-heat-dz-wrap').innerHTML = '<p style="color:var(--txt3);padding:16px">Brak danych dzia≈Ç√≥w</p>';
    return;
  }

  // Chart 1: bar ‚Äî aktywne dzi≈õ
  const barLabels = dzArr.map(d=>d.label);
  const barData   = dzArr.map(d=>d.projs.filter(p=>obIsActiveAt(p,now)).length);
  setTimeout(()=>obChart('ob-chart-dz-bar','bar',{
    labels: barLabels,
    datasets:[{ label:'Aktywne projekty', data: barData,
      backgroundColor: ['#2563ebcc','#059669cc','#d97706cc','#7c3aedcc'],
      borderColor: ['#2563eb','#059669','#d97706','#7c3aed'],
      borderWidth:1.5, borderRadius:5 }]
  },{plugins:{legend:{display:false}}}),0);

  // Chart 2: bar ‚Äî bud≈ºety
  const budData = dzArr.map(d=>Math.round(d.budzet/1e6*100)/100);
  setTimeout(()=>obChart('ob-chart-dz-bud','bar',{
    labels: barLabels,
    datasets:[{ label:'Bud≈ºet (mln z≈Ç)', data: budData,
      backgroundColor: ['#0891b2cc','#7c3aedcc','#ea580ccc','#dc2626cc'],
      borderColor: ['#0891b2','#7c3aed','#ea580c','#dc2626'],
      borderWidth:1.5, borderRadius:5 }]
  },{plugins:{legend:{display:false}}, scales:{y:{ticks:{callback:v=>v+' mln'}}}}),0);

  // Chart 3: line ‚Äî rozk≈Çad w czasie
  if (periods.length) {
    const lineColors = ['#2563eb','#059669','#d97706','#7c3aed'];
    const lineDatasets = dzArr.map((d,i)=>({
      label: d.label,
      data: periods.map(per=>d.projs.filter(p=>obIsActiveAt(p,per.start)).length),
      borderColor: lineColors[i%lineColors.length],
      backgroundColor: lineColors[i%lineColors.length]+'22',
      tension:.35, fill: i===0, pointRadius:4, borderWidth:2.5
    }));
    setTimeout(()=>obChart('ob-chart-dz-line','line',{
      labels: periods.map(p=>p.label),
      datasets: lineDatasets
    }),0);
  }

  // Heatmapa
  obRenderHeatWrap('ob-heat-dz-wrap', dzArr, periods, now, 'dz');
}

// Wsp√≥lna heatmapa dla op/dz
function obRenderHeatWrap(wrapId, groupArr, periods, now, type) {
  const wrap = document.getElementById(wrapId);
  if (!wrap) return;

  if (!periods.length || !groupArr.length) { wrap.innerHTML=''; return; }

  let globalMax = 0;
  groupArr.forEach(g => {
    periods.forEach(per => {
      const cnt = g.projs.filter(p=>obIsActiveAt(p,per.start)).length;
      if (cnt > globalMax) globalMax = cnt;
    });
  });

  const futurePers = periods.filter(p=>p.start>now);

  const perHeaders = periods.map(per =>
    `<th class="nr" style="${per.isCurrent?'color:var(--acc);font-weight:900':''}">${per.label}${per.isCurrent?'<br><span style="font-size:.62rem;font-weight:400;color:var(--acc)">TERAZ</span>':''}</th>`
  ).join('');

  const tbody = groupArr.map(g => {
    const activeNow = g.projs.filter(p=>obIsActiveAt(p,now)).length;
    let minPer=null, minVal=Infinity;
    futurePers.forEach(per=>{
      const cnt=g.projs.filter(p=>obIsActiveAt(p,per.start)).length;
      if(cnt>0 && cnt<minVal){minVal=cnt;minPer=per;}
    });
    const cells = periods.map(per => {
      const cnt = g.projs.filter(p=>obIsActiveAt(p,per.start)).length;
      const style = obHeatColor(cnt, globalMax);
      const isMin = minPer && per.label===minPer.label && cnt>0 && cnt===minVal;
      return `<td class="ob-cell" style="${style}">${cnt||'‚Äî'}${isMin?'<span class="ob-min-badge">‚ñº</span>':''}</td>`;
    }).join('');
    const minInfo = (minPer&&minVal>0) ? `<span title="Najmniej obciƒÖ≈ºony: ${minPer.label} (${minVal} proj.)" style="margin-left:6px;font-size:.7rem;color:var(--grn);cursor:help">‚¨§ ‚ñº ${minPer.label}</span>` : '';
    const dzCell = type==='op' ? `<td class="ob-dz">${g.dz?'EFS '+g.dz:'‚Äî'}</td>` : '';
    return `<tr>
      <td class="ob-name">${g.label}${minInfo}</td>
      ${dzCell}
      <td class="ob-cell" style="font-weight:800;color:var(--txt)">${activeNow||'‚Äî'}</td>
      ${cells}
    </tr>`;
  }).join('');

  const dzColHdr = type==='op' ? '<th>Dzia≈Ç</th>' : '';
  const nowHeader = `<th class="nr" style="color:var(--txt2);border-right:2px solid var(--brd2)">Dzi≈õ<br><span style="font-size:.62rem;font-weight:400">aktywne</span></th>`;

  const sumCells = periods.map(per=>{
    const tot = groupArr.reduce((s,g)=>s+g.projs.filter(p=>obIsActiveAt(p,per.start)).length,0);
    return `<td class="ob-cell" style="font-weight:800;border-top:2px solid var(--brd)">${tot||'‚Äî'}</td>`;
  }).join('');
  const sumNow = groupArr.reduce((s,g)=>s+g.projs.filter(p=>obIsActiveAt(p,now)).length,0);
  const sumDzCell = type==='op' ? '<td style="border-top:2px solid var(--brd)"></td>' : '';
  const sumRow = `<tr style="background:var(--bg3)">
    <td class="ob-name" style="border-top:2px solid var(--brd);font-size:.75rem;color:var(--txt3)">RAZEM</td>
    ${sumDzCell}
    <td class="ob-cell" style="font-weight:800;border-top:2px solid var(--brd);border-right:2px solid var(--brd2)">${sumNow||'‚Äî'}</td>
    ${sumCells}
  </tr>`;

  // Oblicz szeroko≈õƒá kolumn: dostƒôpna szeroko≈õƒá = main - sidebar(232) - padding(48)
  const available = Math.max(600, (document.querySelector('.main')?.offsetWidth || window.innerWidth) - 48);
  const nameColW = type === 'op' ? 200 : 160;
  const dzColW   = type === 'op' ? 60  : 0;
  const nowColW  = 64;
  const reservedW = nameColW + dzColW + nowColW + 20;
  const nCols = periods.length;
  // Fit columns into available width, but never narrower than 52px
  const cellW = nCols > 0 ? Math.max(52, Math.min(88, Math.floor((available - reservedW) / nCols))) : 72;
  const tableW = reservedW + cellW * nCols;

  // Generuj colgroup dla dok≈Çadnych szeroko≈õci
  const dzCol = type==='op' ? `<col style="width:${dzColW}px">` : '';
  const periodCols = periods.map(()=>`<col style="width:${cellW}px">`).join('');
  const colgroup = `<colgroup><col style="width:${nameColW}px">${dzCol}<col style="width:${nowColW}px">${periodCols}</colgroup>`;

  wrap.innerHTML = `<div class="ob-section">
    <div class="ob-section-t">Heatmapa obciƒÖ≈ºenia ¬∑ liczba aktywnych projekt√≥w z buforem</div>
    <div class="of"><table class="ob-heat" style="width:${tableW}px">
    ${colgroup}
      <thead><tr>
        <th>${type==='op'?'Opiekun':'Dzia≈Ç'}</th>
        ${dzColHdr}
        ${nowHeader}
        ${perHeaders}
      </tr></thead>
      <tbody>${tbody}${sumRow}</tbody>
    </table></div>
    <div style="display:flex;gap:10px;margin-top:10px;font-size:.75rem;flex-wrap:wrap">
      <span><span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:rgba(34,197,94,.18);margin-right:4px"></span>Niskie</span>
      <span><span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:rgba(59,130,246,.12);margin-right:4px"></span>Umiarkowane</span>
      <span><span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:rgba(234,179,8,.18);margin-right:4px"></span>Wysokie</span>
      <span><span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:rgba(220,38,38,.18);margin-right:4px"></span>Krytyczne</span>
      <span style="margin-left:8px"><span class="ob-min-badge">‚ñº</span> = najmniejsze obciƒÖ≈ºenie w przysz≈Ço≈õci</span>
    </div>
  </div>`;
}

// ‚îÄ‚îÄ HEATMAP COLOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function obHeatColor(val, maxVal) {
  if (!val || !maxVal) return '';
  const pct = val / maxVal;
  if (pct >= 0.85) return 'background:rgba(var(--red-rgb,220,38,38),.18);color:var(--red)';
  if (pct >= 0.60) return 'background:rgba(var(--yel-rgb,234,179,8),.18);color:var(--yel)';
  if (pct >= 0.30) return 'background:rgba(var(--acc-rgb,59,130,246),.12);color:var(--acc)';
  return 'background:rgba(var(--grn-rgb,34,197,94),.12);color:var(--grn)';
}

// ‚îÄ‚îÄ TABELA BAZOWA PROJEKT√ìW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderObProjTable(projs) {
  const now = new Date();
  document.getElementById('ob-proj-count').textContent = `${projs.length} projekt√≥w`;
  document.getElementById('ob-proj-tbody').innerHTML = projs.map(p => {
    const endLbl = p.endD ? fmtD(p.endD.toISOString().slice(0,10)) : '‚Äî';
    const bufLbl = p.endBuf ? fmtD(p.endBuf.toISOString().slice(0,10)) : '‚Äî';
    const isActive = obIsActiveAt(p, now);
    const endSoon = p.endD && p.endD >= now && p.endD <= new Date(now.getTime()+90*864e5);
    const statusBadge = !isActive
      ? `<span class="badge" style="background:var(--bg3);color:var(--txt3)">Zamkniƒôty</span>`
      : endSoon
        ? `<span class="badge br">Ko≈Ñczy siƒô</span>`
        : `<span class="badge bg">Aktywny</span>`;
    const dzLbl = p.dz ? ({"1":"Dzia≈Ç EFS I","2":"Dzia≈Ç EFS II","3":"Dzia≈Ç EFS III"}[p.dz]||`Dzia≈Ç EFS ${p.dz}`) : '‚Äî';
    return `<tr>
      <td class="mono" style="font-size:.88rem">${p.nr}</td>
      <td><div class="clamp" style="max-width:220px">${p.ben||'‚Äî'}</div></td>
      <td>${p.op ? opName(p.op) : '‚Äî'}</td>
      <td style="font-size:.82rem;color:var(--txt3)">${dzLbl}</td>
      <td class="nr mono">${endLbl}</td>
      <td class="nr mono" style="color:var(--acc2)">${bufLbl}</td>
      <td class="nr mono">${fmtK(p.budzet)}</td>
      <td>${statusBadge}</td>
    </tr>`;
  }).join('') || '<tr><td colspan="8" class="empty">Brak projekt√≥w z datami zako≈Ñczenia</td></tr>';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Prze≈ÇƒÖcznik motywu (AiWskazniki design system)
// ===== [JS-AI] ASYSTENT ZARZƒÑDCZY ‚Äî chat obciƒÖ≈ºenia zespo≈Çu =====
const OB_AI_KEY_PLACEHOLDER = 'WSTAW_KLUCZ_API_TUTAJ'; // ‚Üê podmie≈Ñ na sk-ant-...
let obAiKey = OB_AI_KEY_PLACEHOLDER;
let obAiMessages = []; // historia rozmowy

function obAiKeyChange(val) {
  obAiKey = val.trim() || OB_AI_KEY_PLACEHOLDER;
  const hint = document.getElementById('ob-ai-key-hint');
  if (!hint) return;
  if (obAiKey && obAiKey !== OB_AI_KEY_PLACEHOLDER) {
    hint.textContent = '‚úì Klucz wpisany ‚Äî tryb AI aktywny';
    hint.style.color = 'var(--grn)';
  } else {
    hint.textContent = 'Brak klucza ‚Äî tryb demo';
    hint.style.color = 'var(--txt3)';
  }
}

function obAiBuildContext() {
  // Zbierz aktualne dane obciƒÖ≈ºenia z dashboardu
  const projs = obGetProjects ? obGetProjects() : [];
  const now = new Date();

  // Statystyki per dzia≈Ç
  const dzStats = {};
  const DZ_NAMES = {"1":"Dzia≈Ç EFS I","2":"Dzia≈Ç EFS II","3":"Dzia≈Ç EFS III"};
  projs.forEach(p => {
    const dz = p.dz || 'nieprzypisany';
    const dzName = DZ_NAMES[dz] || dz;
    if (!dzStats[dzName]) dzStats[dzName] = {aktywne:0, konczace3m:0, konczace6m:0, budzet:0, opiekunowie:new Set()};
    const s = dzStats[dzName];
    if (p.active) s.aktywne++;
    if (p.do) {
      const end = new Date(p.do);
      const diffM = (end - now) / (1000*60*60*24*30);
      if (diffM >= 0 && diffM <= 3) s.konczace3m++;
      if (diffM >= 0 && diffM <= 6) s.konczace6m++;
    }
    s.budzet += p.budzet || 0;
    if (p.op) s.opiekunowie.add(p.op);
  });

  // Statystyki per opiekun
  const opStats = {};
  projs.forEach(p => {
    if (!p.op) return;
    const name = opName(p.op);
    const dz = DZ_NAMES[p.dz] || p.dz || '‚Äî';
    if (!opStats[name]) opStats[name] = {dz, aktywne:0, konczace3m:0, konczace6m:0};
    const s = opStats[name];
    if (p.active) s.aktywne++;
    if (p.do) {
      const end = new Date(p.do);
      const diffM = (end - now) / (1000*60*60*24*30);
      if (diffM >= 0 && diffM <= 3) s.konczace3m++;
      if (diffM >= 0 && diffM <= 6) s.konczace6m++;
    }
  });

  const dzLines = Object.entries(dzStats).map(([dz,s]) =>
    `  ${dz}: ${s.aktywne} aktywnych proj., ${s.konczace3m} ko≈Ñczy w 3 mies., ${s.konczace6m} ko≈Ñczy w 6 mies., bud≈ºet ${(s.budzet/1e6).toFixed(1)} mln z≈Ç, opiekun√≥w: ${s.opiekunowie.size}`
  ).join('\n');

  const opLines = Object.entries(opStats)
    .sort((a,b) => b[1].aktywne - a[1].aktywne)
    .slice(0, 15)
    .map(([name,s]) =>
      `  ${name} (${s.dz}): ${s.aktywne} aktywnych, ${s.konczace3m} ko≈Ñczy/3m, ${s.konczace6m} ko≈Ñczy/6m`
    ).join('\n');

  const totalActive = projs.filter(p=>p.active).length;
  const totalAll = projs.length;
  const werCount = RAW.wer ? RAW.wer.length : 0;
  const popCount = RAW.pop ? RAW.pop.length : 0;

  return `Jeste≈õ asystentem zarzƒÖdczym Wydzia≈Çu Wdra≈ºania EFS+ w Departamencie Funduszy Europejskich (FEDS 2021-2027).
Odpowiadasz TYLKO na podstawie poni≈ºszych danych. Odpowiedzi sƒÖ zwiƒôz≈Çe, konkretne, w jƒôzyku polskim, z perspektywƒÖ zarzƒÖdczƒÖ.
Data bie≈ºƒÖca: ${now.toISOString().slice(0,10)}

=== STAN OBCIƒÑ≈ªENIA ZESPO≈ÅU ===
≈ÅƒÖcznie projekt√≥w: ${totalAll} (aktywnych: ${totalActive})
W bie≈ºƒÖcej weryfikacji WNP: ${werCount}
W poprawie WNP: ${popCount}

OBCIƒÑ≈ªENIE WG DZIA≈Å√ìW:
${dzLines || '  Brak danych dzia≈Ç√≥w'}

OBCIƒÑ≈ªENIE WG OPIEKUN√ìW (top 15 wg liczby aktywnych):
${opLines || '  Brak danych opiekun√≥w'}

=== KONWENCJA ===
"Projekt ko≈Ñczy siƒô" = data zako≈Ñczenia umowy dofinansowania
"OdciƒÖ≈ºenie" = projekty ko≈ÑczƒÖce realizacjƒô, zwalniajƒÖce zasoby opiekuna
Odpowiadaj zwiƒô≈∫le. Je≈õli pytanie wykracza poza powy≈ºsze dane, powiedz o tym wprost.`;
}

function obAiAddMsg(role, text, isLoading=false) {
  const hist = document.getElementById('ob-ai-history');
  if (!hist) return;
  // Wyczy≈õƒá placeholder przy pierwszej wiadomo≈õci
  if (obAiMessages.length === 0 && !isLoading) {
    const placeholder = hist.querySelector('div[style*="text-align:center"]');
    if (placeholder) placeholder.remove();
  }
  const isUser = role === 'user';
  const div = document.createElement('div');
  div.style.cssText = `display:flex;flex-direction:column;align-items:${isUser?'flex-end':'flex-start'};gap:3px`;
  div.innerHTML = `
    <div style="font-size:.65rem;color:var(--txt3);font-weight:700;text-transform:uppercase;letter-spacing:.06em;padding:0 4px">
      ${isUser ? 'üë§ Ty' : 'ü§ñ Asystent'}
    </div>
    <div style="max-width:88%;padding:9px 13px;border-radius:${isUser?'12px 4px 12px 12px':'4px 12px 12px 12px'};
      background:${isUser?'var(--acc)':'var(--bg3)'};color:${isUser?'#fff':'var(--txt)'};
      font-size:.82rem;line-height:1.55;white-space:pre-wrap;border:1px solid ${isUser?'var(--acc)':'var(--brd)'}">
      ${isLoading ? '<span id="ob-ai-loading" style="color:var(--txt3)">‚è≥ Generujƒô odpowied≈∫‚Ä¶</span>' : text}
    </div>`;
  hist.appendChild(div);
  hist.scrollTop = hist.scrollHeight;
  return div;
}

function obAiClear() {
  obAiMessages = [];
  const hist = document.getElementById('ob-ai-history');
  if (hist) hist.innerHTML = `<div style="text-align:center;color:var(--txt3);font-size:.8rem;padding:20px 0">Historia wyczyszczona. Zadaj nowe pytanie.</div>`;
  const status = document.getElementById('ob-ai-status');
  if (status) status.textContent = '';
}

async function obAiSend(presetText) {
  const input = document.getElementById('ob-ai-input');
  const text = (presetText || input?.value || '').trim();
  if (!text) return;
  if (input) input.value = '';

  const btn = document.getElementById('ob-ai-send-btn');
  if (btn) { btn.disabled = true; btn.textContent = '‚è≥'; }

  obAiAddMsg('user', text);
  obAiMessages.push({role:'user', content: text});

  const loadingDiv = obAiAddMsg('assistant', '', true);
  const status = document.getElementById('ob-ai-status');

  // TRYB DEMO ‚Äî gdy brak prawdziwego klucza
  if (!obAiKey || obAiKey === OB_AI_KEY_PLACEHOLDER) {
    await new Promise(r => setTimeout(r, 800));
    const loadingEl = document.getElementById('ob-ai-loading');
    const demoReply = obAiDemoResponse(text);
    if (loadingEl) loadingEl.closest('div[style*="background"]').innerHTML = demoReply;
    else if (loadingDiv) loadingDiv.querySelector('div[style*="background"]').innerHTML = demoReply;
    obAiMessages.push({role:'assistant', content: demoReply});
    if (status) { status.textContent = '‚ö† Tryb demo ‚Äî brak klucza API'; status.style.color='var(--yel)'; }
    if (btn) { btn.disabled = false; btn.textContent = 'Wy≈õlij ‚ñ∂'; }
    return;
  }

  // TRYB AI ‚Äî prawdziwe wywo≈Çanie Anthropic API
  try {
    if (status) { status.textContent = '‚è≥ ≈ÅƒÖczƒô z API‚Ä¶'; status.style.color='var(--txt3)'; }
    const systemPrompt = obAiBuildContext();
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': obAiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1024,
        system: systemPrompt,
        messages: obAiMessages.slice(-10) // max 10 wiadomo≈õci historii
      })
    });
    if (!response.ok) {
      const err = await response.json().catch(()=>({}));
      throw new Error(err?.error?.message || `HTTP ${response.status}`);
    }
    const data = await response.json();
    const reply = data?.content?.[0]?.text || '(brak odpowiedzi)';
    const loadingEl = document.getElementById('ob-ai-loading');
    if (loadingEl) loadingEl.closest('div[style*="background"]').textContent = reply;
    obAiMessages.push({role:'assistant', content: reply});
    if (status) { status.textContent = '‚úì AI aktywne'; status.style.color='var(--grn)'; }
  } catch(e) {
    const loadingEl = document.getElementById('ob-ai-loading');
    const errMsg = `‚ùå B≈ÇƒÖd: ${e.message}`;
    if (loadingEl) loadingEl.closest('div[style*="background"]').innerHTML = `<span style="color:var(--red)">${errMsg}</span>`;
    if (status) { status.textContent = errMsg; status.style.color='var(--red)'; }
  }

  if (btn) { btn.disabled = false; btn.textContent = 'Wy≈õlij ‚ñ∂'; }
  const hist = document.getElementById('ob-ai-history');
  if (hist) hist.scrollTop = hist.scrollHeight;
}

function obAiDemoResponse(question) {
  // Odpowiedzi demo bazujƒÖce na rzeczywistych danych
  const projs = obGetProjects ? obGetProjects() : [];
  const now = new Date();
  const DZ = {"1":"Dzia≈Ç EFS I","2":"Dzia≈Ç EFS II","3":"Dzia≈Ç EFS III"};
  const dzAkt = {};
  projs.forEach(p => {
    const d = DZ[p.dz]||p.dz||'‚Äî';
    if(!dzAkt[d]) dzAkt[d]={akt:0,kon3:0,kon6:0};
    if(p.active) dzAkt[d].akt++;
    if(p.do){const m=(new Date(p.do)-now)/(1000*60*60*24*30);if(m>=0&&m<=3)dzAkt[d].kon3++;if(m>=0&&m<=6)dzAkt[d].kon6++;}
  });
  const lines = Object.entries(dzAkt).map(([d,s])=>
    `‚Ä¢ ${d}: ${s.akt} aktywnych projekt√≥w, ${s.kon3} ko≈Ñczy w ciƒÖgu 3 miesiƒôcy, ${s.kon6} w ciƒÖgu 6 miesiƒôcy`
  ).join('\n');
  const q = question.toLowerCase();
  if(q.includes('obciƒÖ≈º')||q.includes('dzia≈Ç')||q.includes('przyjƒÖƒá')||q.includes('nowe')) {
    return `[TRYB DEMO ‚Äî wstaw klucz API po analizƒô AI]\n\nNa podstawie danych dashboardu:\n\n${lines||'Brak danych'}\n\nPrognoza odciƒÖ≈ºenia: dzia≈Çy, w kt√≥rych w ciƒÖgu 3 miesiƒôcy ko≈Ñczy siƒô najwiƒôcej projekt√≥w, bƒôdƒÖ gotowe do przyjƒôcia nowych operacji po rozliczeniu WNP ko≈Ñcowych (zwykle 1-2 miesiƒÖce po zako≈Ñczeniu projektu).`;
  }
  if(q.includes('opiekun')||q.includes('pracown')) {
    const opTop = {};
    projs.forEach(p=>{if(p.op&&p.active){if(!opTop[p.op])opTop[p.op]=0;opTop[p.op]++;}});
    const sorted = Object.entries(opTop).sort((a,b)=>b[1]-a[1]).slice(0,5);
    return `[TRYB DEMO]\n\nNajbardziej obciƒÖ≈ºeni opiekunowie:\n${sorted.map(([op,c])=>`‚Ä¢ ${opName(op)}: ${c} aktywnych projekt√≥w`).join('\n')||'Brak danych'}\n\nPo wstawieniu klucza API otrzymasz pe≈ÇnƒÖ analizƒô zarzƒÖdczƒÖ z rekomendacjami.`;
  }
  return `[TRYB DEMO ‚Äî wstaw klucz API w polu powy≈ºej]\n\nOdpowiem na pytanie: "${question}"\n\nDane z dashboardu sƒÖ dostƒôpne (${projs.filter(p=>p.active).length} aktywnych projekt√≥w). Po aktywacji klucza API Anthropic (sk-ant-...) otrzymasz rzeczywistƒÖ analizƒô zarzƒÖdczƒÖ opartƒÖ na aktualnych danych.`;
}

// ===== [JS-P] MOTYW, ROZLICZENIE, INICJALIZACJA ‚Äî setTheme, buildRozliczenie, saveState =====
function setTheme(theme, btn){
  document.body.className = theme === 'light' ? '' : 'theme-' + theme;
  const bgMap = {dark:'#111827', sepia:'#f5efe0', light:'#f8fafc'};
  document.documentElement.style.background = bgMap[theme] || bgMap.dark;
  document.querySelectorAll('.tb-theme-btn').forEach(b => b.classList.remove('on'));
  if(btn) btn.classList.add('on');
  try { localStorage.setItem('rbmv_theme', theme); } catch(e){}
}
// Motyw sta≈Çy: ciemny ‚Äî klasa theme-dark ustawiona na <body> bezpo≈õrednio w HTML


// ‚îÄ‚îÄ SYNCHRONIZACJA FILTRA DZIA≈ÅU ‚Äî topbar ‚Üí wszystkie sekcje ‚îÄ‚îÄ
function syncDzialFilters(val){
  const ids=["fw-dz","fp-dz","fz-dz","fr-dz","froz-dz","fpost-dz","frz-dz","fhw-dz","fhz-dz","fop-dz","fob-dz","fwp-dz","fa-dz","fm-dz"];
  const locked=!!val; // gdy topbar ma konkretny dzia≈Ç ‚Äî blokujemy lokalne filtry
  ids.forEach(id=>{
    const el=document.getElementById(id);
    if(!el)return;
    el.value=val;
    if(locked){
      el.disabled=true;
      el.title="Filtr dzia≈Çu zarzƒÖdzany przez g√≥rny pasek";
      el.style.opacity="0.5";
    } else {
      el.disabled=false;
      el.title="";
      el.style.opacity="";
    }
  });
}

function topbarDzialChange(val){
  if(val==="all"){
    CFG.dzialy=new Set(["all"]);
    const dpAll=document.getElementById("dp-all");if(dpAll)dpAll.classList.add("on");
    ["1","2","3"].forEach(x=>{const el=document.getElementById("dp-"+x);if(el)el.classList.remove("on");});
  } else {
    CFG.dzialy=new Set([val]);
    const dpAll=document.getElementById("dp-all");if(dpAll)dpAll.classList.remove("on");
    ["1","2","3"].forEach(x=>{const el=document.getElementById("dp-"+x);if(el)el.classList.toggle("on",x===val);});
  }
  const names={all:"Wszystkie dzia≈Çy","1":"Dzia≈Ç EFS I","2":"Dzia≈Ç EFS II","3":"Dzia≈Ç EFS III"};
  const dzLbl=names[val]||"Wszystkie dzia≈Çy";
  const el1=document.getElementById("tb-dzial");if(el1)el1.textContent=dzLbl;
  const el2=document.getElementById("ov-dzial");if(el2)el2.textContent=dzLbl;
  syncDzialFilters(val==="all"?"":val);
  saveCFG();
  rebuildAll();
}

// ‚îÄ‚îÄ‚îÄ ROZLICZENIE ‚îÄ‚îÄ‚îÄ
function buildRozliczenie(){
  renderRozGrid();
}

function renderRozGrid(){
  const srch=(document.getElementById('froz-s')||{value:''}).value.toLowerCase();
  const dz=(document.getElementById('froz-dz')||{value:''}).value;
  const fl=(document.getElementById('froz-fl')||{value:''}).value;
  const grid=document.getElementById('roz-grid');if(!grid)return;
  // Zbierz wszystkie projekty z um√≥w + fallback z WNP
  const projNrs=[...new Set([
    ...RAW.umowy.filter(u=>u.ma_umowe).map(u=>u.nr),
    ...RAW.zat.map(r=>r.nr_proj),
    ...RAW.wer.map(r=>r.nr_proj),
    ...RAW.pop.map(r=>r.nr_proj),
  ].filter(Boolean))].sort();
  const projs=projNrs.map(nr=>{
    const umowa=RAW.umowy.find(u=>u.nr===nr)||{};
    const arpkData=RAW.arpk_map[nr]||{};
    const op=umowa.opiekun||arpkData.opiekun||'';
    const budzet=umowa.budzet||0;
    const allWnp=[...RAW.wer,...RAW.pop,...RAW.zat].filter(r=>r.nr_proj===nr);
    const totKwal=allWnp.reduce((s,r)=>s+(r.wyd_kwal||0),0);
    const pct=budzet>0?(totKwal/budzet*100):0;
    const zatCnt=RAW.zat.filter(r=>r.nr_proj===nr).length;
    const werCnt=RAW.wer.filter(r=>r.nr_proj===nr).length;
    return{nr,beneficjent:umowa.beneficjent||'',op,budzet,totKwal,pct,zatCnt,werCnt,status:umowa.status||''};
  });
  let f=projs.filter(p=>{
    if(dz&&!dzialFilter(p.op,dz))return false;
    if(!projInScope(p.nr))return false;
    if(fl==='low'&&p.pct>=25)return false;
    if(fl==='mid'&&(p.pct<25||p.pct>75))return false;
    if(fl==='high'&&p.pct<=75)return false;
    if(srch&&!`${p.nr} ${p.beneficjent}`.toLowerCase().includes(srch))return false;
    return true;
  });
  const cnt=document.getElementById('roz-cnt');
  if(cnt)cnt.textContent=`${f.length} projekt√≥w`;
  if(!f.length){
    grid.innerHTML='<div class="empty" style="grid-column:1/-1;padding:40px">Brak projekt√≥w spe≈ÇniajƒÖcych kryteria. Wczytaj plik danych w zak≈Çadce Dane.</div>';
    document.getElementById('roz-content').innerHTML='';return;
  }
  grid.innerHTML=f.map(p=>{
    const pct=Math.min(100,p.pct);
    const col=p.pct>=75?'var(--grn)':p.pct>=25?'var(--yel)':'var(--red)';
    const opLabel=opName(p.op)||'‚Äî';
    const ab=arpkBadge(getWeightedScore(RAW.arpk_map[p.nr]||{}));
    return`<div class="kpi" style="cursor:pointer;border-radius:12px;padding:14px 16px" onclick="openRozDetail('${p.nr}')" title="Kliknij aby zobaczyƒá szczeg√≥≈Çy">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:6px;margin-bottom:8px">
        <div>
          <div class="kpi-l" style="margin-bottom:2px">Nr projektu</div>
          <div style="font-family:var(--mono);font-size:.75rem;font-weight:700;color:var(--txt)">${p.nr}</div>
        </div>
        <div style="display:flex;gap:4px;flex-shrink:0;flex-wrap:wrap;justify-content:flex-end">${ab.badge}${p.werCnt>0?`<span class="badge bb">${p.werCnt} WER</span>`:''}</div>
      </div>
      <div style="font-size:.8rem;font-weight:600;color:var(--txt2);margin-bottom:10px;line-height:1.3;min-height:2.2em">${clamp(p.beneficjent,40)}</div>
      <div style="margin-bottom:8px">
        <div class="prog" style="height:7px;margin-bottom:3px"><div class="prog-b" style="width:${pct}%;background:${col}"></div></div>
        <div style="display:flex;justify-content:space-between;font-size:.72rem;color:var(--txt3)">
          <span>Rozliczenie: <b style="color:${col}">${p.pct.toFixed(1)}%</b></span>
          <span>${fmtK(p.totKwal)} / ${fmtK(p.budzet)}</span>
        </div>
      </div>
      <div style="display:flex;gap:8px;font-size:.72rem;color:var(--txt3);border-top:1px solid var(--brd);padding-top:7px">
        <span>ZAT: <b style="color:var(--grn)">${p.zatCnt}</b></span>
        <span style="margin-left:auto">${opLabel}</span>
      </div>
    </div>`;
  }).join('');
  // Wyczy≈õƒá szczeg√≥≈Çy gdy od≈õwie≈ºamy grid
  document.getElementById('roz-content').innerHTML='';
}

function openRozDetail(projNr){
  // Zaznacz aktywny kafelek
  document.querySelectorAll('#roz-grid .kpi').forEach(el=>{
    el.style.borderColor=el.getAttribute('onclick')===`openRozDetail('${projNr}')`?'var(--acc)':'var(--brd)';
    el.style.boxShadow=el.getAttribute('onclick')===`openRozDetail('${projNr}')`?'var(--sh2)':'var(--sh)';
  });
  renderRozliczenie(projNr);
  // Scroll do szczeg√≥≈Ç√≥w
  setTimeout(()=>{const el=document.getElementById('roz-content');if(el)el.scrollIntoView({behavior:'smooth',block:'start'});},80);
}

function showRozliczenieForProject(projNr){
  showPage('rozliczenie');
  setTimeout(()=>{
    const sel=document.getElementById("froz-proj");
    if(sel){if(sel.options.length<=1)buildRozliczenie();sel.value=projNr;renderRozliczenie();}
  },50);
}

function renderRozliczenie(){
  const sel=document.getElementById("froz-proj");if(!sel)return;
  const projNr=sel.value;
  const el=document.getElementById("roz-content");if(!el)return;
  if(!projNr){el.innerHTML='<div class="empty" style="padding:48px">Wybierz projekt z listy aby wy≈õwietliƒá rozliczenie</div>';return;}
  const umowa=RAW.umowy.find(u=>u.nr===projNr)||{};
  const arpkData=RAW.arpk_map[projNr]||{};
  const sc=getWeightedScore(arpkData);
  const ab=arpkBadge(sc);
  const allWnp=[...RAW.wer,...RAW.pop,...RAW.zat].filter(r=>r.nr_proj===projNr);
  const totKwal=allWnp.reduce((s,r)=>s+(r.wyd_kwal||0),0);
  const totDof=allWnp.reduce((s,r)=>s+(r.dofinansowanie||0),0);
  const totWl=allWnp.reduce((s,r)=>s+(r.wklad_wlasny||0),0);
  const totZal=allWnp.reduce((s,r)=>s+(r.zaliczka||0),0);
  const totRef=allWnp.reduce((s,r)=>s+(r.refundacja||0),0);
  const budzet=umowa.budzet||0;
  const rozlPct=budzet>0?(totKwal/budzet*100).toFixed(1):0;
  const opiekun=opName(umowa.opiekun||arpkData.opiekun||'');
  el.innerHTML=`
  <div class="kgrid" style="margin-bottom:14px">
    <div class="kpi b"><div class="kpi-l">Numer projektu</div><div class="kpi-v" style="font-size:.72rem;line-height:1.2">${projNr}</div></div>
    <div class="kpi c"><div class="kpi-l">Beneficjent</div><div class="kpi-v" style="font-size:.78rem;line-height:1.2">${clamp(umowa.beneficjent||'‚Äî',30)}</div></div>
    <div class="kpi g"><div class="kpi-l">Status projektu</div><div class="kpi-v" style="font-size:.85rem">${umowa.status||'‚Äî'}</div></div>
    <div class="kpi y"><div class="kpi-l">Opiekun</div><div class="kpi-v" style="font-size:.85rem">${opiekun}</div></div>
  </div>
  <div class="cgrid" style="margin-bottom:14px">
    <div class="ccard"><div class="ctitle">Dane umowy</div>
      <div class="dg" style="grid-template-columns:1fr 1fr;gap:6px">
        <div class="dr"><div class="dk">Okres od</div><div class="dv">${fmtD(umowa.od)}</div></div>
        <div class="dr"><div class="dk">Okres do</div><div class="dv">${fmtD(umowa.do)}</div></div>
        <div class="dr"><div class="dk">Data podpisania umowy</div><div class="dv">${fmtD(umowa.data_umowy)}</div></div>
        <div class="dr"><div class="dk">Forma prawna</div><div class="dv">${umowa.forma_prawna||'‚Äî'}</div></div>
        <div class="dr full"><div class="dk">Tytu≈Ç projektu</div><div class="dv">${umowa.tytu||'‚Äî'}</div></div>
      </div>
    </div>
    <div class="ccard"><div class="ctitle">Realizacja finansowa</div>
      <div class="dg" style="grid-template-columns:1fr 1fr;gap:6px">
        <div class="dr"><div class="dk">Bud≈ºet (wyd. kwal.)</div><div class="dv mono">${fmtK(budzet)}</div></div>
        <div class="dr"><div class="dk">Dofinansowanie (umowa)</div><div class="dv mono">${fmtK(umowa.dofinansowanie)}</div></div>
        <div class="dr"><div class="dk">Stopie≈Ñ rozliczenia</div><div class="dv" style="color:${pctColor(+rozlPct)};font-weight:700;font-size:1.1rem">${rozlPct}%</div></div>
        <div class="dr"><div class="dk">Wyd. kwal. WNP (≈ÇƒÖcznie)</div><div class="dv mono">${fmtK(totKwal)}</div></div>
        <div class="dr"><div class="dk">Dofinansowanie WNP</div><div class="dv mono">${fmtK(totDof)}</div></div>
        <div class="dr"><div class="dk">Wk≈Çad w≈Çasny WNP</div><div class="dv mono">${fmtK(totWl)}</div></div>
        <div class="dr"><div class="dk">Zaliczki</div><div class="dv mono">${fmtK(totZal)}</div></div>
        <div class="dr"><div class="dk">Refundacje</div><div class="dv mono">${fmtK(totRef)}</div></div>
      </div>
      <div style="margin-top:10px"><div class="prog" style="height:8px"><div class="prog-b" style="width:${Math.min(100,+rozlPct)}%;background:${pctColor(+rozlPct)}"></div></div>
      <div style="text-align:right;font-size:.75rem;color:var(--txt3);margin-top:3px">${rozlPct}% bud≈ºetu rozliczone</div>
      </div>
    </div>
  </div>
  <div class="twrap"><div class="ttb"><span style="font-size:.85rem;font-weight:700;color:var(--txt2)">Wykaz wniosk√≥w o p≈Çatno≈õƒá ‚Äî statusy: Zatwierdzony, Z≈Ço≈ºony, W trakcie weryfikacji</span><span class="t-info">${allWnp.length} wniosk√≥w</span></div>
  <div class="of"><table class="tbl"><thead><tr>
    <th>Numer wniosku o p≈Çatno≈õƒá</th><th>Status</th>
    <th class="nr">Wydatki kwalifikowalne</th><th class="nr">Dofinansowanie</th>
    <th class="nr">Wk≈Çad w≈Çasny</th><th class="nr">Zaliczka</th><th class="nr">Refundacja</th>
  </tr></thead><tbody>
  ${allWnp.map(r=>`<tr><td class="mono" style="font-size:.75rem">${r.nr_wn&&!r.nr_wn.startsWith('__ZAT__')?r.nr_wn:'‚Äî'}</td><td style="font-size:.85rem">${badge(r.status)}</td>
    <td class="nr mono" style="font-size:.85rem">${fmtK(r.wyd_kwal)}</td>
    <td class="nr mono" style="font-size:.85rem">${fmtK(r.dofinansowanie||0)}</td>
    <td class="nr mono" style="font-size:.85rem">${fmtK(r.wklad_wlasny||0)}</td>
    <td class="nr mono" style="font-size:.85rem">${fmtK(r.zaliczka||0)}</td>
    <td class="nr mono" style="font-size:.85rem">${fmtK(r.refundacja||0)}</td>
  </tr>`).join('')||'<tr><td colspan="7" class="empty">Brak wniosk√≥w</td></tr>'}
  </tbody><tfoot><tr style="background:var(--bg3);font-weight:700">
    <td colspan="2" style="padding:5px 10px;border-top:1px solid var(--brd2)">Suma</td>
    <td class="nr mono" style="padding:5px 10px;border-top:1px solid var(--brd2);font-size:.85rem">${fmtK(totKwal)}</td>
    <td class="nr mono" style="padding:5px 10px;border-top:1px solid var(--brd2);font-size:.85rem">${fmtK(totDof)}</td>
    <td class="nr mono" style="padding:5px 10px;border-top:1px solid var(--brd2);font-size:.85rem">${fmtK(totWl)}</td>
    <td class="nr mono" style="padding:5px 10px;border-top:1px solid var(--brd2);font-size:.85rem">${fmtK(totZal)}</td>
    <td class="nr mono" style="padding:5px 10px;border-top:1px solid var(--brd2);font-size:.85rem">${fmtK(totRef)}</td>
  </tr></tfoot></table></div></div>`;
}

// ‚îÄ‚îÄ‚îÄ BOOTSTRAP ‚îÄ‚îÄ‚îÄ
// ===== [JS-M] REBUILD ‚Äî PRZELICZENIE DANYCH ‚Äî rebuildAll, rebuildOpStats, rebuildPostepData =====
function rebuildAll(){
  // Przebuduj dane pochodne (RPK z ZAT, Postƒôp z Um√≥w+Zada≈Ñ)
  rebuildRpkData(RAW);
  rebuildPostepData(RAW);
  // Synchronizuj CFG.opDzial ‚Äî uzupe≈Çnij dzia≈Ç dla opiekun√≥w z ZAT/WER/POP na podstawie PERSONEL
  // (obs≈Çuguje przypadek gdy opiekun jest identyfikowany auto ZAT ale nie by≈Ç rƒôcznie wpisany do opDzial)
  const allOps=new Set();
  RAW.zat.forEach(r=>{if(r.opiekun&&!r.opiekun.startsWith('__'))allOps.add(r.opiekun);});
  RAW.wer.forEach(r=>{if(r.opiekun)allOps.add(r.opiekun);});
  RAW.pop.forEach(r=>{if(r.opiekun)allOps.add(r.opiekun);});
  allOps.forEach(op=>{
    if(!CFG.opDzial[op]){
      const p=PERSONEL[op];
      if(p&&p.dzial){const code=dzialToCode(p.dzial);if(code)CFG.opDzial[op]=code;}
    }
  });
  // Przebuduj widoki
  buildOverview();buildWer();buildPop();buildZat();buildRpk();buildPostep();buildRzeczowy();buildHp();buildOpGrid();buildArpk();buildMetryki();buildRozliczenie();
  // Wykaz projekt√≥w ‚Äî od≈õwie≈º tylko gdy strona widoczna
  if(document.getElementById('page-wykaz-proj').classList.contains('on')) buildWykazProj();
  if(document.getElementById('page-obciazenie').classList.contains('on')) buildObciazenie();
}
loadWeights();loadPersonel();
// Inicjalizuj rƒôczne przypisania opiekun√≥w z localStorage
if(!CFG.projOpiekun) CFG.projOpiekun=loadProjOpiekun();
// opDzial sync is now handled inside loadPersonel()
// Restore saved config values into form controls
(function syncCfgToForm(){
  const el=id=>document.getElementById(id);
  try{
    if(el("cfg-postep-od"))el("cfg-postep-od").value=CFG.postepOd||"projekt";
    if(el("cfg-opozn"))el("cfg-opozn").value=CFG.opozn||20;
    if(el("cfg-d1"))el("cfg-d1").value=CFG.d1||20;
    if(el("cfg-dn"))el("cfg-dn").value=CFG.dn||15;
    if(el("cfg-dp"))el("cfg-dp").value=CFG.dp||5;
    if(el("pop-lim"))el("pop-lim").textContent=CFG.dp||5;
    // Restore dzial pills
    if(!CFG.dzialy.has("all")){
      el("dp-all").classList.remove("on");
      ["1","2","3"].forEach(x=>{if(CFG.dzialy.has(x))el("dp-"+x).classList.add("on");});
    }
    // Update header labels
    const dzLbl=CFG.dzialy.has("all")?"Wszystkie dzia≈Çy":[...CFG.dzialy].map(x=>({"1":"Dzia≈Ç EFS I","2":"Dzia≈Ç EFS II","3":"Dzia≈Ç EFS III"}[x]||"Dzia≈Ç EFS "+x)).join(", ");
    if(el("tb-dzial"))el("tb-dzial").textContent=dzLbl;
    if(el("ov-dzial"))el("ov-dzial").textContent=dzLbl;
    if(el("postep-od-lbl"))el("postep-od-lbl").textContent=CFG.postepOd==="umowa"?"podpisania umowy":"rozpoczƒôcia projektu";
    // Sync topbar dropdown and all section filters
    const activeDzVal=CFG.dzialy.has("all")?"":(CFG.dzialy.size===1?[...CFG.dzialy][0]:"");
    if(el("tb-dzial-sel"))el("tb-dzial-sel").value=activeDzVal||"all";
    syncDzialFilters(activeDzVal);
  }catch(e){}
})();
buildOpAssign();buildArpkCatEditor();buildPersonelTab();rebuildAll();
// Poka≈º stan FEDS przy starcie
(function(){
  fedsUpdateCount();
  const n=Object.keys(CFG.projOpiekun_feds||{}).length;
  if(n>0) fedsSetStatus(`Za≈Çadowano ${n} projekt√≥w z poprzedniego importu`,'ok');
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// v10 ‚Äî Zapisz stan / Wyczy≈õƒá dane / Toast
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function clearData(){
  if(!confirm('Wyczy≈õciƒá wszystkie wczytane dane?\nKod, konfiguracja i lista pracownik√≥w pozostanƒÖ.'))return;
  RAW.wer=[];RAW.pop=[];RAW.zat=[];RAW.rpk=[];
  RAW.arpk=[];RAW.arpk_map={};RAW.hp=[];
  RAW.hp_wer=[];RAW.hp_zat=[];RAW.postep=[];
  RAW.rzeczowy=[];RAW.metryki=[];RAW.umowy=[];
  RAW.wskazniki=[];RAW.zadania={};RAW.op_stats={};
  CFG.projOpiekun_feds={};
  saveCFG();
  podzSetStatus('Usuniƒôto dane z pliku FEDS','var(--txt3)');
  const btn=document.getElementById('podz-clear-btn');if(btn)btn.style.display='none';
  rebuildAll();
  showToast('Dane wyczyszczone ‚úì');
}

// ‚îÄ‚îÄ‚îÄ _syncPersonelToSrc: stub ‚Äî PERSONEL jest zapisywany live do DEFAULT_PERSONEL w pliku HTML ‚îÄ‚îÄ‚îÄ
function _syncPersonelToSrc(){/* no-op: saveState pobiera PERSONEL live z obiektu */}

function saveState(){
  showToast('Generujƒô plik HTML...');
  try{
    _STORAGE.setItem('RBMV_PROJ_OPIEKUN', JSON.stringify(CFG.projOpiekun||{}));
    _STORAGE.setItem('RBMV_FEDS', JSON.stringify(CFG.projOpiekun_feds||{}));

    // ‚îÄ‚îÄ KROK 1: outerHTML daje poprawna strukture DOM, ale encoduje tresc blokow script ‚îÄ‚îÄ
    // Rozwiazanie: pobieramy outerHTML jako szkielet HTML, a potem kazdy blok script
    // (encodowany) zastepujemy surowym textContent z document.scripts
    var html = '<!DOCTYPE html>\n' + document.documentElement.outerHTML;

    // ‚îÄ‚îÄ KROK 2: podmie≈Ñ encodowane bloki script na surowy JS z document.scripts ‚îÄ‚îÄ
    // document.scripts zawiera tylko inline scripts (bez src="...")
    var inlineScripts = [];
    for(var i=0;i<document.scripts.length;i++){
      if(!document.scripts[i].src) inlineScripts.push(document.scripts[i].textContent);
    }
    var scriptIdx = 0;
    var scriptCloseTag = '<' + '/script>';
    var scriptReplRx = new RegExp('<script((?:\\s[^>]*)?)>([\\s\\S]*?)' + scriptCloseTag.replace('/','\\/'),'gi');
    html = html.replace(scriptReplRx, function(match, attrs, inner){
      // Pomi≈Ñ tagi <script src="..."> ‚Äî nie majƒÖ inline content
      if(/src\s*=/i.test(attrs)) return match;
      if(scriptIdx >= inlineScripts.length) return match;
      var raw = inlineScripts[scriptIdx++];
      raw = raw.replace(/<\/script/gi, '<\\/script');
      var sOpen = '<scr'+'ipt>', sClose = '<'+'\/script>';
      return sOpen + raw + sClose;
    });

    // ‚îÄ‚îÄ KROK 3: wstrzyknij aktualne dane RAW przez markery ‚îÄ‚îÄ
    var rawData = {
      wer:RAW.wer||[], pop:RAW.pop||[], zat:RAW.zat||[],
      rpk:RAW.rpk||[], arpk:RAW.arpk||[], arpk_map:RAW.arpk_map||{},
      hp:RAW.hp||[], hp_wer:RAW.hp_wer||[], hp_zat:RAW.hp_zat||[],
      postep:RAW.postep||[], rzeczowy:RAW.rzeczowy||[],
      metryki:RAW.metryki||[], umowy:RAW.umowy||[],
      wskazniki:RAW.wskazniki||[], zadania:RAW.zadania||{},
      op_stats:RAW.op_stats||{}, projOpiekun_xlsx:RAW.projOpiekun_xlsx||{}
    };
    var rawJson = JSON.stringify(rawData).replace(/<\/script/gi,'<\\/script');
    var rawRx = /\/\*__RAW_START__\*\/const RAW=[\s\S]*?\/\*__RAW_END__\*\//;
    if(!rawRx.test(html)){
      showToast('B≈ÇƒÖd: brak markera RAW');
      console.error('saveState: brak /*__RAW_START__*/');
      return;
    }
    html = html.replace(rawRx,'/*__RAW_START__*/const RAW='+rawJson+';/*__RAW_END__*/');

    // ‚îÄ‚îÄ KROK 4: wstrzyknij PERSONEL ‚îÄ‚îÄ
    var perJson = JSON.stringify(PERSONEL).replace(/<\/script/gi,'<\\/script');
    var perRx = /\/\*__PER_START__\*\/const DEFAULT_PERSONEL=[\s\S]*?\/\*__PER_END__\*\//;
    if(perRx.test(html)){
      html = html.replace(perRx,'/*__PER_START__*/const DEFAULT_PERSONEL='+perJson+'; /*__PER_END__*/');
    }

    // ‚îÄ‚îÄ KROK 5: wstrzyknij mape opiekun√≥w i dzia≈Ç√≥w FEDS ‚îÄ‚îÄ
    var fedsData = {
      projOpiekun_feds: CFG.projOpiekun_feds||{},
      projDzial_feds:   CFG.projDzial_feds||{}
    };
    var fedsJson = JSON.stringify(fedsData).replace(/<\/script/gi,'<\\/script');
    var fedsRx = /\/\*__FEDS_START__\*\/const _EMBEDDED_FEDS=[\s\S]*?;\/\*__FEDS_END__\*\//;
    if(fedsRx.test(html)){
      html = html.replace(fedsRx,'/*__FEDS_START__*/const _EMBEDDED_FEDS='+fedsJson+';/*__FEDS_END__*/');
    }

    // ‚îÄ‚îÄ KROK 6: pobierz plik ‚îÄ‚îÄ
    var ts = new Date().toISOString().slice(0,16).replace('T','_').replace(/:/g,'');
    var fname = 'dashboard_wnp_'+ts+'.html';
    var blob = new Blob([html],{type:'text/html;charset=utf-8'});
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = fname;
    document.body.appendChild(a); a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(a.href);
    showToast('Zapisano: '+fname);
  }catch(e){
    showToast('B≈ÇƒÖd zapisu: '+e.message);
    console.error('saveState error:',e);
  }
}


function showToast(msg,dur){
  dur=dur||2800;
  let t=document.getElementById('_toast');
  if(!t){
    t=document.createElement('div');t.id='_toast';
    t.style.cssText='position:fixed;bottom:1.5rem;right:1.5rem;background:var(--acc);color:#fff;padding:.65rem 1.3rem;border-radius:9px;font-size:.9rem;font-weight:600;z-index:99999;opacity:0;transition:opacity .25s;pointer-events:none;box-shadow:0 4px 16px rgba(0,0,0,.25)';
    document.body.appendChild(t);
  }
  t.textContent=msg;t.style.opacity='1';
  clearTimeout(t._tid);t._tid=setTimeout(()=>t.style.opacity='0',dur);
}
</script>

<script>
window.toggleSidebar = function() {
  document.querySelector('.sidebar').classList.toggle('collapsed');
  document.querySelector('.main').classList.toggle('collapsed');
  localStorage.setItem('sidebarCollapsed', document.querySelector('.sidebar').classList.contains('collapsed'));
};

// Load state on init
if (localStorage.getItem('sidebarCollapsed') === 'true') {
  document.querySelector('.sidebar').classList.add('collapsed');
  document.querySelector('.main').classList.add('collapsed');
}
</script>
</body>
</html>